unit UDBFinanceiro.Update;

interface

uses
  UDBUpdate,
  Tc.RTL.SmartPointer,
  Tc.VCL.Application,
  System.ioUtils,
  Winapi.Windows,
  dialogs ;

type

{$M+}
  TDBFinanceiroUpdate = class( TDBUpdate )
  published
    procedure _5_000_01;
    procedure _5_000_04;
    procedure _5_000_05;
    procedure _5_000_06;
    procedure _5_000_07;
    procedure _5_000_13;
    procedure _5_000_14;
    procedure _5_000_17;
    procedure _5_000_19;
    procedure _5_000_25;
    procedure _5_000_26;
    procedure _5_000_27;
    procedure _5_000_30;
    procedure _5_000_31;
    procedure _5_000_35;
    procedure _5_000_36;
    procedure _5_000_37;
    procedure _5_000_61;
    procedure _5_000_66;
    procedure _5_000_74;
    procedure _5_000_76;
    procedure _5_000_80;
    procedure _5_000_82;
    procedure _5_000_83;
    procedure _5_000_84;
    procedure _5_000_88; // SEATTLE
    procedure _5_000_91;
    procedure _5_000_92;
    procedure _5_000_93;
    procedure _5_000_94;
    procedure _5_000_95;
    procedure _5_000_96;
    procedure _5_000_97;
    procedure _5_000_98;
    procedure _5_001_01;
    procedure _5_001_02;
    procedure _5_001_03;
    procedure _5_001_04 ;
    procedure _5_001_05 ;
    procedure _5_001_07 ;
    procedure _5_001_09 ;
    procedure _5_001_10 ;
    procedure _5_001_12 ;
    procedure _5_001_14 ;
    procedure _5_001_15 ; // BERLIN
    procedure _5_001_16 ;
    procedure _5_001_17 ;
    procedure _5_001_18 ;
    procedure _5_001_19 ;
    procedure _5_001_20 ;
    procedure _5_001_21 ;
    procedure _5_001_22 ;
    procedure _5_001_25 ;
    procedure _5_001_29 ;
    procedure _5_001_30 ;
    procedure _5_001_31 ;
    procedure _5_001_35 ;
    procedure _5_001_36 ;
    procedure _5_001_38 ;
    procedure _5_001_39 ;
    procedure _5_001_40 ;
    procedure _5_001_41 ;
    procedure _5_001_42 ;
    procedure _5_001_43 ;
    procedure _5_001_44 ;
    procedure _5_001_45 ;
    procedure _5_001_47 ;
    procedure _5_001_48 ;
    procedure _5_001_49 ;
    procedure _5_001_50 ;
    procedure _5_001_51 ;
    procedure _5_001_52 ;
    procedure _5_001_53 ;
    procedure _5_001_54 ;
    procedure _5_001_55 ;
    procedure _5_001_57 ;
    procedure _5_001_58 ;
    procedure _5_001_59 ;
    procedure _5_001_60 ;
    procedure _5_001_61 ;
    procedure _5_001_62 ;
    procedure _5_001_65 ;
    procedure _5_001_68 ;
    procedure _5_001_69 ;
    procedure _5_001_70 ;
    procedure _5_001_71 ;
    procedure _5_001_72 ;
    procedure _5_001_73 ;
    procedure _5_001_74 ;
    procedure _5_001_75 ;
    procedure _5_001_76 ; //193
    procedure _5_001_77 ;
    procedure _5_001_79 ;
    procedure _5_001_80 ;
    procedure _5_001_81 ;
    procedure _5_001_82 ;
    procedure _5_001_83 ;
    procedure _5_001_84 ;
    procedure _5_001_85 ;
    procedure _5_001_86 ;
    procedure _5_001_87 ;
    procedure _5_001_88 ;
    procedure _5_001_89 ;
    procedure _5_001_90 ;
    procedure _5_001_91 ;
    procedure _5_001_92 ;
    procedure _5_001_94 ;
    procedure _5_001_95 ;
    procedure _5_001_96 ;
//    procedure _5_001_97 ;
    procedure _5_001_98 ;
    procedure _5_002_01 ;
    procedure _5_002_02 ;
    procedure _5_002_03 ;
    procedure _5_002_04 ;
    procedure _5_002_05 ;
    procedure _5_002_06 ;
    procedure _5_002_08 ;
    procedure _5_002_09 ;
    procedure _5_002_10 ;
    procedure _5_002_11 ;
    procedure _5_002_14 ; // v197 - 20180508
    procedure _5_002_15 ; // v197 - 20180604
    procedure _5_002_16 ;
    procedure _5_002_17 ;
    procedure _5_002_18 ;
    procedure _5_002_19 ;
    procedure _5_002_21 ;
    procedure _5_002_22 ;
    procedure _5_002_23 ;
    procedure _5_002_25 ;
    procedure _5_002_26 ;
    procedure _5_002_28 ;
    procedure _5_002_29 ;
    procedure _5_002_33 ;
    procedure _5_002_34 ;
    procedure _5_002_35 ;
    procedure _5_002_36 ;
    procedure _5_002_37 ;
//  procedure _5_002_38   //SKIP
    procedure _5_002_39 ;
    procedure _5_002_40 ; // APAGAR
    procedure _5_002_41 ; // ARECEBER
    procedure _5_002_42 ; // CMP_PEDIDOS
    procedure _5_002_43 ; // VND_PEDIDOS
    procedure _5_002_44 ; // DEV_PEDIDOS
    procedure _5_002_45 ; // FIN_FINACIAMENTOS ....
  end;
{$M-}

implementation

Uses
    Tc.RTL.Exceptions, System.SysUtils, System.DateUtils, System.Classes,
    Data.DB, Tc.Data.DB.Helpers, DataSnap.DBClient, Tc.DataSnap.DBClient.Helpers,
    ClAg5.Utils.Financeiro.EncerramentoMensal,
    UFIN_PlanoContasReceitasDespesasClass,
    GuidSuppl,
    Tc.RTL.MD5,
    Tc.DBRTL.AbstractDB  ;


procedure LoadResourceStrings( AResourceName : string ; const AStrings : TStrings);
var
 LResourceStream: TResourceStream;
begin
  LResourceStream := TResourceStream.Create( HInstance, AResourceName, RT_RCDATA);
  try
   AStrings.LoadFromStream(LResourceStream);
  finally
   LResourceStream.Free;
  end;
end;



(*
  NOTA_FISCAL_,
DEV_PEDIDOS

*)

procedure TDBFinanceiroUpdate._5_002_45 ;
const
  _ALTER_TABLE_FIN_FINANCIAMENTOS =
         'ALTER TABLE FIN_FINANCIAMENTOS'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC_'
  +#13#10', ALTER DOCUMENTO_ POSITION 8' ;

   _UPDATE_FIN_FINANCIAMENTOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_FINANCIAMENTOS SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_FINANCIAMENTOS_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_FINANCIAMENTOS_BIUD0 FOR FIN_FINANCIAMENTOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10''
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF ( updating ) THEN'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF  ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) THEN'
  +#13#10'         NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_FIN_FINANCIAMENTOS ) ;
  ExecuteDirect( _UPDATE_FIN_FINANCIAMENTOS  ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_FINANCIAMENTOS_BIUD0  ) ;
end  ;

procedure TDBFinanceiroUpdate._5_002_44 ;
const
  _ALTER_TABLE_DEV_PEDIDOS =
         'ALTER TABLE DEV_PEDIDOS'
  +#13#10'    ADD NOTA_FISCAL_ SYS$CODE_'
  +#13#10', ALTER NOTA_FISCAL_ POSITION 10' ;

   _UPDATE_DEV_PEDIDOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE DEV_PEDIDOS SET'
  +#13#10'     NOTA_FISCAL_ = IIF ('
  +#13#10'          TRIM (NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NOTA_FISCAL))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(NOTA_FISCAL)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(NOTA_FISCAL)) )'
  +#13#10'    WHERE NOTA_FISCAL_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_DEV_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER DEV_PEDIDOS_BIUD0 FOR DEV_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
  +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
  +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
  +#13#10'          || COALESCE (NEW.DATA_ENTRADA, '''' ) ;'
  +#13#10''
  +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'         IF ( NEW.DATA_EMISSAO IS DISTINCT FROM NEW.DATA_ENTRADA ) THEN'
  +#13#10'            EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
  +#13#10'        END'
  +#13#10''
  +#13#10'      NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
  +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM DEV_PEDIDO_ITENS'
  +#13#10'        WHERE KDEV_PEDIDO = NEW.KDEV_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL IS DISTINCT FROM OLD.NOTA_FISCAL ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10'  ELSE IF ( deleting ) then'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10'    END'
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_DEV_PEDIDOS ) ;
  ExecuteDirect( _UPDATE_DEV_PEDIDOS  ) ;
  ExecuteDirect( _ALTER_TRIGGER_DEV_PEDIDOS_BIUD0  ) ;
end  ;


procedure TDBFinanceiroUpdate._5_002_43 ;
const
  _ALTER_TABLE_VND_PEDIDOS =
         'ALTER TABLE VND_PEDIDOS'
  +#13#10'    ADD NOTA_FISCAL_ SYS$CODE_'
  +#13#10', ALTER NOTA_FISCAL_ POSITION 10' ;

   _UPDATE_VND_PEDIDOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE VND_PEDIDOS SET'
  +#13#10'     NOTA_FISCAL_ = IIF ('
  +#13#10'          TRIM (NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NOTA_FISCAL))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(NOTA_FISCAL)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(NOTA_FISCAL)) )'
  +#13#10'    WHERE NOTA_FISCAL_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER VND_PEDIDOS_BIUD0 FOR VND_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
  +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
  +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
  +#13#10'     --     || COALESCE (NEW.DATA_SAIDA,   '''' )'
  +#13#10'          ;'
  +#13#10''
  +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'         --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'            --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
  +#13#10'        END'
  +#13#10''
  +#13#10'      NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --IF ( OLD.DATA_SAIDA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'      --  EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'      --   EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM VND_PEDIDO_ITENS'
  +#13#10'        WHERE KVND_PEDIDO = NEW.KVND_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO /*DATA_SAIDA*/ ;'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL IS DISTINCT FROM OLD.NOTA_FISCAL ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_VND_PEDIDOS ) ;
  ExecuteDirect( _UPDATE_VND_PEDIDOS  ) ;
  ExecuteDirect( _ALTER_TRIGGER_VND_PEDIDOS_BIUD0  ) ;
end  ;




procedure TDBFinanceiroUpdate._5_002_42 ;
const
  _ALTER_TABLE_CMP_PEDIDOS =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'    ADD NOTA_FISCAL_ SYS$CODE_'
  +#13#10', ALTER NOTA_FISCAL_ POSITION 6' ;

   _UPDATE_CMP_PEDIDOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE CMP_PEDIDOS SET'
  +#13#10'     NOTA_FISCAL_ = IIF ('
  +#13#10'          TRIM (NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NOTA_FISCAL))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(NOTA_FISCAL)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(NOTA_FISCAL)) )'
  +#13#10'    WHERE NOTA_FISCAL_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;


  _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_BIUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'   BEGIN'
  +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
  +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
  +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
  +#13#10'          || COALESCE (NEW.DATA_ENTRADA, '''' ) ;'
  +#13#10''
  +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'         IF ( NEW.DATA_EMISSAO IS DISTINCT FROM NEW.DATA_ENTRADA ) THEN'
  +#13#10'            EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
  +#13#10'        END'
  +#13#10''
  +#13#10'      NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( UPDATING )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
  +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL IS DISTINCT FROM OLD.NOTA_FISCAL ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL)) ) ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM CMP_PEDIDO_ITENS'
  +#13#10'        WHERE KCMP_PEDIDO = NEW.KCMP_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( DELETING ) then'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10'    END'
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_CMP_PEDIDOS     ) ;
  ExecuteDirect( _UPDATE_CMP_PEDIDOS  ) ;
  ExecuteDirect   ( _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0  ) ;
end  ;


procedure TDBFinanceiroUpdate._5_002_41 ; // ARECEBER
const
  _ALTER_TABLE_FIN_ARECEBER =
         'ALTER TABLE FIN_ARECEBER'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC_'
  +#13#10', ALTER DOCUMENTO_ POSITION 8' ;

  _ALTER_TABLE_FIN_ARECEBER_PARCELAS =
         'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC_'
  +#13#10', ALTER DOCUMENTO_ POSITION 4' ;

   _UPDATE_FIN_ARECEBER =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_ARECEBER SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

   _UPDATE_FIN_ARECEBER_PARCELAS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_ARECEBER_PARCELAS SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_ARECEBER_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_ARECEBER_BIUD0 FOR FIN_ARECEBER'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'--   if ( NEW.KFIN_ARECEBER is null ) then'
  +#13#10'--     NEW.KFIN_ARECEBER = GEN_ID ( KFIN_ARECEBER, 1 ) ;'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''FIN_ARECEBER'', OLD.KFIN_ARECEBER ;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_ARECEBER_PARCELAS_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_ARECEBER_PARCELAS_BIUD0 FOR FIN_ARECEBER_PARCELAS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_FIN_ARECEBER          ) ;
  TryExecuteDirect( _ALTER_TABLE_FIN_ARECEBER_PARCELAS ) ;
  ExecuteDirect( _UPDATE_FIN_ARECEBER               ) ;
  ExecuteDirect( _UPDATE_FIN_ARECEBER_PARCELAS      ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_ARECEBER_BIUD0  ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_ARECEBER_PARCELAS_BIUD0  ) ;
end  ;

procedure TDBFinanceiroUpdate._5_002_40 ; // APAGAR
const
  _ALTER_TABLE_FIN_APAGAR =
         'ALTER TABLE FIN_APAGAR'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC_'
  +#13#10', ALTER DOCUMENTO_ POSITION 8' ;

  _ALTER_TABLE_FIN_APAGAR_PARCELAS =
         'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC_'
  +#13#10', ALTER DOCUMENTO_ POSITION 4' ;

   _UPDATE_FIN_APAGAR =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_APAGAR SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

   _UPDATE_FIN_APAGAR_PARCELAS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_APAGAR_PARCELAS SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 32, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_APAGAR_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_BIUD0 FOR FIN_APAGAR'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'--   if ( NEW.KFIN_APAGAR is null ) then'
  +#13#10'--     NEW.KFIN_APAGAR = GEN_ID ( KFIN_APAGAR, 1 ) ;'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''FIN_APAGAR'', OLD.KFIN_APAGAR ;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_APAGAR_PARCELAS_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_PARCELAS_BIUD0 FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 32, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_FIN_APAGAR          ) ;
  TryExecuteDirect( _ALTER_TABLE_FIN_APAGAR_PARCELAS ) ;
  ExecuteDirect( _UPDATE_FIN_APAGAR               ) ;
  ExecuteDirect( _UPDATE_FIN_APAGAR_PARCELAS      ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_APAGAR_BIUD0  ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_APAGAR_PARCELAS_BIUD0 ) ;
end  ;

procedure TDBFinanceiroUpdate._5_002_39 ;
const
   _CREATE_DOMAIN_SYSCODE_ =
          'CREATE DOMAIN SYS$CODE_ AS'
   +#13#10'VARCHAR(33) CHARACTER SET ISO8859_1'
   +#13#10'COLLATE ISO8859_1' ;

   _CREATE_DOMAIN_FINDOC_ =
          'CREATE DOMAIN FIN$DOC_ AS'
   +#13#10'VARCHAR(33) CHARACTER SET ISO8859_1'
   +#13#10'COLLATE ISO8859_1' ;

begin
  TryExecuteDirect( _CREATE_DOMAIN_SYSCODE_ ) ;
  TryExecuteDirect( _CREATE_DOMAIN_FINDOC_ ) ;
end;

(*
procedure TDBFinanceiroUpdate._5_002_38 ;
const
  _ALTER_TABLE_FIN_APAGAR =
         'ALTER TABLE FIN_APAGAR'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC'
  +#13#10', ALTER DOCUMENTO_ POSITION 8' ;

  _ALTER_TABLE_FIN_APAGAR_PARCELAS =
         'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC'
  +#13#10', ALTER DOCUMENTO_ POSITION 4' ;

  _ALTER_TABLE_FIN_ARECEBER =
         'ALTER TABLE FIN_ARECEBER'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC'
  +#13#10', ALTER DOCUMENTO_ POSITION 8' ;

  _ALTER_TABLE_FIN_ARECEBER_PARCELAS =
         'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'    ADD DOCUMENTO_ FIN$DOC'
  +#13#10', ALTER DOCUMENTO_ POSITION 4' ;

  _ALTER_TABLE_CMP_PEDIDOS =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'    ADD NOTA_FISCAL_ SYS$CODE'
  +#13#10', ALTER NOTA_FISCAL_ POSITION 6' ;

  _ALTER_TABLE_VND_PEDIDOS =
         'ALTER TABLE VND_PEDIDOS'
  +#13#10'    ADD NOTA_FISCAL_ SYS$CODE'
  +#13#10', ALTER NOTA_FISCAL_ POSITION 10' ;

   _UPDATE_FIN_APAGAR =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_APAGAR SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 16, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

   _UPDATE_FIN_ARECEBER =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE FIN_ARECEBER SET'
  +#13#10'     DOCUMENTO_ = IIF ('
  +#13#10'          TRIM (DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(DOCUMENTO))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(DOCUMENTO)), 16, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(DOCUMENTO)) )'
  +#13#10'    WHERE DOCUMENTO_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

   _UPDATE_CMP_PEDIDOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE CMP_PEDIDOS SET'
  +#13#10'     NOTA_FISCAL_ = IIF ('
  +#13#10'          TRIM (NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NOTA_FISCAL))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(NOTA_FISCAL)), 16, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(NOTA_FISCAL)) )'
  +#13#10'    WHERE NOTA_FISCAL_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

   _UPDATE_VND_PEDIDOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE VND_PEDIDOS SET'
  +#13#10'     NOTA_FISCAL_ = IIF ('
  +#13#10'          TRIM (NOTA_FISCAL) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NOTA_FISCAL))||''}'''
  +#13#10'        , LPAD ( TRIM(UPPER(NOTA_FISCAL)), 16, ''0'' )'
  +#13#10'        , ''A'' || TRIM(UPPER(NOTA_FISCAL)) )'
  +#13#10'    WHERE NOTA_FISCAL_ IS NULL ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'', NULL ) ;'
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_APAGAR_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_BIUD0 FOR FIN_APAGAR'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE VCODIGO VARCHAR ( 32 ) ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'--   if ( NEW.KFIN_APAGAR is null ) then'
  +#13#10'--     NEW.KFIN_APAGAR = GEN_ID ( KFIN_APAGAR, 1 ) ;'
  +#13#10''
  +#13#10'--   if ( new.tablename = ''CMP_PEDIDOS'' ) then'
  +#13#10'--      begin'
  +#13#10'--         select CODIGO from CMP_PEDIDOS  where KCMP_PEDIDO = new.tablekey'
  +#13#10'--           into vCODIGO ;'
  +#13#10'--'
  +#13#10'--         new.documento = ''PC'' || :vCodigo ;'
  +#13#10'--         new.historico =  ''Pedido Compra : '' || :vCodigo ;'
  +#13#10'--      end'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''FIN_APAGAR'', OLD.KFIN_APAGAR ;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_FIN_ARECEBER_BIUD0 =
         'CREATE OR ALTER TRIGGER FIN_ARECEBER_BIUD0 FOR FIN_ARECEBER'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'--   if ( NEW.KFIN_ARECEBER is null ) then'
  +#13#10'--     NEW.KFIN_ARECEBER = GEN_ID ( KFIN_ARECEBER, 1 ) ;'
  +#13#10''
  +#13#10'   IF  (    ( INSERTING OR UPDATING )'
  +#13#10'        AND ( NEW.DOCUMENTO IS DISTINCT FROM OLD.DOCUMENTO ) ) THEN'
  +#13#10'      NEW.DOCUMENTO_ = IIF ( TRIM (NEW.DOCUMENTO) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.DOCUMENTO))||''}'', LPAD ( TRIM(UPPER(NEW.DOCUMENTO)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.DOCUMENTO)) ) ;'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''FIN_ARECEBER'', OLD.KFIN_ARECEBER ;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_BIUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'   BEGIN'
  +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
  +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
  +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
  +#13#10'          || COALESCE (NEW.DATA_ENTRADA, '''' ) ;'
  +#13#10''
  +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'         IF ( NEW.DATA_EMISSAO IS DISTINCT FROM NEW.DATA_ENTRADA ) THEN'
  +#13#10'            EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
  +#13#10'        END'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL_ IS DISTINCT FROM OLD.NOTA_FISCAL_ ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL_) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL_))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL_)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL_)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( UPDATING )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
  +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL_ IS DISTINCT FROM OLD.NOTA_FISCAL_ ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL_) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL_))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL_)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL_)) ) ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM CMP_PEDIDO_ITENS'
  +#13#10'        WHERE KCMP_PEDIDO = NEW.KCMP_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( DELETING ) then'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10'    END'
  +#13#10'END' ;

  _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER VND_PEDIDOS_BIUD0 FOR VND_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
  +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
  +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
  +#13#10'     --     || COALESCE (NEW.DATA_SAIDA,   '''' )'
  +#13#10'          ;'
  +#13#10''
  +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'         --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'            --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
  +#13#10'        END'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL_ IS DISTINCT FROM OLD.NOTA_FISCAL_ ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL_) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL_))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL_)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL_)) ) ;'
  +#13#10''
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --IF ( OLD.DATA_SAIDA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'      --  EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'      --   EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM VND_PEDIDO_ITENS'
  +#13#10'        WHERE KVND_PEDIDO = NEW.KVND_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO /*DATA_SAIDA*/ ;'
  +#13#10''
  +#13#10'      IF  ( NEW.NOTA_FISCAL_ IS DISTINCT FROM OLD.NOTA_FISCAL_ ) THEN'
  +#13#10'         NEW.NOTA_FISCAL_ = IIF ( TRIM (NEW.NOTA_FISCAL_) SIMILAR TO ''[0-9]{''||CHAR_LENGTH(TRIM(NEW.NOTA_FISCAL_))||''}'', LPAD ( TRIM(UPPER(NEW.NOTA_FISCAL_)), 16, ''0'' ), ''A'' || TRIM(UPPER(NEW.NOTA_FISCAL_)) ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect( _ALTER_TABLE_FIN_APAGAR               ) ;
  TryExecuteDirect( _ALTER_TABLE_FIN_APAGAR_PARCELAS      ) ;
  TryExecuteDirect( _UPDATE_FIN_APAGAR   ) ;



  TryExecuteDirect( _ALTER_TABLE_FIN_ARECEBER    ) ;
  TryExecuteDirect( _ALTER_TABLE_CMP_PEDIDOS     ) ;
  TryExecuteDirect( _ALTER_TABLE_VND_PEDIDOS ) ;

  TryExecuteDirect( _UPDATE_FIN_ARECEBER ) ;
  TryExecuteDirect( _UPDATE_CMP_PEDIDOS  ) ;
  TryExecuteDirect( _UPDATE_VND_PEDIDOS  ) ;

  ExecuteDirect( _ALTER_TRIGGER_FIN_APAGAR_BIUD0   ) ;
  ExecuteDirect( _ALTER_TRIGGER_FIN_ARECEBER_BIUD0 ) ;
  ExecuteDirect( _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0  ) ;
  ExecuteDirect( _ALTER_TRIGGER_VND_PEDIDOS_BIUD0  ) ;


end  ;
*)


procedure TDBFinanceiroUpdate._5_002_37 ;
const
  _ALTER_TRIGGER_CAD_PATRIMONIOS_BIUD0 =
          'CREATE OR ALTER TRIGGER CAD_PATRIMONIOS_BIUD0 FOR CAD_PATRIMONIOS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'   IF ( INSERTING OR UPDATING ) THEN'
   +#13#10'      BEGIN'
   +#13#10''
   +#13#10'        IF ( NEW.CODIGO IS NULL ) THEN'
   +#13#10'          SELECT  SEQUENCE_VALUE'
   +#13#10'          FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''CAD_PATRIMONIOS_CODIGO'' )'
   +#13#10'        INTO NEW.CODIGO ;'
   +#13#10''
   +#13#10'        IF ( NEW.CODIGO_ IS NULL ) THEN'
   +#13#10'          SELECT Right ( ''0000000'' || NEW.CODIGO, 7 )'
   +#13#10'          FROM  RDB$DATABASE'
   +#13#10'        INTO NEW.CODIGO_ ;'
   +#13#10''
   +#13#10'      IF (NEW.DATA_BAIXA IS NOT NULL) THEN'
   +#13#10'         NEW.ATIVO = ''F'';'
   +#13#10'   END'
   +#13#10''
   +#13#10'   IF ( DELETING ) THEN'
   +#13#10'     EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CAD_PATRIMONIOS'', OLD.KCAD_PATRIMONIO ;'
   +#13#10''
   +#13#10''
   +#13#10'END' ;

   _ALTER_TRIGGER_VND_PEDIDO_ITENS_AIUD0 =
          'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
   +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
   +#13#10'AS'
   +#13#10''
   +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
   +#13#10'DECLARE DATA            SYS$DATE;'
   +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
   +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
   +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
   +#13#10'DECLARE KVND_PEDIDO     SYS$FKGUID20  = NULL ;'
   +#13#10''
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
   +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
   +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
   +#13#10'     ) THEN'
   +#13#10'    EXIT ;'
   +#13#10''
   +#13#10'  KVND_PEDIDO = IIF( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO ) ;'
   +#13#10''
   +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO'
   +#13#10'    FROM VND_PEDIDOS'
   +#13#10'   WHERE KVND_PEDIDO = :KVND_PEDIDO'
   +#13#10'  INTO KDOMAIN, DATA;'
   +#13#10''
   +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
   +#13#10'    EXIT ;'
   +#13#10''
   +#13#10'  IF (    UPDATING'
   +#13#10'      AND ('
   +#13#10'                ( OLD.KVND_PEDIDO_ITEM IS DISTINCT FROM NEW.KVND_PEDIDO_ITEM )'
   +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
   +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
   +#13#10'                )'
   +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
   +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
   +#13#10'                )'
   +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
   +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
   +#13#10'                )'
   +#13#10'          )'
   +#13#10'     ) THEN'
   +#13#10'   BEGIN'
   +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
   +#13#10'                                                KDOMAIN,'
   +#13#10'                                                OLD.KEST_PRODUTO,'
   +#13#10'                                                DATA,'
   +#13#10'                                                ''S'','
   +#13#10'                                                OLD.QTDE,'
   +#13#10'                                                OLD.CUSTO,'
   +#13#10'                                                ''VND_PEDIDO_ITENS'','
   +#13#10'                                                OLD.KVND_PEDIDO_ITEM'
   +#13#10'                                                );'
   +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
   +#13#10'          EXIT ;'
   +#13#10''
   +#13#10'   END'
   +#13#10''
   +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
   +#13#10'    BEGIN'
   +#13#10'       KEST_PRODUTO    = NEW.KEST_PRODUTO ;'
   +#13#10'       KFIN_PLANOCONTA = NEW.KFIN_PLANOCONTA ;'
   +#13#10'    END'
   +#13#10'  ELSE'
   +#13#10'    BEGIN'
   +#13#10'      KEST_PRODUTO    = OLD.KEST_PRODUTO ;'
   +#13#10'      KFIN_PLANOCONTA = OLD.KFIN_PLANOCONTA ;'
   +#13#10'    END'
   +#13#10''
   +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
   +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
   +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
   +#13#10'    INTO BAIXA_ESTOQUE ;'
   +#13#10''
   +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
   +#13#10'    KEST_PRODUTO = NULL ;'
   +#13#10''
   +#13#10'  BAIXA_ESTOQUE = NULL ;'
   +#13#10''
   +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
   +#13#10''
   +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
   +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
   +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
   +#13#10'    INTO BAIXA_ESTOQUE ;'
   +#13#10''
   +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
   +#13#10'    KEST_PRODUTO = NULL ;'
   +#13#10''
   +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
   +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
   +#13#10'                                             when Inserting then ''I'''
   +#13#10'                                             when Updating  then ''U'''
   +#13#10'                                             when Deleting  then ''D'''
   +#13#10'                                             end,'
   +#13#10'                                             KDOMAIN,'
   +#13#10'                                             KEST_PRODUTO,'
   +#13#10'                                             DATA,'
   +#13#10'                                             ''S'','
   +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
   +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
   +#13#10'                                             ''VND_PEDIDO_ITENS'','
   +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
   +#13#10'                                            );'
   +#13#10''
   +#13#10''
   +#13#10'END' ;

   _ALTER_PROCEDURE_FIN_INSERT_CREDITODEBITO =
          'CREATE OR ALTER PROCEDURE FIN_INSERT_CREDITODEBITO ('
   +#13#10'    KFIN_TRANSFERENCIA SYS$FKGUID20,'
   +#13#10'    KSYS$DOMAIN SYS$FKGUID20_NN,'
   +#13#10'    KFIN_CONTA_ORIGEM SYS$FKGUID20_NN,'
   +#13#10'    DOC_ORIGEM FIN$DOC,'
   +#13#10'    KFIN_CONTA_DESTINO SYS$FKGUID20_NN,'
   +#13#10'    DOC_DESTINO FIN$DOC,'
   +#13#10'    DATA SYS$DATE,'
   +#13#10'    VALOR SYS$FLOAT,'
   +#13#10'    OBS SYS$BLOBTEXT)'
   +#13#10'AS'
   +#13#10'DECLARE PK SYS$FKGUID20;'
   +#13#10'BEGIN'
   +#13#10'  /* CREDITO */'
   +#13#10'  PK = GUID20();'
   +#13#10''
   +#13#10'  INSERT INTO FIN_ARECEBER'
   +#13#10'    ( KFIN_ARECEBER, KSYS$DOMAIN, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
   +#13#10'  VALUES'
   +#13#10'    ( :PK, :KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || :DOC_DESTINO, NULL, ''FIN_TRANSFERENCIAS'', :KFIN_TRANSFERENCIA, :OBS);'
   +#13#10''
   +#13#10'  INSERT INTO FIN_ARECEBER_PARCELAS'
   +#13#10'    ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
   +#13#10'  VALUES'
   +#13#10'    ( GUID20(), :PK, ''TC'' || :DOC_DESTINO, :DATA, :VALOR, :DATA, :DATA, :VALOR, :KFIN_CONTA_DESTINO );'
   +#13#10''
   +#13#10'  /* DEBITO */'
   +#13#10'  PK = GUID20();'
   +#13#10'  INSERT INTO FIN_APAGAR'
   +#13#10'    ( KFIN_APAGAR, KSYS$DOMAIN, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
   +#13#10'  VALUES'
   +#13#10'    ( :PK, :KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || :DOC_ORIGEM, NULL, ''FIN_TRANSFERENCIAS'', :KFIN_TRANSFERENCIA, :OBS);'
   +#13#10''
   +#13#10'  INSERT INTO FIN_APAGAR_PARCELAS'
   +#13#10'    ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
   +#13#10'  VALUES'
   +#13#10'    ( GUID20(), :PK, ''TC'' || :DOC_ORIGEM, :DATA, :VALOR, :DATA, :DATA, :VALOR, :KFIN_CONTA_ORIGEM );'
   +#13#10'END' ;

   _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS =
          'CREATE OR ALTER PROCEDURE SYS$COPY_PLANOCONTAS ('
   +#13#10'    PKSYS$DOMAIN TYPE OF SYS$FKGUID20_NN,'
   +#13#10'    FROM_TIPO SYS$INT = -3,'
   +#13#10'    TO_TIPO SYS$INT = 1)'
   +#13#10'AS'
   +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
   +#13#10'  DECLARE KEQV_PLANOCONTA      SYS$FKGUID20 ;'
   +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
   +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
   +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
   +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
   +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
   +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
   +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
   +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
   +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
   +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
   +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
   +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
   +#13#10'  DECLARE SYS$DU               SYS$DATE;'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  FOR WITH RECURSIVE PLM'
   +#13#10'  AS ('
   +#13#10'  SELECT'
   +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
   +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
   +#13#10'  FROM FIN_PLANOCONTAS'
   +#13#10'  WHERE KMDEF_PLANOCONTA IS NULL'
   +#13#10'     AND TIPO_PLANOCONTAS = :FROM_TIPO'
   +#13#10'   UNION ALL'
   +#13#10'   SELECT'
   +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
   +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
   +#13#10'     FROM FIN_PLANOCONTAS PL'
   +#13#10'     JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'
   +#13#10'     WHERE PL.TIPO_PLANOCONTAS = :FROM_TIPO'
   +#13#10'    )'
   +#13#10'    SELECT'
   +#13#10'     KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
   +#13#10'     ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'     TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
   +#13#10'    FROM PLM'
   +#13#10'  INTO KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
   +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
   +#13#10'  DO'
   +#13#10'    BEGIN'
   +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
   +#13#10'          KMFIN_PLANOCONTA = NULL ;'
   +#13#10'       ELSE'
   +#13#10'          BEGIN'
   +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
   +#13#10'            WHERE KSYS$DOMAIN = :pKSYS$DOMAIN'
   +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA AND TIPO_PLANOCONTAS = :TO_TIPO'
   +#13#10'            INTO KMFIN_PLANOCONTA ;'
   +#13#10'          END'
   +#13#10''
   +#13#10'       IF ( NOT EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
   +#13#10'                    WHERE KSYS$DOMAIN      = :pKSYS$DOMAIN'
   +#13#10'                      AND KDEF_PLANOCONTA   = :KDEF_PLANOCONTA'
   +#13#10'                      AND TIPO_PLANOCONTAS  = :TO_TIPO ) ) THEN'
   +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KSYS$DOMAIN, TIPO_PLANOCONTAS,'
   +#13#10'                CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
   +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
   +#13#10'           VALUES ( Guid20(), :pKSYS$DOMAIN, :TO_TIPO,'
   +#13#10'                :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA, :KEQV_PLANOCONTA,'
   +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
   +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
   +#13#10''
   +#13#10'    END'
   +#13#10''
   +#13#10'END' ;

   _ALTER_PROCEDURE_SYS_INIT =
          'CREATE OR ALTER PROCEDURE SYS$INIT'
   +#13#10'AS'
   +#13#10'DECLARE KSYS$DOMAIN TYPE OF SYS$FKGUID20_NN ;'
   +#13#10'BEGIN'
   +#13#10'   EXECUTE PROCEDURE SYS$INIT_TYPES ;'
   +#13#10'   EXECUTE PROCEDURE SYS$INIT_BANCOS ;'
   +#13#10''
   +#13#10'   FOR SELECT KCAD_FAZENDA FROM CAD_FAZENDAS INTO :KSYS$DOMAIN'
   +#13#10'   DO'
   +#13#10'     BEGIN'
   +#13#10'      EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS KSYS$DOMAIN ;'
   +#13#10'      EXECUTE PROCEDURE SYS$INIT_CENTROSCUSTO KSYS$DOMAIN ;'
   +#13#10'     END'
   +#13#10'END' ;

   _ALTER_PROCEDURE_SYS_INIT_CENTROSCUSTO =
          'CREATE OR ALTER PROCEDURE SYS$INIT_CENTROSCUSTO ('
   +#13#10'    PKSYS$DOMAIN TYPE OF SYS$FKGUID20_NN)'
   +#13#10'AS'
   +#13#10'  DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
   +#13#10'  DECLARE CODIGO               SYS$INT ;'
   +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
   +#13#10'  DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
   +#13#10'  DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
   +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
   +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
   +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
   +#13#10'  DECLARE SYS$DU               SYS$DATE;'
   +#13#10'  DECLARE PATH VARCHAR( 256 );'
   +#13#10'  DECLARE LF_ char;'
   +#13#10'BEGIN'
   +#13#10'  LF_ = ASCII_CHAR(10) ;'
   +#13#10''
   +#13#10'  IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO) ) THEN'
   +#13#10'    EXIT ;'
   +#13#10''
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
   +#13#10''
   +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
   +#13#10'    EXIT ;'
   +#13#10''
   +#13#10'  FOR EXECUTE STATEMENT ('
   +#13#10'            ''WITH RECURSIVE CCM'''
   +#13#10'     ||LF_||''AS ('''
   +#13#10'     ||LF_||'' SELECT'''
   +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
   +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'     ||LF_||'' FROM DEF_CENTROSCUSTO'''
   +#13#10'     ||LF_||'' WHERE KMDEF_CENTROCUSTO IS NULL'''
   +#13#10'     ||LF_||'' UNION ALL'''
   +#13#10'     ||LF_||'' SELECT'''
   +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
   +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'     ||LF_||'' FROM DEF_CENTROSCUSTO CC'''
   +#13#10'     ||LF_||'' JOIN CCM ON CCM.KDEF_CENTROCUSTO = CC.KMDEF_CENTROCUSTO'''
   +#13#10'     ||LF_||'')'''
   +#13#10'     ||LF_||''SELECT'''
   +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
   +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'     ||LF_||''FROM CCM'''
   +#13#10'   ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
   +#13#10'   WITH COMMON TRANSACTION'
   +#13#10'   INTO :KDEF_CENTROCUSTO, :CODIGO, :NOME, :KMDEF_CENTROCUSTO,'
   +#13#10'        :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU'
   +#13#10'  DO'
   +#13#10'    BEGIN'
   +#13#10'       IF ( KMDEF_CENTROCUSTO IS NULL ) THEN'
   +#13#10'          KMFIN_CENTROCUSTO = NULL ;'
   +#13#10'       ELSE'
   +#13#10'          BEGIN'
   +#13#10'            SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
   +#13#10'            WHERE KSYS$DOMAIN = :pKSYS$DOMAIN AND KDEF_CENTROCUSTO = :KMDEF_CENTROCUSTO'
   +#13#10'            INTO KMFIN_CENTROCUSTO ;'
   +#13#10'          END'
   +#13#10''
   +#13#10'       IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO WHERE KSYS$DOMAIN = :pKSYS$DOMAIN AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO ) ) THEN'
   +#13#10'          UPDATE FIN_CENTROSCUSTO'
   +#13#10'          SET'
   +#13#10'              CODIGO           = :CODIGO,'
   +#13#10'              NOME             = :NOME,'
   +#13#10'              KMFIN_CENTROCUSTO = :KMFIN_CENTROCUSTO,'
   +#13#10'              ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
   +#13#10'              CLASSIFICACAO       = :CLASSIFICACAO,'
   +#13#10'              ATIVO               = :ATIVO,'
   +#13#10'              SYS$DU              = :SYS$DU'
   +#13#10'           WHERE ( KSYS$DOMAIN = :pKSYS$DOMAIN  AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO )'
   +#13#10'            AND ( KDEF_CENTROCUSTO <> ''RA9e#LZO^m^Q?jN2OV5O'' )'
   +#13#10'            AND ( KDEF_CENTROCUSTO <> ''La;m;0+smOQ+4RnK^6as'' )'
   +#13#10'            AND (   (SYS$DU IS NULL)'
   +#13#10'                 OR (SYS$DU < :SYS$DU)'
   +#13#10'                 OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
   +#13#10'                 OR ( NOME                IS DISTINCT FROM  :NOME )'
   +#13#10'                 OR ( KMFIN_CENTROCUSTO   IS DISTINCT FROM  :KMFIN_CENTROCUSTO )'
   +#13#10'                 OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
   +#13#10'                 OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
   +#13#10'                 OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
   +#13#10'              ) ;'
   +#13#10'       ELSE'
   +#13#10'         BEGIN'
   +#13#10'           INSERT INTO FIN_CENTROSCUSTO ('
   +#13#10'              KFIN_CENTROCUSTO, KSYS$DOMAIN, CODIGO, NOME, KMFIN_CENTROCUSTO, KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
   +#13#10'              ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU )'
   +#13#10'           VALUES ( Guid20(), :pKSYS$DOMAIN, :CODIGO, :NOME, :KMFIN_CENTROCUSTO, :KDEF_CENTROCUSTO, :KMDEF_CENTROCUSTO,'
   +#13#10'                :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
   +#13#10''
   +#13#10'         END'
   +#13#10'    END'
   +#13#10''
   +#13#10'  CODIGO = NULL ;'
   +#13#10'  SELECT MAX(CODIGO) FROM FIN_CENTROSCUSTO'
   +#13#10'  INTO CODIGO ;'
   +#13#10''
   +#13#10'  EXECUTE STATEMENT ''ALTER SEQUENCE CODIGO_CENTROS_CUSTO RESTART WITH '' || COALESCE( :CODIGO, 0 ) ;'
   +#13#10''
   +#13#10'END' ;

   _ALTER_PROCEDURE_SYS_INIT_PLANOCONTAS =
          'CREATE OR ALTER PROCEDURE SYS$INIT_PLANOCONTAS ('
   +#13#10'    PKSYS$DOMAIN TYPE OF SYS$FKGUID20_NN)'
   +#13#10'AS'
   +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
   +#13#10'  DECLARE TIPO_PLANOCONTAS     SYS$INT_NN ;'
   +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
   +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
   +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
   +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
   +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
   +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
   +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
   +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
   +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
   +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
   +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
   +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
   +#13#10'  DECLARE SYS$DU               SYS$DATE;'
   +#13#10'  DECLARE PATH VARCHAR( 256 );'
   +#13#10'  DECLARE LF_ char;'
   +#13#10''
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  LF_ = ASCII_CHAR(10) ;'
   +#13#10''
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
   +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
   +#13#10''
   +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
   +#13#10'    EXIT ;'
   +#13#10''
   +#13#10'  FOR EXECUTE STATEMENT ('
   +#13#10'              ''WITH RECURSIVE PLM'''
   +#13#10'       ||LF_||''AS ('''
   +#13#10'       ||LF_||'' SELECT'''
   +#13#10'       ||LF_||''  KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
   +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
   +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS'''
   +#13#10'       ||LF_||'' WHERE KMDEF_PLANOCONTA IS NULL'''
   +#13#10'       ||LF_||'' UNION ALL'''
   +#13#10'       ||LF_||'' SELECT'''
   +#13#10'       ||LF_||''  KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
   +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
   +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS PL'''
   +#13#10'       ||LF_||'' JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'''
   +#13#10'       ||LF_||'')'''
   +#13#10'       ||LF_||''SELECT'''
   +#13#10'       ||LF_||'' KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
   +#13#10'       ||LF_||'' ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
   +#13#10'       ||LF_||'' TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
   +#13#10'       ||LF_||''FROM PLM'''
   +#13#10'  ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
   +#13#10'  WITH COMMON TRANSACTION'
   +#13#10'  INTO KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'
   +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
   +#13#10'  DO'
   +#13#10'    BEGIN'
   +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
   +#13#10'          KMFIN_PLANOCONTA = NULL ;'
   +#13#10'       ELSE'
   +#13#10'          BEGIN'
   +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
   +#13#10'            WHERE KSYS$DOMAIN = :pKSYS$DOMAIN'
   +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA'
   +#13#10'              AND TIPO_PLANOCONTAS = :TIPO_PLANOCONTAS'
   +#13#10'            INTO KMFIN_PLANOCONTA ;'
   +#13#10'          END'
   +#13#10''
   +#13#10'       IF ( EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
   +#13#10'                    WHERE KSYS$DOMAIN     = :pKSYS$DOMAIN'
   +#13#10'                      AND KDEF_PLANOCONTA  = :KDEF_PLANOCONTA'
   +#13#10'                      AND TIPO_PLANOCONTAS < 0 ) ) THEN'
   +#13#10'          UPDATE FIN_PLANOCONTAS'
   +#13#10'          SET'
   +#13#10'              TIPO_PLANOCONTAS    = :TIPO_PLANOCONTAS,'
   +#13#10'              CODIGO              = :CODIGO,'
   +#13#10'              NOME                = :NOME,'
   +#13#10'              KMFIN_PLANOCONTA    = :KMFIN_PLANOCONTA,'
   +#13#10'              ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
   +#13#10'              DEVEDORA_CREDORA    = :DEVEDORA_CREDORA,'
   +#13#10'              FLUXOCAIXA          = :FLUXOCAIXA,'
   +#13#10'              TIPO_APRD           = :TIPO_APRD  ,'
   +#13#10'              FIXA_VARIAVEL       = :FIXA_VARIAVEL,'
   +#13#10'              MOVIMENTA_ESTOQUE   = :MOVIMENTA_ESTOQUE,'
   +#13#10'              CLASSIFICACAO       = :CLASSIFICACAO,'
   +#13#10'              ATIVO               = :ATIVO,'
   +#13#10'              SYS$DU              = :SYS$DU'
   +#13#10'           WHERE'
   +#13#10'                ( KSYS$DOMAIN = :pKSYS$DOMAIN )'
   +#13#10'            AND ( KDEF_PLANOCONTA = :KDEF_PLANOCONTA )'
   +#13#10'            AND ( TIPO_PLANOCONTAS < 0 )'
   +#13#10'            AND (   (SYS$DU IS NULL)'
   +#13#10'                 OR (SYS$DU < :SYS$DU)'
   +#13#10'                 OR ( TIPO_PLANOCONTAS    IS DISTINCT FROM  :TIPO_PLANOCONTAS )'
   +#13#10'                 OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
   +#13#10'                 OR ( NOME                IS DISTINCT FROM  :NOME )'
   +#13#10'                 OR ( KMFIN_PLANOCONTA    IS DISTINCT FROM  :KMFIN_PLANOCONTA )'
   +#13#10'                 OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
   +#13#10'                 OR ( DEVEDORA_CREDORA    IS DISTINCT FROM  :DEVEDORA_CREDORA )'
   +#13#10'                 OR ( FLUXOCAIXA          IS DISTINCT FROM  :FLUXOCAIXA )'
   +#13#10'                 OR ( TIPO_APRD           IS DISTINCT FROM  :TIPO_APRD )'
   +#13#10'                 OR ( FIXA_VARIAVEL       IS DISTINCT FROM  :FIXA_VARIAVEL )'
   +#13#10'                 OR ( MOVIMENTA_ESTOQUE   IS DISTINCT FROM  :MOVIMENTA_ESTOQUE )'
   +#13#10'                 OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
   +#13#10'                 OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
   +#13#10'                 ) ;'
   +#13#10'       ELSE'
   +#13#10'         BEGIN'
   +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KSYS$DOMAIN, TIPO_PLANOCONTAS, CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA,'
   +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
   +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
   +#13#10'           VALUES ( Guid20(), :pKSYS$DOMAIN, :TIPO_PLANOCONTAS, :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA,'
   +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
   +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
   +#13#10''
   +#13#10'         END'
   +#13#10'    END'
   +#13#10''
   +#13#10'END' ;
begin
   ExecuteDirect( _ALTER_TRIGGER_CAD_PATRIMONIOS_BIUD0        ) ;
   ExecuteDirect( _ALTER_TRIGGER_VND_PEDIDO_ITENS_AIUD0       ) ;
   ExecuteDirect( _ALTER_PROCEDURE_FIN_INSERT_CREDITODEBITO   ) ;
   ExecuteDirect( _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS       ) ;
   ExecuteDirect( _ALTER_PROCEDURE_SYS_INIT                   ) ;
   ExecuteDirect( _ALTER_PROCEDURE_SYS_INIT_CENTROSCUSTO      ) ;
   ExecuteDirect( _ALTER_PROCEDURE_SYS_INIT_PLANOCONTAS       ) ;
end ;


procedure TDBFinanceiroUpdate._5_002_36 ;
const
   _ALTER_TRIGGER_CAD_TIPOS_DOMAIN =
          'CREATE OR ALTER TRIGGER CAD_TIPOS_DOMAIN FOR CAD_TIPOS'
   +#13#10'ACTIVE BEFORE INSERT POSITION 1002'
   +#13#10'AS'
   +#13#10'BEGIN'
   +#13#10'  IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
   +#13#10'END' ;
begin
   ExecuteDirect( _ALTER_TRIGGER_CAD_TIPOS_DOMAIN ) ;
end ;

procedure TDBFinanceiroUpdate._5_002_35 ;
const
  _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS =
         'CREATE OR ALTER PROCEDURE SYS$COPY_PLANOCONTAS ('
  +#13#10'    PKCAD_FAZENDA TYPE OF SYS$FKGUID20_NN,'
  +#13#10'    FROM_TIPO SYS$INT = -3,'
  +#13#10'    TO_TIPO SYS$INT = 1)'
  +#13#10'AS'
  +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE KEQV_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
  +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
  +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
  +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
  +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
  +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
  +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'  DECLARE SYS$DU               SYS$DATE;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  FOR WITH RECURSIVE PLM'
  +#13#10'  AS ('
  +#13#10'  SELECT'
  +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  FROM FIN_PLANOCONTAS'
  +#13#10'  WHERE KMDEF_PLANOCONTA IS NULL'
  +#13#10'     AND TIPO_PLANOCONTAS = :FROM_TIPO'
  +#13#10'   UNION ALL'
  +#13#10'   SELECT'
  +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'     FROM FIN_PLANOCONTAS PL'
  +#13#10'     JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'
  +#13#10'     WHERE PL.TIPO_PLANOCONTAS = :FROM_TIPO'
  +#13#10'    )'
  +#13#10'    SELECT'
  +#13#10'     KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'     ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'     TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'    FROM PLM'
  +#13#10'  INTO KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
  +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
  +#13#10'          KMFIN_PLANOCONTA = NULL ;'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
  +#13#10'            WHERE KCAD_FAZENDA = :pKCAD_FAZENDA'
  +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA AND TIPO_PLANOCONTAS = :TO_TIPO'
  +#13#10'            INTO KMFIN_PLANOCONTA ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'       IF ( NOT EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
  +#13#10'                    WHERE KCAD_FAZENDA      = :pKCAD_FAZENDA'
  +#13#10'                      AND KDEF_PLANOCONTA   = :KDEF_PLANOCONTA'
  +#13#10'                      AND TIPO_PLANOCONTAS  = :TO_TIPO ) ) THEN'
  +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KCAD_FAZENDA, TIPO_PLANOCONTAS,'
  +#13#10'                CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
  +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
  +#13#10'           VALUES ( Guid20(), :pKCAD_FAZENDA, :TO_TIPO,'
  +#13#10'                :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA, :KEQV_PLANOCONTA,'
  +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
  +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'END';

begin
  TryExecuteDirect( _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS );
end;

procedure TDBFinanceiroUpdate._5_002_34;
const
  _UPDATE_SEQUENCE_TIPO_PLANOCONTAS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'  DECLARE TIPO_PLANOCONTA  SYS$INT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'    SELECT GEN_ID( TIPO_PLANOCONTAS, 0 ) AS RESULT FROM RDB$DATABASE'
  +#13#10'    INTO'
  +#13#10'      :TIPO_PLANOCONTA;'
  +#13#10''
  +#13#10'    if (:TIPO_PLANOCONTA <= 0 AND :TIPO_PLANOCONTA <> -2) then'
  +#13#10'     BEGIN'
  +#13#10'      EXECUTE STATEMENT ''ALTER SEQUENCE TIPO_PLANOCONTAS RESTART WITH -3'';'
  +#13#10'     END'
  +#13#10''
  +#13#10'END';

begin
  ExecuteDirect( _UPDATE_SEQUENCE_TIPO_PLANOCONTAS );
end;



procedure TDBFinanceiroUpdate._5_002_33;
const

  _ALTER_PROCEDURE_EST_CHECK_SALDOINICIAL_EM =
         'CREATE OR ALTER PROCEDURE EST_CHECK_SALDOINICIAL_EM ('
  +#13#10'    KSYS$DOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE)'
  +#13#10'AS'
  +#13#10'DECLARE DATA_SALDOINICIAL SYS$DATE = NULL ;'
  +#13#10'DECLARE NOME SYS$DESCR = NULL ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_SALDOINICIAL_EM$OFF'' ) = ''1'' ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NULL ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  SELECT NOME, CAST ( DATA_SALDOINICIAL AS DATE )'
  +#13#10'  FROM EST_PRODUTOS'
  +#13#10'  WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'  INTO NOME, DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'  IF ( DATA_SALDOINICIAL IS NULL ) THEN'
  +#13#10'     EXCEPTION SYS$EXCEPTION ''Produto não cadastrado.''  ;'
  +#13#10''
  +#13#10'  IF ( DATA_SALDOINICIAL > CAST ( DATA AS DATE ) ) THEN'
  +#13#10'       EXCEPTION SYS$EXCEPTION ''Produto "'' || NOME || ''" não tem saldo inicial na data ('' || DATA || '').''  ;'
  +#13#10''
  +#13#10'END' ;


  _ALTER_TABLE_FIN_PLANOCONTAS_ADD_KFIN_PLANOCONTA_DEPARA =
         'ALTER TABLE FIN_PLANOCONTAS'
  +#13#10'ADD KFIN_PLANOCONTA_DEPARA SYS$FKGUID20'
  +#13#10', ALTER KFIN_PLANOCONTA_DEPARA POSITION 20';

  _UPDATE_KFIN_PLANOCONTA_DEPARA =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'  DECLARE KFIN_PLANOCONTA        SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_PLANOCONTA_DEPARA SYS$FKGUID20 ;'
  +#13#10'  DECLARE KDEF_PLANOCONTA        SYS$FKGUID20 ;'
  +#13#10'  DECLARE KDEF_PLANOCONTA_DEPARA SYS$FKGUID20 ;'
  +#13#10''
  +#13#10'  DECLARE PATH VARCHAR( 256 );'
  +#13#10'  DECLARE LF_ char;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  LF_ = ASCII_CHAR(10) ;'
  +#13#10''
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10''
  +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'    SELECT'
  +#13#10'      KFIN_PLANOCONTA,'
  +#13#10'      KDEF_PLANOCONTA'
  +#13#10'    FROM FIN_PLANOCONTAS'
  +#13#10'    WHERE TIPO_PLANOCONTAS = -3'
  +#13#10'    INTO'
  +#13#10'      :KFIN_PLANOCONTA,'
  +#13#10'      :KDEF_PLANOCONTA'
  +#13#10'  DO'
  +#13#10'  BEGIN'
  +#13#10'     EXECUTE STATEMENT('
  +#13#10'              ''SELECT KDEF_PLANOCONTA_DEPARA'''
  +#13#10'       ||LF_||''  FROM DEF_PLANOCONTAS'''
  +#13#10'       ||LF_||'' WHERE KDEF_PLANOCONTA = ''''''|| :KDEF_PLANOCONTA  ||'''''''''
  +#13#10'     ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
  +#13#10'     INTO :KDEF_PLANOCONTA_DEPARA;'
  +#13#10''
  +#13#10'     if (:KDEF_PLANOCONTA_DEPARA IS NOT NULL)  then'
  +#13#10'     BEGIN'
  +#13#10'        FOR SELECT KFIN_PLANOCONTA'
  +#13#10'          FROM FIN_PLANOCONTAS'
  +#13#10'         WHERE KDEF_PLANOCONTA = :KDEF_PLANOCONTA_DEPARA'
  +#13#10'           AND TIPO_PLANOCONTAS = -1'
  +#13#10'         INTO :KFIN_PLANOCONTA_DEPARA'
  +#13#10'         DO'
  +#13#10'         IF (:KFIN_PLANOCONTA_DEPARA IS NOT NULL)  THEN'
  +#13#10'            UPDATE FIN_PLANOCONTAS'
  +#13#10'             SET'
  +#13#10'                  KFIN_PLANOCONTA_DEPARA = :KFIN_PLANOCONTA_DEPARA'
  +#13#10'             WHERE'
  +#13#10'                  KFIN_PLANOCONTA = :KFIN_PLANOCONTA;'
  +#13#10'     END'
  +#13#10'  END'
  +#13#10''
  +#13#10'END';

  _UPDATE_PLANOCONTAS_MOVIMENTOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'  DECLARE KFIN_PLANOCONTA        SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_PLANOCONTA_DEPARA SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_SALDOINICIAL_EM$OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'    SELECT'
  +#13#10'      KFIN_PLANOCONTA,'
  +#13#10'      KFIN_PLANOCONTA_DEPARA'
  +#13#10'    FROM FIN_PLANOCONTAS'
  +#13#10'    WHERE TIPO_PLANOCONTAS = -3'
  +#13#10'      AND KFIN_PLANOCONTA_DEPARA IS NOT NULL'
  +#13#10'    INTO'
  +#13#10'      :KFIN_PLANOCONTA,'
  +#13#10'      :KFIN_PLANOCONTA_DEPARA'
  +#13#10'  DO'
  +#13#10'  BEGIN'
  +#13#10''
  +#13#10'      UPDATE VND_PEDIDO_SERVICOS         SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE VND_PEDIDO_ITENS            SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_FINANCIAMENTOS_PARCELAS SET KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_FINANCIAMENTOS_GERAL    SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_FINANCIAMENTOS          SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_ARECEBER_PARCELAS       SET KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_ARECEBER                SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_APAGAR_PARCELAS         SET KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE FIN_APAGAR                  SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE EST_PRODUTOS                SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE EST_OUTRAS_ENTRADAS_SAIDAS  SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE DEV_PEDIDO_ITENS            SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE CMP_PEDIDO_SERVICOS         SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE CMP_PEDIDO_ITENS            SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE CAD_PATRIMONIOS             SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10'      UPDATE CAD_ENTIDADES               SET KFIN_PLANOCONTA               = :KFIN_PLANOCONTA WHERE KFIN_PLANOCONTA               = :KFIN_PLANOCONTA_DEPARA ;'
  +#13#10''
  +#13#10''
  +#13#10'  END'
  +#13#10''
  +#13#10'END';

   {$IFDEF _EXPORT}
   procedure InsertPlanoDeContas ;
   var
     LPlanoDeContas : TStringList ;
     &String : string ;
   begin

     LPlanoDeContas := TStringList.Create ;
     LoadResourceStrings ('SQL_UPDATE_PLANOCONTAS_EXPORT', LPlanoDeContas );
     for &String in  LPlanoDeContas do
        if &String <> '' then
           ExecuteDirect ( &String ) ;
     LPlanoDeContas.DisposeOf ;
   end ;
   {$ENDIF _EXPORT}

var
  LEncerramentoMensal : IEncerramentoMensal ;
begin
  TryExecuteDirect( _ALTER_PROCEDURE_EST_CHECK_SALDOINICIAL_EM );

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;
  TryExecuteDirect( _ALTER_TABLE_FIN_PLANOCONTAS_ADD_KFIN_PLANOCONTA_DEPARA );
  {$IFDEF _EXPORT}
  InsertPlanoDeContas ;
  {$ENDIF _EXPORT}
  ExecuteDirect( _UPDATE_KFIN_PLANOCONTA_DEPARA );
  ExecuteDirect( _UPDATE_PLANOCONTAS_MOVIMENTOS );
end;


procedure TDBFinanceiroUpdate._5_002_29;
const
        _CREATE_OR_ALTER_PROCEDURE_ORDER_CLASSIFICACAO =
           'CREATE OR ALTER PROCEDURE ORDER_CLASSIFICACAO ('
    +#13#10'    CLASSIFICACAO SYS$CODE)'
    +#13#10'RETURNS ('
    +#13#10'    RESULT SYS$CODE)'
    +#13#10'AS'
    +#13#10'DECLARE TMP SYS$CODE ;'
    +#13#10'BEGIN'
    +#13#10'  RESULT = '''' ;'
    +#13#10'  FOR SELECT STRINGITEM FROM SYS$SPLIT( ''.'', :CLASSIFICACAO )'
    +#13#10'  INTO TMP'
    +#13#10'  DO'
    +#13#10'    RESULT = SUBSTRING ( RESULT || RIGHT( ''00'' || TMP, 3 ) FROM 1 FOR 32 );'
    +#13#10'  SUSPEND ;'
    +#13#10'END' ;


begin
  TryExecuteDirect( _CREATE_OR_ALTER_PROCEDURE_ORDER_CLASSIFICACAO );
end;


procedure TDBFinanceiroUpdate._5_002_28;
const
  _ALTER_TABLE_FRISIA_NOTASFISCAIS =
         'ALTER TABLE FRISIA_NOTASFISCAIS'
  +#13#10'ADD CD_CONTRATO2 SYS$CODE';

begin
  TryExecuteDirect( _ALTER_TABLE_FRISIA_NOTASFISCAIS );
end;


procedure TDBFinanceiroUpdate._5_002_26;
const
  _UPDATE_CUSTO_DEVOLUCAO =
             'EXECUTE BLOCK'
      +#13#10'AS'
      +#13#10'DECLARE KDEV_PEDIDO_ITEM SYS$FKGUID20;'
      +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20;'
      +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20;'
      +#13#10'DECLARE QTDE SYS$FLOAT_NN_0;'
      +#13#10'DECLARE VALOR_UNITARIO SYS$FLOAT_NN_0;'
      +#13#10'DECLARE DESCONTO SYS$FLOAT_NN_0 ;'
      +#13#10'DECLARE FRETE SYS$FLOAT_NN_0;'
      +#13#10'DECLARE TOTAL SYS$FLOAT_NN_0;'
      +#13#10'DECLARE CUSTO SYS$FLOAT_NN_0;'
      +#13#10'DECLARE DATA_COMPRA SYS$DATE_NN;'
      +#13#10'BEGIN'
      +#13#10'  FOR'
      +#13#10'    SELECT DI.KDEV_PEDIDO_ITEM,'
      +#13#10'           DI.KEST_PRODUTO,'
      +#13#10'           P.KSYS$DOMAIN,'
      +#13#10'           DV.DATA_COMPRA,'
      +#13#10'           DI.VALOR_UNITARIO,'
      +#13#10'           DI.QTDE,'
      +#13#10'           DI.DESCONTO,'
      +#13#10'           DI.FRETE,'
      +#13#10'           DI.CUSTO,'
      +#13#10'           DI.TOTAL'
      +#13#10'      FROM DEV_PEDIDO_ITENS DI'
      +#13#10'      INNER JOIN DEV_PEDIDOS DV ON DI.KDEV_PEDIDO = DV.KDEV_PEDIDO'
      +#13#10'      INNER JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = DI.KEST_PRODUTO'
      +#13#10'      ORDER BY DV.DATA_COMPRA'
      +#13#10'     INTO :KDEV_PEDIDO_ITEM, :KEST_PRODUTO, :KSYS$DOMAIN, :DATA_COMPRA,'
      +#13#10'          :VALOR_UNITARIO, :QTDE, :DESCONTO, :FRETE, :CUSTO, :TOTAL'
      +#13#10'     DO'
      +#13#10'     BEGIN'
      +#13#10'       IF (:CUSTO <> ( (:VALOR_UNITARIO * :QTDE - :DESCONTO) / :QTDE )) THEN'
      +#13#10'        BEGIN'
      +#13#10''
      +#13#10'          CUSTO = ( (:VALOR_UNITARIO * :QTDE - :DESCONTO) / :QTDE );'
      +#13#10''
      +#13#10'          UPDATE DEV_PEDIDO_ITENS'
      +#13#10'             SET CUSTO = :CUSTO'
      +#13#10'           WHERE KDEV_PEDIDO_ITEM = :KDEV_PEDIDO_ITEM;'
      +#13#10''
      +#13#10'        END'
      +#13#10''
      +#13#10'       EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( :KSYS$DOMAIN, :KEST_PRODUTO , :DATA_COMPRA );'
      +#13#10''
      +#13#10'     END'
      +#13#10'END';

var
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;
  ExecuteDirect( _UPDATE_CUSTO_DEVOLUCAO );

end;


procedure TDBFinanceiroUpdate._5_002_25 ;
const
   _EXCLUIR_FINANCIAMENTO_ADIANTAMENTO_PRODUCAO_DE_LEITE =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'  DECLARE KFIN_FINANCIAMENTO           SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_ARECEBER_FINANCIAMENTO  SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_APAGAR_AMORTIZACAO      SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_APAGAR_JUROS            SYS$FKGUID20 ;'
  +#13#10'  DECLARE KFIN_APAGAR_DESPESAS         SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'    KFIN_FINANCIAMENTO'
  +#13#10'  , KFIN_ARECEBER_FINANCIAMENTO'
  +#13#10'  , KFIN_APAGAR_AMORTIZACAO'
  +#13#10'  , KFIN_APAGAR_JUROS'
  +#13#10'  , KFIN_APAGAR_DESPESAS'
  +#13#10'  FROM FIN_FINANCIAMENTOS'
  +#13#10'  WHERE'
  +#13#10'    HISTORICO = ''ADIANTAMENTO PRODUCAO DE LEITE REF PAGAMENTO COMPLEMENTAR - 05/2018'''
  +#13#10'  INTO'
  +#13#10'    KFIN_FINANCIAMENTO'
  +#13#10'  , KFIN_ARECEBER_FINANCIAMENTO'
  +#13#10'  , KFIN_APAGAR_AMORTIZACAO'
  +#13#10'  , KFIN_APAGAR_JUROS'
  +#13#10'  , KFIN_APAGAR_DESPESAS'
  +#13#10'  DO'
  +#13#10'   BEGIN'
  +#13#10''
  +#13#10'     DELETE FROM'
  +#13#10'       FIN_ARECEBER'
  +#13#10'     WHERE'
  +#13#10'       KFIN_ARECEBER = :KFIN_ARECEBER_FINANCIAMENTO ;'
  +#13#10''
  +#13#10'     DELETE FROM'
  +#13#10'       FIN_APAGAR'
  +#13#10'     WHERE'
  +#13#10'       KFIN_APAGAR   = :KFIN_APAGAR_AMORTIZACAO ;'
  +#13#10''
  +#13#10'     DELETE'
  +#13#10'       FROM FIN_APAGAR'
  +#13#10'     WHERE'
  +#13#10'       KFIN_APAGAR   = :KFIN_APAGAR_JUROS ;'
  +#13#10''
  +#13#10'     DELETE FROM'
  +#13#10'       FIN_APAGAR'
  +#13#10'     WHERE'
  +#13#10'       KFIN_APAGAR   = :KFIN_APAGAR_DESPESAS ;'
  +#13#10''
  +#13#10'     DELETE FROM'
  +#13#10'       FIN_FINANCIAMENTOS'
  +#13#10'     WHERE'
  +#13#10'       KFIN_FINANCIAMENTO = :KFIN_FINANCIAMENTO ;'
  +#13#10''
  +#13#10'  END'
  +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
    if Fields[0].asInteger = 0 then
      exit ;

  ExecuteDirect ( _EXCLUIR_FINANCIAMENTO_ADIANTAMENTO_PRODUCAO_DE_LEITE ) ;

end ;

procedure TDBFinanceiroUpdate._5_002_23 ;
const
   _ALTER_VND_FRISIA =
          'EXECUTE BLOCK'
   +#13#10'AS'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  EXECUTE PROCEDURE EST_REABRIR_MESES ;'
   +#13#10''
   +#13#10'  UPDATE VND_PEDIDOS'
   +#13#10'  SET'
   +#13#10'    DATA_VENDA = ''2018.05.31'''
   +#13#10'  WHERE'
   +#13#10'      CAST( DATA_VENDA AS DATE ) = ''2018.06.04'''
   +#13#10'  OR  CAST( DATA_VENDA AS DATE ) = ''2018.06.22'' ;'
   +#13#10''
   +#13#10'  EXECUTE PROCEDURE EST_ENCERRAR_MESES ;'
   +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
    if Fields[0].asInteger = 0 then
      exit ;

  ExecuteDirect ( _ALTER_VND_FRISIA ) ;
end;


procedure TDBFinanceiroUpdate._5_002_22;
const
   _ALTER_TABLE_CAD_PATRIMONIOS =
              'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10'ADD CODIGO_ SYS$CODE'
       +#13#10', ALTER CODIGO_ POSITION 20';

   _CREATE_OR_REPLACE_TRIGGER_CAD_PATRIMONIOS_BIUD0 =
              'CREATE OR ALTER TRIGGER CAD_PATRIMONIOS_BIUD0 FOR CAD_PATRIMONIOS'
       +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
       +#13#10'AS'
       +#13#10'BEGIN'
       +#13#10''
       +#13#10'   IF ( INSERTING OR UPDATING ) THEN'
       +#13#10'      BEGIN'
       +#13#10''
       +#13#10'        IF ( NEW.CODIGO IS NULL ) THEN'
       +#13#10'          SELECT  SEQUENCE_VALUE'
       +#13#10'          FROM  SYS$GET_SEQUENCE( NEW.KCAD_FAZENDA, ''CAD_PATRIMONIOS_CODIGO'' )'
       +#13#10'        INTO NEW.CODIGO ;'
       +#13#10''
       +#13#10'        IF ( NEW.CODIGO_ IS NULL ) THEN'
       +#13#10'          SELECT Right ( ''0000000'' || NEW.CODIGO, 7 )'
       +#13#10'          FROM  RDB$DATABASE'
       +#13#10'        INTO NEW.CODIGO_ ;'
       +#13#10''
       +#13#10'      IF (NEW.DATA_BAIXA IS NOT NULL) THEN'
       +#13#10'         NEW.ATIVO = ''F'';'
       +#13#10'   END'
       +#13#10''
       +#13#10'   IF ( DELETING ) THEN'
       +#13#10'     EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CAD_PATRIMONIOS'', OLD.KCAD_PATRIMONIO ;'
       +#13#10''
       +#13#10''
       +#13#10'END ';

   _UPDATE_CODIGO_PATRIMONIO =
              'EXECUTE BLOCK'
       +#13#10'AS'
       +#13#10'DECLARE CODIGO  SYS$CODE;'
       +#13#10'DECLARE NEW_CODIGO INTEGER;'
       +#13#10'DECLARE KCAD_PATRIMONIO SYS$FKGUID20;'
       +#13#10''
       +#13#10'BEGIN'
       +#13#10'  NEW_CODIGO = 1;'
       +#13#10'  FOR'
       +#13#10'    SELECT P.KCAD_PATRIMONIO, P.CODIGO'
       +#13#10'      FROM CAD_PATRIMONIOS P'
       +#13#10'     ORDER BY P.CODIGO'
       +#13#10'     INTO  :KCAD_PATRIMONIO, :CODIGO'
       +#13#10'  DO'
       +#13#10'  BEGIN'
       +#13#10''
       +#13#10'    UPDATE CAD_PATRIMONIOS'
       +#13#10'       SET CODIGO = CAST(:NEW_CODIGO AS VARCHAR(32)),'
       +#13#10'           CODIGO_ = LPAD(:NEW_CODIGO, 7, ''0'' )'
       +#13#10'     WHERE KCAD_PATRIMONIO = :KCAD_PATRIMONIO;'
       +#13#10''
       +#13#10'    NEW_CODIGO = NEW_CODIGO + 1;'
       +#13#10''
       +#13#10'  END'
       +#13#10''
       +#13#10'END';

   _UPDATE_SEQUENCE_PATRIMONIOS =
              'UPDATE OR INSERT INTO SYS$SEQUENCE (KSYS$DOMAIN, SEQUENCE_NAME, SEQUENCE_VALUE)'
       +#13#10'VALUES (   (SELECT KSYS$DOMAIN FROM SYS$DOMAINS ROWS 1)'
       +#13#10'        ,  ''CAD_PATRIMONIOS_CODIGO'''
       +#13#10'        ,  COALESCE('
       +#13#10'               (SELECT MAX(CAST(CODIGO AS INTEGER)) FROM CAD_PATRIMONIOS)'
       +#13#10'             , 0'
       +#13#10'           )'
       +#13#10'       )'
       +#13#10'MATCHING (KSYS$DOMAIN, SEQUENCE_NAME)'
       ;


begin
   TryExecuteDirect( _ALTER_TABLE_CAD_PATRIMONIOS );
   ExecuteDirect   ( _CREATE_OR_REPLACE_TRIGGER_CAD_PATRIMONIOS_BIUD0 );
   ExecuteDirect   ( _UPDATE_CODIGO_PATRIMONIO );
   ExecuteDirect   ( _UPDATE_SEQUENCE_PATRIMONIOS );
end;

procedure TDBFinanceiroUpdate._5_002_21;
const
   _ALTER_TABLE_CAD_PATRIMONIOS =
              'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10' ALTER KCAD_UNIDADE TYPE SYS$FKGUID20' ;
begin
  ExecuteDirect ( _ALTER_TABLE_CAD_PATRIMONIOS ) ;
end ;

procedure TDBFinanceiroUpdate._5_002_19 ;
const
    _ALTER_TIPOS_CONTA_FRISIA =
           'EXECUTE BLOCK'
    +#13#10'AS'
    +#13#10'BEGIN'
    +#13#10'  UPDATE FRISIA_TIPOSCONTA'
    +#13#10'   SET DESCRICAO = ''Pecuária de leite'''
    +#13#10'  WHERE KFRISIA_TIPOCONTA = 0 ;'
    +#13#10''
    +#13#10'  UPDATE FRISIA_TIPOSCONTA'
    +#13#10'   SET DESCRICAO = ''Extra atividade'''
    +#13#10'  WHERE KFRISIA_TIPOCONTA = 24 ;'
    +#13#10''
    +#13#10'  UPDATE FRISIA_TIPOSCONTA'
    +#13#10'   SET DESCRICAO = ''Outras contas'''
    +#13#10'  WHERE KFRISIA_TIPOCONTA = 999 ;'
    +#13#10'END' ;
begin
  TryExecuteDirect( _ALTER_TIPOS_CONTA_FRISIA ) ;
end;



procedure TDBFinanceiroUpdate._5_002_18;
const
    _ALTER_TABLE_VND_PEDIDOS =
           'ALTER TABLE VND_PEDIDOS'
    +#13#10'  ADD VALOR_DEDUCOES SYS$FLOAT_NN_0'
    +#13#10', ALTER VALOR_DEDUCOES POSITION 18' ;
begin
  TryExecuteDirect( _ALTER_TABLE_VND_PEDIDOS ) ;
end;

procedure TDBFinanceiroUpdate._5_002_17;
const
    _ALTER_TABLE_FIN_APAGAR =
          'ALTER TABLE FIN_APAGAR'
   +#13#10'  ADD ANUAL SYS$BOOL_F'
   +#13#10', ALTER ANUAL POSITION 15' ;

   _ALTER_TABLE_FIN_ARECEBER =
          'ALTER TABLE FIN_ARECEBER'
   +#13#10'  ADD ANUAL SYS$BOOL_F'
   +#13#10', ALTER ANUAL POSITION 15'  ;

   _ALTER_TABLE_FIN_FINANCIAMENTOS_GERAL =
          'ALTER TABLE FIN_FINANCIAMENTOS_GERAL'
   +#13#10'  ADD ANUAL SYS$BOOL_F'
   +#13#10', ALTER ANUAL POSITION 17'  ;
begin
   TryExecuteDirect ( _ALTER_TABLE_FIN_APAGAR ) ;
   TryExecuteDirect ( _ALTER_TABLE_FIN_ARECEBER ) ;
   TryExecuteDirect ( _ALTER_TABLE_FIN_FINANCIAMENTOS_GERAL ) ;
end;

procedure TDBFinanceiroUpdate._5_002_16;
const
 _UPDATE_NOMES_CONTAS_FRISIA =
          'EXECUTE BLOCK'
   +#13#10'AS'
   +#13#10'DECLARE KFIN_CONTA SYS$FKGUID20 ;'
   +#13#10'DECLARE NOME FIN$DESCCONTA ;'
   +#13#10'BEGIN'
   +#13#10' FOR SELECT'
   +#13#10'  FC.KFIN_CONTA,'
   +#13#10'  TRIM ('
   +#13#10'    CASE FC.KFRISIA_TIPOCONTA'
   +#13#10'     WHEN  0  THEN ''Pecuária de leite'''
   +#13#10'     WHEN 24  THEN ''Extra atividade'''
   +#13#10'     WHEN 999 THEN ''Outras contas'''
   +#13#10'    END'
   +#13#10'  ) || '' - '' || FM.FRISIA_MATRICULA'
   +#13#10' FROM FRISIA_MATRICULA_CONTAS FC'
   +#13#10' LEFT JOIN FRISIA_MATRICULAS FM'
   +#13#10'   USING ( KFRISIA_MATRICULA )'
   +#13#10' WHERE'
   +#13#10'   FC.KFRISIA_TIPOCONTA in (0,24,999)'
   +#13#10' INTO ::KFIN_CONTA, ::NOME'
   +#13#10' DO'
   +#13#10'   UPDATE FIN_CONTAS'
   +#13#10'     SET'
   +#13#10'       NOME = ::NOME'
   +#13#10'    WHERE'
   +#13#10'      KFIN_CONTA = ::KFIN_CONTA ;'
   +#13#10'END' ;
begin
  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_NOMES_CONTAS_FRISIA )
    .SQLExec ;
end ;

procedure TDBFinanceiroUpdate._5_002_15;
const
 _UPDATE_ARECEBER_DEVOLUCOES =
         'UPDATE FIN_ARECEBER'
  +#13#10'  SET '
  +#13#10'    TABLENAME = ''DEV_PEDIDOS'''
  +#13#10'WHERE KFIN_ARECEBER IN  '
  +#13#10'  (SELECT '
  +#13#10'     KFIN_ARECEBER '
  +#13#10'   FROM FIN_ARECEBER'
  +#13#10'   INNER JOIN DEV_PEDIDOS '
  +#13#10'     USING ( KFIN_ARECEBER )'
  +#13#10'   WHERE '
  +#13#10'     TABLENAME = ''VND_PEDIDOS'''
  +#13#10'  )' ;
begin
  ExecuteDirect ( _UPDATE_ARECEBER_DEVOLUCOES ) ;
end;

procedure TDBFinanceiroUpdate._5_002_14;
const
  _UPDATE_PLANOCONTAS_FINANCIAMENTO =
             'UPDATE FIN_FINANCIAMENTOS'
      +#13#10'   SET KFIN_PLANOCONTA ='
      +#13#10'         (SELECT'
      +#13#10'                 KFIN_PLANOCONTA'
      +#13#10'            FROM FIN_PLANOCONTAS'
      +#13#10'           WHERE'
      +#13#10'                 KDEF_PLANOCONTA = ''Sx|lxs,C,LTC22`}@T[@'''
      +#13#10'             AND TIPO_PLANOCONTAS = COALESCE ( NULLIF( GEN_ID( TIPO_PLANOCONTAS, 0), 0 ), -1 )'
      +#13#10'           )'
      +#13#10' WHERE (KFIN_PLANOCONTA IS NULL or KFIN_PLANOCONTA = '''')'
      ;

  _INSERT_APROPRIACAO_JUROS_FINANCIAMENTO =
             'INSERT INTO FIN_APROPRIACAO (KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM)'
      +#13#10'SELECT GUID20() KFIN_APROPRIACAO,'
      +#13#10'       ''FIN_FINANCIAMENTOS'' TABLENAME,'
      +#13#10'       F.KFIN_FINANCIAMENTO,'
      +#13#10'       AP.KFIN_CENTROCUSTO,'
      +#13#10'       AP.PORCENTAGEM'
      +#13#10'  FROM FIN_FINANCIAMENTOS F'
      +#13#10'  INNER JOIN FIN_APROPRIACAO AP ON AP.TABLEKEY = F.KFIN_APAGAR_JUROS'
      +#13#10' WHERE F.KFIN_FINANCIAMENTO NOT IN (SELECT TABLEKEY FROM FIN_APROPRIACAO WHERE TABLENAME = ''FIN_FINANCIAMENTOS'')'
      ;

  _INSERT_NOVA_APROPRIACAO_FINANCIAMENTO = //Para casos em que não havia apropriação de juros
             'INSERT INTO FIN_APROPRIACAO (KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM)'
      +#13#10'SELECT GUID20() KFIN_APROPRIACAO,'
      +#13#10'       ''FIN_FINANCIAMENTOS'' TABLENAME,'
      +#13#10'       F.KFIN_FINANCIAMENTO,'
      +#13#10'       (SELECT'
      +#13#10'          KFIN_CENTROCUSTO'
      +#13#10'          FROM'
      +#13#10'          FRISIA_TIPOSCONTA'
      +#13#10'         WHERE'
      +#13#10'            KSYS$DOMAIN = %s'
      +#13#10'            AND KFRISIA_TIPOCONTA = F.CONTA_ORIGEM'
      +#13#10'       ) KFIN_CENTROCUSTO,'
      +#13#10'        100.00 "PORCENTAGEM"'
      +#13#10'  FROM FIN_FINANCIAMENTOS F'
      +#13#10' WHERE F.KFIN_FINANCIAMENTO NOT IN (SELECT TABLEKEY FROM FIN_APROPRIACAO WHERE TABLENAME = ''FIN_FINANCIAMENTOS'')'
      ;

  _DELTE_APROPRIACAO_JUROS =
             'DELETE FROM FIN_APROPRIACAO'
      +#13#10' WHERE TABLENAME = ''FIN_APAGAR'''
      +#13#10'   AND TABLEKEY IN ('
      +#13#10'       SELECT F.KFIN_APAGAR_JUROS'
      +#13#10'         FROM FIN_FINANCIAMENTOS F'
      +#13#10'        )'
      ;

 _CREATE_TABLE_EST_PRODUTO_JUNCTION =
        'CREATE TABLE EST_PRODUTO_JUNCTION'
 +#13#10'('
 +#13#10'   KEST_PRODUTO SYS$PKGUID20'
 +#13#10' , KEST_PRODUTO_JUNCTION SYS$FKGUID20'
 +#13#10' , CONSTRAINT PKEST_PRODUTO_JUNCTION'
 +#13#10'     PRIMARY KEY( KEST_PRODUTO )'
 +#13#10' , CONSTRAINT FKEST_PRODUTO_JUNCTION_01'
 +#13#10'     FOREIGN KEY( KEST_PRODUTO )'
 +#13#10'     REFERENCES EST_PRODUTOS'
 +#13#10')' ;

 _CREATE_PROCEDURE_EST_GET_PRODUTO_JUNCTION =
        'CREATE OR ALTER PROCEDURE EST_GET_PRODUTO_JUNCTION ( KEST_PRODUTO SYS$FKGUID20 )'
 +#13#10'RETURNS( KPRODUTO_JUNCTION SYS$FKGUID20 )'
 +#13#10'AS'
 +#13#10'DECLARE CONTINUE_ SYS$INT ;'
 +#13#10'BEGIN'
 +#13#10' CONTINUE_ = 1 ;'
 +#13#10' KPRODUTO_JUNCTION = KEST_PRODUTO ;'
 +#13#10' WHILE ( CONTINUE_ = 1 ) DO'
 +#13#10'   BEGIN'
 +#13#10'     CONTINUE_ = 0 ;'
 +#13#10'     SELECT'
 +#13#10'       KEST_PRODUTO_JUNCTION, 1'
 +#13#10'     FROM EST_PRODUTO_JUNCTION'
 +#13#10'     WHERE KEST_PRODUTO = :KPRODUTO_JUNCTION'
 +#13#10'     INTO KPRODUTO_JUNCTION, CONTINUE_ ;'
 +#13#10'   END'
 +#13#10' SUSPEND ;'
 +#13#10'END' ;

begin
  TryExecuteDirect( _UPDATE_PLANOCONTAS_FINANCIAMENTO );
  TryExecuteDirect( _INSERT_APROPRIACAO_JUROS_FINANCIAMENTO );
  TryExecuteDirect( Format( _INSERT_NOVA_APROPRIACAO_FINANCIAMENTO, [ QuotedStr( LoggedUser.DomainID ) ])  );
  TryExecuteDirect( _DELTE_APROPRIACAO_JUROS );

  TryExecuteDirect ( _CREATE_TABLE_EST_PRODUTO_JUNCTION )  ;
  TryExecuteDirect ( _CREATE_PROCEDURE_EST_GET_PRODUTO_JUNCTION ) ;
end ;



procedure TDBFinanceiroUpdate._5_002_11;
const
  _ALTER_TABLE_FIN_FINANCIAMENTOS_ADD_KFIN_PLANOCONTA =
             'ALTER TABLE FIN_FINANCIAMENTOS'
      +#13#10'ADD KFIN_PLANOCONTA SYS$FKGUID20'
      +#13#10', ALTER KFIN_PLANOCONTA POSITION 20';

  _ALTER_ALTER_TABLE_FIN_FINANCIAMENTOS_ADD_CONSTRAINT =
             'ALTER TABLE FIN_FINANCIAMENTOS'
      +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTO_03'
      +#13#10'FOREIGN KEY (KFIN_PLANOCONTA)'
      +#13#10'REFERENCES FIN_PLANOCONTAS(KFIN_PLANOCONTA)'
      +#13#10'ON UPDATE CASCADE';

begin
  TryExecuteDirect( _ALTER_TABLE_FIN_FINANCIAMENTOS_ADD_KFIN_PLANOCONTA );
  TryExecuteDirect( _ALTER_ALTER_TABLE_FIN_FINANCIAMENTOS_ADD_CONSTRAINT );
end;


procedure TDBFinanceiroUpdate._5_002_10;
const
  _CREATE_OR_ALTER_PROCEDURE_EST_UPDATE_ESTOQUE =
             'create or alter procedure EST_UPDATE_ESTOQUE ('
      +#13#10'    KDOMAIN SYS$FKGUID20,'
      +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
      +#13#10'    data SYS$DATE)'
      +#13#10'AS'
      +#13#10'DECLARE TIPO CHAR(1) = NULL;'
      +#13#10'DECLARE ESTOQUE SYS$FLOAT;'
      +#13#10'DECLARE ESTOQUE_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE QTDE SYS$FLOAT;'
      +#13#10'DECLARE CUSTO SYS$FLOAT;'
      +#13#10'DECLARE CUSTO_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_ENTRADA SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_SAIDA SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_DEVOLVIDA SYS$FLOAT;'
      +#13#10'DECLARE DATAMOVTO SYS$DATE;'
      +#13#10'DECLARE EST$MOVTO_OFF VARCHAR(1);'
      +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
      +#13#10'DECLARE ANO SMALLINT = NULL ;'
      +#13#10'DECLARE MES SMALLINT = NULL ;'
      +#13#10'DECLARE ATUALIZAR_CUSTO SYS$BOOL ;'
      +#13#10'BEGIN'
      +#13#10''
      +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
      +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
      +#13#10''
      +#13#10'  CUSTO_ANTERIOR   = null ;'
      +#13#10'  CUSTO_MEDIO      = null ;'
      +#13#10'  ESTOQUE_ANTERIOR = null ;'
      +#13#10''
      +#13#10'  Ano = Extract ( YEAR from DATA ) ;'
      +#13#10'  Mes = Extract ( MONTH from DATA ) ;'
      +#13#10''
      +#13#10'  IF (MES=1) THEN'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || (Ano - 1), 4 ) || ''12'' ;'
      +#13#10'  ELSE'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || Ano, 4 ) || RIGHT ( ''00'' || (MES - 1), 2) ;'
      +#13#10''
      +#13#10'  SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
      +#13#10'    FROM EST_MOVIMENTO'
      +#13#10'   WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'     AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'     AND DATA < :DATA'
      +#13#10'   ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'    ROWS 1'
      +#13#10'    INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10''
      +#13#10'  IF ( TIPO IS NULL ) then'
      +#13#10'    BEGIN'
      +#13#10'      SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, QTDE, DATA'
      +#13#10'        FROM EST_MOVIMENTO'
      +#13#10'       WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'         AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'         AND TIPO = ''C'''
      +#13#10'       ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'        ROWS 1'
      +#13#10'        INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10'      DATA = DATAMOVTO ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'  IF (     (TIPO <> ''C'')'
      +#13#10'       AND ('
      +#13#10'               (EXTRACT( MONTH FROM DATAMOVTO ) <> EXTRACT( MONTH FROM DATA ))'
      +#13#10'            OR (EXTRACT( YEAR  FROM DATAMOVTO ) <> EXTRACT( YEAR  FROM DATA ))'
      +#13#10'           )'
      +#13#10'     ) THEN'
      +#13#10'     BEGIN'
      +#13#10'       SELECT EMP.CUSTO_MEDIO FROM EST_ENCERRAMENTO_MES EM'
      +#13#10'       LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = :KEST_PRODUTO )'
      +#13#10'       WHERE ( EM.ANO_MES = :ANO_MES_ANT AND EM.ENCERRADO = ''T'' )'
      +#13#10'       INTO CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'       CUSTO_ANTERIOR = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'     END'
      +#13#10''
      +#13#10'  FOR SELECT'
      +#13#10'       TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
      +#13#10'  FROM EST_MOVIMENTO'
      +#13#10'  WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'    AND DATA >= :DATA'
      +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
      +#13#10'  INTO TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
      +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
      +#13#10'  DO'
      +#13#10'    BEGIN'
      +#13#10''
      +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
      +#13#10'        BEGIN'
      +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
      +#13#10'          CUSTO_MEDIO      = CUSTO_ANTERIOR ;'
      +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
      +#13#10'        END'
      +#13#10'      ELSE IF ('
      +#13#10'                ( TIPO = ''E'' )'
      +#13#10'            AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
      +#13#10'              ) THEN'
      +#13#10'         BEGIN'
      +#13#10'           IF ( ATUALIZAR_CUSTO = ''T'') THEN'
      +#13#10'             CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
      +#13#10'           ELSE'
      +#13#10'             CUSTO_MEDIO = CUSTO_ANTERIOR ;'
      +#13#10'         END'
      +#13#10'      ELSE IF ('
      +#13#10'                ( TIPO = ''D'' )'
      +#13#10'              ) THEN'
      +#13#10'         BEGIN'
      +#13#10'           IF (( ATUALIZAR_CUSTO = ''T'') AND ( ESTOQUE_ANTERIOR + QTDE <= 0 )) THEN'
      +#13#10'             CUSTO_MEDIO = 0;'
      +#13#10'           ELSE IF ( ATUALIZAR_CUSTO = ''T'') THEN'
      +#13#10'             CUSTO_MEDIO = (( QTDE * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) +  QTDE  ) ;'
      +#13#10'           ELSE'
      +#13#10'             CUSTO_MEDIO = CUSTO_ANTERIOR ;'
      +#13#10'         END'
      +#13#10'      ELSE IF ( TIPO = ''S'' ) THEN'
      +#13#10'         CUSTO = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
      +#13#10''
      +#13#10'      UPDATE EST_MOVIMENTO'
      +#13#10'         SET'
      +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
      +#13#10'             CUSTO            = :CUSTO,'
      +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
      +#13#10'             ESTOQUE          = :ESTOQUE'
      +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
      +#13#10''
      +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
      +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
      +#13#10''
      +#13#10'    END'
      +#13#10''
      +#13#10'  -- revisar....'
      +#13#10'  -- Atualiza status atual produto'
      +#13#10'    SELECT'
      +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
      +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA,'
      +#13#10'        SUM( IIF ( TIPO = ''D'', -ME.QTDE, 0 ) ) DEVOLVIDA'
      +#13#10'     FROM EST_MOVIMENTO ME'
      +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'       AND ME.TIPO <> ''C'''
      +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA, TOTAL_DEVOLVIDA ;'
      +#13#10''
      +#13#10'   UPDATE EST_PRODUTOS'
      +#13#10'      SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
      +#13#10'          QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
      +#13#10'          QTDE_DEVOLVIDA    = COALESCE( :TOTAL_DEVOLVIDA, 0),'
      +#13#10'          CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
      +#13#10'          CUSTO_MEDIO_MES   = NULL'
      +#13#10'   WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
      +#13#10''
      +#13#10' RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
      +#13#10''
      +#13#10''
      +#13#10'END';


  _UPDATE_CUSTO_DEVOLUCAO =
             'EXECUTE BLOCK'
      +#13#10'AS'
      +#13#10'DECLARE KDEV_PEDIDO_ITEM SYS$FKGUID20;'
      +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20;'
      +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20;'
      +#13#10'DECLARE QTDE SYS$FLOAT_NN_0;'
      +#13#10'DECLARE VALOR_UNITARIO SYS$FLOAT_NN_0;'
      +#13#10'DECLARE DESCONTO SYS$FLOAT_NN_0 ;'
      +#13#10'DECLARE FRETE SYS$FLOAT_NN_0;'
      +#13#10'DECLARE TOTAL SYS$FLOAT_NN_0;'
      +#13#10'DECLARE CUSTO SYS$FLOAT_NN_0;'
      +#13#10'DECLARE DATA_COMPRA SYS$DATE_NN;'
      +#13#10'BEGIN'
      +#13#10'  FOR'
      +#13#10'    SELECT DI.KDEV_PEDIDO_ITEM,'
      +#13#10'           DI.KEST_PRODUTO,'
      +#13#10'           P.KSYS$DOMAIN,'
      +#13#10'           DV.DATA_COMPRA,'
      +#13#10'           DI.VALOR_UNITARIO,'
      +#13#10'           DI.QTDE,'
      +#13#10'           DI.DESCONTO,'
      +#13#10'           DI.FRETE,'
      +#13#10'           DI.CUSTO,'
      +#13#10'           DI.TOTAL'
      +#13#10'      FROM DEV_PEDIDO_ITENS DI'
      +#13#10'      INNER JOIN DEV_PEDIDOS DV ON DI.KDEV_PEDIDO = DV.KDEV_PEDIDO'
      +#13#10'      INNER JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = DI.KEST_PRODUTO'
      +#13#10'      ORDER BY DV.DATA_COMPRA'
      +#13#10'     INTO :KDEV_PEDIDO_ITEM, :KEST_PRODUTO, :KSYS$DOMAIN, :DATA_COMPRA,'
      +#13#10'          :VALOR_UNITARIO, :QTDE, :DESCONTO, :FRETE, :CUSTO, :TOTAL'
      +#13#10'     DO'
      +#13#10'     BEGIN'
      +#13#10'       IF (:CUSTO <> ( (:VALOR_UNITARIO * :QTDE - :DESCONTO) / :QTDE )) THEN'
      +#13#10'        BEGIN'
      +#13#10''
      +#13#10'          CUSTO = ( (:VALOR_UNITARIO * :QTDE - :DESCONTO) / :QTDE );'
      +#13#10''
      +#13#10'          UPDATE DEV_PEDIDO_ITENS'
      +#13#10'             SET CUSTO = :CUSTO'
      +#13#10'           WHERE KDEV_PEDIDO_ITEM = :KDEV_PEDIDO_ITEM;'
      +#13#10''
      +#13#10'        END'
      +#13#10''
      +#13#10'       EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( :KSYS$DOMAIN, :KEST_PRODUTO , :DATA_COMPRA );'
      +#13#10''
      +#13#10'     END'
      +#13#10'END';

var
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;
  TryExecuteDirect( _CREATE_OR_ALTER_PROCEDURE_EST_UPDATE_ESTOQUE );
  ExecuteDirect( _UPDATE_CUSTO_DEVOLUCAO );

end;


procedure TDBFinanceiroUpdate._5_002_09;
const
 _ALTER_TABLE_VND_PEDIDOS =
         'ALTER TABLE VND_PEDIDOS'
  +#13#10'  ADD KFIN_APAGAR SYS$FKGUID20'
  +#13#10', ALTER KFIN_APAGAR POSITION 17' ;
begin
  TryExecuteDirect( _ALTER_TABLE_VND_PEDIDOS ) ;
end;


procedure TDBFinanceiroUpdate._5_002_08;
const
   _ALTER_TABLE_EST_PRODUTOS_ADD_QTDE_DEVOLVIDA =
             'ALTER TABLE EST_PRODUTOS'
      +#13#10'ADD QTDE_DEVOLVIDA SYS$FLOAT_NN_0'
      +#13#10', ALTER QTDE_DEVOLVIDA POSITION 19';

   _ALTER_TABLE_EST_PRODUTOS_ALTER_COMPUTED =
             'ALTER TABLE EST_PRODUTOS'
      +#13#10'ALTER QTDE_PRODUTO COMPUTED('
      +#13#10'     CAST ( QTDE_INICIAL + QTDE_COMPRADA - QTDE_UTILIZADA - QTDE_DEVOLVIDA AS SYS$FLOAT )   )';

   _CREATE_OR_ALTER_PROCEDURE_EST_UPDATE_ESTOQUE =
             'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE ('
      +#13#10'    KDOMAIN SYS$FKGUID20,'
      +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
      +#13#10'    data SYS$DATE)'
      +#13#10'AS'
      +#13#10'DECLARE TIPO CHAR(1) = NULL;'
      +#13#10'DECLARE ESTOQUE SYS$FLOAT;'
      +#13#10'DECLARE ESTOQUE_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE QTDE SYS$FLOAT;'
      +#13#10'DECLARE CUSTO SYS$FLOAT;'
      +#13#10'DECLARE CUSTO_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_ENTRADA SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_SAIDA SYS$FLOAT;'
      +#13#10'DECLARE TOTAL_DEVOLVIDA SYS$FLOAT;'
      +#13#10'DECLARE DATAMOVTO SYS$DATE;'
      +#13#10'DECLARE EST$MOVTO_OFF VARCHAR(1);'
      +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
      +#13#10'DECLARE ANO SMALLINT = NULL ;'
      +#13#10'DECLARE MES SMALLINT = NULL ;'
      +#13#10'DECLARE ATUALIZAR_CUSTO SYS$BOOL ;'
      +#13#10'BEGIN'
      +#13#10''
      +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
      +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
      +#13#10''
      +#13#10'  CUSTO_ANTERIOR   = null ;'
      +#13#10'  CUSTO_MEDIO      = null ;'
      +#13#10'  ESTOQUE_ANTERIOR = null ;'
      +#13#10''
      +#13#10'  Ano = Extract ( YEAR from DATA ) ;'
      +#13#10'  Mes = Extract ( MONTH from DATA ) ;'
      +#13#10''
      +#13#10'  IF (MES=1) THEN'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || (Ano - 1), 4 ) || ''12'' ;'
      +#13#10'  ELSE'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || Ano, 4 ) || RIGHT ( ''00'' || (MES - 1), 2) ;'
      +#13#10''
      +#13#10'  SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
      +#13#10'    FROM EST_MOVIMENTO'
      +#13#10'   WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'     AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'     AND DATA < :DATA'
      +#13#10'   ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'    ROWS 1'
      +#13#10'    INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10''
      +#13#10'  IF ( TIPO IS NULL ) then'
      +#13#10'    BEGIN'
      +#13#10'      SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, QTDE, DATA'
      +#13#10'        FROM EST_MOVIMENTO'
      +#13#10'       WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'         AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'         AND TIPO = ''C'''
      +#13#10'       ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'        ROWS 1'
      +#13#10'        INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10'      DATA = DATAMOVTO ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'  IF (     (TIPO <> ''C'')'
      +#13#10'       AND ('
      +#13#10'               (EXTRACT( MONTH FROM DATAMOVTO ) <> EXTRACT( MONTH FROM DATA ))'
      +#13#10'            OR (EXTRACT( YEAR  FROM DATAMOVTO ) <> EXTRACT( YEAR  FROM DATA ))'
      +#13#10'           )'
      +#13#10'     ) THEN'
      +#13#10'     BEGIN'
      +#13#10'       SELECT EMP.CUSTO_MEDIO FROM EST_ENCERRAMENTO_MES EM'
      +#13#10'       LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = :KEST_PRODUTO )'
      +#13#10'       WHERE ( EM.ANO_MES = :ANO_MES_ANT AND EM.ENCERRADO = ''T'' )'
      +#13#10'       INTO CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'       CUSTO_ANTERIOR = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'     END'
      +#13#10''
      +#13#10'  FOR SELECT'
      +#13#10'       TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
      +#13#10'  FROM EST_MOVIMENTO'
      +#13#10'  WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'    AND DATA >= :DATA'
      +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
      +#13#10'  INTO TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
      +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
      +#13#10'  DO'
      +#13#10'    BEGIN'
      +#13#10''
      +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
      +#13#10'        BEGIN'
      +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
      +#13#10'          CUSTO_MEDIO      = CUSTO_ANTERIOR ;'
      +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
      +#13#10'        END'
      +#13#10'      ELSE IF ('
      +#13#10'                ( TIPO = ''E'' )'
      +#13#10'            AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
      +#13#10'              ) THEN'
      +#13#10'         BEGIN'
      +#13#10'           IF ( ATUALIZAR_CUSTO = ''T'') THEN'
      +#13#10'             CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
      +#13#10'           ELSE'
      +#13#10'             CUSTO_MEDIO = CUSTO_ANTERIOR ;'
      +#13#10'         END'
      +#13#10'      ELSE IF ('
      +#13#10'                ( TIPO = ''D'' )'
      +#13#10'            AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
      +#13#10'              ) THEN'
      +#13#10'         BEGIN'
      +#13#10'           IF ( ATUALIZAR_CUSTO = ''T'') THEN'
      +#13#10'             CUSTO_MEDIO = (( QTDE * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) +  QTDE  ) ;'
      +#13#10'           ELSE'
      +#13#10'             CUSTO_MEDIO = CUSTO_ANTERIOR ;'
      +#13#10'         END'
      +#13#10'      ELSE IF ( TIPO = ''S'' ) THEN'
      +#13#10'         CUSTO = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
      +#13#10''
      +#13#10'      UPDATE EST_MOVIMENTO'
      +#13#10'         SET'
      +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
      +#13#10'             CUSTO            = :CUSTO,'
      +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
      +#13#10'             ESTOQUE          = :ESTOQUE'
      +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
      +#13#10''
      +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
      +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
      +#13#10''
      +#13#10'    END'
      +#13#10''
      +#13#10'  -- revisar....'
      +#13#10'  -- Atualiza status atual produto'
      +#13#10'    SELECT'
      +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
      +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA,'
      +#13#10'        SUM( IIF ( TIPO = ''D'', -ME.QTDE, 0 ) ) DEVOLVIDA'
      +#13#10'     FROM EST_MOVIMENTO ME'
      +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'       AND ME.TIPO <> ''C'''
      +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA, TOTAL_DEVOLVIDA ;'
      +#13#10''
      +#13#10'   UPDATE EST_PRODUTOS'
      +#13#10'      SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
      +#13#10'          QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
      +#13#10'          QTDE_DEVOLVIDA    = COALESCE( :TOTAL_DEVOLVIDA, 0),'
      +#13#10'          CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
      +#13#10'          CUSTO_MEDIO_MES   = NULL'
      +#13#10'   WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
      +#13#10''
      +#13#10' RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
      +#13#10''
      +#13#10''
      +#13#10'END';

begin
  TryExecuteDirect( _ALTER_TABLE_EST_PRODUTOS_ADD_QTDE_DEVOLVIDA );
  TryExecuteDirect( _ALTER_TABLE_EST_PRODUTOS_ALTER_COMPUTED );
  TryExecuteDirect( _CREATE_OR_ALTER_PROCEDURE_EST_UPDATE_ESTOQUE );
end;


procedure TDBFinanceiroUpdate._5_002_06;
const
   _ALTER_TABLE_FRISIA_MATRICULA_CONTAS =
       'ALTER TABLE FRISIA_MATRICULA_CONTAS'
+#13#10' ADD   SINCRONIZAR_APARTIR     SYS$DATE,'
+#13#10' ADD   SINCRONIZAR             SYS$BOOL_T' ;

   _UPDATE_FRISIA_MATRICULA_CONTAS =
       'UPDATE FRISIA_MATRICULA_CONTAS'
+#13#10' SET   SINCRONIZAR_APARTIR   =   ULTIMO_SINCRONISMO '
+#13#10'WHERE SINCRONIZAR_APARTIR IS NULL' ;

begin
  TryExecuteDirect( _ALTER_TABLE_FRISIA_MATRICULA_CONTAS ) ;
  ExecuteDirect( _UPDATE_FRISIA_MATRICULA_CONTAS ) ;
end ;


procedure TDBFinanceiroUpdate._5_002_05;
const

   _CREATE_OR_ALTER_PROCEDURE_EST_REABRIR_MESES =
           'CREATE OR ALTER PROCEDURE EST_REABRIR_MESES'
    +#13#10'AS'
    +#13#10'DECLARE KEST_ENCERRAMENTO_MES SYS$FKGUID20 ;'
    +#13#10'DECLARE ANO_MES SYS$ANO_MES ;'
    +#13#10'DECLARE FIRST_MONTH SYS$BOOL = ''T'' ;'
    +#13#10'BEGIN'
    +#13#10'  FOR SELECT'
    +#13#10'      KEST_ENCERRAMENTO_MES'
    +#13#10'    , ANO_MES'
    +#13#10'  FROM EST_ENCERRAMENTO_MES'
    +#13#10'  WHERE ENCERRADO = ''T'''
    +#13#10'  ORDER BY ANO_MES DESC'
    +#13#10'  INTO KEST_ENCERRAMENTO_MES, ANO_MES'
    +#13#10'  DO'
    +#13#10'  BEGIN'
    +#13#10'     IF ( FIRST_MONTH = ''T'' ) THEN'
    +#13#10'       BEGIN'
    +#13#10'          FIRST_MONTH = ''F'' ;'
    +#13#10'          RDB$SET_CONTEXT( ''USER_SESSION'', ''SYS$ENCERRAMENTO_MES_ANO'', ANO_MES ) ;'
    +#13#10'       END'
    +#13#10'     EXECUTE PROCEDURE EST_REABRIR_MES( KEST_ENCERRAMENTO_MES ) ;'
    +#13#10'  END'
    +#13#10'END' ;

   _CREATE_OR_ALTER_PROCEDURE_EST_ENCERRAR_MESES =
           'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MESES'
    +#13#10'AS'
    +#13#10'DECLARE KEST_ENCERRAMENTO_MES SYS$FKGUID20 ;'
    +#13#10'DECLARE ANO_MES SYS$ANO_MES ;'
    +#13#10'BEGIN'
    +#13#10'  ANO_MES = RDB$GET_CONTEXT( ''USER_SESSION'', ''SYS$ENCERRAMENTO_MES_ANO'' ) ;'
    +#13#10'  IF ( ANO_MES IS NULL ) THEN'
    +#13#10'    EXIT ;'
    +#13#10''
    +#13#10'  FOR SELECT'
    +#13#10'      KEST_ENCERRAMENTO_MES'
    +#13#10'  FROM EST_ENCERRAMENTO_MES'
    +#13#10'  WHERE ANO_MES <= :ANO_MES'
    +#13#10'  ORDER BY ANO_MES'
    +#13#10'  INTO KEST_ENCERRAMENTO_MES'
    +#13#10'  DO'
    +#13#10'     EXECUTE PROCEDURE EST_ENCERRAR_MES( KEST_ENCERRAMENTO_MES ) ;'
    +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''SYS$ENCERRAMENTO_MES_ANO'', NULL ) ;'
    +#13#10'END' ;

begin
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_EST_REABRIR_MESES  ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_EST_ENCERRAR_MESES ) ;
end;


procedure TDBFinanceiroUpdate._5_002_03;
const
  _UPDATE_CENTROCUSTO_RETENCAO =
            'EXECUTE BLOCK'
     +#13#10'AS'
     +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
     +#13#10'BEGIN'
     +#13#10'  FOR SELECT'
     +#13#10'    KFIN_APAGAR'
     +#13#10'  FROM FIN_APAGAR'
     +#13#10'  WHERE'
     +#13#10'    HISTORICO CONTAINING '' RETENCAO CAP.GIRO PROPRIO - RACOES-LEITE '''
     +#13#10'  INTO KFIN_APAGAR'
     +#13#10'  DO'
     +#13#10'    DELETE FROM FIN_APROPRIACAO'
     +#13#10'    WHERE'
     +#13#10'         TABLENAME = ''FIN_APAGAR'''
     +#13#10'     AND TABLEKEY = ::KFIN_APAGAR ;'
     +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
    if Fields[0].asInteger = 0 then
      exit ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_CENTROCUSTO_RETENCAO )
    .SQLExec ;

end;

procedure TDBFinanceiroUpdate._5_002_04;
const
   _CREATE_DEV_PEDIDO_ITENS_BIUD0 =
               'CREATE OR ALTER TRIGGER DEV_PEDIDO_ITENS_BIUD0 FOR DEV_PEDIDO_ITENS'
        +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
        +#13#10'AS'
        +#13#10'DECLARE KDOMAIN      SYS$FKGUID20 = null ;'
        +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
        +#13#10'DECLARE DATA_ENTRADA SYS$DATE;'
        +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
        +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO, DATA_ENTRADA'
        +#13#10'  FROM DEV_PEDIDOS'
        +#13#10'  WHERE KDEV_PEDIDO = IIF ( inserting or updating, NEW.KDEV_PEDIDO, OLD.KDEV_PEDIDO )'
        +#13#10'  INTO KDOMAIN, DATA_EMISSAO, DATA_ENTRADA ;'
        +#13#10''
        +#13#10'  IF ( DELETING AND KDOMAIN IS NULL  ) THEN'
        +#13#10'     EXIT ;'
        +#13#10''
        +#13#10'  LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
        +#13#10'  THISCHECK_ENCERRAMENTO_MES = KDOMAIN'
        +#13#10'       || COALESCE (DATA_EMISSAO, '''' )'
        +#13#10'       || COALESCE (DATA_ENTRADA, '''' ) ;'
        +#13#10''
        +#13#10'  IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
        +#13#10'  BEGIN'
        +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
        +#13#10''
        +#13#10'    IF ( DATA_ENTRADA IS DISTINCT FROM DATA_EMISSAO ) THEN'
        +#13#10'       EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_ENTRADA ;'
        +#13#10'  END'
        +#13#10''
        +#13#10'  IF ( ( INSERTING OR UPDATING ) AND ( NEW.KEST_PRODUTO IS NOT NULL ) ) THEN'
        +#13#10'     EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  KDOMAIN, NEW.KEST_PRODUTO, DATA_ENTRADA ;'
        +#13#10''
        +#13#10'  IF ( DELETING ) THEN'
        +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''DEV_PEDIDO_ITENS'', OLD.KDEV_PEDIDO_ITEM ;'
        +#13#10''
        +#13#10'END';

   _CREATE_ECRM_DEV_PEDIDO_ITENS =
               'CREATE OR ALTER TRIGGER ECRM$DEV_PEDIDO_ITENS FOR DEV_PEDIDO_ITENS'
        +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
        +#13#10'AS'
        +#13#10'BEGIN'
        +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
        +#13#10'    ''DEV_PEDIDO_ITENS'','
        +#13#10'    IIF ( INSERTING, NEW.KDEV_PEDIDO_ITEM, OLD.KDEV_PEDIDO_ITEM ),'
        +#13#10'    CASE'
        +#13#10'       WHEN INSERTING THEN ''I'''
        +#13#10'       WHEN UPDATING  THEN ''U'''
        +#13#10'       WHEN DELETING  THEN ''D'''
        +#13#10'    END,'
        +#13#10'    ''DEV_PEDIDOS'','
        +#13#10'    IIF ( INSERTING, NEW.KDEV_PEDIDO, OLD.KDEV_PEDIDO ) ;'
        +#13#10'END';

   _CREATE_DEV_PEDIDO_ITENS_AIUD0 =
               'CREATE OR ALTER TRIGGER DEV_PEDIDO_ITENS_AIUD0 FOR DEV_PEDIDO_ITENS'
        +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
        +#13#10'AS'
        +#13#10''
        +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
        +#13#10'DECLARE KCAD_ENTIDADE   SYS$FKGUID20;'
        +#13#10'DECLARE NOMEENTIDADE    SYS$DESCR;'
        +#13#10'DECLARE DATA            SYS$DATE;'
        +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
        +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
        +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
        +#13#10'DECLARE KDEV_PEDIDO     SYS$FKGUID20  = NULL ;'
        +#13#10''
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
        +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
        +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
        +#13#10'     ) THEN'
        +#13#10'    EXIT ;'
        +#13#10''
        +#13#10'  KDEV_PEDIDO = IIF( DELETING, OLD.KDEV_PEDIDO, NEW.KDEV_PEDIDO ) ;'
        +#13#10''
        +#13#10'  SELECT KSYS$DOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
        +#13#10'    FROM DEV_PEDIDOS'
        +#13#10'   WHERE KDEV_PEDIDO = :KDEV_PEDIDO'
        +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
        +#13#10''
        +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
        +#13#10'    EXIT ;'
        +#13#10''
        +#13#10'  IF (    UPDATING'
        +#13#10'      AND ('
        +#13#10'                ( OLD.KDEV_PEDIDO_ITEM IS DISTINCT FROM NEW.KDEV_PEDIDO_ITEM )'
        +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
        +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
        +#13#10'                )'
        +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
        +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
        +#13#10'                )'
        +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
        +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
        +#13#10'                )'
        +#13#10'          )'
        +#13#10'     ) THEN'
        +#13#10'   BEGIN'
        +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
        +#13#10'                                                KDOMAIN,'
        +#13#10'                                                OLD.KEST_PRODUTO,'
        +#13#10'                                                DATA,'
        +#13#10'                                                ''D'','
        +#13#10'                                                OLD.QTDE,'
        +#13#10'                                                OLD.CUSTO,'
        +#13#10'                                                ''DEV_PEDIDO_ITENS'','
        +#13#10'                                                OLD.KDEV_PEDIDO_ITEM,'
        +#13#10'                                                OLD.ATUALIZAR_CUSTO'
        +#13#10'                                                );'
        +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
        +#13#10'          EXIT ;'
        +#13#10''
        +#13#10'   END'
        +#13#10''
        +#13#10''
        +#13#10'  IF (INSERTING) THEN'
        +#13#10'    BEGIN'
        +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
        +#13#10'        UPDATE EST_PRODUTOS'
        +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
        +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
        +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
        +#13#10''
        +#13#10'    END'
        +#13#10''
        +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
        +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
        +#13#10'  ELSE'
        +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
        +#13#10''
        +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
        +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
        +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    INTO BAIXA_ESTOQUE ;'
        +#13#10''
        +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
        +#13#10'    KEST_PRODUTO = NULL ;'
        +#13#10''
        +#13#10'  BAIXA_ESTOQUE = NULL ;'
        +#13#10''
        +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
        +#13#10''
        +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
        +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
        +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
        +#13#10'    INTO BAIXA_ESTOQUE ;'
        +#13#10''
        +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
        +#13#10'    KEST_PRODUTO = NULL ;'
        +#13#10''
        +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
        +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
        +#13#10'                                             when Inserting then ''I'''
        +#13#10'                                             when Updating  then ''U'''
        +#13#10'                                             when Deleting  then ''D'''
        +#13#10'                                             end,'
        +#13#10'                                             KDOMAIN,'
        +#13#10'                                             KEST_PRODUTO,'
        +#13#10'                                             DATA,'
        +#13#10'                                             ''D'','
        +#13#10'                                             NEW.QTDE,'
        +#13#10'                                             NEW.CUSTO,'
        +#13#10'                                             ''DEV_PEDIDO_ITENS'','
        +#13#10'                                             IIF( DELETING, OLD.KDEV_PEDIDO_ITEM, NEW.KDEV_PEDIDO_ITEM ),'
        +#13#10'                                             IIF( DELETING, OLD.ATUALIZAR_CUSTO, NEW.ATUALIZAR_CUSTO )'
        +#13#10'                                             );'
        +#13#10''
        +#13#10'END';

   _CREATE_DEV_PEDIDOS_BIUD0 =
               'CREATE OR ALTER TRIGGER DEV_PEDIDOS_BIUD0 FOR DEV_PEDIDOS'
        +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
        +#13#10'AS'
        +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
        +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
        +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  IF (inserting) THEN'
        +#13#10'   BEGIN'
        +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
        +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
        +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
        +#13#10'          || COALESCE (NEW.DATA_ENTRADA, '''' ) ;'
        +#13#10''
        +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
        +#13#10'        BEGIN'
        +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
        +#13#10'         IF ( NEW.DATA_EMISSAO IS DISTINCT FROM NEW.DATA_ENTRADA ) THEN'
        +#13#10'            EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
        +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
        +#13#10'        END'
        +#13#10'   END'
        +#13#10'  ELSE IF (    ( updating )'
        +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
        +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
        +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
        +#13#10'    BEGIN'
        +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
        +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
        +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
        +#13#10''
        +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
        +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
        +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
        +#13#10''
        +#13#10'      FOR SELECT KEST_PRODUTO'
        +#13#10'        FROM DEV_PEDIDO_ITENS'
        +#13#10'        WHERE KDEV_PEDIDO = NEW.KDEV_PEDIDO AND NOT KEST_PRODUTO IS NULL'
        +#13#10'        INTO KEST_PRODUTO'
        +#13#10'      DO'
        +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
        +#13#10'    END'
        +#13#10'  ELSE IF ( deleting ) then'
        +#13#10'    BEGIN'
        +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
        +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
        +#13#10'    END'
        +#13#10'END';

   _CREATE_ECRM_DEV_PEDIDOS =
               'CREATE OR ALTER TRIGGER ECRM$DEV_PEDIDOS FOR DEV_PEDIDOS'
        +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
        +#13#10'AS'
        +#13#10'BEGIN'
        +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
        +#13#10'    ''DEV_PEDIDOS'','
        +#13#10'    IIF ( INSERTING, NEW.KDEV_PEDIDO, OLD.KDEV_PEDIDO ),'
        +#13#10'    CASE'
        +#13#10'       WHEN INSERTING THEN ''I'''
        +#13#10'       WHEN UPDATING  THEN ''U'''
        +#13#10'       WHEN DELETING  THEN ''D'''
        +#13#10'    END;'
        +#13#10'END';

   _CREATE_DEV_PEDIDOS_AUD0 =
               'CREATE OR ALTER TRIGGER DEV_PEDIDOS_AUD0 FOR DEV_PEDIDOS'
        +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
        +#13#10'AS'
        +#13#10'DECLARE KEST_PRODUTO      SYS$FKGUID20 ;'
        +#13#10'DECLARE QTDE              SYS$FLOAT ;'
        +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
        +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
        +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
        +#13#10'DECLARE ATUALIZAR_CUSTO   SYS$BOOL ;'
        +#13#10'DECLARE KDEV_PEDIDO_ITEM  SYS$FKGUID20 ;'
        +#13#10'DECLARE KDEV_PEDIDO_SERVICO SYS$FKGUID20 ;'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  IF ( UPDATING ) THEN'
        +#13#10'    BEGIN'
        +#13#10'      UPDATE FIN_ARECEBER'
        +#13#10'       SET'
        +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
        +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
        +#13#10'      WHERE ( KFIN_ARECEBER = NEW.KFIN_ARECEBER )'
        +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
        +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
        +#13#10'            ) ;'
        +#13#10''
        +#13#10'      IF ( NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
        +#13#10'        EXIT ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  IF ( DELETING ) THEN'
        +#13#10'    BEGIN'
        +#13#10'     DELETE FROM FIN_ARECEBER WHERE KFIN_ARECEBER = OLD.KFIN_ARECEBER ;'
        +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_TRANSPORTE ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  FOR SELECT'
        +#13#10'     I.KDEV_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE, I.ATUALIZAR_CUSTO'
        +#13#10'  FROM DEV_PEDIDO_ITENS I'
        +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
        +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
        +#13#10'  WHERE I.KDEV_PEDIDO = IIF ( DELETING, OLD.KDEV_PEDIDO, NEW.KDEV_PEDIDO )'
        +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
        +#13#10'  INTO KDEV_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE, ATUALIZAR_CUSTO'
        +#13#10'  DO'
        +#13#10'    BEGIN'
        +#13#10'     IF ( DELETING ) THEN'
        +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''DEV_PEDIDO_ITENS'', KDEV_PEDIDO_ITEM ;'
        +#13#10'     IF (     ( KEST_PRODUTO IS NOT NULL )'
        +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
        +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
        +#13#10'       ) THEN'
        +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (  IIF ( DELETING, ''D'', ''U'' ),'
        +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
        +#13#10'                                                 KEST_PRODUTO,'
        +#13#10'                                                 IIF (  DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
        +#13#10'                                                 ''D'','
        +#13#10'                                                 QTDE,'
        +#13#10'                                                 CUSTO,'
        +#13#10'                                                 ''DEV_PEDIDO_ITENS'','
        +#13#10'                                                 KDEV_PEDIDO_ITEM,'
        +#13#10'                                                 ATUALIZAR_CUSTO);'
        +#13#10'    END'
        +#13#10''
        +#13#10'END';

   _ALTER_EST_UPDATE_MOVIMENTO =
               'create or alter procedure EST_UPDATE_MOVIMENTO ('
        +#13#10'    TIPO_IUD char(1),'
        +#13#10'    KDOMAIN SYS$FKGUID20,'
        +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
        +#13#10'    data SYS$DATE,'
        +#13#10'    TIPO_ES SYS$TIPOMOVEST,'
        +#13#10'    QTDE SYS$FLOAT,'
        +#13#10'    CUSTO SYS$FLOAT,'
        +#13#10'    TABLENAME SYS$TABLENAME,'
        +#13#10'    TABLEKEY SYS$FKGUID20,'
        +#13#10'    ATUALIZAR_CUSTO SYS$BOOL = ''T'')'
        +#13#10'AS'
        +#13#10'BEGIN'
        +#13#10'  IF ( (TIPO_ES = ''S'' OR TIPO_ES = ''D'') AND QTDE > 0 )  THEN'
        +#13#10'     QTDE = -QTDE ;'
        +#13#10''
        +#13#10'  IF (    (TIPO_IUD = ''U'')'
        +#13#10'      AND NOT EXISTS( SELECT 1 FROM EST_MOVIMENTO'
        +#13#10'                  WHERE'
        +#13#10'                       KSYS$DOMAIN = :KDOMAIN'
        +#13#10'                   AND TABLENAME    = :TABLENAME'
        +#13#10'                   AND TABLEKEY     = :TABLEKEY)'
        +#13#10''
        +#13#10'     ) THEN'
        +#13#10'     TIPO_IUD = ''I'' ;'
        +#13#10''
        +#13#10'  IF ( TIPO_IUD = ''I'' ) THEN'
        +#13#10'    INSERT INTO EST_MOVIMENTO'
        +#13#10'      ( KEST_MOVIMENTO, KSYS$DOMAIN, DATA, KEST_PRODUTO, TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO,'
        +#13#10'        TABLENAME, TABLEKEY )'
        +#13#10'    VALUES'
        +#13#10'      ( GUID20(), :KDOMAIN, :DATA, :KEST_PRODUTO, :TIPO_ES, :QTDE, :CUSTO, :ATUALIZAR_CUSTO,'
        +#13#10'        :TABLENAME, :TABLEKEY );'
        +#13#10'  ELSE IF (TIPO_IUD = ''U'') THEN'
        +#13#10'    UPDATE EST_MOVIMENTO'
        +#13#10'      SET KEST_PRODUTO = :KEST_PRODUTO,'
        +#13#10'          DATA = :DATA,'
        +#13#10'          TIPO = :TIPO_ES,'
        +#13#10'          QTDE = :QTDE,'
        +#13#10'          CUSTO = :CUSTO,'
        +#13#10'          ATUALIZAR_CUSTO = :ATUALIZAR_CUSTO'
        +#13#10'     WHERE'
        +#13#10'          KSYS$DOMAIN = :KDOMAIN'
        +#13#10'      AND TABLENAME    = :TABLENAME'
        +#13#10'      AND TABLEKEY     = :TABLEKEY'
        +#13#10'      AND (   (KEST_PRODUTO    IS DISTINCT FROM :KEST_PRODUTO)'
        +#13#10'           OR (DATA            IS DISTINCT FROM :DATA)'
        +#13#10'           OR (TIPO            IS DISTINCT FROM :TIPO_ES)'
        +#13#10'           OR (QTDE            IS DISTINCT FROM :QTDE)'
        +#13#10'           OR (CUSTO           IS DISTINCT FROM :CUSTO)'
        +#13#10'           OR (ATUALIZAR_CUSTO IS DISTINCT FROM :ATUALIZAR_CUSTO)'
        +#13#10'          ) ;'
        +#13#10'  ELSE IF (TIPO_IUD = ''D'') THEN'
        +#13#10'    DELETE FROM EST_MOVIMENTO'
        +#13#10'    WHERE KSYS$DOMAIN = :KDOMAIN AND TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY;'
        +#13#10''
        +#13#10'END';

   _ALTER_EST_ENCERRAR_MES =
               'create or alter procedure EST_ENCERRAR_MES ('
        +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
        +#13#10'AS'
        +#13#10'DECLARE SOURCE_KEST_PRODUTO SYS$FKGUID20;'
        +#13#10'DECLARE SOURCE_NOME SYS$DESCR;'
        +#13#10'DECLARE SOURCE_QTDE_ESTOQUE SYS$FLOAT;'
        +#13#10'DECLARE SOURCE_QTDE_ENTRADAS SYS$FLOAT;'
        +#13#10'DECLARE SOURCE_SOMA_ENTRADA_X_CUSTO SYS$FLOAT;'
        +#13#10'DECLARE SOURCE_ESTOQUE_ANTERIOR SYS$FLOAT;'
        +#13#10'DECLARE SOURCE_CM_ANTERIOR SYS$FLOAT;'
        +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
        +#13#10'DECLARE SOMA_EA_QE SYS$FLOAT;'
        +#13#10'DECLARE TARGET_KEST_PRODUTO SYS$FKGUID20;'
        +#13#10'DECLARE TARGET_NOME SYS$DESCR;'
        +#13#10'DECLARE TARGET_QTDE_ESTOQUE SYS$FLOAT;'
        +#13#10'DECLARE TARGET_CUSTO_MEDIO SYS$FLOAT;'
        +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
        +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
        +#13#10'DECLARE ANO_MES_PROX SYS$ANO_MES = NULL ;'
        +#13#10'DECLARE PROX_MES SYS$DATE ;'
        +#13#10'DECLARE ANO_MES SYS$ANO_MES = NULL ;'
        +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
        +#13#10'DECLARE RLOG$OFF VARCHAR(1);'
        +#13#10'DECLARE RC_SOURCE INTEGER;'
        +#13#10'DECLARE RC_TARGET INTEGER;'
        +#13#10'DECLARE EST$ENCERRAMES_OFF VARCHAR(1);'
        +#13#10'DECLARE SOURCE CURSOR FOR (SELECT'
        +#13#10'         E.KEST_PRODUTO,'
        +#13#10'         P.NOME,'
        +#13#10'         (SELECT'
        +#13#10'           ESTOQUE'
        +#13#10'            FROM EST_MOVIMENTO QE'
        +#13#10'           WHERE'
        +#13#10'                 QE.KEST_PRODUTO = E.KEST_PRODUTO'
        +#13#10'             AND QE.ANO_MES <= :ANO_MES'
        +#13#10'           ORDER BY CAST ( QE.DATA AS DATE ) DESC, QE.MOVTO_ID DESC'
        +#13#10'           ROWS 1'
        +#13#10'         ) QTDE_ESTOQUE,'
        +#13#10'         (SELECT'
        +#13#10'           COALESCE( SUM( C.QTDE ), 0 )'
        +#13#10'            FROM EST_MOVIMENTO C'
        +#13#10'           WHERE'
        +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
        +#13#10'             AND C.TIPO IN ( ''C'', ''E'', ''D'' )'
        +#13#10'             AND C.ANO_MES = :ANO_MES'
        +#13#10'         ) QTDE_ENTRADAS ,'
        +#13#10'         (SELECT'
        +#13#10'           COALESCE( SUM( C.QTDE * C.CUSTO ), 0 )'
        +#13#10'            FROM EST_MOVIMENTO C'
        +#13#10'           WHERE'
        +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
        +#13#10'             AND C.TIPO IN ( ''C'', ''E'', ''D'' )'
        +#13#10'             AND C.ANO_MES = :ANO_MES'
        +#13#10'         ) SOMA_ENTRADA_X_CUSTO,'
        +#13#10'         COALESCE ( EMP.QTDE_ESTOQUE, 0 ) ESTOQUE_ANTERIOR,'
        +#13#10'         COALESCE ( EMP.CUSTO_MEDIO, 0 )  CM_ANTERIOR'
        +#13#10'         FROM EST_MOVIMENTO E'
        +#13#10'         LEFT JOIN EST_PRODUTOS P ON ( P.KEST_PRODUTO = E.KEST_PRODUTO )'
        +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES EM ON ( EM.ANO_MES = :ANO_MES_ANT )'
        +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = E.KEST_PRODUTO )'
        +#13#10'         WHERE E.TIPO = ''C'''
        +#13#10'         AND E.ANO_MES <= :ANO_MES'
        +#13#10'         ORDER BY E.KEST_PRODUTO'
        +#13#10' );'
        +#13#10'DECLARE TARGET CURSOR FOR (SELECT KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO'
        +#13#10'         FROM  EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
        +#13#10'         ORDER BY KEST_PRODUTO );'
        +#13#10'DECLARE CURSOR_ENCERRAMENTO CURSOR FOR (SELECT KSYS$DOMAIN, ANO_MES, ENCERRADO'
        +#13#10'         FROM EST_ENCERRAMENTO_MES'
        +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES );'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10''
        +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
        +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
        +#13#10''
        +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''01'' ) THEN'
        +#13#10'     ANO_MES_ANT = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) - 1), 4 ) || ''12'' ;'
        +#13#10'   ELSE'
        +#13#10'     ANO_MES_ANT = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) - 1), 2) ;'
        +#13#10''
        +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
        +#13#10'     ANO_MES_PROX = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
        +#13#10'   ELSE'
        +#13#10'     ANO_MES_PROX = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1), 2) ;'
        +#13#10''
        +#13#10'   PROX_MES = CAST ( SUBSTRING( ANO_MES_PROX FROM 1 FOR 4 ) || ''-'' || SUBSTRING( ANO_MES_PROX FROM 5 FOR 2 ) || ''-01'' AS DATE  ) ;'
        +#13#10''
        +#13#10''
        +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
        +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
        +#13#10''
        +#13#10''
        +#13#10'  OPEN SOURCE ;'
        +#13#10'  FETCH SOURCE'
        +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR  ;'
        +#13#10'  RC_SOURCE = ROW_COUNT ;'
        +#13#10''
        +#13#10'  OPEN TARGET ;'
        +#13#10'  FETCH TARGET'
        +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'  RC_TARGET = ROW_COUNT ;'
        +#13#10''
        +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
        +#13#10'    BEGIN'
        +#13#10''
        +#13#10'       IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
        +#13#10'        LEAVE ;'
        +#13#10''
        +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
        +#13#10'        BEGIN'
        +#13#10'          IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
        +#13#10'               SOURCE_ESTOQUE_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'          IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
        +#13#10'               SOURCE_QTDE_ENTRADAS = 0 ;'
        +#13#10''
        +#13#10'          IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
        +#13#10'               SOURCE_CM_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'          SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
        +#13#10'          IF ( SOMA_EA_QE = 0 ) THEN'
        +#13#10'             SOMA_EA_QE = 1 ;'
        +#13#10''
        +#13#10'          CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
        +#13#10''
        +#13#10''
        +#13#10'          --update target'
        +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
        +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
        +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM CUSTO_MEDIO  ) ) then'
        +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'                  SET'
        +#13#10'                   NOME            = :SOURCE_NOME,'
        +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
        +#13#10'                   CUSTO_MEDIO     = :CUSTO_MEDIO'
        +#13#10'                WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
        +#13#10'          EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
        +#13#10''
        +#13#10'          -- next source'
        +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
        +#13#10'          RC_SOURCE = ROW_COUNT ;'
        +#13#10'          -- next target'
        +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'          RC_TARGET = ROW_COUNT ;'
        +#13#10'        END'
        +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
        +#13#10'          BEGIN'
        +#13#10'            -- delete target'
        +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
        +#13#10''
        +#13#10'            -- next target'
        +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'            RC_TARGET = ROW_COUNT ;'
        +#13#10'          END'
        +#13#10'       ELSE'
        +#13#10'          BEGIN'
        +#13#10'            IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
        +#13#10'                 SOURCE_ESTOQUE_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'            IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
        +#13#10'                 SOURCE_QTDE_ENTRADAS = 0 ;'
        +#13#10''
        +#13#10'            IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
        +#13#10'                 SOURCE_CM_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'            SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
        +#13#10'            IF ( SOMA_EA_QE = 0 ) THEN'
        +#13#10'               SOMA_EA_QE = 1 ;'
        +#13#10''
        +#13#10'            CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
        +#13#10''
        +#13#10'            -- insert into target'
        +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
        +#13#10'            VALUES'
        +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
        +#13#10''
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
        +#13#10''
        +#13#10'            -- next source'
        +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
        +#13#10'            RC_SOURCE = ROW_COUNT ;'
        +#13#10'          END'
        +#13#10''
        +#13#10'    END'
        +#13#10''
        +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
        +#13#10'    BEGIN'
        +#13#10'       IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
        +#13#10'          SOURCE_ESTOQUE_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'       IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
        +#13#10'          SOURCE_QTDE_ENTRADAS = 0 ;'
        +#13#10''
        +#13#10'       IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
        +#13#10'          SOURCE_CM_ANTERIOR = 0 ;'
        +#13#10''
        +#13#10'       SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
        +#13#10'       IF ( SOMA_EA_QE = 0 ) THEN'
        +#13#10'          SOMA_EA_QE = 1 ;'
        +#13#10''
        +#13#10'       CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
        +#13#10''
        +#13#10'      -- insert target'
        +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
        +#13#10'      VALUES'
        +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
        +#13#10''
        +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
        +#13#10'      EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
        +#13#10''
        +#13#10'      -- next source'
        +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
        +#13#10'      RC_SOURCE = ROW_COUNT ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
        +#13#10'    BEGIN'
        +#13#10'       -- delete target'
        +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
        +#13#10'       EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
        +#13#10''
        +#13#10'       -- next target'
        +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'       RC_TARGET = ROW_COUNT ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
        +#13#10''
        +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
        +#13#10'    BEGIN'
        +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
        +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
        +#13#10''
        +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
        +#13#10'       SET ENCERRADO = ''T'''
        +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
        +#13#10''
        +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  CLOSE TARGET ;'
        +#13#10'  CLOSE SOURCE ;'
        +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
        +#13#10''
        +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
        +#13#10'                    WHERE KSYS$DOMAIN = :KDOMAIN'
        +#13#10'                      AND ANO_MES = :ANO_MES_PROX ) ) THEN'
        +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KSYS$DOMAIN, ANO_MES )'
        +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES_PROX ) ;'
        +#13#10''
        +#13#10'END';

begin
  TryExecuteDirect( _CREATE_DEV_PEDIDO_ITENS_BIUD0 );
  TryExecuteDirect( _CREATE_ECRM_DEV_PEDIDO_ITENS );
  TryExecuteDirect( _CREATE_DEV_PEDIDO_ITENS_AIUD0 );
  TryExecuteDirect( _CREATE_DEV_PEDIDOS_BIUD0 );
  TryExecuteDirect( _CREATE_ECRM_DEV_PEDIDOS );
  TryExecuteDirect( _CREATE_DEV_PEDIDOS_AUD0 );
  TryExecuteDirect( _ALTER_EST_UPDATE_MOVIMENTO );
  TryExecuteDirect( _ALTER_EST_ENCERRAR_MES );
end;

procedure TDBFinanceiroUpdate._5_002_02;
const
  _UPDATE_EST_PRODUTOS =
             'UPDATE EST_PRODUTOS P'
      +#13#10'   SET P.UNIDADE = (SELECT U.DESCRICAO'
      +#13#10'                      FROM CAD_TIPOS U WHERE U.KCAD_TIPOS = P.KCAD_UNIDADE AND U.TIPO = 2)'
      +#13#10' WHERE P.KCAD_UNIDADE IS NOT NULL AND P.KCAD_UNIDADE <> '''' ';

begin
  TryExecuteDirect( _UPDATE_EST_PRODUTOS );
end;


procedure TDBFinanceiroUpdate._5_002_01;
const

   _CREATE_OR_ALTER_PROCEDURE_SYS_ENDOFDAY =
          'CREATE OR ALTER PROCEDURE SYS$ENDOFDAY ('
   +#13#10'    ATIMESTAMP TIMESTAMP)'
   +#13#10'RETURNS ('
   +#13#10'    AENDOFDAYTIMESTAMP TIMESTAMP)'
   +#13#10'AS'
   +#13#10'BEGIN'
   +#13#10'  AENDOFDAYTIMESTAMP =  DATEADD(-1 MILLISECOND TO CAST(CAST(ATIMESTAMP AS DATE) + 1 AS TIMESTAMP));'
   +#13#10'  SUSPEND;'
   +#13#10'END' ;

   _CREATE_OR_ALTER_PROCEDURE_SYS_COMPARE_TIMESTAMP =
          'CREATE OR ALTER PROCEDURE SYS$COMPARE_TIMESTAMP ('
   +#13#10'    ATIMESTAMP1 TIMESTAMP,'
   +#13#10'    ATIMESTAMP2 TIMESTAMP)'
   +#13#10'RETURNS ('
   +#13#10'    RESULT INTEGER)'
   +#13#10'AS'
   +#13#10'BEGIN'
   +#13#10'    RESULT = 0;'
   +#13#10'    IF (DATEADD(-1 * EXTRACT(MILLISECOND FROM ATIMESTAMP1) MILLISECOND TO ATIMESTAMP1) ='
   +#13#10'        DATEADD(-1 * EXTRACT(MILLISECOND FROM ATIMESTAMP2) MILLISECOND TO ATIMESTAMP2)) THEN'
   +#13#10'      RESULT = 1;'
   +#13#10'    SUSPEND;'
   +#13#10'END' ;


   _CREATE_OR_ALTER_PROCEDURE_SYS_SPLIT =
          'CREATE OR ALTER PROCEDURE SYS$SPLIT('
   +#13#10'    SEPARATOR VARCHAR(10),'
   +#13#10'    ASTRING VARCHAR(8000))'
   +#13#10'RETURNS ('
   +#13#10'    STRINGITEM VARCHAR(1000))'
   +#13#10'AS'
   +#13#10'DECLARE VARIABLE STR VARCHAR(8000);'
   +#13#10'DECLARE VARIABLE POS INTEGER;'
   +#13#10'DECLARE VARIABLE SEPARATOR_LENGTH INTEGER;'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  STR = ASTRING;'
   +#13#10'  SEPARATOR_LENGTH = CHAR_LENGTH(SEPARATOR);'
   +#13#10'  '
   +#13#10'  IF (SEPARATOR_LENGTH>0) THEN'
   +#13#10'  BEGIN'
   +#13#10'    POS = POSITION(SEPARATOR, STR);'
   +#13#10'  '
   +#13#10'    WHILE (POS <> 0) DO'
   +#13#10'    BEGIN'
   +#13#10'      IF (POS>1) THEN'
   +#13#10'      BEGIN'
   +#13#10'        STRINGITEM = SUBSTRING(STR FROM 1 FOR (POS-1));'
   +#13#10'        SUSPEND;'
   +#13#10'      END'
   +#13#10'      STR = SUBSTRING(STR FROM (POS+SEPARATOR_LENGTH) );'
   +#13#10'      POS = POSITION(SEPARATOR, STR);'
   +#13#10'    END'
   +#13#10'  END'
   +#13#10'  '
   +#13#10'  IF (CHAR_LENGTH(STR) >0 ) THEN'
   +#13#10'  BEGIN'
   +#13#10'    STRINGITEM = STR;'
   +#13#10'    SUSPEND;'
   +#13#10'  END'
   +#13#10''
   +#13#10'END' ;


   _CREATE_OR_ALTER_PROCEDURE_SYS_SPLIT_INTEGER_STRING =
          'CREATE OR ALTER PROCEDURE SYS$SPLIT_INTEGER_STRING ('
   +#13#10'    ASTRING VARCHAR(100))'
   +#13#10'RETURNS ('
   +#13#10'    N INTEGER,'
   +#13#10'    AN VARCHAR(100))'
   +#13#10'AS'
   +#13#10'DECLARE VARIABLE I INTEGER;'
   +#13#10'DECLARE VARIABLE TMP_N VARCHAR(100);'
   +#13#10'DECLARE VARIABLE C VARCHAR(1);'
   +#13#10'BEGIN'
   +#13#10'    I = 1;'
   +#13#10'    TMP_N = '''';'
   +#13#10'    N = 0;'
   +#13#10'    AN = '''';'
   +#13#10'    WHILE (I <= CHAR_LENGTH(ASTRING)) DO'
   +#13#10'    BEGIN'
   +#13#10'      C = SUBSTRING(ASTRING FROM I FOR 1);'
   +#13#10'      IF (C IN (''1'',''2'',''3'',''4'',''5'',''6'',''7'',''8'',''9'',''0'') AND (AN = '''')) THEN'
   +#13#10'        TMP_N = TMP_N || C;'
   +#13#10'      ELSE'
   +#13#10'        AN = AN || C;'
   +#13#10'      I = I + 1;'
   +#13#10'    END'
   +#13#10''
   +#13#10'    IF (TMP_N <> '''' ) THEN'
   +#13#10'    BEGIN'
   +#13#10'      N = CAST(TMP_N AS INTEGER);'
   +#13#10'    END'
   +#13#10'    SUSPEND;'
   +#13#10''
   +#13#10'END'  ;

   _CREATE_OR_ALTER_PROCEDURE_SYS_TIMESTAMP_TO_UNIX_TIMESTAMP =
          'CREATE OR ALTER PROCEDURE SYS$TIMESTAMP_TO_UNIX_TIMESTAMP ('
   +#13#10'    ATIMESTAMP TIMESTAMP)'
   +#13#10'RETURNS ('
   +#13#10'    UNIX_TIMESTAMP BIGINT)'
   +#13#10'AS'
   +#13#10'  DECLARE VARIABLE UNIX_OFFSET TIMESTAMP = ''1970-01-01 00:00:00'';'
   +#13#10'BEGIN'
   +#13#10'  IF ((ATIMESTAMP IS NOT NULL) AND (ATIMESTAMP >= UNIX_OFFSET)) THEN'
   +#13#10'    UNIX_TIMESTAMP = DATEDIFF(SECOND, :UNIX_OFFSET, :ATIMESTAMP) * 1000;'
   +#13#10'  ELSE'
   +#13#10'    UNIX_TIMESTAMP = 0;'
   +#13#10'  SUSPEND;'
   +#13#10'END' ;

   _CREATE_OR_ALTER_PROCEDURE_SYS_UNIX_TIMESTAMP_TO_TIMESTAMP =
          'CREATE OR ALTER PROCEDURE SYS$UNIX_TIMESTAMP_TO_TIMESTAMP ('
   +#13#10'    AUNIX_TIMESTAMP BIGINT)'
   +#13#10'RETURNS ('
   +#13#10'    ATIMESTAMP TIMESTAMP)'
   +#13#10'AS'
   +#13#10'  DECLARE VARIABLE UNIX_OFFSET TIMESTAMP = ''1970-01-01 00:00:00'';'
   +#13#10'BEGIN'
   +#13#10'  /* PROCEDURE SYS$TEXT */'
   +#13#10'  ATIMESTAMP = DATEADD(:AUNIX_TIMESTAMP / 1000 SECOND TO :UNIX_OFFSET);'
   +#13#10'  SUSPEND;'
   +#13#10'END' ;


   _CREATE_OR_ALTER_PROCEDURE_SYS_REPLACE_ITEM_IN_STRING =
          'CREATE OR ALTER PROCEDURE SYS$REPLACE_ITEM_IN_STRING ('
   +#13#10'    SEPARATOR VARCHAR(10),'
   +#13#10'    ASTRING VARCHAR(8000),'
   +#13#10'    AOLDVALUE VARCHAR(10),'
   +#13#10'    ANEWVALUE VARCHAR(10))'
   +#13#10'RETURNS ('
   +#13#10'    ARESULT VARCHAR(8000))'
   +#13#10'AS'
   +#13#10'DECLARE VARIABLE STR VARCHAR(8000);'
   +#13#10'DECLARE VARIABLE POS INTEGER;'
   +#13#10'DECLARE VARIABLE STRINGITEM VARCHAR(1000);'
   +#13#10'DECLARE VARIABLE SEPARATOR_LENGTH INTEGER;'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  STR = ASTRING;'
   +#13#10'  SEPARATOR_LENGTH = CHAR_LENGTH(SEPARATOR);'
   +#13#10'  '
   +#13#10'  IF (SEPARATOR_LENGTH > 0) THEN'
   +#13#10'  BEGIN'
   +#13#10'    POS = POSITION(SEPARATOR, STR);'
   +#13#10'  '
   +#13#10'    WHILE (POS <> 0) DO'
   +#13#10'    BEGIN'
   +#13#10'      IF (POS > 1) THEN'
   +#13#10'      BEGIN'
   +#13#10'        STRINGITEM = SUBSTRING(STR FROM 1 FOR (POS-1));'
   +#13#10'        IF (STRINGITEM = :AOLDVALUE) THEN'
   +#13#10'          STRINGITEM = :ANEWVALUE;'
   +#13#10''
   +#13#10'        IF (:ARESULT IS NULL) THEN'
   +#13#10'          ARESULT = STRINGITEM;'
   +#13#10'        ELSE IF (:STRINGITEM IS NOT NULL) THEN'
   +#13#10'          ARESULT = ARESULT || SEPARATOR || STRINGITEM;'
   +#13#10''
   +#13#10'      END'
   +#13#10'      STR = SUBSTRING(STR FROM (POS+SEPARATOR_LENGTH) );'
   +#13#10'      POS = POSITION(SEPARATOR, STR);'
   +#13#10'    END'
   +#13#10'  END'
   +#13#10'  '
   +#13#10'  IF (CHAR_LENGTH(STR) > 0 ) THEN'
   +#13#10'  BEGIN'
   +#13#10'    STRINGITEM = STR;'
   +#13#10''
   +#13#10'    IF (STRINGITEM = :AOLDVALUE) THEN'
   +#13#10'      STRINGITEM = :ANEWVALUE;'
   +#13#10''
   +#13#10'    IF (:ARESULT IS NULL) THEN'
   +#13#10'      ARESULT = STRINGITEM;'
   +#13#10'    ELSE IF (:STRINGITEM IS NOT NULL) THEN'
   +#13#10'      ARESULT = ARESULT || SEPARATOR || STRINGITEM;'
   +#13#10''
   +#13#10'  END'
   +#13#10''
   +#13#10'  SUSPEND;'
   +#13#10''
   +#13#10'END' ;

begin
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_ENDOFDAY                     ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_COMPARE_TIMESTAMP            ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_SPLIT                        ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_SPLIT_INTEGER_STRING         ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_TIMESTAMP_TO_UNIX_TIMESTAMP  ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_UNIX_TIMESTAMP_TO_TIMESTAMP  ) ;
   ExecuteDirect ( _CREATE_OR_ALTER_PROCEDURE_SYS_REPLACE_ITEM_IN_STRING       ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_98 ;
const
  _UPDATE_CENTROCUSTO_FRISIA =
            'EXECUTE BLOCK'
     +#13#10'AS'
     +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
     +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20 ;'
     +#13#10'BEGIN'
     +#13#10'  FOR SELECT'
     +#13#10'    KFIN_APAGAR,'
     +#13#10'    IIF ('
     +#13#10'         SUBSTRING( NOME FROM POSITION ( '' - '', NOME ) + 3 FOR 50 ) = ''CTA. PEC. LEITE'''
     +#13#10'       , (SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
     +#13#10'          WHERE KDEF_CENTROCUSTO = ''La;m;0+smOQ+4RnK^6as'''
     +#13#10'         )'
     +#13#10'       , (SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
     +#13#10'          WHERE NOME = ''CTA. EXTRA - ATIVIDADE'''
     +#13#10'            AND ANALITICO_SINTETICO = ''A'''
     +#13#10'         )'
     +#13#10'    ) KFIN_CENTROCUSTO'
     +#13#10'  FROM ('
     +#13#10'       SELECT KFIN_APAGAR'
     +#13#10'       , (SELECT P.KFIN_CONTA'
     +#13#10'          FROM FIN_APAGAR_PARCELAS P'
     +#13#10'          WHERE P.KFIN_APAGAR = FIN_APAGAR.KFIN_APAGAR'
     +#13#10'          ROWS 1'
     +#13#10'         ) KFIN_CONTA'
     +#13#10'       FROM FIN_APAGAR'
     +#13#10'       WHERE'
     +#13#10'              HISTORICO STARTING  ''Débito'''
     +#13#10'          AND KFIN_PLANOCONTA IS NOT NULL'
     +#13#10'          AND TABLENAME IS NULL'
     +#13#10'          AND NOT EXISTS ( SELECT 1 FROM FIN_APROPRIACAO WHERE TABLEKEY = KFIN_APAGAR )'
     +#13#10'       )'
     +#13#10'  LEFT JOIN FIN_CONTAS USING ( KFIN_CONTA )'
     +#13#10'  INTO KFIN_APAGAR, KFIN_CENTROCUSTO'
     +#13#10'  DO'
     +#13#10'    IF (    KFIN_CENTROCUSTO IS NOT NULL'
     +#13#10'        AND NOT EXISTS'
     +#13#10'            (SELECT 1'
     +#13#10'             FROM FIN_APROPRIACAO'
     +#13#10'             WHERE'
     +#13#10'                  TABLENAME = ''FIN_APAGAR'''
     +#13#10'              AND TABLEKEY = ::KFIN_APAGAR'
     +#13#10'              ROWS 1'
     +#13#10'            )'
     +#13#10'         ) THEN'
     +#13#10'          INSERT INTO FIN_APROPRIACAO ('
     +#13#10'              KFIN_APROPRIACAO'
     +#13#10'            , TABLENAME'
     +#13#10'            , TABLEKEY'
     +#13#10'            , KFIN_CENTROCUSTO'
     +#13#10'            , PORCENTAGEM'
     +#13#10'          ) VALUES ('
     +#13#10'               GUID20()'
     +#13#10'            ,  ''FIN_APAGAR'''
     +#13#10'            , ::KFIN_APAGAR'
     +#13#10'            , ::KFIN_CENTROCUSTO'
     +#13#10'            , 100'
     +#13#10'          ) ;'
     +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
    if Fields[0].asInteger = 0 then
      exit ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_CENTROCUSTO_FRISIA )
    .SQLExec ;

end;
(*
procedure TDBFinanceiroUpdate._5_001_97 ;
const
  _UPDATE_CENTROCUSTO_RETENCAO =
            'EXECUTE BLOCK'
     +#13#10'AS'
     +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
     +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20 ;'
     +#13#10'BEGIN'
     +#13#10'  FOR SELECT'
     +#13#10'    KFIN_APAGAR,'
     +#13#10'    IIF ('
     +#13#10'         SUBSTRING( NOME FROM POSITION ( '' - '', NOME ) + 3 FOR 50 ) = ''CTA. PEC. LEITE'''
     +#13#10'       , (SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
     +#13#10'          WHERE KDEF_CENTROCUSTO = ''La;m;0+smOQ+4RnK^6as'''
     +#13#10'         )'
     +#13#10'       , (SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
     +#13#10'          WHERE NOME = ''CTA. EXTRA - ATIVIDADE'''
     +#13#10'            AND ANALITICO_SINTETICO = ''A'''
     +#13#10'         )'
     +#13#10'    ) KFIN_CENTROCUSTO'
     +#13#10'  FROM ('
     +#13#10'       SELECT KFIN_APAGAR'
     +#13#10'       , (SELECT P.KFIN_CONTA'
     +#13#10'          FROM FIN_APAGAR_PARCELAS P'
     +#13#10'          WHERE P.KFIN_APAGAR = FIN_APAGAR.KFIN_APAGAR'
     +#13#10'          ROWS 1'
     +#13#10'         ) KFIN_CONTA'
     +#13#10'       FROM FIN_APAGAR'
     +#13#10'       WHERE'
     +#13#10'          HISTORICO CONTAINING '' RETENCAO CAP.GIRO PROPRIO - RACOES-LEITE '''
     +#13#10'          AND NOT EXISTS ( SELECT 1 FROM FIN_APROPRIACAO WHERE TABLEKEY = KFIN_APAGAR )'
     +#13#10'       )'
     +#13#10'  LEFT JOIN FIN_CONTAS USING ( KFIN_CONTA )'
     +#13#10'  INTO KFIN_APAGAR, KFIN_CENTROCUSTO'
     +#13#10'  DO'
     +#13#10'    IF (    KFIN_CENTROCUSTO IS NOT NULL'
     +#13#10'        AND NOT EXISTS'
     +#13#10'            (SELECT 1'
     +#13#10'             FROM FIN_APROPRIACAO'
     +#13#10'             WHERE'
     +#13#10'                  TABLENAME = ''FIN_APAGAR'''
     +#13#10'              AND TABLEKEY = ::KFIN_APAGAR'
     +#13#10'              ROWS 1'
     +#13#10'            )'
     +#13#10'         ) THEN'
     +#13#10'          INSERT INTO FIN_APROPRIACAO ('
     +#13#10'              KFIN_APROPRIACAO'
     +#13#10'            , TABLENAME'
     +#13#10'            , TABLEKEY'
     +#13#10'            , KFIN_CENTROCUSTO'
     +#13#10'            , PORCENTAGEM'
     +#13#10'          ) VALUES ('
     +#13#10'               GUID20()'
     +#13#10'            ,  ''FIN_APAGAR'''
     +#13#10'            , ::KFIN_APAGAR'
     +#13#10'            , ::KFIN_CENTROCUSTO'
     +#13#10'            , 100'
     +#13#10'          ) ;'
     +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
    if Fields[0].asInteger = 0 then
      exit ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_CENTROCUSTO_RETENCAO )
    .SQLExec ;

end;
*)


procedure TDBFinanceiroUpdate._5_001_96;
const
  _SELECT_APROPRIACAO_DUPLICADA =
       'SELECT 1 FROM FIN_APROPRIACAO S'
+#13#10'WHERE EXISTS'
+#13#10'  (SELECT 1 FROM FIN_APROPRIACAO D'
+#13#10'   WHERE'
+#13#10'        D.TABLENAME   = S.TABLENAME'
+#13#10'    AND D.TABLEKEY    = S.TABLEKEY'
+#13#10'    AND D.PORCENTAGEM = S.PORCENTAGEM'
+#13#10'    AND S.PORCENTAGEM = 100'
+#13#10'    AND D.RDB$DB_KEY  > S.RDB$DB_KEY'
+#13#10'  )' ;

  _DELETE_APROPRIACAO_DUPLICADA =
       'DELETE FROM FIN_APROPRIACAO S'
+#13#10'WHERE EXISTS'
+#13#10'  (SELECT 1 FROM FIN_APROPRIACAO D'
+#13#10'   WHERE'
+#13#10'        D.TABLENAME   = S.TABLENAME'
+#13#10'    AND D.TABLEKEY    = S.TABLEKEY'
+#13#10'    AND D.PORCENTAGEM = S.PORCENTAGEM'
+#13#10'    AND S.PORCENTAGEM = 100'
+#13#10'    AND D.RDB$DB_KEY  > S.RDB$DB_KEY'
+#13#10'  )' ;
begin
  while TTcAbstractDB
    .GetByAlias('FINANCEIRO')
    .ISQL( _SELECT_APROPRIACAO_DUPLICADA )
    .GetDS
    .Fields[0].asInteger = 1
  do
   ExecuteDirect ( _DELETE_APROPRIACAO_DUPLICADA ) ;
end;

procedure TDBFinanceiroUpdate._5_001_95;
const
   _CREATE_TABLE_FIN_FINANCIAMENTOS_GERAL =
                 'CREATE TABLE FIN_FINANCIAMENTOS_GERAL('
          +#13#10'KFIN_FINANCIAMENTO_GERAL SYS$PKGUID20 NOT NULL,'
          +#13#10'KSYS$DOMAIN SYS$FKGUID20_NN,'
          +#13#10'KCAD_ENTIDADE SYS$FKGUID20,'
          +#13#10'NOMEENTIDADE SYS$DESCR,'
          +#13#10'HISTORICO SYS$DESCR,'
          +#13#10'APELIDO SYS$DESCR,'
          +#13#10'DOCUMENTO FIN$DOC,'
          +#13#10'DATALANCTO SYS$DATE_DEF,'
          +#13#10'VALOR SYS$FLOAT,'
          +#13#10'PROVISAO SYS$BOOL_F,'
          +#13#10'CONTA_ORIGEM FIN$DESCCONTA,'
          +#13#10'CONTA_DESTINO FIN$DESCCONTA,'
          +#13#10'VALOR_PARCELAS SYS$FLOAT,'
          +#13#10'NUM_PARCELAS SYS$INT_NN_0,'
          +#13#10'DIA_VENCTO SYS$INT_NN_0,'
          +#13#10'PROXIMO_MES SYS$BOOL_F,'
          +#13#10'KFIN_ARECEBER_FINANCIAMENTO SYS$FKGUID20,'
          +#13#10'KFIN_APAGAR_AMORTIZACAO SYS$FKGUID20,'
          +#13#10'KFIN_APAGAR_JUROS SYS$FKGUID20,'
          +#13#10'KFIN_APAGAR_DESPESAS SYS$FKGUID20,'
          +#13#10'KFIN_CONTA_PREF SYS$FKGUID20,'
          +#13#10'KFIN_PLANOCONTA SYS$FKGUID20,'
          +#13#10'OBS SYS$BLOBTEXT,'
          +#13#10'ATIVO SYS$BOOL_T,'
          +#13#10'IMPORTADO SYS$BOOL_F,'
          +#13#10'SYS$UI SYS$USERLOGIN,'
          +#13#10'SYS$DI SYS$DATE,'
          +#13#10'SYS$UU SYS$USERLOGIN,'
          +#13#10'SYS$DU SYS$DATE,'
          +#13#10'SYS$ORIGIN_TYPE SYS$INT_NN_0,'
          +#13#10'CONSTRAINT PK_FIN_FINANCIAMENTO_GERAL PRIMARY KEY(KFIN_FINANCIAMENTO_GERAL) )';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_01 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_GERAL'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_GERAL_01'
          +#13#10'FOREIGN KEY (KSYS$DOMAIN)'
          +#13#10'REFERENCES SYS$DOMAINS(KSYS$DOMAIN)'
          +#13#10'ON DELETE CASCADE'
          +#13#10'ON UPDATE CASCADE';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_02 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_GERAL'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_GERAL_02'
          +#13#10'FOREIGN KEY (KCAD_ENTIDADE)'
          +#13#10'REFERENCES CAD_ENTIDADES(KCAD_ENTIDADE)'
          +#13#10'ON DELETE SET NULL'
          +#13#10'ON UPDATE CASCADE';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_03 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_GERAL'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_GERAL_03'
          +#13#10'FOREIGN KEY (KFIN_CONTA_PREF)'
          +#13#10'REFERENCES FIN_CONTAS(KFIN_CONTA)'
          +#13#10'ON DELETE SET NULL'
          +#13#10'ON UPDATE CASCADE';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_04 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_GERAL'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_GERAL_04'
          +#13#10'FOREIGN KEY (KFIN_PLANOCONTA)'
          +#13#10'REFERENCES FIN_PLANOCONTAS(KFIN_PLANOCONTA)'
          +#13#10'ON UPDATE CASCADE';

   _CREATE_TABLE_FIN_FINANCIAMENTOS_PARCELAS =
                 'CREATE TABLE FIN_FINANCIAMENTOS_PARCELAS('
          +#13#10'KFIN_FINANCIAMENTO_PARCELA SYS$PKGUID20,'
          +#13#10'KFIN_FINANCIAMENTO_GERAL SYS$FKGUID20_NN,'
          +#13#10'DOCUMENTO FIN$DOC,'
          +#13#10'VENCTO SYS$DATE_NN,'
          +#13#10'VALOR SYS$FLOAT_NN_0,'
          +#13#10'PRORROGACAO SYS$DATE,'
          +#13#10'OBS SYS$BLOBTEXT,'
          +#13#10'DUVIDOSO SYS$BOOL_F,'
          +#13#10'PREVISAO SYS$BOOL_F,'
          +#13#10'JUROS SYS$FLOAT,'
          +#13#10'AMORTIZACAO SYS$FLOAT,'
          +#13#10'PAGTO SYS$DATE,'
          +#13#10'PAGO SYS$FLOAT,'
          +#13#10'JURO_DESCONTO SYS$FLOAT,'
          +#13#10'KFIN_PLANOCONTA_JURO_DESCONTO SYS$FKGUID20,'
          +#13#10'CHEQUE SYS$BOOL_F,'
          +#13#10'NUM_CHEQUE FIN$DOC,'
          +#13#10'KFIN_CONTA SYS$FKGUID20,'
          +#13#10'DT_COMPENSACAO SYS$DATE,'
          +#13#10'KFIN_APAGAR_PARCELA SYS$FKGUID20,'
          +#13#10'SYS$UI SYS$USERLOGIN,'
          +#13#10'SYS$DI SYS$DATE,'
          +#13#10'SYS$UU SYS$USERLOGIN,'
          +#13#10'SYS$DU SYS$DATE,'
          +#13#10'CONSTRAINT PK_FINANCIAMENTOS_PARCELAS PRIMARY KEY (KFIN_FINANCIAMENTO_PARCELA) )';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_01 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_PARCELAS'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_PARCEL_01'
          +#13#10'FOREIGN KEY (KFIN_FINANCIAMENTO_GERAL)'
          +#13#10'REFERENCES FIN_FINANCIAMENTOS_GERAL(KFIN_FINANCIAMENTO_GERAL)'
          +#13#10'ON DELETE CASCADE'
          +#13#10'ON UPDATE CASCADE';


   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_02 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_PARCELAS'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_PARCEL_02'
          +#13#10'FOREIGN KEY (KFIN_PLANOCONTA_JURO_DESCONTO)'
          +#13#10'REFERENCES FIN_PLANOCONTAS(KFIN_PLANOCONTA)'
          +#13#10'ON UPDATE CASCADE';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_03 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_PARCELAS'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_PARCEL_03'
          +#13#10'FOREIGN KEY (KFIN_CONTA)'
          +#13#10'REFERENCES FIN_CONTAS(KFIN_CONTA)'
          +#13#10'ON UPDATE CASCADE';

   _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_04 =
                 'ALTER TABLE FIN_FINANCIAMENTOS_PARCELAS'
          +#13#10'ADD CONSTRAINT FKFIN_FINANCIAMENTOS_PARCEL_04'
          +#13#10'FOREIGN KEY (KFIN_APAGAR_PARCELA)'
          +#13#10'REFERENCES FIN_APAGAR_PARCELAS(KFIN_APAGAR_PARCELA)'
          +#13#10'ON UPDATE CASCADE';


begin
  TryExecuteDirect( _CREATE_TABLE_FIN_FINANCIAMENTOS_GERAL );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_01 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_02 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_03 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_GERAL_04 );

  TryExecuteDirect( _CREATE_TABLE_FIN_FINANCIAMENTOS_PARCELAS );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_01 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_02 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_03 );
  TryExecuteDirect( _ADD_CONSTRAINT_FKFIN_FINANCIAMENTOS_PARCEL_04 );
end;


procedure TDBFinanceiroUpdate._5_001_94 ;
const
  _UPDATE_SERIE_NF_COMPRA =
         'UPDATE CMP_PEDIDOS'
  +#13#10' SET SERIE = '''''
  +#13#10'WHERE SERIE IS NULL' ;

  _UPDATE_SERIE_NF_VENDA =
         'UPDATE VND_PEDIDOS'
  +#13#10' SET SERIE = '''''
  +#13#10'WHERE SERIE IS NULL' ;
var
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_SERIE_NF_COMPRA )
    .SQLExec ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_SERIE_NF_VENDA )
    .SQLExec ;

end;


procedure TDBFinanceiroUpdate._5_001_92 ;
const
  _UPDATE_RETENCAO =
         'UPDATE FIN_APAGAR'
  +#13#10' SET KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
  +#13#10'WHERE HISTORICO CONTAINING '' RETENCAO CAP.GIRO PROPRIO - RACOES-LEITE '''
  +#13#10'  AND KFIN_PLANOCONTA IS NULL' ;
var
  LKeyPlanoContas : string ;
begin
  LKeyPlanoContas := TPlanoContasDespesasReceitas.GetKeyBancos ;
  if ( LKeyPlanoContas = '' ) then
     Exit ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_RETENCAO )
    .SQLParamValues( 'KFIN_PLANOCONTA', LKeyPlanoContas )
    .SQLExec ;

end;


procedure TDBFinanceiroUpdate._5_001_91;
const
  _ALTER_TABLE_CMP_PEDIDOS =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'  ADD TOTAL_PATRIMONIOS SYS$FLOAT_NN_0'
  +#13#10', ALTER TOTAL_PATRIMONIOS POSITION 19' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_90;
const
  _UPDATE_JUROS_FINANCIAMENTO =
         'EXECUTE BLOCK ( KFIN_PLANOCONTA_JURO_DESCONTO TYPE OF COLUMN FIN_APAGAR_PARCELAS.KFIN_PLANOCONTA_JURO_DESCONTO = :KFIN_PLANOCONTA_JURO_DESCONTO )'
  +#13#10'AS'
  +#13#10'DECLARE KFIN_APAGAR_PARCELA TYPE OF COLUMN FIN_APAGAR_PARCELAS.KFIN_APAGAR_PARCELA ;'
  +#13#10'BEGIN'
  +#13#10'   FOR SELECT'
  +#13#10'     P.KFIN_APAGAR_PARCELA'
  +#13#10'   FROM FIN_APAGAR A'
  +#13#10'   LEFT JOIN FIN_APAGAR_PARCELAS P USING ( KFIN_APAGAR )'
  +#13#10'   WHERE A.TABLENAME = ''FIN_FINANCIAMENTOS'''
  +#13#10'      AND P.JURO_DESCONTO <> 0'
  +#13#10'   INTO KFIN_APAGAR_PARCELA'
  +#13#10'   DO'
  +#13#10'     UPDATE FIN_APAGAR_PARCELAS'
  +#13#10'     SET'
  +#13#10'       KFIN_PLANOCONTA_JURO_DESCONTO = ::KFIN_PLANOCONTA_JURO_DESCONTO'
  +#13#10'     WHERE KFIN_APAGAR_PARCELA = ::KFIN_APAGAR_PARCELA ;'
  +#13#10'END' ;
var
 LKeyJurosFinanciamento : string ;
begin

  LKeyJurosFinanciamento :=
    UFIN_PlanoContasReceitasDespesasClass
     .TPlanoContasDespesasReceitas
     .GetKeyJurosFinanciamentos ;

  if LKeyJurosFinanciamento = '' then
     exit ;

   TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_JUROS_FINANCIAMENTO )
    .SQLParamValues( 'KFIN_PLANOCONTA_JURO_DESCONTO', LKeyJurosFinanciamento )
    .SQLExec ;
end ;



procedure TDBFinanceiroUpdate._5_001_89;
const
  _UPDATE_APROPRIACAO_JUROS =
         'UPDATE FIN_APROPRIACAO'
  +#13#10'SET'
  +#13#10'    TABLEKEY = TABLENAME'
  +#13#10'  , TABLENAME = ''FIN_APAGAR'''
  +#13#10'WHERE TABLEKEY = ''FIN_APAGAR''' ;

begin
  ExecuteDirect ( _UPDATE_APROPRIACAO_JUROS ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_88;
const
  _UPDATE_RETENCAO =
         'UPDATE FIN_APAGAR'
  +#13#10' SET RECORRENCIA = ''T'''
  +#13#10'WHERE HISTORICO CONTAINING '' RETENCAO CAP.GIRO PROPRIO - RACOES-LEITE ''' ;
begin
  ExecuteDirect ( _UPDATE_RETENCAO ) ;
end;



procedure TDBFinanceiroUpdate._5_001_87;
const
  _UPDATE_PRODUTOS_DUPLICADOS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO TYPE OF COLUMN EST_PRODUTOS.KEST_PRODUTO ;'
  +#13#10'DECLARE NOME TYPE OF COLUMN EST_PRODUTOS.NOME ;'
  +#13#10'DECLARE KFRISIA_PRODUTO TYPE OF COLUMN FRISIA_PRODUTOS.KFRISIA_PRODUTO ;'
  +#13#10'DECLARE NEW_KEST_PRODUTO TYPE OF COLUMN EST_PRODUTOS.KEST_PRODUTO ;'
  +#13#10'DECLARE FRISIA_KEST_PRODUTO SYS$FKGUID20 = NULL ;'
  +#13#10'DECLARE LAST_NOME TYPE OF COLUMN EST_PRODUTOS.NOME = '''' ;'
  +#13#10'DECLARE DATA_SALDOINICIAL TYPE OF COLUMN EST_PRODUTOS.DATA_SALDOINICIAL ;'
  +#13#10'DECLARE NEW_DATA_SALDOINICIAL TYPE OF COLUMN EST_PRODUTOS.DATA_SALDOINICIAL ;'
  +#13#10'DECLARE QTDE_INICIAL TYPE OF COLUMN EST_PRODUTOS.QTDE_INICIAL ;'
  +#13#10'DECLARE NEW_QTDE_INICIAL TYPE OF COLUMN EST_PRODUTOS.QTDE_INICIAL ;'
  +#13#10'BEGIN'
  +#13#10'  FOR SELECT'
  +#13#10'     S.NOME FROM EST_PRODUTOS S'
  +#13#10'  WHERE S.ATIVO  = ''T'''
  +#13#10'    AND EXISTS'
  +#13#10'    (SELECT 1 FROM EST_PRODUTOS D'
  +#13#10'     WHERE'
  +#13#10'         D.NOME   = S.NOME'
  +#13#10'     AND D.ATIVO  = ''T''    '
  +#13#10'     AND D.RDB$DB_KEY  > S.RDB$DB_KEY'
  +#13#10'   )'
  +#13#10'  INTO NOME'
  +#13#10'  DO'
  +#13#10'  FOR SELECT '
  +#13#10'       P.KEST_PRODUTO'
  +#13#10'     , P.DATA_SALDOINICIAL  '
  +#13#10'     , P.QTDE_INICIAL'
  +#13#10'     , F.KEST_PRODUTO'
  +#13#10'  FROM EST_PRODUTOS P'
  +#13#10'  LEFT JOIN FRISIA_PRODUTOS F USING ( KEST_PRODUTO )'
  +#13#10'  WHERE P.NOME = ::NOME'
  +#13#10'  ORDER BY F.KFRISIA_PRODUTO NULLS LAST'
  +#13#10'  INTO KEST_PRODUTO, DATA_SALDOINICIAL, QTDE_INICIAL, FRISIA_KEST_PRODUTO'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'      IF ( NOME <> LAST_NOME ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         LAST_NOME             = NOME ;'
  +#13#10'         NEW_KEST_PRODUTO      = FRISIA_KEST_PRODUTO ; '
  +#13#10'         NEW_DATA_SALDOINICIAL = DATA_SALDOINICIAL ;'
  +#13#10'         NEW_QTDE_INICIAL      = QTDE_INICIAL ;'
  +#13#10'        END'
  +#13#10'      IF ( NEW_KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'        BEGIN'
  +#13#10'         IF ( KEST_PRODUTO <> NEW_KEST_PRODUTO ) THEN'
  +#13#10'           BEGIN '
  +#13#10''
  +#13#10'             NEW_QTDE_INICIAL = NEW_QTDE_INICIAL + QTDE_INICIAL ;'
  +#13#10''
  +#13#10'             IF ( DATA_SALDOINICIAL < NEW_DATA_SALDOINICIAL ) THEN'
  +#13#10'               NEW_DATA_SALDOINICIAL = DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'             UPDATE EST_PRODUTOS '
  +#13#10'               SET DATA_SALDOINICIAL = ::NEW_DATA_SALDOINICIAL'
  +#13#10'             WHERE '
  +#13#10'                    KEST_PRODUTO = ::NEW_KEST_PRODUTO '
  +#13#10'               AND  DATA_SALDOINICIAL > ::NEW_DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'             UPDATE EST_PRODUTOS '
  +#13#10'               SET QTDE_INICIAL = ::NEW_QTDE_INICIAL'
  +#13#10'             WHERE '
  +#13#10'                   KEST_PRODUTO = ::NEW_KEST_PRODUTO '
  +#13#10'               AND QTDE_INICIAL <> ::NEW_QTDE_INICIAL ;'
  +#13#10''
  +#13#10'             UPDATE CMP_PEDIDO_ITENS'
  +#13#10'               SET KEST_PRODUTO = ::NEW_KEST_PRODUTO'
  +#13#10'             WHERE '
  +#13#10'                   KEST_PRODUTO = ::KEST_PRODUTO ;'
  +#13#10''
  +#13#10'             UPDATE EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'               SET KEST_PRODUTO = ::NEW_KEST_PRODUTO'
  +#13#10'             WHERE '
  +#13#10'                   KEST_PRODUTO = ::KEST_PRODUTO ;'
  +#13#10''
  +#13#10'             UPDATE EST_PRODUTOS '
  +#13#10'               SET ATIVO = ''F'''
  +#13#10'             WHERE '
  +#13#10'               KEST_PRODUTO = ::KEST_PRODUTO ;'
  +#13#10'                                      '
  +#13#10'           END'
  +#13#10'        END'
  +#13#10'    END'
  +#13#10'END' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

var
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
      if Fields[0].asInteger = 0 then
         exit ;

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_PRODUTOS_DUPLICADOS )
    .SQLExec ;

end ;





procedure TDBFinanceiroUpdate._5_001_86;
const
  _UPDATE_DOCUMENTO_FRISIA =
          'EXECUTE BLOCK'
   +#13#10'AS'
   +#13#10'DECLARE KFIN_APAGAR_PARCELA TYPE OF COLUMN FIN_APAGAR_PARCELAS.KFIN_APAGAR_PARCELA ;'
   +#13#10'DECLARE DOCUMENTO TYPE OF COLUMN FIN_APAGAR_PARCELAS.DOCUMENTO ;'
   +#13#10'BEGIN'
   +#13#10'  FOR SELECT'
   +#13#10'    P.KFIN_APAGAR_PARCELA'
   +#13#10'    ,  LEFT( A.HISTORICO, 6 )'
   +#13#10'       || ''/'''
   +#13#10'       || RIGHT(A.HISTORICO,7)'
   +#13#10'       || ''-'''
   +#13#10'       || LEFT('
   +#13#10'           SUBSTRING( A.HISTORICO FROM 8 FOR 10 ),'
   +#13#10'           POSITION ( '' '', SUBSTRING( A.HISTORICO FROM 8 FOR 10 ) )'
   +#13#10'           )'
   +#13#10'  FROM FIN_APAGAR_PARCELAS P'
   +#13#10'  LEFT JOIN FIN_APAGAR A USING ( KFIN_APAGAR )'
   +#13#10'  WHERE'
   +#13#10'       A.TABLENAME = ''CMP_PEDIDOS'''
   +#13#10'   AND POSITION ( '' '', SUBSTRING( A.HISTORICO FROM 8 FOR 10 ) ) > 0'
   +#13#10'   AND POSITION( ''TITULO :'', A.HISTORICO ) > 0'
   +#13#10'   AND A.DOCUMENTO IS NULL'
   +#13#10'  INTO KFIN_APAGAR_PARCELA, DOCUMENTO DO'
   +#13#10'    UPDATE FIN_APAGAR_PARCELAS'
   +#13#10'      SET DOCUMENTO = :DOCUMENTO'
   +#13#10'    WHERE KFIN_APAGAR_PARCELA = :KFIN_APAGAR_PARCELA ;'
   +#13#10'END' ;
begin
   TryExecuteDirect ( _UPDATE_DOCUMENTO_FRISIA ) ;
end ;



procedure TDBFinanceiroUpdate._5_001_85;
const
  _ALTER_TABLE_SYSVERSION_APPVERSION =
     'ALTER TABLE SYS$VERSION ADD SYS$APPVERSION SYS$INT';
begin
  TryExecuteDirect( _ALTER_TABLE_SYSVERSION_APPVERSION );
end;

procedure TDBFinanceiroUpdate._5_001_84;
const

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

  _UPDATE_FIN_APAGAR =
         'UPDATE FIN_APAGAR'
  +#13#10'     SET KFIN_PLANOCONTA = %s '
  +#13#10'WHERE TABLENAME = ''CMP_PEDIDOS'''
  +#13#10'  AND HISTORICO CONTAINING ''JUROS''' ;

var
  LKeyDespesas : string ;
begin

  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
      if Fields[0].asInteger = 0 then
         exit ;

  LKeyDespesas := TPlanoContasDespesasReceitas.GetKeyDespesas  ;

  if LKeyDespesas.isEmpty then
    exit ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL(
      Format (
        _UPDATE_FIN_APAGAR
        , [
             LKeyDespesas.QuotedString
        ]
      )
    )
    .SQLExec ;

end ;


procedure TDBFinanceiroUpdate._5_001_83;
const

  _CREATE_TABLE_FRISIA_DEBITOS =
          'CREATE TABLE FRISIA_DEBITOS ('
   +#13#10'   KFRISIA_DEBITO    SYS$PKGUID20'
   +#13#10' , ID                SYS$INT'
   +#13#10' , CONTA             SYS$SHDESCR'
   +#13#10' , DOCUMENTO         SYS$CODE'
   +#13#10' , DATA              SYS$DATE'
   +#13#10' , VALOR             SYS$FLOAT'
   +#13#10' , APROPRIACAO       SYS$SHDESCR'
   +#13#10' , DESCRICAO         SYS$DESCR'
   +#13#10')' ;

  _CREATE_TABLE_FRISIA_CREDITOS =
          'CREATE TABLE FRISIA_CREDITOS ('
   +#13#10'   KFRISIA_CREDITO   SYS$PKGUID20'
   +#13#10' , ID                SYS$INT'
   +#13#10' , CONTA             SYS$SHDESCR'
   +#13#10' , DOCUMENTO         SYS$CODE'
   +#13#10' , DATA              SYS$DATE'
   +#13#10' , VALOR             SYS$FLOAT'
   +#13#10' , APROPRIACAO       SYS$SHDESCR'
   +#13#10' , DESCRICAO         SYS$DESCR'
   +#13#10')' ;

begin
  TryExecuteDirect ( _CREATE_TABLE_FRISIA_DEBITOS ) ;
  TryExecuteDirect ( _CREATE_TABLE_FRISIA_CREDITOS )  ;
end ;


procedure TDBFinanceiroUpdate._5_001_82;
const
  _ALTER_TABLE_FIN_FINANCIAMENTOS =
         'ALTER TABLE FIN_FINANCIAMENTOS'
  +#13#10'   ADD   CONTA_ORIGEM  FIN$DESCCONTA'
  +#13#10' , ADD   CONTA_DESTINO FIN$DESCCONTA'
  +#13#10' , ALTER CONTA_ORIGEM  POSITION 10'
  +#13#10' , ALTER CONTA_DESTINO POSITION 11'  ;
begin
  TryExecuteDirect ( _ALTER_TABLE_FIN_FINANCIAMENTOS ) ;
end;


procedure TDBFinanceiroUpdate._5_001_81;
const
  _DELETE_APAGAR_FIN_FINANCIAMENTOS =
       'DELETE FROM FIN_APAGAR WHERE TABLENAME = ''FIN_FINANCIAMENTOS''' ;
begin
  ExecuteDirect ( _DELETE_APAGAR_FIN_FINANCIAMENTOS ) ;
end;


procedure TDBFinanceiroUpdate._5_001_80;
const
  _ALTER_TABLE_FIN_FINANCIAMENTOS =
         'ALTER TABLE FIN_FINANCIAMENTOS'
  +#13#10'   ADD   KFIN_APAGAR_DESPESAS SYS$FKGUID20'
  +#13#10' , ALTER KFIN_APAGAR_DESPESAS POSITION 14'  ;
begin
  TryExecuteDirect ( _ALTER_TABLE_FIN_FINANCIAMENTOS ) ;
end;

procedure TDBFinanceiroUpdate._5_001_79;
const
   _DELETE_DUPLICIDADE_APAGAR =
          'DELETE FROM FIN_APAGAR_PARCELAS TARGET'
   +#13#10'WHERE EXISTS ('
   +#13#10'SELECT 1 FROM FIN_APAGAR_PARCELAS SOURCE'
   +#13#10'WHERE'
   +#13#10'       TARGET.KFIN_APAGAR = SOURCE.KFIN_APAGAR'
   +#13#10'   AND TARGET.VENCTO = SOURCE.VENCTO'
   +#13#10'   AND TARGET.VALOR = SOURCE.VALOR'
   +#13#10'AND TARGET.RDB$DB_KEY < SOURCE.RDB$DB_KEY'
   +#13#10')' ;

   _DELETE_DUPLICIDADE_ARECEBER =
          'DELETE FROM FIN_APAGAR_PARCELAS TARGET'
   +#13#10'WHERE EXISTS ('
   +#13#10'SELECT 1 FROM FIN_APAGAR_PARCELAS SOURCE'
   +#13#10'WHERE'
   +#13#10'       TARGET.KFIN_APAGAR = SOURCE.KFIN_APAGAR'
   +#13#10'   AND TARGET.VENCTO = SOURCE.VENCTO'
   +#13#10'   AND TARGET.VALOR = SOURCE.VALOR'
   +#13#10'AND TARGET.RDB$DB_KEY < SOURCE.RDB$DB_KEY'
   +#13#10')' ;

  _SELECT_EXISTS =
    'SELECT 1 FROM FRISIA_MATRICULAS ROWS 1' ;

   _DELETE_APAGAR_NEGATIVO =
          'DELETE FROM FIN_APAGAR_PARCELAS'
   +#13#10'WHERE VALOR < 0' ;

   _DELETE_ARECEBER_NEGATIVO =
          'DELETE FROM FIN_ARECEBER_PARCELAS'
   +#13#10'WHERE VALOR < 0' ;

begin
  with
    TTcAbstractDB.GetByAlias('FINANCEIRO')
      .ISQL( _SELECT_EXISTS )
      .GetDS
  do
      if Fields[0].asInteger = 0 then
         exit ;


  ExecuteDirect ( _DELETE_DUPLICIDADE_APAGAR   ) ;
  ExecuteDirect ( _DELETE_DUPLICIDADE_ARECEBER ) ;
  ExecuteDirect (  _DELETE_APAGAR_NEGATIVO     ) ;
  ExecuteDirect ( _DELETE_ARECEBER_NEGATIVO    ) ;
end;

procedure TDBFinanceiroUpdate._5_001_77;
const
  _UPDATE_CUSTO =
        'UPDATE'
 +#13#10'  CMP_PEDIDO_ITENS'
 +#13#10'  SET'
 +#13#10'    CUSTO = TOTAL / QTDE'
 +#13#10'WHERE'
 +#13#10'      QTDE > 1'
 +#13#10'  AND CUSTO = TOTAL' ;
var
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;
  ExecuteDirect ( _UPDATE_CUSTO ) ;
end;

procedure TDBFinanceiroUpdate._5_001_76;
const
  _DELETE_APROPRIACAO_DUPLICADA =
       'DELETE FROM FIN_APROPRIACAO S'
+#13#10'WHERE EXISTS'
+#13#10'  (SELECT 1 FROM FIN_APROPRIACAO D'
+#13#10'   WHERE'
+#13#10'        D.TABLENAME   = S.TABLENAME'
+#13#10'    AND D.TABLEKEY    = S.TABLEKEY'
+#13#10'    AND D.PORCENTAGEM = S.PORCENTAGEM'
+#13#10'    AND S.PORCENTAGEM = 100'
+#13#10'    AND D.RDB$DB_KEY  > S.RDB$DB_KEY'
+#13#10'  )' ;
begin
   ExecuteDirect ( _DELETE_APROPRIACAO_DUPLICADA ) ;
end;


procedure TDBFinanceiroUpdate._5_001_75 ;
const

    _SELECT_FORNECEDORES_TO_UPDATE =
           'SELECT'
    +#13#10'    KCAD_ENTIDADE'
    +#13#10'  , MD5STR20( ''FRISIA_FORNECEDOR_'' || CPF_CNPJ ) "NEW_KCAD_ENTIDADE"'
    +#13#10'FROM FRISIA_FORNECEDORES'
    +#13#10'WHERE'
    +#13#10'     KCAD_ENTIDADE IS NOT NULL'
    +#13#10' AND KCAD_ENTIDADE <> MD5STR20( ''FRISIA_FORNECEDOR_'' || CPF_CNPJ )' ;

    _SELECT_CLIENTES_TO_UPDATE =
           'SELECT'
    +#13#10'    KCAD_ENTIDADE'
    +#13#10'  , MD5STR20( ''FRISIA_CLIENTE_'' || CPF_CNPJ ) "NEW_KCAD_ENTIDADE"'
    +#13#10'FROM FRISIA_CLIENTES'
    +#13#10'WHERE'
    +#13#10'     KCAD_ENTIDADE IS NOT NULL'
    +#13#10' AND KCAD_ENTIDADE <> MD5STR20( ''FRISIA_CLIENTE_'' || CPF_CNPJ )' ;

    _UPDATE_FORNECEDORES =
           'EXECUTE BLOCK'
    +#13#10'AS'
    +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
    +#13#10'DECLARE NEW_KCAD_ENTIDADE SYS$FKGUID20 ;'
    +#13#10'BEGIN'
    +#13#10'  FOR SELECT'
    +#13#10'      KCAD_ENTIDADE'
    +#13#10'    , MD5STR20( ''FRISIA_FORNECEDOR_'' || CPF_CNPJ ) "NEW_KCAD_ENTIDADE"'
    +#13#10'  FROM FRISIA_FORNECEDORES'
    +#13#10'  WHERE'
    +#13#10'       KCAD_ENTIDADE IS NOT NULL'
    +#13#10'   AND KCAD_ENTIDADE <> MD5STR20( ''FRISIA_FORNECEDOR_'' || CPF_CNPJ )'
    +#13#10'  INTO'
    +#13#10'     KCAD_ENTIDADE'
    +#13#10'   , NEW_KCAD_ENTIDADE'
    +#13#10'  DO'
    +#13#10'  BEGIN'
    +#13#10''
    +#13#10'   IF ( NOT EXISTS (SELECT 1 FROM CAD_ENTIDADES WHERE KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE ) ) THEN'
    +#13#10'    UPDATE CAD_ENTIDADES'
    +#13#10'      SET'
    +#13#10'        KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10''
    +#13#10'    UPDATE CMP_PEDIDOS'
    +#13#10'      SET'
    +#13#10'         KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10''
    +#13#10'    UPDATE FRISIA_FORNECEDORES'
    +#13#10'      SET'
    +#13#10'         KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10'  END'
    +#13#10'END' ;


    _UPDATE_CLIENTES =
           'EXECUTE BLOCK'
    +#13#10'AS'
    +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
    +#13#10'DECLARE NEW_KCAD_ENTIDADE SYS$FKGUID20 ;'
    +#13#10'BEGIN'
    +#13#10'  FOR SELECT'
    +#13#10'      KCAD_ENTIDADE'
    +#13#10'    , MD5STR20( ''FRISIA_CLIENTE_'' || CPF_CNPJ ) "NEW_KCAD_ENTIDADE"'
    +#13#10'  FROM FRISIA_CLIENTES'
    +#13#10'  WHERE'
    +#13#10'       KCAD_ENTIDADE IS NOT NULL'
    +#13#10'   AND KCAD_ENTIDADE <> MD5STR20( ''FRISIA_CLIENTE_'' || CPF_CNPJ )'
    +#13#10'  INTO'
    +#13#10'     KCAD_ENTIDADE'
    +#13#10'   , NEW_KCAD_ENTIDADE'
    +#13#10'  DO'
    +#13#10'  BEGIN'
    +#13#10''
    +#13#10'   IF ( NOT EXISTS (SELECT 1 FROM CAD_ENTIDADES WHERE KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE ) ) THEN'
    +#13#10'    UPDATE CAD_ENTIDADES'
    +#13#10'      SET'
    +#13#10'        KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10''
    +#13#10'    UPDATE VND_PEDIDOS'
    +#13#10'      SET'
    +#13#10'         KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10''
    +#13#10'    UPDATE FRISIA_CLIENTES'
    +#13#10'      SET'
    +#13#10'         KCAD_ENTIDADE = ::NEW_KCAD_ENTIDADE'
    +#13#10'    WHERE'
    +#13#10'      KCAD_ENTIDADE = ::KCAD_ENTIDADE ;'
    +#13#10'  END'
    +#13#10'END' ;

  _UPDATE_ENTIDADES =
           'UPDATE CAD_ENTIDADES'
    +#13#10'  SET'
    +#13#10'    KCAD_ENTIDADE = :NEW_KCAD_ENTIDADE'
    +#13#10'WHERE'
    +#13#10'     KCAD_ENTIDADE = :KCAD_ENTIDADE'
    +#13#10' AND NOT EXISTS (SELECT 1 FROM CAD_ENTIDADES WHERE KCAD_ENTIDADE = :NEW_KCAD_ENTIDADE)' ;

var
  LSQL : ISQLSuppl ;
  DBEntidades : ITcAbstractDB ;
  cdsFornecedores, cdsClientes : TClientDataSet ;
  LEncerramentoMensal : IEncerramentoMensal ;
begin

  LEncerramentoMensal := TEncerramentoMensal.New( self.IDB )  ;

  DBEntidades := TTcAbstractDB.GetByAlias('ENTIDADES') ;

  if Assigned ( DBEntidades ) then
     LSQL := DBEntidades.ISQL( _UPDATE_ENTIDADES ) ;

  cdsFornecedores := nil ;
  TTcAbstractDB.GetByAlias('FINANCEIRO')
       .populateClientDataSet (
            cdsFornecedores
          , _SELECT_FORNECEDORES_TO_UPDATE
       ) ;


  cdsClientes     := nil ;
  TTcAbstractDB.GetByAlias('FINANCEIRO')
       .populateClientDataSet (
            cdsClientes
          , _SELECT_CLIENTES_TO_UPDATE
       ) ;


  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_FORNECEDORES )
    .SQLExec ;

  TTcAbstractDB.GetByAlias('FINANCEIRO')
    .ISQL( _UPDATE_CLIENTES )
    .SQLExec ;

  with cdsFornecedores do
    while not EOF do
       begin
         if Assigned ( DBEntidades ) then
           begin
            LSQL.SQLParam('NEW_KCAD_ENTIDADE').asString := Fields[1].asString ;
            LSQL.SQLParam('KCAD_ENTIDADE').asString     := Fields[0].asString ;
            try
              LSQL.SQLExec ;
            except On E : Exception do
              raise Exception.Create(
                 '_UPDATE_FORNECEDORES'
                +#13#10
                + E.Message
            );
            end;
           end;
         next ;
       end;

  with cdsClientes do
    while not EOF do
       begin
         if Assigned ( DBEntidades ) then
           begin
            LSQL.SQLParam('NEW_KCAD_ENTIDADE').asString := Fields[1].asString ;
            LSQL.SQLParam('KCAD_ENTIDADE').asString     := Fields[0].asString ;
            try
              LSQL.SQLExec ;
            except On E : Exception do
              raise Exception.Create(
                 '_UPDATE_CLIENTES'
                +#13#10
                + E.Message
            );
            end;
           end;
         next ;
       end;

    cdsFornecedores.DisposeOf ;
    cdsClientes.DisposeOf ;

end ;


procedure TDBFinanceiroUpdate._5_001_74;
const

    _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 =
          'CREATE OR ALTER TRIGGER CMP_PEDIDOS_BIUD0 FOR CMP_PEDIDOS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  IF (inserting) THEN'
   +#13#10'   BEGIN'
   +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
   +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
   +#13#10'          || COALESCE (NEW.DATA_ENTRADA, '''' ) ;'
   +#13#10''
   +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'        BEGIN'
   +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
   +#13#10'         IF ( NEW.DATA_EMISSAO IS DISTINCT FROM NEW.DATA_ENTRADA ) THEN'
   +#13#10'            EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
   +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
   +#13#10'        END'
   +#13#10'   END'
   +#13#10'  ELSE IF (    ( updating )'
   +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
   +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
   +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
   +#13#10'    BEGIN'
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
   +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
   +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
   +#13#10''
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
   +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
   +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
   +#13#10''
   +#13#10'      FOR SELECT KEST_PRODUTO'
   +#13#10'        FROM CMP_PEDIDO_ITENS'
   +#13#10'        WHERE KCMP_PEDIDO = NEW.KCMP_PEDIDO AND NOT KEST_PRODUTO IS NULL'
   +#13#10'        INTO KEST_PRODUTO'
   +#13#10'      DO'
   +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
   +#13#10'    END'
   +#13#10'  ELSE IF ( deleting ) then'
   +#13#10'    BEGIN'
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
   +#13#10'    END'
   +#13#10'END' ;



   _ALTER_TRIGGER_CMP_PEDIDO_ITENS_BIUD0 =
          'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_BIUD0 FOR CMP_PEDIDO_ITENS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KDOMAIN      SYS$FKGUID20 = null ;'
   +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
   +#13#10'DECLARE DATA_ENTRADA SYS$DATE;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO, DATA_ENTRADA'
   +#13#10'  FROM CMP_PEDIDOS'
   +#13#10'  WHERE KCMP_PEDIDO = IIF ( inserting or updating, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO )'
   +#13#10'  INTO KDOMAIN, DATA_EMISSAO, DATA_ENTRADA ;'
   +#13#10''
   +#13#10'  IF ( DELETING AND KDOMAIN IS NULL  ) THEN'
   +#13#10'     EXIT ;'
   +#13#10''
   +#13#10'  LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'  THISCHECK_ENCERRAMENTO_MES = KDOMAIN'
   +#13#10'       || COALESCE (DATA_EMISSAO, '''' )'
   +#13#10'       || COALESCE (DATA_ENTRADA, '''' ) ;'
   +#13#10''
   +#13#10'  IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'  BEGIN'
   +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
   +#13#10''
   +#13#10'    IF ( DATA_ENTRADA IS DISTINCT FROM DATA_EMISSAO ) THEN'
   +#13#10'       EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_ENTRADA ;'
   +#13#10'  END'
   +#13#10''
   +#13#10'  IF ( ( INSERTING OR UPDATING ) AND ( NEW.KEST_PRODUTO IS NOT NULL ) ) THEN'
   +#13#10'     EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  KDOMAIN, NEW.KEST_PRODUTO, DATA_ENTRADA ;'
   +#13#10''
   +#13#10'  IF ( DELETING ) THEN'
   +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''CMP_PEDIDO_ITENS'', OLD.KCMP_PEDIDO_ITEM ;'
   +#13#10''
   +#13#10'END' ;

   _ALTER_TRIGGER_CMP_PEDIDO_SERVICOS_BIUD0 =
          'CREATE OR ALTER TRIGGER CMP_PEDIDO_SERVICOS_BIUD0 FOR CMP_PEDIDO_SERVICOS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KDOMAIN      SYS$FKGUID20 = null ;'
   +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
   +#13#10'DECLARE DATA_ENTRADA SYS$DATE;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO, DATA_ENTRADA'
   +#13#10'  FROM CMP_PEDIDOS'
   +#13#10'  WHERE KCMP_PEDIDO = IIF ( inserting or updating, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO )'
   +#13#10'  INTO KDOMAIN, DATA_EMISSAO, DATA_ENTRADA ;'
   +#13#10''
   +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) THEN'
   +#13#10'     EXIT ;'
   +#13#10''
   +#13#10'  LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'  THISCHECK_ENCERRAMENTO_MES = KDOMAIN'
   +#13#10'       || COALESCE (DATA_EMISSAO, '''' )'
   +#13#10'       || COALESCE (DATA_ENTRADA, '''' ) ;'
   +#13#10''
   +#13#10'  IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'  BEGIN'
   +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
   +#13#10''
   +#13#10'    IF ( DATA_ENTRADA IS DISTINCT FROM DATA_EMISSAO ) THEN'
   +#13#10'       EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_ENTRADA ;'
   +#13#10'  END'
   +#13#10''
   +#13#10'  IF ( DELETING ) THEN'
   +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''CMP_PEDIDO_SERVICOS'', OLD.KCMP_PEDIDO_SERVICO ;'
   +#13#10''
   +#13#10'END' ;

   _ALTER_PROCEDURE_EST_CHECK_ENCERRAMENTO_MES =
          'CREATE OR ALTER PROCEDURE EST_CHECK_ENCERRAMENTO_MES ('
   +#13#10'    KSYS$DOMAIN SYS$FKGUID20,'
   +#13#10'    DATA SYS$DATE,'
   +#13#10'    ADDNEW SYS$BOOL_NULL = ''T'')'
   +#13#10'AS'
   +#13#10'DECLARE ANO SMALLINT ;'
   +#13#10'DECLARE MES SMALLINT ;'
   +#13#10'DECLARE ANO_MES SYS$ANO_MES ;'
   +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
   +#13#10'BEGIN'
   +#13#10'  IF ( DATA IS NULL ) THEN'
   +#13#10'    EXCEPTION SYS$EXCEPTION ''Não é permitido movimentaçao de estoque sem data.'' ;'
   +#13#10''
   +#13#10'  IF (  (RDB$GET_CONTEXT( ''USER_SESSION'',     ''EST_CHECK_ENCERRAMENTO_MES$OFF'' ) = ''1'')'
   +#13#10'     OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST_CHECK_ENCERRAMENTO_MES$OFF'' ) = ''1'') ) THEN'
   +#13#10'       EXIT ;'
   +#13#10''
   +#13#10'  ANO = EXTRACT ( YEAR  FROM DATA ) ;'
   +#13#10'  MES = EXTRACT ( MONTH FROM DATA ) ;'
   +#13#10''
   +#13#10'  ANO_MES =  Right ( ''0000'' || ANO, 4 ) || Right ( ''00'' || MES, 2 ) ;'
   +#13#10''
   +#13#10'  SELECT ENCERRADO'
   +#13#10'  FROM EST_ENCERRAMENTO_MES'
   +#13#10'  WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
   +#13#10'    AND ANO_MES = :ANO_MES'
   +#13#10'  INTO ENCERRADO ;'
   +#13#10''
   +#13#10'  IF ( ENCERRADO = ''T'' ) THEN'
   +#13#10'    EXCEPTION SYS$EXCEPTION ''A movimentação de estoque para este mes esta encerrada ('' || RIGHT( ANO_MES, 2 ) ||  ''.'' || LEFT ( ANO_MES, 4 ) || '').'' ;'
   +#13#10''
   +#13#10'  IF ( ENCERRADO IS NULL ) THEN'
   +#13#10'    BEGIN'
   +#13#10'      SELECT ENCERRADO, ANO_MES'
   +#13#10'        FROM EST_ENCERRAMENTO_MES'
   +#13#10'      WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
   +#13#10'        AND ANO_MES > :ANO_MES'
   +#13#10'        AND ENCERRADO = ''T'''
   +#13#10'      ROWS 1'
   +#13#10'      INTO ENCERRADO, ANO_MES ;'
   +#13#10''
   +#13#10'      IF ( ENCERRADO = ''T'' ) THEN'
   +#13#10'        EXCEPTION SYS$EXCEPTION ''Não é permitido esta movimentação. Um período posterior esta encerrado ('' || RIGHT( ANO_MES, 2 ) ||  ''.'' || LEFT ( ANO_MES, 4 ) || '').'' ;'
   +#13#10''
   +#13#10'      IF ( ADDNEW = ''T'' ) THEN'
   +#13#10'        INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KSYS$DOMAIN, ANO_MES )'
   +#13#10'        VALUES ( GUID20(), :KSYS$DOMAIN, :ANO_MES ) ;'
   +#13#10''
   +#13#10'    END'
   +#13#10''
   +#13#10'END' ;


   _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 =
          'CREATE OR ALTER TRIGGER VND_PEDIDOS_BIUD0 FOR VND_PEDIDOS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  IF (inserting) THEN'
   +#13#10'   BEGIN'
   +#13#10'     LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'     THISCHECK_ENCERRAMENTO_MES = NEW.KSYS$DOMAIN'
   +#13#10'          || COALESCE (NEW.DATA_EMISSAO, '''' )'
   +#13#10'     --     || COALESCE (NEW.DATA_SAIDA,   '''' )'
   +#13#10'          ;'
   +#13#10''
   +#13#10'      IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'        BEGIN'
   +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
   +#13#10'         --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
   +#13#10'            --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
   +#13#10'         RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'', THISCHECK_ENCERRAMENTO_MES ) ;'
   +#13#10'        END'
   +#13#10'   END'
   +#13#10'  ELSE IF (    ( updating )'
   +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
   +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO ) ) ) THEN'
   +#13#10'    BEGIN'
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
   +#13#10'      --IF ( OLD.DATA_SAIDA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
   +#13#10'      --  EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
   +#13#10''
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
   +#13#10'      --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
   +#13#10'      --   EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
   +#13#10''
   +#13#10'      FOR SELECT KEST_PRODUTO'
   +#13#10'        FROM VND_PEDIDO_ITENS'
   +#13#10'        WHERE KVND_PEDIDO = NEW.KVND_PEDIDO AND NOT KEST_PRODUTO IS NULL'
   +#13#10'        INTO KEST_PRODUTO'
   +#13#10'      DO'
   +#13#10'        EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO /*DATA_SAIDA*/ ;'
   +#13#10''
   +#13#10'    END'
   +#13#10'  ELSE'
   +#13#10'    BEGIN'
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
   +#13#10'      --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
   +#13#10'    END'
   +#13#10''
   +#13#10'END' ;

   _ALTER_TRIGGER_VND_PEDIDO_ITENS_BIUD0 =
          'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_BIUD0 FOR VND_PEDIDO_ITENS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KDOMAIN SYS$FKGUID20 = null ;'
   +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
   +#13#10'--DECLARE DATA_SAIDA SYS$DATE;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO /*, DATA_SAIDA */'
   +#13#10'  FROM VND_PEDIDOS'
   +#13#10'  WHERE KVND_PEDIDO = IIF ( inserting or updating, NEW.KVND_PEDIDO, OLD.KVND_PEDIDO )'
   +#13#10'  INTO KDOMAIN, DATA_EMISSAO /*, DATA_SAIDA */ ;'
   +#13#10''
   +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) THEN'
   +#13#10'     EXIT ;'
   +#13#10''
   +#13#10'  LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'  THISCHECK_ENCERRAMENTO_MES = KDOMAIN'
   +#13#10'       || COALESCE (DATA_EMISSAO, '''' )'
   +#13#10'  --     || COALESCE (DATA_ENTRADA, '''' )'
   +#13#10'    ;'
   +#13#10''
   +#13#10'  IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'    BEGIN'
   +#13#10''
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
   +#13#10'      --  IF ( DATA_SAIDA IS DISTINCT FROM DATA_EMISSAO ) THEN'
   +#13#10'      --     EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_SAIDA ;'
   +#13#10'    END'
   +#13#10''
   +#13#10'  IF ( ( INSERTING OR UPDATING ) AND ( NEW.KEST_PRODUTO IS NOT NULL ) ) THEN'
   +#13#10'     EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  KDOMAIN, NEW.KEST_PRODUTO, DATA_EMISSAO /* DATA_SAIDA */ ;'
   +#13#10''
   +#13#10'  IF ( DELETING ) THEN'
   +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''VND_PEDIDO_ITENS'', OLD.KVND_PEDIDO_ITEM ;'
   +#13#10''
   +#13#10'END' ;

   _ALTER_TRIGGER_VND_PEDIDO_SERVICOS_BIUD0 =
          'CREATE OR ALTER TRIGGER VND_PEDIDO_SERVICOS_BIUD0 FOR VND_PEDIDO_SERVICOS'
   +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
   +#13#10'AS'
   +#13#10'DECLARE KDOMAIN SYS$FKGUID20 = null ;'
   +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
   +#13#10'--DECLARE DATA_SAIDA SYS$DATE;'
   +#13#10'DECLARE LASTCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'DECLARE THISCHECK_ENCERRAMENTO_MES VARCHAR ( 70 );'
   +#13#10'BEGIN'
   +#13#10''
   +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO /*, DATA_SAIDA */'
   +#13#10'  FROM VND_PEDIDOS'
   +#13#10'  WHERE KVND_PEDIDO = IIF ( inserting or updating, NEW.KVND_PEDIDO, OLD.KVND_PEDIDO )'
   +#13#10'  INTO KDOMAIN, DATA_EMISSAO /*, DATA_SAIDA */ ;'
   +#13#10''
   +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) THEN'
   +#13#10'     EXIT ;'
   +#13#10''
   +#13#10'  LASTCHECK_ENCERRAMENTO_MES = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''LASTCHECK_ENCERRAMENTO_MES'' ) ;'
   +#13#10'  THISCHECK_ENCERRAMENTO_MES = KDOMAIN'
   +#13#10'       || COALESCE (DATA_EMISSAO, '''' )'
   +#13#10'  --     || COALESCE (DATA_ENTRADA, '''' )'
   +#13#10'    ;'
   +#13#10''
   +#13#10'  IF ( LASTCHECK_ENCERRAMENTO_MES IS DISTINCT FROM THISCHECK_ENCERRAMENTO_MES ) THEN'
   +#13#10'    BEGIN'
   +#13#10''
   +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
   +#13#10'      --  IF ( DATA_SAIDA IS DISTINCT FROM DATA_EMISSAO ) THEN'
   +#13#10'      --     EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_SAIDA ;'
   +#13#10'    END'
   +#13#10''
   +#13#10'  IF ( DELETING ) THEN'
   +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''VND_PEDIDO_SERVICOS'', OLD.KVND_PEDIDO_SERVICO ;'
   +#13#10''
   +#13#10'END' ;

begin

  ExecuteDirect ( _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 ) ;
  ExecuteDirect ( _ALTER_TRIGGER_CMP_PEDIDO_ITENS_BIUD0 ) ;
  ExecuteDirect ( _ALTER_TRIGGER_CMP_PEDIDO_SERVICOS_BIUD0 ) ;

  ExecuteDirect ( _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 ) ;
  ExecuteDirect ( _ALTER_TRIGGER_VND_PEDIDO_ITENS_BIUD0 ) ;
  ExecuteDirect ( _ALTER_TRIGGER_VND_PEDIDO_SERVICOS_BIUD0 ) ;

  ExecuteDirect ( _ALTER_PROCEDURE_EST_CHECK_ENCERRAMENTO_MES ) ;
end;

procedure TDBFinanceiroUpdate._5_001_73;
const
  _X =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'DECLARE KCMP_PEDIDO  SYS$FKGUID20 ; '
  +#13#10'DECLARE KCAD_ENTIDADE  SYS$FKGUID20 ; '
  +#13#10'BEGIN       '
  +#13#10'  FOR SELECT '
  +#13#10'    C.KCMP_PEDIDO'
  +#13#10'  , FF.KCAD_ENTIDADE KCAD_ENTIDADE'
  +#13#10'  FROM CMP_PEDIDOS C'
  +#13#10'  LEFT JOIN FRISIA_FORNECEDORES FF ON SUBSTRING ( C.CHAVENFE FROM 7 FOR 14 )= FF.CPF_CNPJ '
  +#13#10'  WHERE FF.KCAD_ENTIDADE IS NOT NULL'
  +#13#10'    AND C.KCAD_ENTIDADE IS DISTINCT FROM FF.KCAD_ENTIDADE'
  +#13#10'  INTO KCMP_PEDIDO, KCAD_ENTIDADE'
  +#13#10'  DO'
  +#13#10'    UPDATE CMP_PEDIDOS'
  +#13#10'    SET'
  +#13#10'      KCAD_ENTIDADE = :KCAD_ENTIDADE'
  +#13#10'    WHERE'
  +#13#10'      KCMP_PEDIDO = :KCMP_PEDIDO ;'
  +#13#10'       '
  +#13#10'END' ;
var
  EncerramentoMensal : TEncerramentoMensal ;
begin
  EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );
  try
    ExecuteDirect ( _X ) ;
  finally
    EncerramentoMensal.Free
  end;
end;

procedure TDBFinanceiroUpdate._5_001_72;
const
 _ALTER_TABLE_FIN_TRANSFERENCIAS =
         'ALTER TABLE FIN_TRANSFERENCIAS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;
begin
 TryExecuteDirect ( _ALTER_TABLE_FIN_TRANSFERENCIAS )
end;

procedure TDBFinanceiroUpdate._5_001_71;
const
  _ALTER_TRIGGER_FIN_TRANSFERENCIAS_AIUD0 =
       'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AIUD0 FOR FIN_TRANSFERENCIAS'
+#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
+#13#10'AS'
+#13#10'BEGIN'
+#13#10''
+#13#10'  IF ( (RDB$GET_CONTEXT( ''USER_SESSION'',     ''FIN_TRANSFERENCIAS_TRIGGER$OFF'' ) = ''1'')'
+#13#10'    OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''FIN_TRANSFERENCIAS_TRIGGER$OFF'' ) = ''1'') ) THEN'
+#13#10'     EXIT ;'
+#13#10''
+#13#10'  IF (INSERTING) THEN'
+#13#10'    EXECUTE PROCEDURE FIN_INSERT_CREDITODEBITO'
+#13#10'       NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
+#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
+#13#10'  ELSE IF (UPDATING) THEN'
+#13#10'    EXECUTE PROCEDURE FIN_UPDATE_CREDITODEBITO'
+#13#10'       OLD.KFIN_TRANSFERENCIA, NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
+#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
+#13#10'  ELSE'
+#13#10'    EXECUTE PROCEDURE FIN_DELETE_CREDITODEBITO OLD.KFIN_TRANSFERENCIA ;'
+#13#10'END' ;

begin
   ExecuteDirect ( _ALTER_TRIGGER_FIN_TRANSFERENCIAS_AIUD0 ) ;
end;


procedure TDBFinanceiroUpdate._5_001_70;
const
  _CREATE_TABLE_FRISIA_NOTASFISCAIS =
         'CREATE TABLE FRISIA_NOTASFISCAIS ('
  +#13#10'   KFRISIA_NOTAFISCAL SYS$PKGUID20'
  +#13#10' , TIPO               SYS$SHDESCR'
  +#13#10' , CHAVE_NFE          FIN$CHAVENFE'
  +#13#10' , NR_NOTA            SYS$CODE'
  +#13#10' , SERIE              SYS$SHDESCR'
  +#13#10' , EMISSAO            SYS$DATE'
  +#13#10' , SITUACAO           SYS$SHDESCR'
  +#13#10' , VL_TOTAL_NF        SYS$FLOAT'
  +#13#10' , MOVIMENTO_ESTOQUE  SYS$SHDESCR'
  +#13#10' , FINANCEIRO         SYS$SHDESCR'
  +#13#10' , TIPO_PAGAMENTO     SYS$SHDESCR'
  +#13#10' , CD_CONTRATO        SYS$CODE'
  +#13#10' , XML_NFE            SYS$BLOBXML2'
  +#13#10')' ;

  _CREATE_TABLE_FRISIA_NOTAFISCAL_ITENS =
         'CREATE TABLE FRISIA_NOTAFISCAL_ITENS('
  +#13#10'   KFRISIA_NOTAFISCAL_ITEM SYS$PKGUID20'
  +#13#10' , KFRISIA_NOTAFISCAL      SYS$FKGUID20_NN'
  +#13#10' , ID                      SYS$INT'
  +#13#10' , APROPRIACAO             SYS$SHDESCR'
  +#13#10' , CD_TIPO_CORRENTE        SYS$INT'
  +#13#10' , CD_PRODUTO              SYS$CODE'
  +#13#10' , DS_PRODUTO              SYS$DESCR'
  +#13#10' , CFOP                    FIN$CFOP'
  +#13#10' , TOTAL_ITEM              SYS$FLOAT'
  +#13#10' , VENCTO                  SYS$DATE'
  +#13#10')' ;
begin
  TryExecuteDirect( _CREATE_TABLE_FRISIA_NOTASFISCAIS ) ;
  TryExecuteDirect( _CREATE_TABLE_FRISIA_NOTAFISCAL_ITENS ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_69;
const
   _SELECT_FORNECEDORES =
        'SELECT CPF_CNPJ, KCAD_ENTIDADE'
 +#13#10'FROM CAD_ENTIDADES'
 +#13#10'WHERE  KSYS$DOMAIN = :KSYS$DOMAIN'
 +#13#10'  AND IS_FORNECEDOR = ''T'''
 +#13#10'  AND SYS$DELETED = ''F''' ;

const
   _UPDATE_PEDIDOS =
       'EXECUTE BLOCK ('
+#13#10'            KSYS$DOMAIN SYS$FKGUID20 = :KSYS$DOMAIN'
+#13#10'          , KCAD_ENTIDADE SYS$FKGUID20 = :KCAD_ENTIDADE'
+#13#10'          , CNPJ VARCHAR( 14 )= :CNPJ )'
+#13#10'AS'
+#13#10'DECLARE KCMP_PEDIDO SYS$FKGUID20 ;'
+#13#10'BEGIN'
+#13#10'  FOR SELECT KCMP_PEDIDO'
+#13#10'  FROM CMP_PEDIDOS'
+#13#10'  WHERE KSYS$DOMAIN = ::KSYS$DOMAIN'
+#13#10'    AND KCAD_ENTIDADE IS NULL'
+#13#10'    AND CHAVENFE LIKE ''%'' || ::CNPJ || ''%'''
+#13#10'  INTO KCMP_PEDIDO'
+#13#10'  DO'
+#13#10'  UPDATE CMP_PEDIDOS'
+#13#10'     SET KCAD_ENTIDADE = ::KCAD_ENTIDADE'
+#13#10'  WHERE KCMP_PEDIDO = ::KCMP_PEDIDO ;'
+#13#10'END' ;

  function Digits ( s : string ) : string ;
  var
      y, x : integer ;
  begin
      y := 1 ;

      SetLength ( Result, Length ( s ) ) ;
      for x := 1 to Length ( s ) do
          if ( CharInSet ( s [x], ['0'..'9'] ) ) then
              begin
                 Result [ y ] := s [ x ] ;
                inc ( y ) ;
              end ;
       SetLength ( Result, y - 1 ) ;
  end ;

  procedure UpdateNFCompra(
     const FDomainID
         , AKEntidade
         , ACNPJ      : string
  ) ;
  var
  LSQL : ISQLSuppl ;
  begin

    LSQL := TTcAbstractDB.GetByAlias('FINANCEIRO').ISQL( _UPDATE_PEDIDOS ) ;
    LSQL.SQLParam( 'KSYS$DOMAIN'   ).AsString := FDomainID ;
    LSQL.SQLParam( 'KCAD_ENTIDADE' ).AsString := AKEntidade ;
    LSQL.SQLParam( 'CNPJ'          ).AsString := ACNPJ ;
    LSQL.SQLExec ;

  end ;


var
 LSQL : ISQLSuppl ;
 LCNPJ : string ;
begin
 if not assigned( TTcAbstractDB.GetByAlias('ENTIDADES') ) then
   exit;

 LSQL := TTcAbstractDB.GetByAlias('ENTIDADES').ISQL( _SELECT_FORNECEDORES ) ;
 LSQL.SQLParam('KSYS$DOMAIN').AsString := LoggedUser.DomainID ;
 With LSQL.GetDS do
   while not eof do
     begin
         LCNPJ :=  Digits( Fields[0].AsString ) ;
         if ( LCNPJ <> '' ) and ( LCNPJ.Length =  14 ) then
            UpdateNFCompra( LoggedUser.DomainID, Fields[1].AsString, LCNPJ ) ;
         Next ;
     end ;
end;


procedure TDBFinanceiroUpdate._5_001_68;
const
 _ALTER_TABLE_FRISIA_TIPOSCONTA_ADD_CENTROCUSTO =
         'ALTER TABLE FRISIA_TIPOSCONTA '
  +#13#10'   ADD KFIN_CENTROCUSTO SYS$FKGUID20'
  +#13#10' , ALTER KFIN_CENTROCUSTO POSITION 3'  ;

 _ALTER_TABLE_FRISIA_TIPOSCONTA_ADD_DOMAIN =
         'ALTER TABLE FRISIA_TIPOSCONTA'
  +#13#10'   ADD KSYS$DOMAIN SYS$FKGUID20_NN'
  +#13#10' , ALTER KSYS$DOMAIN POSITION 2'  ;

 _UPDATE_FRISIA_TIPOSCONTA =
         'UPDATE FRISIA_TIPOSCONTA'
  +#13#10' SET'
  +#13#10'  KSYS$DOMAIN = %s'
  +#13#10'WHERE'
  +#13#10'  KSYS$DOMAIN IS NULL'  ;

 _DROP_PK =
           'ALTER TABLE FRISIA_TIPOSCONTA'
    +#13#10'DROP CONSTRAINT PKFRISIA_TIPOSCONTA' ;

 _CREATE_PK =
           'ALTER TABLE FRISIA_TIPOSCONTA'
    +#13#10'ADD CONSTRAINT PKFRISIA_TIPOSCONTA'
    +#13#10'PRIMARY KEY (KSYS$DOMAIN, KFRISIA_TIPOCONTA)' ;

begin
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_TIPOSCONTA_ADD_CENTROCUSTO ) ;
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_TIPOSCONTA_ADD_DOMAIN ) ;
  ExecuteDirect    ( Format ( _UPDATE_FRISIA_TIPOSCONTA, [ QuotedStr ( LoggedUser.DomainID  ) ] ) ) ;

  TryExecuteDirect ( _DROP_PK ) ;
  TryExecuteDirect ( _CREATE_PK ) ;
end;



procedure TDBFinanceiroUpdate._5_001_65;
const
 _ALTER_TABLE_FIN_APAGAR =
         'ALTER TABLE FIN_APAGAR'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_FIN_ARECEBER =
         'ALTER TABLE FIN_ARECEBER'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_CMP_PEDIDOS =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_VND_PEDIDOS =
         'ALTER TABLE VND_PEDIDOS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_DEV_PEDIDOS =
         'ALTER TABLE DEV_PEDIDOS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_EST_PRODUTOS =
         'ALTER TABLE EST_PRODUTOS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_FIN_CENTROSCUSTO =
         'ALTER TABLE FIN_CENTROSCUSTO'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;

 _ALTER_TABLE_FIN_FINANCIAMENTOS =
         'ALTER TABLE FIN_FINANCIAMENTOS'
  +#13#10'ADD SYS$ORIGIN_TYPE SYS$INT_NN_0' ;



begin
   TryExecuteDirect ( _ALTER_TABLE_FIN_APAGAR   ) ;
   TryExecuteDirect ( _ALTER_TABLE_FIN_ARECEBER ) ;
   TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS  ) ;
   TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS  ) ;
   TryExecuteDirect ( _ALTER_TABLE_DEV_PEDIDOS  ) ;
   TryExecuteDirect ( _ALTER_TABLE_EST_PRODUTOS  ) ;
   TryExecuteDirect ( _ALTER_TABLE_FIN_CENTROSCUSTO  ) ;
   TryExecuteDirect ( _ALTER_TABLE_FIN_FINANCIAMENTOS  ) ;
end ;



procedure TDBFinanceiroUpdate._5_001_62;
const
 _ALTER_PROCEDURE_FIN_UPDATE_SALDO_CONTA =
       'CREATE OR ALTER PROCEDURE FIN_UPDATE_SALDO_CONTA ('
+#13#10'    KFIN_CONTA SYS$PKGUID20,'
+#13#10'    PSOMA SYS$FLOAT,'
+#13#10'    PSUBTRAI SYS$FLOAT,'
+#13#10'    DEBITO_CREDITO FIN$DEVEDORA_CREDORA)'
+#13#10'AS'
+#13#10'DECLARE VALOR_INJETADO SYS$FLOAT ;'
+#13#10'DECLARE VALOR_UTILIZADO SYS$FLOAT ;'
+#13#10'BEGIN'
+#13#10''
+#13#10'  if ( (RDB$GET_CONTEXT( ''USER_SESSION'',     ''FIN_UPDATE_SALDO_CONTA$OFF'' ) = ''1'')'
+#13#10'    OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''FIN_UPDATE_SALDO_CONTA$OFF'' ) = ''1'') ) THEN'
+#13#10'     EXIT ;'
+#13#10''
+#13#10'  WHILE ( 1=1 ) DO'
+#13#10'  BEGIN'
+#13#10'    IF (DEBITO_CREDITO = ''D'') THEN'
+#13#10'      UPDATE FIN_CONTAS'
+#13#10'        SET VALOR_UTILIZADO'
+#13#10'            = VALOR_UTILIZADO'
+#13#10'            + :pSOMA'
+#13#10'            - :pSUBTRAI'
+#13#10'      WHERE KFIN_CONTA = :KFIN_CONTA;'
+#13#10''
+#13#10'    IF (DEBITO_CREDITO = ''C'') THEN'
+#13#10'      UPDATE FIN_CONTAS'
+#13#10'          SET VALOR_INJETADO'
+#13#10'            = VALOR_INJETADO'
+#13#10'            + :pSOMA'
+#13#10'             - :pSUBTRAI'
+#13#10'      WHERE KFIN_CONTA = :KFIN_CONTA;'
+#13#10''
+#13#10''
+#13#10'    LEAVE ;'
+#13#10'  WHEN GDSCODE lock_conflict'
+#13#10'     , GDSCODE deadlock DO'
+#13#10'  BEGIN'
+#13#10'--    INSERT INTO LOGX VALUES ( ''erro'' );'
+#13#10'  END'
+#13#10'  END'
+#13#10'END' ;

begin
  ExecuteDirect ( _ALTER_PROCEDURE_FIN_UPDATE_SALDO_CONTA ) ;
end;

procedure TDBFinanceiroUpdate._5_001_61 ;
const
    _CREATE_TABLE_DEV_PEDIDOS =
         'CREATE TABLE DEV_PEDIDOS ('
  +#13#10'    KDEV_PEDIDO             SYS$PKGUID20'
  +#13#10'  , KSYS$DOMAIN             SYS$FKGUID20_NN'
  +#13#10'  , KCAD_ENTIDADE           SYS$FKGUID20'
  +#13#10'  , NOTA_FISCAL             SYS$CODE'
  +#13#10'  , CHAVENFE                FIN$CHAVENFE'
  +#13#10'  , IMPORTADO_NFE           SYS$BOOL_F'
  +#13#10'  , NOMEENTIDADE            SYS$DESCR_NN'
  +#13#10'  , SERIE                   SYS$SHDESCR'
  +#13#10'  , DATA_EMISSAO            SYS$DATE_NN'
  +#13#10'  , DATA_DEVOLUCAO          SYS$DATE_NN DEFAULT CURRENT_TIMESTAMP'
  +#13#10'  , DATA_COMPRA             SYS$DATE_NN'
  +#13#10'  , DATA_ENTRADA            SYS$DATE_NN'
  +#13#10'  , IMPOSTOS                SYS$FLOAT'
  +#13#10'  , DESCONTOS               SYS$FLOAT'
  +#13#10'  , FRETE                   SYS$FLOAT'
  +#13#10'  , KFIN_ARECEBER           SYS$FKGUID20_NN'
  +#13#10'  , KFIN_APAGAR_TRANSPORTE  SYS$FKGUID20'
  +#13#10'  , TOTAL_ITENS             SYS$FLOAT_NN_0'
  +#13#10'  , TOTAL_NOTA              SYS$FLOAT_NN_0'
  +#13#10'  , OBS                     SYS$BLOBTEXT'
  +#13#10'  , MODELO_NFE              SYS$INT'
  +#13#10'  , ATIVO                   SYS$BOOL_T'
  +#13#10'  , SYS$UI                  SYS$USERLOGIN'
  +#13#10'  , SYS$DI                  SYS$DATE'
  +#13#10'  , SYS$UU                  SYS$USERLOGIN'
  +#13#10'  , SYS$DU                  SYS$DATE'
  +#13#10'  , XML_NFE                 SYS$BLOBXML2'
  +#13#10'  , CONSTRAINT PKDEV_PEDIDOS PRIMARY KEY (KDEV_PEDIDO)'
  +#13#10'  , CONSTRAINT FKDEV_PEDIDOS_01 FOREIGN KEY (KSYS$DOMAIN)'
  +#13#10'     REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
  +#13#10'     ON DELETE CASCADE ON UPDATE CASCADE'
  +#13#10'  , CONSTRAINT FKDEV_PEDIDOS_02 FOREIGN KEY (KCAD_ENTIDADE)'
  +#13#10'     REFERENCES CAD_ENTIDADES (KCAD_ENTIDADE)'
  +#13#10'     ON DELETE SET NULL ON UPDATE CASCADE'
  +#13#10')' ;

  _CREATE_TABLE_DEV_PEDIDO_ITENS =
           'CREATE TABLE DEV_PEDIDO_ITENS ('
    +#13#10'     KDEV_PEDIDO_ITEM  SYS$PKGUID20'
    +#13#10'   , KDEV_PEDIDO       SYS$FKGUID20_NN'
    +#13#10'   , KEST_PRODUTO      SYS$FKGUID20'
    +#13#10'   , CODIGO            SYS$CODE'
    +#13#10'   , NOME              SYS$DESCR_NN'
    +#13#10'   , UNIDADE           SYS$UNIDADE'
    +#13#10'   , DETALHES          SYS$BLOBTEXT'
    +#13#10'   , QTDE              SYS$FLOAT_NN_0'
    +#13#10'   , VALOR_UNITARIO    SYS$FLOAT_NN_0'
    +#13#10'   , QTDE_COMPRA       SYS$FLOAT_NN_0'
    +#13#10'   , VALOR_PARCIAL     COMPUTED BY (QTDE*VALOR_UNITARIO)'
    +#13#10'   , UNITARIO_COMPRA   SYS$FLOAT_NN_0'
    +#13#10'   , UNIDADE_COMPRA    SYS$UNIDADE'
    +#13#10'   , CFOP              FIN$CFOP'
    +#13#10'   , CST_CSOSN         FIN$CST_CSOSN'
    +#13#10'   , CFOP_ESTOQUE      FIN$CFOP'
    +#13#10'   , ATUALIZAR_CUSTO   SYS$BOOL_T'
    +#13#10'   , DESCONTO          SYS$FLOAT_NN_0'
    +#13#10'   , FRETE             SYS$FLOAT_NN_0'
    +#13#10'   , IMPOSTO           SYS$FLOAT_NN_0'
    +#13#10'   , TOTAL             SYS$FLOAT_NN_0'
    +#13#10'   , CUSTO             SYS$FLOAT_NN_0'
    +#13#10'   , OBS               SYS$BLOBTEXT'
    +#13#10'   , KFIN_PLANOCONTA   SYS$FKGUID20'
    +#13#10'   , IS_PATRIMONIO     SYS$BOOL_F'
    +#13#10'   , SYS$UI            SYS$USERLOGIN'
    +#13#10'   , SYS$DI            SYS$DATE'
    +#13#10'   , SYS$UU            SYS$USERLOGIN'
    +#13#10'   , SYS$DU            SYS$DATE'
    +#13#10'   , VALOR_IPI         SYS$FLOAT_NN_0'
    +#13#10'   , CONSTRAINT PKDEV_PEDIDO_ITENS PRIMARY KEY (KDEV_PEDIDO_ITEM)'
    +#13#10'   , CONSTRAINT FKDEV_PEDIDO_ITENS_01 FOREIGN KEY (KDEV_PEDIDO)'
    +#13#10'      REFERENCES DEV_PEDIDOS (KDEV_PEDIDO)'
    +#13#10'      ON DELETE CASCADE ON UPDATE CASCADE'
    +#13#10'   , CONSTRAINT FKDEV_PEDIDO_ITENS_02 FOREIGN KEY (KEST_PRODUTO)'
    +#13#10'      REFERENCES EST_PRODUTOS (KEST_PRODUTO)'
    +#13#10'      ON UPDATE CASCADE'
    +#13#10'   , CONSTRAINT FKDEV_PEDIDO_ITENS_03 FOREIGN KEY (KFIN_PLANOCONTA)'
    +#13#10'      REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA)'
    +#13#10'      ON UPDATE CASCADE'
    +#13#10')' ;

begin
  TryExecuteDirect( _CREATE_TABLE_DEV_PEDIDOS ) ;
  TryExecuteDirect( _CREATE_TABLE_DEV_PEDIDO_ITENS ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_60 ;
const
  _ALTER_TABLE_FRISIA_CLIENTES =
         'ALTER TABLE FRISIA_CLIENTES'
  +#13#10'  ADD KCAD_ENTIDADE SYS$FKGUID20'
  +#13#10', ALTER KCAD_ENTIDADE POSITION 3' ;

  _ALTER_TABLE_FRISIA_FORNECEDORES =
         'ALTER TABLE FRISIA_FORNECEDORES '
  +#13#10'  ADD KCAD_ENTIDADE SYS$FKGUID20'
  +#13#10', ALTER KCAD_ENTIDADE POSITION 3' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_CLIENTES ) ;
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_FORNECEDORES ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_59;
const
   _ALTER_PROCEDURE_FIN_UPDATE_SALDO_CONTA =
       'CREATE OR ALTER PROCEDURE FIN_UPDATE_SALDO_CONTA ('
+#13#10'      KFIN_CONTA SYS$PKGUID20'
+#13#10'    , PSOMA SYS$FLOAT'
+#13#10'    , PSUBTRAI SYS$FLOAT'
+#13#10'    , DEBITO_CREDITO FIN$DEVEDORA_CREDORA)'
+#13#10'AS'
+#13#10'DECLARE VALOR_INJETADO SYS$FLOAT ;'
+#13#10'DECLARE VALOR_UTILIZADO SYS$FLOAT ;'
+#13#10'BEGIN'
+#13#10'  WHILE ( 1=1 ) DO'
+#13#10'  BEGIN'
+#13#10'    IF (DEBITO_CREDITO = ''D'') THEN'
+#13#10'      UPDATE FIN_CONTAS'
+#13#10'        SET VALOR_UTILIZADO'
+#13#10'            = VALOR_UTILIZADO'
+#13#10'            + :pSOMA'
+#13#10'            - :pSUBTRAI'
+#13#10'      WHERE KFIN_CONTA = :KFIN_CONTA;'
+#13#10''
+#13#10'    IF (DEBITO_CREDITO = ''C'') THEN'
+#13#10'      UPDATE FIN_CONTAS'
+#13#10'          SET VALOR_INJETADO'
+#13#10'            = VALOR_INJETADO'
+#13#10'            + :pSOMA'
+#13#10'             - :pSUBTRAI'
+#13#10'      WHERE KFIN_CONTA = :KFIN_CONTA;'
+#13#10''
+#13#10''
+#13#10'    LEAVE ;'
+#13#10'  WHEN GDSCODE lock_conflict'
+#13#10'     , GDSCODE deadlock DO'
+#13#10'  BEGIN'
+#13#10'  END'
+#13#10'  END'
+#13#10'END' ;

begin
  ExecuteDirect ( _ALTER_PROCEDURE_FIN_UPDATE_SALDO_CONTA ) ;
end;


procedure TDBFinanceiroUpdate._5_001_58;
const
  _ALTER_TABLE_VND_PEDIDOS_ADD_XML_NFE2 =
          'ALTER TABLE VND_PEDIDOS'
   +#13#10'ADD XML_NFE SYS$BLOBXML2,'
   +#13#10'ALTER XML_NFE POSITION 21' ;

begin
  TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS_ADD_XML_NFE2 ) ;
end;

procedure TDBFinanceiroUpdate._5_001_57 ;
const
  _ALTER_TABLE_FRISIA_MATRICULAS =
      'ALTER TABLE FRISIA_MATRICULAS'
+#13#10'   ADD SENHA SYS$PASSWORD'
+#13#10' , ALTER SENHA POSITION 6' ;

begin
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_MATRICULAS ) ;
end;


procedure TDBFinanceiroUpdate._5_001_55;
const
  _UPDATE_EST_PRODUTOS_QTDE_MINIMA =
          'UPDATE '
    +#13#10'  EST_PRODUTOS '
    +#13#10'SET '
    +#13#10'  QTDE_MINIMA = 0 '
    +#13#10'WHERE '
    +#13#10'      PRODUTO_INSUMO_SERVICO = 3 '
    +#13#10'  AND QTDE_MINIMA IS NOT NULL' ;

  _UPDATE_EST_PRODUTOS_BAIXA_ESTOQUE =
          'UPDATE '
    +#13#10'  EST_PRODUTOS '
    +#13#10'SET '
    +#13#10'  BAIXA_ESTOQUE = ''F'' '
    +#13#10'WHERE '
    +#13#10'      PRODUTO_INSUMO_SERVICO = 3 ';
var
  EncerramentoMensal : TEncerramentoMensal ;
begin
  EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );
  TryExecuteDirect ( _UPDATE_EST_PRODUTOS_QTDE_MINIMA ) ;
  TryExecuteDirect ( _UPDATE_EST_PRODUTOS_BAIXA_ESTOQUE ) ;
  EncerramentoMensal.Free ;
end;

procedure TDBFinanceiroUpdate._5_001_54 ;
const
  _CREATE_DOMAIN_SYS_SMDESCR =
               'CREATE DOMAIN SYS$SMDESCR AS'
        +#13#10'VARCHAR(64) CHARACTER SET ISO8859_1'
        +#13#10'COLLATE ISO8859_1' ;

  _CREATE_DOMAIN_SYS_SMDESCR_NN =
               'CREATE DOMAIN SYS$SMDESCR_NN AS'
        +#13#10'VARCHAR(64) CHARACTER SET ISO8859_1'
        +#13#10'NOT NULL'
        +#13#10'COLLATE ISO8859_1' ;

   _ALTER_TABLE_EST_PRODUTOS =
             'ALTER TABLE EST_PRODUTOS'
      +#13#10'  ADD   TIPO_PRODUTO SYS$SMDESCR'
      +#13#10', ALTER TIPO_PRODUTO POSITION 9' ;

   _SQL_CAD_TIPOS =
             'SELECT DISTINCT '
      +#13#10'    KCAD_TIPOS'
      +#13#10'  , DESCRICAO'
      +#13#10'  , KSYS$DOMAIN'
      +#13#10'  , KCAD_FAZENDA'
      +#13#10'  , TIPO'
      +#13#10'FROM CAD_TIPOS'
      +#13#10'WHERE TIPO = 3' ;

   _INSERT_CAD_TIPOS  =
             'INSERT INTO CAD_TIPOS (KCAD_TIPOS, KSYS$DOMAIN, KCAD_FAZENDA, TIPO, DESCRICAO) '
      +#13#10' VALUES (:KCAD_TIPOS, :KSYS$DOMAIN, :KCAD_FAZENDA, :TIPO, :DESCRICAO)' ;

   _UPDATE_EST_PRODUTOS =
             'UPDATE EST_PRODUTOS P'
      +#13#10'SET'
      +#13#10'  P.TIPO_PRODUTO = (SELECT SUBSTRING( T.DESCRICAO FROM 1 FOR 64 ) FROM CAD_TIPOS T WHERE T.KCAD_TIPOS = P.KTIPO_PRODUTO )'
      +#13#10'WHERE P.KTIPO_PRODUTO IS NOT NULL' ;

var
  cds: TClientDataSet;
  p: TParams;
begin
  TryExecuteDirect ( _CREATE_DOMAIN_SYS_SMDESCR    ) ;
  TryExecuteDirect ( _CREATE_DOMAIN_SYS_SMDESCR_NN ) ;
  TryExecuteDirect ( _ALTER_TABLE_EST_PRODUTOS     ) ;

  if not Assigned ( TTcAbstractDB.GetByAlias('ENTIDADES') ) then
     exit ;

  cds:= nil;
  Tc.DBRTL.AbstractDB.TTcAbstractDB.GetByAlias('ENTIDADES').populateClientDataSet( cds, _SQL_CAD_TIPOS );

  p:= TParams.Create(nil);
  p.Clear;
  p.CreateParam(ftString, 'KCAD_TIPOS',   ptInput ) ;
  p.CreateParam(ftString, 'KSYS$DOMAIN',       ptInput ) ;
  p.CreateParam(ftString, 'KCAD_FAZENDA', ptInput ) ;
  p.CreateParam(ftInteger,'TIPO',         ptInput ) ;
  p.CreateParam(ftString, 'DESCRICAO',    ptInput ) ;

  with cds do
   begin
     First;
     while not Eof do
      begin

        p.ParamByName( 'KCAD_TIPOS'   ).AsString  := FieldByName( 'KCAD_TIPOS'   ).AsString  ;
        p.ParamByName( 'KSYS$DOMAIN'  ).AsString  := FieldByName( 'KSYS$DOMAIN'  ).AsString  ;
        p.ParamByName( 'KCAD_FAZENDA' ).AsString  := FieldByName( 'KCAD_FAZENDA' ).AsString  ;
        p.ParamByName( 'TIPO'         ).AsInteger := FieldByName( 'TIPO'         ).AsInteger ;
        p.ParamByName( 'DESCRICAO'    ).AsString  := FieldByName( 'DESCRICAO'    ).AsString; ;

        IDB.Execute( _INSERT_CAD_TIPOS, p);
        Next;
      end;
   end;
  cds.Free;

  p.Free;
  ExecuteDirect ( _UPDATE_EST_PRODUTOS ) ;

end;

procedure TDBFinanceiroUpdate._5_001_53;
const
  _UPDATE_FIN_APAGAR_PARCELAS =
          'UPDATE'
    +#13#10'  FIN_APAGAR_PARCELAS'
    +#13#10'SET'
    +#13#10'  DT_COMPENSACAO = PAGTO'
    +#13#10'WHERE'
    +#13#10'      PAGTO IS NOT NULL'
    +#13#10'  AND CHEQUE = ''F'''
    +#13#10'  AND DT_COMPENSACAO IS NULL' ;

  _UPDATE_FIN_ARECEBER_PARCELAS =
          'UPDATE'
    +#13#10'  FIN_ARECEBER_PARCELAS'
    +#13#10'SET'
    +#13#10'  DT_COMPENSACAO = PAGTO'
    +#13#10'WHERE'
    +#13#10'      PAGTO IS NOT NULL'
    +#13#10'  AND CHEQUE = ''F'''
    +#13#10'  AND DT_COMPENSACAO IS NULL' ;
begin
  TryExecuteDirect ( _UPDATE_FIN_APAGAR_PARCELAS ) ;
  TryExecuteDirect ( _UPDATE_FIN_ARECEBER_PARCELAS ) ;
end;

procedure TDBFinanceiroUpdate._5_001_52;
const
  _ALTER_TABLE_CMP_PEDIDO_ITENS_ADD_VALOR_IPI =
       'ALTER TABLE CMP_PEDIDO_ITENS ADD VALOR_IPI SYS$FLOAT_NN_0';
begin
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDO_ITENS_ADD_VALOR_IPI ) ;
end;

procedure TDBFinanceiroUpdate._5_001_51 ;
const
  _ALTER_TABLE_FRISIA_CLIENTES =
         'ALTER TABLE FRISIA_CLIENTES'
  +#13#10'  ADD KCAD_ENTIDADE SYS$FKGUID20'
  +#13#10', ALTER KCAD_ENTIDADE POSITION 3' ;

  _ALTER_TABLE_FRISIA_FORNECEDORES =
         'ALTER TABLE FRISIA_FORNECEDORES '
  +#13#10'  ADD KCAD_ENTIDADE SYS$FKGUID20'
  +#13#10', ALTER KCAD_ENTIDADE POSITION 3' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_CLIENTES ) ;
  TryExecuteDirect ( _ALTER_TABLE_FRISIA_FORNECEDORES ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_50 ;
const
  _CREATE_TABLE_FIN_FINANCIAMENTOS =
       'CREATE TABLE FIN_FINANCIAMENTOS ('
+#13#10'    KFIN_FINANCIAMENTO           SYS$PKGUID20'
+#13#10'  , KSYS$DOMAIN                  SYS$FKGUID20_NN'
+#13#10'  , KCAD_ENTIDADE                SYS$FKGUID20'
+#13#10'  , NOMEENTIDADE                 SYS$DESCR'
+#13#10'  , HISTORICO                    SYS$DESCR'
+#13#10'  , APELIDO                      SYS$DESCR'
+#13#10'  , DOCUMENTO                    FIN$DOC'
+#13#10'  , DATALANCTO                   SYS$DATE_DEF'
+#13#10'  , VALOR                        SYS$FLOAT'
+#13#10'  , NUM_PARCELAS                 SYS$INT_NN_0'
+#13#10'  , KFIN_ARECEBER_FINANCIAMENTO  SYS$FKGUID20_NN'
+#13#10'  , KFIN_APAGAR_AMORTIZACAO      SYS$FKGUID20_NN'
+#13#10'  , KFIN_APAGAR_JUROS            SYS$FKGUID20'
+#13#10'  , OBS                          SYS$BLOBTEXT'
+#13#10'  , ATIVO                        SYS$BOOL_T'
+#13#10'  , IMPORTADO                    SYS$BOOL_F'
+#13#10'  , SYS$UI                       SYS$USERLOGIN'
+#13#10'  , SYS$DI                       SYS$DATE'
+#13#10'  , SYS$UU                       SYS$USERLOGIN'
+#13#10'  , SYS$DU                       SYS$DATE'
+#13#10'  , CONSTRAINT PKFIN_FINANCIAMENTO'
+#13#10'    PRIMARY KEY (KFIN_FINANCIAMENTO)'
+#13#10'  , CONSTRAINT FKFIN_FINANCIAMENTO_01'
+#13#10'    FOREIGN KEY (KSYS$DOMAIN)'
+#13#10'    REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
+#13#10'    ON DELETE CASCADE ON UPDATE CASCADE'
+#13#10'  , CONSTRAINT FKFIN_FINANCIAMENTO_02'
+#13#10'    FOREIGN KEY (KCAD_ENTIDADE)'
+#13#10'    REFERENCES CAD_ENTIDADES (KCAD_ENTIDADE)'
+#13#10'    ON DELETE SET NULL ON UPDATE CASCADE'
+#13#10')' ;


 _CREATE_INDEX_IXFIN_FINANCIAMENTOS_01 =
  'CREATE INDEX IXFIN_FINANCIAMENTOS_01 ON FIN_FINANCIAMENTOS (KSYS$DOMAIN, DOCUMENTO)' ;

 _CREATE_TRIGGER_FIN_FINANCIAMENTOS_AUD0 =
         'CREATE OR ALTER TRIGGER FIN_FINANCIAMENTOS_AUD0 FOR FIN_FINANCIAMENTOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_ARECEBER'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_ARECEBER = NEW.KFIN_ARECEBER_FINANCIAMENTO )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR_AMORTIZACAO )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR_JUROS )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'     DELETE FROM FIN_ARECEBER WHERE KFIN_ARECEBER = OLD.KFIN_ARECEBER_FINANCIAMENTO ;'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_AMORTIZACAO ;'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_JUROS ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;

begin
   TryExecuteDirect ( _CREATE_TABLE_FIN_FINANCIAMENTOS ) ;
   TryExecuteDirect ( _CREATE_INDEX_IXFIN_FINANCIAMENTOS_01 ) ;
   ExecuteDirect    ( _CREATE_TRIGGER_FIN_FINANCIAMENTOS_AUD0 ) ;
end;


procedure TDBFinanceiroUpdate._5_001_49;
const
  _ALTER_TABLE_VND_PEDIDOS_ADD_CHAVENFE =
          'ALTER TABLE VND_PEDIDOS'
   +#13#10'ADD CHAVENFE FIN$CHAVENFE,'
   +#13#10'ALTER CHAVENFE POSITION 6' ;

 _ALTER_TABLE_VND_PEDIDOS_ADD_IMPORTADO_NFE =
        'ALTER TABLE VND_PEDIDOS'
 +#13#10'ADD IMPORTADO_NFE SYS$BOOL_F,'
 +#13#10'ALTER IMPORTADO_NFE POSITION 7' ;

 _ALTER_TABLE_VND_PEDIDOS_ADD_MODELO_NFE  =
        'ALTER TABLE VND_PEDIDOS'
 +#13#10'ADD MODELO_NFE SYS$INT,'
 +#13#10'ALTER MODELO_NFE POSITION 8' ;

  _ALTER_TABLE_VND_PEDIDOS_ADD_XML_NFE2 =
          'ALTER TABLE VND_PEDIDOS'
   +#13#10'ADD XML_NFE SYS$BLOBXML2,'
   +#13#10'ALTER XML_NFE POSITION 21' ;

begin
  TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS_ADD_CHAVENFE ) ;
  TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS_ADD_IMPORTADO_NFE ) ;
  TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS_ADD_MODELO_NFE  ) ;
  TryExecuteDirect ( _ALTER_TABLE_VND_PEDIDOS_ADD_XML_NFE2 ) ;
end;

procedure TDBFinanceiroUpdate._5_001_48;
const
    _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_BIUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
  +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM CMP_PEDIDO_ITENS'
  +#13#10'        WHERE KCMP_PEDIDO = NEW.KCMP_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( deleting ) then'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_ENTRADA ;'
  +#13#10'    END'
  +#13#10'END' ;

 _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 =
         'CREATE OR ALTER TRIGGER VND_PEDIDOS_BIUD0 FOR VND_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'    --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --IF ( OLD.DATA_SAIDA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'      --  EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_EMISSAO ;'
  +#13#10'      --IF ( NEW.DATA_SAIDA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'      --   EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SAIDA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM VND_PEDIDO_ITENS'
  +#13#10'        WHERE KVND_PEDIDO = NEW.KVND_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, KEST_PRODUTO, NEW.DATA_EMISSAO /*DATA_SAIDA*/ ;'
  +#13#10''
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_EMISSAO ;'
  +#13#10'      --EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA_SAIDA ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;


begin
   ExecuteDirect ( _ALTER_TRIGGER_CMP_PEDIDOS_BIUD0 ) ;
   ExecuteDirect ( _ALTER_TRIGGER_VND_PEDIDOS_BIUD0 ) ;
end;

procedure TDBFinanceiroUpdate._5_001_47 ;
const
  _CREATE_TABLE_FRISIA_PRODUTOS =
         'CREATE TABLE FRISIA_PRODUTOS ('
  +#13#10'   KFRISIA_PRODUTO    SYS$PKGUID20'
  +#13#10' , KSYS$DOMAIN        SYS$FKGUID20_NN'
  +#13#10' , KEST_PRODUTO       SYS$FKGUID20'
  +#13#10' , CPF_CNPJ           SYS$CPF_CNPJ'
  +#13#10' , CODIGOPRODUTO      SYS$CODE'
  +#13#10' , DESCRICAO          SYS$DESCR'
  +#13#10' , UNIDADE            SYS$UNIDADE'
  +#13#10' , APROPRIACAO        SYS$CODE'
  +#13#10' , VINCULO            SYS$INT_NN_0'
  +#13#10' , ATIVO              SYS$BOOL_T'
  +#13#10' , SYS$UI             SYS$USERLOGIN'
  +#13#10' , SYS$DI             SYS$DATE'
  +#13#10' , SYS$UU             SYS$USERLOGIN'
  +#13#10' , SYS$DU             SYS$DATE'
  +#13#10' , CONSTRAINT PKFRISIA_PRODUTO'
  +#13#10'     PRIMARY KEY (KFRISIA_PRODUTO)'
  +#13#10' , CONSTRAINT FKFRISIA_PRODUTO_01'
  +#13#10'     FOREIGN KEY (KSYS$DOMAIN)'
  +#13#10'     REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
  +#13#10'     ON DELETE CASCADE ON UPDATE CASCADE'
  +#13#10' , CONSTRAINT FKFRISIA_PRODUTO_02'
  +#13#10'     FOREIGN KEY (KEST_PRODUTO)'
  +#13#10'     REFERENCES EST_PRODUTOS (KEST_PRODUTO)'
  +#13#10'     ON DELETE SET NULL ON UPDATE CASCADE'
  +#13#10' , CONSTRAINT CKFRISIA_PRODUTO_01'
  +#13#10'     CHECK ( VINCULO IN (0,1,2))'
  +#13#10')' ;

     _CREATE_TABLE_FRISIA_CLIENTES =

         'CREATE TABLE FRISIA_CLIENTES ('
  +#13#10'   KFRISIA_CLIENTE  SYS$PKGUID20 NOT NULL'
  +#13#10' , KSYS$DOMAIN         SYS$FKGUID20_NN'
  +#13#10' , CPF_CNPJ            SYS$CPF_CNPJ'
  +#13#10' , APELIDO             SYS$DESCR_NN'
  +#13#10' , NOME                SYS$DESCR_NN'
  +#13#10' , ENDERECO            SYS$ENDERECO'
  +#13#10' , NUMERO              SYS$NUMERO'
  +#13#10' , COMPLEMENTO         SYS$COMPLEMENTO'
  +#13#10' , BAIRRO              SYS$BAIRRO'
  +#13#10' , CEP                 SYS$CEP'
  +#13#10' , CIDADE              SYS$CIDADE'
  +#13#10' , UF                  SYS$UF'
  +#13#10' , PESSOA              SYS$TIPO_PESSOA'
  +#13#10' , RG_IE               SYS$RG_IE'
  +#13#10' , URL                 SYS$URL'
  +#13#10' , EMAIL               SYS$EMAIL'
  +#13#10' , FONE                SYS$FONE'
  +#13#10' , RAMAL               SYS$RAMAL'
  +#13#10' , SYS$UI              SYS$USERLOGIN'
  +#13#10' , SYS$DI              SYS$DATE'
  +#13#10' , SYS$UU              SYS$USERLOGIN'
  +#13#10' , SYS$DU              SYS$DATE'
  +#13#10' , CONSTRAINT PKFRISIA_CLIENTES PRIMARY KEY (KFRISIA_CLIENTE)'
  +#13#10' , CONSTRAINT FKFRISIA_CLIENTES_02 FOREIGN KEY (KSYS$DOMAIN)'
  +#13#10'    REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
  +#13#10'    ON DELETE CASCADE ON UPDATE CASCADE'
  +#13#10')' ;

     _CREATE_TABLE_FRISIA_FORNECEDORES =
         'CREATE TABLE FRISIA_FORNECEDORES ('
  +#13#10'   KFRISIA_FORNECEDOR  SYS$PKGUID20 NOT NULL'
  +#13#10' , KSYS$DOMAIN         SYS$FKGUID20_NN'
  +#13#10' , CPF_CNPJ            SYS$CPF_CNPJ'
  +#13#10' , APELIDO             SYS$DESCR_NN'
  +#13#10' , NOME                SYS$DESCR_NN'
  +#13#10' , ENDERECO            SYS$ENDERECO'
  +#13#10' , NUMERO              SYS$NUMERO'
  +#13#10' , COMPLEMENTO         SYS$COMPLEMENTO'
  +#13#10' , BAIRRO              SYS$BAIRRO'
  +#13#10' , CEP                 SYS$CEP'
  +#13#10' , CIDADE              SYS$CIDADE'
  +#13#10' , UF                  SYS$UF'
  +#13#10' , PESSOA              SYS$TIPO_PESSOA'
  +#13#10' , RG_IE               SYS$RG_IE'
  +#13#10' , URL                 SYS$URL'
  +#13#10' , EMAIL               SYS$EMAIL'
  +#13#10' , FONE                SYS$FONE'
  +#13#10' , RAMAL               SYS$RAMAL'
  +#13#10' , SYS$UI              SYS$USERLOGIN'
  +#13#10' , SYS$DI              SYS$DATE'
  +#13#10' , SYS$UU              SYS$USERLOGIN'
  +#13#10' , SYS$DU              SYS$DATE'
  +#13#10' , CONSTRAINT PKFRISIA_FORNECEDORES PRIMARY KEY (KFRISIA_FORNECEDOR)'
  +#13#10' , CONSTRAINT FKFRISIA_FORNECEDORES_02 FOREIGN KEY (KSYS$DOMAIN)'
  +#13#10'    REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
  +#13#10'    ON DELETE CASCADE ON UPDATE CASCADE'
  +#13#10')' ;

begin
    TryExecuteDirect ( _CREATE_TABLE_FRISIA_PRODUTOS ) ;
    TryExecuteDirect( _CREATE_TABLE_FRISIA_CLIENTES ) ;
    TryExecuteDirect( _CREATE_TABLE_FRISIA_FORNECEDORES ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_45;
const
   _ALTER_TABLE_FIN_ARECEBER_ADD_PAGTO_AVISTA =
         'ALTER TABLE FIN_ARECEBER'
  +#13#10'ADD PAGTO_AVISTA SYS$BOOL_F' ;
begin
 TryExecuteDirect ( _ALTER_TABLE_FIN_ARECEBER_ADD_PAGTO_AVISTA ) ;
end;




procedure TDBFinanceiroUpdate._5_001_44;
const
  _CREATE_TABLE_FRISIA_MATRICULAS =
      'CREATE TABLE FRISIA_MATRICULAS ('
+#13#10'    KFRISIA_MATRICULA SYS$PKGUID20,'
+#13#10'    KSYS$DOMAIN       SYS$FKGUID20_NN,'
+#13#10'    FRISIA_MATRICULA  SYS$INT,'
+#13#10'    DESCRICAO         SYS$DESCR,'
+#13#10'    ATIVO             SYS$BOOL_T,'
+#13#10'    SYS$UI            SYS$USERLOGIN,'
+#13#10'    SYS$DI            SYS$DATE,'
+#13#10'    SYS$UU            SYS$USERLOGIN,'
+#13#10'    SYS$DU            SYS$DATE'
+#13#10')' ;


 _PKFRISIA_MATRICULA =
  'ALTER TABLE FRISIA_MATRICULAS ADD CONSTRAINT PKFRISIA_MATRICULA PRIMARY KEY (KFRISIA_MATRICULA)' ;

 _FKFRISIA_MATRICULA_01 =
  'ALTER TABLE FRISIA_MATRICULAS ADD CONSTRAINT FKFRISIA_MATRICULA_01 FOREIGN KEY (KSYS$DOMAIN) REFERENCES SYS$DOMAINS (KSYS$DOMAIN) ON DELETE CASCADE ON UPDATE CASCADE' ;

 _CREATE_TABLE_FRISIA_TIPOSCONTA =
         'CREATE TABLE FRISIA_TIPOSCONTA ('
  +#13#10'    KFRISIA_TIPOCONTA SYS$PKINT,'
  +#13#10'    DESCRICAO         SYS$DESCR,'
  +#13#10'    SYS$UI            SYS$USERLOGIN,'
  +#13#10'    SYS$DI            SYS$DATE,'
  +#13#10'    SYS$UU            SYS$USERLOGIN,'
  +#13#10'    SYS$DU            SYS$DATE'
  +#13#10')' ;

 _PKFRISIA_TIPOSCONTA =
   'ALTER TABLE FRISIA_TIPOSCONTA ADD CONSTRAINT PKFRISIA_TIPOSCONTA PRIMARY KEY (KFRISIA_TIPOCONTA)' ;

   _CREATE_TABLE_FRISIA_MATRICULA_CONTAS =
       'CREATE TABLE FRISIA_MATRICULA_CONTAS ('
+#13#10'    KFRISIA_MATRICULA_CONTA        SYS$PKGUID20,'
+#13#10'    KFRISIA_MATRICULA              SYS$FKGUID20_NN,'
+#13#10'    KFRISIA_TIPOCONTA              SYS$INT_NN,'
+#13#10'    FRISIA_ID                      SYS$INT_NN,'
+#13#10'    ULTIMO_SALDO                   SYS$FLOAT_NN_0,'
+#13#10'    ULTIMO_SINCRONISMO             SYS$DATE,'
+#13#10'    KFIN_CONTA                     SYS$FKGUID20,'
+#13#10'    SYS$UI                         SYS$USERLOGIN,'
+#13#10'    SYS$DI                         SYS$DATE,'
+#13#10'    SYS$UU                         SYS$USERLOGIN,'
+#13#10'    SYS$DU                         SYS$DATE'
+#13#10')' ;


 _PKFRISIA_MATRICULA_CONTAS =
    'ALTER TABLE FRISIA_MATRICULA_CONTAS ADD CONSTRAINT PKFRISIA_MATRICULA_CONTAS PRIMARY KEY (KFRISIA_MATRICULA_CONTA)' ;
 _FKFRISIA_MATRICULA_CONTA_01 =
    'ALTER TABLE FRISIA_MATRICULA_CONTAS ADD CONSTRAINT FKFRISIA_MATRICULA_CONTA_01 FOREIGN KEY (KFRISIA_MATRICULA) REFERENCES FRISIA_MATRICULAS (KFRISIA_MATRICULA) ON DELETE CASCADE ON UPDATE CASCADE' ;
 _FKFRISIA_MATRICULA_CONTA_02 =
    'ALTER TABLE FRISIA_MATRICULA_CONTAS ADD CONSTRAINT FKFRISIA_MATRICULA_CONTA_02 FOREIGN KEY (KFIN_CONTA) REFERENCES FIN_CONTAS (KFIN_CONTA) ON UPDATE CASCADE' ;


begin
 TryExecuteDirect ( _CREATE_TABLE_FRISIA_MATRICULAS ) ;
 TryExecuteDirect ( _PKFRISIA_MATRICULA             ) ;
 TryExecuteDirect ( _FKFRISIA_MATRICULA_01          ) ;

 TryExecuteDirect ( _CREATE_TABLE_FRISIA_TIPOSCONTA ) ;
 TryExecuteDirect ( _PKFRISIA_TIPOSCONTA            ) ;

 TryExecuteDirect ( _CREATE_TABLE_FRISIA_MATRICULA_CONTAS ) ;
 TryExecuteDirect ( _PKFRISIA_MATRICULA_CONTAS            ) ;
 TryExecuteDirect ( _FKFRISIA_MATRICULA_CONTA_01          ) ;
 TryExecuteDirect ( _FKFRISIA_MATRICULA_CONTA_02          ) ;

end ;

procedure TDBFinanceiroUpdate._5_001_43;
const
   _CREATE_TABLE_CAD_TIPOS=
          'CREATE TABLE CAD_TIPOS('
     +#13#10'  KCAD_TIPOS SYS$PKGUID20,'
     +#13#10'  KSYS$DOMAIN SYS$FKGUID20_NN,'
     +#13#10'  KCAD_FAZENDA SYS$FKGUID20_NN,'
     +#13#10'  TIPO SYS$INT_NN,'
     +#13#10'  DESCRICAO SYS$DESCR_NN,'
     +#13#10'  SYS$UI SYS$USERLOGIN,'
     +#13#10'  SYS$DI SYS$DATE,'
     +#13#10'  SYS$UU SYS$USERLOGIN,'
     +#13#10'  SYS$DU SYS$DATE,'
     +#13#10'  CONSTRAINT PKCAD_TIPOS PRIMARY KEY (KCAD_TIPOS)'
     +#13#10');';


   _CREATE_TRIGGER_CAD_TIPOS_DOMAIN_BI0 =
          'CREATE OR ALTER TRIGGER CAD_TIPOS_DOMAIN FOR CAD_TIPOS'
   +#13#10'ACTIVE BEFORE INSERT POSITION 1002'
   +#13#10'AS'
   +#13#10'BEGIN'

   +#13#10'   NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ;'

   +#13#10'END;';


   _CREATE_TRIGGER_RLOGCAD_TIPOS_BIU0 =
             'CREATE OR ALTER TRIGGER RLOG$CAD_TIPOS FOR CAD_TIPOS'
      +#13#10'ACTIVE BEFORE INSERT OR UPDATE POSITION 15000'
      +#13#10'AS'
      +#13#10'BEGIN'

      +#13#10'  if ( (RDB$GET_CONTEXT( ''USER_SESSION'',     ''RLOG$OFF'' ) = ''1'')'
      +#13#10'    OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) = ''1'') ) THEN'
      +#13#10'     EXIT ;'

      +#13#10'  if ( inserting ) then'
      +#13#10'  begin'
      +#13#10'    if ( NEW.SYS$UI is NULL ) then'
      +#13#10'      NEW.SYS$UI = RDB$GET_CONTEXT ( ''USER_SESSION'', ''USERNAME'' ) ;'
      +#13#10'    if ( NEW.SYS$DI is NULL ) then'
      +#13#10'      NEW.SYS$DI = CURRENT_TIMESTAMP ;'
      +#13#10'  end'

      +#13#10'  if ( updating ) then'
      +#13#10'  begin'
      +#13#10'     NEW.SYS$UU = RDB$GET_CONTEXT ( ''USER_SESSION'', ''USERNAME'' ) ;'
      +#13#10'     NEW.SYS$DU = CURRENT_TIMESTAMP ;'
      +#13#10'  end'

      +#13#10'END;';


   _CREATE_TRIGGER_JNLCAD_TIPOS_AIUE0 =
             'CREATE OR ALTER TRIGGER JNL$CAD_TIPOS FOR CAD_TIPOS'
      +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 16000'
      +#13#10'AS'
      +#13#10'  DECLARE JNL$TRASACTION_SEQUENCE  INTEGER ;'
      +#13#10'  DECLARE nf  SMALLINT = 0 ;'
      +#13#10'  DECLARE nfb SMALLINT = 0 ;'
      +#13#10'  DECLARE xml BLOB SUB_TYPE 1 ;'
      +#13#10'  DECLARE fxml BLOB SUB_TYPE 1 ;'
      +#13#10'  DECLARE VARIABLE START_TRANSACTION TIMESTAMP ;'
      +#13#10'BEGIN'

      +#13#10'  if ( (RDB$GET_CONTEXT( ''USER_SESSION'',     ''JNL$OFF'' ) = ''1'')'
      +#13#10'    OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''JNL$OFF'' ) = ''1'') ) THEN '
      +#13#10'     EXIT ;'

      +#13#10'  EXECUTE PROCEDURE JNL$GET_TRANSACTION_SEQUENCE'
      +#13#10'  RETURNING_VALUES JNL$TRASACTION_SEQUENCE ;'

      +#13#10'  xml = ''<table Name="CAD_TIPOS"'' '
      +#13#10'   || '' sequence="'' || NEXT VALUE FOR JNL$TABLE_SEQUENCE || ''"'' '
      +#13#10'   || '' uk="'''
      +#13#10'   ||    CASE'
      +#13#10'           WHEN ( inserting ) THEN ''I'''
      +#13#10'           WHEN ( updating  ) THEN ''U'''
      +#13#10'           ELSE ''D'''
      +#13#10'         END'
      +#13#10'   || ''"'' '
      +#13#10'   || '' ts="'' || cast ( ''NOW'' as TIMESTAMP ) || ''">'' ;'


      +#13#10'  IF ( not inserting ) THEN'
      +#13#10'  BEGIN'
      +#13#10'    xml = xml || ''<PrimaryKey count="1">'' ;'

      +#13#10'    IF ( OLD.KCAD_TIPOS is NULL ) THEN'
      +#13#10'      xml = xml || ''<field Name="KCAD_TIPOS" IsNull="T"/>'' ;'
      +#13#10'    ELSE'
      +#13#10'      xml = xml || ''<field Name="KCAD_TIPOS">'' || OLD.KCAD_TIPOS || ''</field>'' ;'
      +#13#10'    xml = xml || ''</PrimaryKey>'' ;'
      +#13#10'  END'

      +#13#10'  fxml = '''' ;'

      +#13#10'  IF (   (inserting  and  NEW.KCAD_TIPOS IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.KCAD_TIPOS IS DISTINCT FROM OLD.KCAD_TIPOS) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.KCAD_TIPOS is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="KCAD_TIPOS" IsNull="T" ft="14"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="KCAD_TIPOS" ft="14">'' || TRIM ( NEW.KCAD_TIPOS ) || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.KSYS$DOMAIN IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.KSYS$DOMAIN is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="KSYS$DOMAIN" IsNull="T" ft="14"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="KSYS$DOMAIN" ft="14">'' || TRIM ( NEW.KSYS$DOMAIN ) || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.KCAD_FAZENDA IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.KCAD_FAZENDA IS DISTINCT FROM OLD.KCAD_FAZENDA) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.KCAD_FAZENDA is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="KCAD_FAZENDA" IsNull="T" ft="14"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="KCAD_FAZENDA" ft="14">'' || TRIM ( NEW.KCAD_FAZENDA ) || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.TIPO IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.TIPO IS DISTINCT FROM OLD.TIPO) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.TIPO is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="TIPO" IsNull="T" ft="8"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="TIPO" ft="8">'' || NEW.TIPO || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.DESCRICAO IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.DESCRICAO IS DISTINCT FROM OLD.DESCRICAO) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.DESCRICAO is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="DESCRICAO" IsNull="T" ft="37"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="DESCRICAO" ft="37">'' || NEW.DESCRICAO || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.SYS$UI IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.SYS$UI IS DISTINCT FROM OLD.SYS$UI) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.SYS$UI is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="SYS$UI" IsNull="T" ft="37"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="SYS$UI" ft="37">'' || NEW.SYS$UI || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.SYS$DI IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.SYS$DI IS DISTINCT FROM OLD.SYS$DI) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.SYS$DI is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="SYS$DI" IsNull="T" ft="35"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="SYS$DI" ft="35">'' || NEW.SYS$DI || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.SYS$UU IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.SYS$UU IS DISTINCT FROM OLD.SYS$UU) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.SYS$UU is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="SYS$UU" IsNull="T" ft="37"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="SYS$UU" ft="37">'' || NEW.SYS$UU || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF (   (inserting  and  NEW.SYS$DU IS NOT NULL)'
      +#13#10'      or (updating   and  NEW.SYS$DU IS DISTINCT FROM OLD.SYS$DU) ) THEN'
      +#13#10'  BEGIN'
      +#13#10'     nf = nf + 1 ;'
      +#13#10'     IF ( NEW.SYS$DU is NULL ) THEN'
      +#13#10'        fxml = fxml || ''<field Name="SYS$DU" IsNull="T" ft="35"/>'' ;'
      +#13#10'     ELSE'
      +#13#10'        fxml = fxml || ''<field Name="SYS$DU" ft="35">'' || NEW.SYS$DU || ''</field>'' ;'
      +#13#10'  END'

      +#13#10'  IF ( nf > 0 ) THEN'
      +#13#10'    BEGIN '
      +#13#10'      xml = xml || ''<fields count="'' || nf || ''">'' || fxml || ''</fields>'' ;'
      +#13#10'      fxml = '''' ;'
      +#13#10'    END'

     // finaliza geracao do xml e salva em disco
      +#13#10'  xml = xml || fxml || ''</table>'' ; '

      +#13#10'  IF ((nf > 0) OR (nfb > 0)) THEN'
      +#13#10'    SU$AppendBlobToFile('
      +#13#10'      RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ' // path/banco.ext
      +#13#10'      || ''-'' ||JNL$TRASACTION_SEQUENCE || ''_'' '// -Sequencia_
      +#13#10'      || CURRENT_TRANSACTION     || ''.JNL'', '    // Transacao.jnl
      +#13#10'      xml ) ;'

      +#13#10'END;';

   _SQL_CAD_TIPOS =
             'SELECT DISTINCT DESCRICAO,'
      +#13#10'       KSYS$DOMAIN "DOMAIN",'
      +#13#10'       KCAD_FAZENDA,'
      +#13#10'       TIPO'
      +#13#10'  FROM CAD_TIPOS'
      +#13#10' WHERE TIPO = 2'
      +#13#10' ORDER BY DESCRICAO';

   _INSERT_CAD_TIPOS =
             'INSERT INTO CAD_TIPOS (KCAD_TIPOS, KSYS$DOMAIN, KCAD_FAZENDA, TIPO, DESCRICAO)'
      +#13#10' VALUES (:KCAD_TIPOS, :DOMAIN, :KCAD_FAZENDA, :TIPO, :DESCRICAO)';

   _DELETE_CAD_TIPOS =
             'DELETE FROM CAD_TIPOS WHERE TIPO = 2';


   _UPDATE_EST_PRODUTOS =
             'UPDATE EST_PRODUTOS'
      +#13#10'  SET  KCAD_UNIDADE = (SELECT T.KCAD_TIPOS FROM CAD_TIPOS T WHERE UPPER(T.DESCRICAO) = UPPER(UNIDADE) ),'
      +#13#10'       UNIDADE = (SELECT T.DESCRICAO FROM CAD_TIPOS T WHERE UPPER(T.DESCRICAO) = UPPER(UNIDADE) )'
      +#13#10' WHERE 0 < (SELECT COUNT(*) FROM CAD_TIPOS T WHERE UPPER(T.DESCRICAO) = UPPER(UNIDADE))';

var
  cds, cdsVerificacao: TClientDataSet;
  p: TParams;
  listaUnd: TStringList;
begin
  TryExecuteDirect ( _CREATE_TABLE_CAD_TIPOS ) ;
  TryExecuteDirect ( _CREATE_TRIGGER_CAD_TIPOS_DOMAIN_BI0 ) ;
  TryExecuteDirect ( _CREATE_TRIGGER_RLOGCAD_TIPOS_BIU0 ) ;
 // {Try}ExecuteDirect ( _CREATE_TRIGGER_JNLCAD_TIPOS_AIUE0 ) ;

  if not Assigned ( TTcAbstractDB.GetByAlias('ENTIDADES') ) then
     exit ;

  cds:= nil;
  Tc.DBRTL.AbstractDB.TTcAbstractDB.GetByAlias('ENTIDADES').populateClientDataSet( cds, _SQL_CAD_TIPOS );

  cdsVerificacao:= nil;
  Tc.DBRTL.AbstractDB.TTcAbstractDB.GetByAlias('FINANCEIRO').populateClientDataSet( cdsVerificacao, _SQL_CAD_TIPOS );

  if not cdsVerificacao.IsEmpty then
    begin
      ExecuteDirect ( _DELETE_CAD_TIPOS ) ;
    end;

  p:= TParams.Create(nil);
  p.Clear;
  p.CreateParam(ftString, 'KCAD_TIPOS',   ptInput ) ;
  p.CreateParam(ftString, 'DOMAIN',       ptInput ) ;
  p.CreateParam(ftString, 'KCAD_FAZENDA', ptInput ) ;
  p.CreateParam(ftInteger,'TIPO',         ptInput ) ;
  p.CreateParam(ftString, 'DESCRICAO',    ptInput ) ;

  listaUnd := TStringList.Create;

  with cds do
   begin
     First;
     while not Eof do
      begin
        if ( listaUnd.IndexOf(UpperCase( Trim( FieldByName( 'DESCRICAO' ).AsString ) ) ) < 0 )  then
          begin
            p.ParamByName( 'KCAD_TIPOS'   ).AsString  := GuidStr20;
            p.ParamByName( 'DOMAIN'       ).AsString  := FieldByName( 'DOMAIN'       ).AsString;
            p.ParamByName( 'KCAD_FAZENDA' ).AsString  := FieldByName( 'KCAD_FAZENDA' ).AsString;
            p.ParamByName( 'TIPO'         ).AsInteger := FieldByName( 'TIPO'         ).AsInteger;
            p.ParamByName( 'DESCRICAO'    ).AsString  := FieldByName( 'DESCRICAO'    ).AsString;

            IDB.Execute( _INSERT_CAD_TIPOS, p);
            listaUnd.Add( UpperCase( Trim( FieldByName( 'DESCRICAO' ).AsString ) ) );
          end;
        Next;
      end;
   end;

  listaUnd.Free;
  cds.Free;
  cdsVerificacao.Free;
  p.Free;
  ExecuteDirect ( _UPDATE_EST_PRODUTOS ) ;

end;


procedure TDBFinanceiroUpdate._5_001_41 ;
const
   _ALTER_TRIGGER_EST_PRODUTOS_AIU0 =
           'CREATE OR ALTER TRIGGER EST_PRODUTOS_AIU0 FOR EST_PRODUTOS'
    +#13#10'ACTIVE AFTER INSERT OR UPDATE POSITION 20001'
    +#13#10'AS'
    +#13#10'BEGIN'
    +#13#10''
    +#13#10'  IF (     ( UPDATING )'
    +#13#10'       AND (NEW.BAIXA_ESTOQUE IS DISTINCT FROM OLD.BAIXA_ESTOQUE)'
    +#13#10'       AND (NEW.BAIXA_ESTOQUE IS DISTINCT FROM ''T'')'
    +#13#10'     ) THEN'
    +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO( ''D'','
    +#13#10'                                            NEW.KSYS$DOMAIN,'
    +#13#10'                                            NEW.KEST_PRODUTO,'
    +#13#10'                                            NEW.DATA_SALDOINICIAL,'
    +#13#10'                                            ''C'','
    +#13#10'                                            NEW.QTDE_INICIAL,'
    +#13#10'                                            NEW.CUSTO_INICIAL,'
    +#13#10'                                            ''EST_PRODUTOS'','
    +#13#10'                                            NEW.KEST_PRODUTO );'
    +#13#10''
    +#13#10''
    +#13#10'  IF (    (   ( INSERTING )'
    +#13#10'           OR (     UPDATING'
    +#13#10'               AND (   ( NEW.KSYS$DOMAIN      IS DISTINCT FROM OLD.KSYS$DOMAIN      )'
    +#13#10'                    OR ( NEW.KEST_PRODUTO      IS DISTINCT FROM OLD.KEST_PRODUTO      )'
    +#13#10'                    OR ( NEW.DATA_SALDOINICIAL IS DISTINCT FROM OLD.DATA_SALDOINICIAL )'
    +#13#10'                    OR ( NEW.QTDE_INICIAL      IS DISTINCT FROM OLD.QTDE_INICIAL      )'
    +#13#10'                    OR ( NEW.CUSTO_INICIAL     IS DISTINCT FROM OLD.CUSTO_INICIAL     )'
    +#13#10'                    OR ( NEW.BAIXA_ESTOQUE     IS DISTINCT FROM OLD.BAIXA_ESTOQUE     )'
    +#13#10'                   )'
    +#13#10'              )'
    +#13#10'          )'
    +#13#10'      AND (NEW.BAIXA_ESTOQUE  = ''T'')'
    +#13#10'     ) THEN'
    +#13#10'  EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO( CASE'
    +#13#10'                                          when Inserting then ''I'''
    +#13#10'                                          when Updating  then ''U'''
    +#13#10'                                          end,'
    +#13#10'                                          NEW.KSYS$DOMAIN,'
    +#13#10'                                          NEW.KEST_PRODUTO,'
    +#13#10'                                          NEW.DATA_SALDOINICIAL,'
    +#13#10'                                          ''C'','
    +#13#10'                                          NEW.QTDE_INICIAL,'
    +#13#10'                                          NEW.CUSTO_INICIAL,'
    +#13#10'                                          ''EST_PRODUTOS'','
    +#13#10'                                          NEW.KEST_PRODUTO );'
    +#13#10''
    +#13#10'END' ;

   _UPDATE_EST_PRODUTOS =
         'UPDATE EST_PRODUTOS'
  +#13#10'SET'
  +#13#10'  DATA_SALDOINICIAL = DATA_SALDOINICIAL -1'
  +#13#10'WHERE KEST_PRODUTO IN ('
  +#13#10' SELECT'
  +#13#10'  P.KEST_PRODUTO'
  +#13#10' FROM EST_PRODUTOS P'
  +#13#10' LEFT JOIN EST_MOVIMENTO M on M.KEST_PRODUTO = P.KEST_PRODUTO'
  +#13#10' WHERE P.BAIXA_ESTOQUE = ''T'''
  +#13#10'  AND M.KEST_PRODUTO IS NULL'
  +#13#10')' ;

   _UPDATE_BAK_EST_PRODUTOS =
         'UPDATE EST_PRODUTOS'
  +#13#10'SET'
  +#13#10'  DATA_SALDOINICIAL = DATA_SALDOINICIAL +1'
  +#13#10'WHERE KEST_PRODUTO IN ('
  +#13#10' SELECT'
  +#13#10'  M.KEST_PRODUTO'
  +#13#10' FROM EST_MOVIMENTO M'
  +#13#10' WHERE M.TIPO = ''C'''
  +#13#10'   AND M.SYS$DI > %s'
  +#13#10'GROUP BY 1'
  +#13#10')' ;

var
  LUpdateDate : string ;
begin

  LUpdateDate := QuotedStr( FormatDateTime ( 'dd.mm.yyyy hh:nn', IncMinute( Now, -1 ) ) ) ;

  TryExecuteDirect ( _ALTER_TRIGGER_EST_PRODUTOS_AIU0 ) ;
  TryExecuteDirect ( _UPDATE_EST_PRODUTOS ) ;
  TryExecuteDirect ( Format( _UPDATE_BAK_EST_PRODUTOS, [ LUpdateDate ] ) ) ;

end ;

procedure TDBFinanceiroUpdate._5_001_40 ;
const
  _UPDATE_FIN_APAGAR_PARCELAS =
          'UPDATE'
    +#13#10'  FIN_APAGAR_PARCELAS'
    +#13#10'SET'
    +#13#10'  DT_COMPENSACAO = PAGTO'
    +#13#10'WHERE'
    +#13#10'      PAGTO IS NOT NULL'
    +#13#10'  AND CHEQUE = ''F'''
    +#13#10'  AND DT_COMPENSACAO IS NULL' ;

  _UPDATE_FIN_ARECEBER_PARCELAS =
          'UPDATE'
    +#13#10'  FIN_ARECEBER_PARCELAS'
    +#13#10'SET'
    +#13#10'  DT_COMPENSACAO = PAGTO'
    +#13#10'WHERE'
    +#13#10'      PAGTO IS NOT NULL'
    +#13#10'  AND CHEQUE = ''F'''
    +#13#10'  AND DT_COMPENSACAO IS NULL' ;
begin
  TryExecuteDirect ( _UPDATE_FIN_APAGAR_PARCELAS ) ;
  TryExecuteDirect ( _UPDATE_FIN_ARECEBER_PARCELAS ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_39 ;
const
  _CREATE_DOMAIN_FIN_CST_CSOSN =
         'CREATE DOMAIN FIN$CST_CSOSN AS'
  +#13#10'VARCHAR(4) CHARACTER SET ISO8859_1'
  +#13#10'COLLATE ISO8859_1 ' ;


 _ALTER_TABLE_CMP_PEDIDO_ITENS =
           'ALTER TABLE CMP_PEDIDO_ITENS'
    +#13#10'ADD CFOP_ESTOQUE FIN$CFOP,'
    +#13#10'ADD CST_CSOSN FIN$CST_CSOSN,'
    +#13#10'ALTER CST_CSOSN POSITION 16,'
    +#13#10'ALTER CFOP_ESTOQUE POSITION 17' ;

begin
  TryExecuteDirect ( _CREATE_DOMAIN_FIN_CST_CSOSN ) ;
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDO_ITENS ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_38 ;
const
  _CREATE_TABLE_SYS_DOMAIN_TYPES =
         'CREATE TABLE SYS$DOMAIN_TYPES ('
  +#13#10'    KSYS$DOMAIN      SYS$PKGUID20,'
  +#13#10'    SYS$TYPE         SYS$ST_TYPE,'
  +#13#10'    SYS$VALUE        SYS$ST_VALUE_NULL,'
  +#13#10'    SYS$DESCRIPTION  SYS$ST_DESCRIPTION,'
  +#13#10'    SYS$ORDER        SYS$ST_ORDER,'
  +#13#10'    SYS$TYPEID       SYS$ST_TYPEID'
  +#13#10')' ;


  _CREATE_INDEX_UQSYS_DOMAIN_TYPES =
    'ALTER TABLE SYS$DOMAIN_TYPES ADD CONSTRAINT UQSYS$DOMAIN_TYPES UNIQUE (KSYS$DOMAIN, SYS$TYPE, SYS$VALUE)' ;

  _CREATE_COMMENT_1 =
    'COMMENT ON TABLE SYS$DOMAIN_TYPES IS ''Tipos do sistema para o Domínio''';
  _CREATE_COMMENT_2 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.KSYS$DOMAIN IS ''Domínio''';
  _CREATE_COMMENT_4 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.SYS$TYPE IS ''Grupo''';
  _CREATE_COMMENT_5 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.SYS$VALUE IS ''Valor''';
  _CREATE_COMMENT_6 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.SYS$DESCRIPTION IS ''Descrição''';
  _CREATE_COMMENT_7 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.SYS$ORDER IS  ''Ordem de apresentação''';
  _CREATE_COMMENT_8 =
    'COMMENT ON COLUMN SYS$DOMAIN_TYPES.SYS$TYPEID IS ''Identificador para uso interno no sistema''';

  _ALTER_PROCEDURE_SYS_DOMAIN_TYPES_GETDESCRIPTION =
         'CREATE OR ALTER PROCEDURE SYS$DOMAIN_TYPES_GETDESCRIPTION ('
  +#13#10'    SYS$DOMAIN type of SYS$ST_TYPE,'
  +#13#10'    SYS$TYPE type of SYS$ST_TYPE,'
  +#13#10'    SYS$VALUE type of SYS$ST_VALUE_NULL)'
  +#13#10'RETURNS ('
  +#13#10'    SYS$DESCRIPTION type of SYS$ST_DESCRIPTION)'
  +#13#10'AS'
  +#13#10'DECLARE VARIABLE EXISTS_  SYS$BOOL_NULL ;'
  +#13#10'BEGIN'
  +#13#10'  SELECT SYS$DESCRIPTION, ''T'''
  +#13#10'  FROM SYS$DOMAIN_TYPES'
  +#13#10'  WHERE KSYS$DOMAIN = :SYS$DOMAIN AND SYS$TYPE = :SYS$TYPE AND SYS$VALUE = :SYS$VALUE'
  +#13#10'  INTO SYS$DESCRIPTION, EXISTS_ ;'
  +#13#10''
  +#13#10'  IF ( EXISTS_ IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    EXECUTE PROCEDURE SYS$TYPES_GETDESCRIPTION( SYS$TYPE, SYS$VALUE ) RETURNING_VALUES SYS$DESCRIPTION ;'
  +#13#10''
  +#13#10'  SUSPEND;'
  +#13#10'END' ;

  _ALTER_PROCEDURE_SYS_DOMAIN_TYPES_GETVALUE =
        'CREATE OR ALTER PROCEDURE SYS$DOMAIN_TYPES_GETVALUE ('
 +#13#10'    KSYS$DOMAIN  SYS$PKGUID20,'
 +#13#10'    SYS$TYPE TYPE OF SYS$ST_TYPE,'
 +#13#10'    SYS$TYPEID TYPE OF SYS$ST_TYPEID)'
 +#13#10'RETURNS ('
 +#13#10'    SYS$VALUE TYPE OF SYS$ST_VALUE_NULL)'
 +#13#10'AS'
 +#13#10'DECLARE EXISTS_ SYS$BOOL_NULL ;'
 +#13#10'BEGIN'
 +#13#10''
 +#13#10'  SELECT SYS$VALUE, ''T'''
 +#13#10'  FROM SYS$DOMAIN_TYPES'
 +#13#10'  WHERE KSYS$DOMAIN = :KSYS$DOMAIN AND SYS$TYPE = :SYS$TYPE AND SYS$TYPEID = :SYS$TYPEID'
 +#13#10'  INTO :SYS$VALUE, EXISTS_ ;'
 +#13#10''
 +#13#10'  IF ( EXISTS_ IS DISTINCT FROM ''T'' ) THEN'
 +#13#10'    EXECUTE PROCEDURE SYS$TYPES_GETVALUE ( SYS$TYPE, SYS$TYPEID ) RETURNING_VALUES SYS$VALUE ;'
 +#13#10''
 +#13#10'  SUSPEND;'
 +#13#10''
 +#13#10'END'  ;

begin
  TryExecuteDirect ( _CREATE_TABLE_SYS_DOMAIN_TYPES ) ;
  TryExecuteDirect ( _CREATE_INDEX_UQSYS_DOMAIN_TYPES ) ;
  ExecuteDirect (_CREATE_COMMENT_1 ) ;
  ExecuteDirect (_CREATE_COMMENT_2 ) ;
  ExecuteDirect (_CREATE_COMMENT_4 ) ;
  ExecuteDirect (_CREATE_COMMENT_5 ) ;
  ExecuteDirect (_CREATE_COMMENT_6 ) ;
  ExecuteDirect (_CREATE_COMMENT_7 ) ;
  ExecuteDirect (_CREATE_COMMENT_8 ) ;
  ExecuteDirect ( _ALTER_PROCEDURE_SYS_DOMAIN_TYPES_GETDESCRIPTION ) ;
  ExecuteDirect ( _ALTER_PROCEDURE_SYS_DOMAIN_TYPES_GETVALUE ) ;
end;

procedure TDBFinanceiroUpdate._5_001_36 ;
const
   _ALTER_TABLE_FIN_APAGAR_ADD_PAGTO_AVISTA =
         'ALTER TABLE FIN_APAGAR'
  +#13#10'ADD PAGTO_AVISTA SYS$BOOL_F' ;
begin
 TryExecuteDirect ( _ALTER_TABLE_FIN_APAGAR_ADD_PAGTO_AVISTA ) ;
end;


procedure TDBFinanceiroUpdate._5_001_35 ;
const
   _ALTER_TABLE_FIN_PLANOCONTAS_ADD_HIDE_BY_USER =
         'ALTER TABLE FIN_PLANOCONTAS'
  +#13#10'ADD HIDE_BY_USER SYS$BOOL_F' ;

   _ALTER_TABLE_FIN_PLANOCONTAS_ADD_KEQV_PLANOCONTA =
         'ALTER TABLE FIN_PLANOCONTAS'
  +#13#10'ADD KEQV_PLANOCONTA SYS$FKGUID20' ;

   _ALTER_TABLE_FIN_PLANOCONTAS_ALTER_POSITION =
         'ALTER TABLE FIN_PLANOCONTAS'
  +#13#10'ALTER HIDE_BY_USER POSITION 16,'
  +#13#10'ALTER KDEF_PLANOCONTA POSITION 17,'
  +#13#10'ALTER KMDEF_PLANOCONTA POSITION 18,'
  +#13#10'ALTER KEQV_PLANOCONTA POSITION 19,'
  +#13#10'ALTER SYS$UI POSITION 20,'
  +#13#10'ALTER SYS$DI POSITION 21,'
  +#13#10'ALTER SYS$UU POSITION 22,'
  +#13#10'ALTER SYS$DU POSITION 23' ;

 _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS  =
         'CREATE OR ALTER PROCEDURE SYS$COPY_PLANOCONTAS ('
  +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN,'
  +#13#10'    FROM_TIPO SYS$INT = -1,'
  +#13#10'    TO_TIPO SYS$INT = 1)'
  +#13#10'AS'
  +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE KEQV_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
  +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
  +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
  +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
  +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
  +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
  +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'  DECLARE SYS$DU               SYS$DATE;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  FOR WITH RECURSIVE PLM'
  +#13#10'  AS ('
  +#13#10'  SELECT'
  +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  FROM FIN_PLANOCONTAS'
  +#13#10'  WHERE KMDEF_PLANOCONTA IS NULL'
  +#13#10'     AND TIPO_PLANOCONTAS = :FROM_TIPO'
  +#13#10'   UNION ALL'
  +#13#10'   SELECT'
  +#13#10'    KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'    ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'    TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'     FROM FIN_PLANOCONTAS PL'
  +#13#10'     JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'
  +#13#10'     WHERE PL.TIPO_PLANOCONTAS = :FROM_TIPO'
  +#13#10'    )'
  +#13#10'    SELECT'
  +#13#10'     KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KFIN_PLANOCONTA,'
  +#13#10'     ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'     TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'    FROM PLM'
  +#13#10'  INTO KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
  +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
  +#13#10'          KMFIN_PLANOCONTA = NULL ;'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
  +#13#10'            WHERE KCAD_FAZENDA = :pKCAD_FAZENDA'
  +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA AND TIPO_PLANOCONTAS = :TO_TIPO'
  +#13#10'            INTO KMFIN_PLANOCONTA ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'       IF ( NOT EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
  +#13#10'                    WHERE KCAD_FAZENDA      = :pKCAD_FAZENDA'
  +#13#10'                      AND KDEF_PLANOCONTA   = :KDEF_PLANOCONTA'
  +#13#10'                      AND TIPO_PLANOCONTAS  = :TO_TIPO ) ) THEN'
  +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KCAD_FAZENDA, TIPO_PLANOCONTAS,'
  +#13#10'                CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA, KEQV_PLANOCONTA,'
  +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
  +#13#10'           VALUES ( Guid20(), :pKCAD_FAZENDA, :TO_TIPO,'
  +#13#10'                :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA, :KEQV_PLANOCONTA,'
  +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
  +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;

begin
 TryExecuteDirect ( _ALTER_TABLE_FIN_PLANOCONTAS_ADD_HIDE_BY_USER    ) ;
 TryExecuteDirect ( _ALTER_TABLE_FIN_PLANOCONTAS_ADD_KEQV_PLANOCONTA ) ;
 ExecuteDirect    ( _ALTER_TABLE_FIN_PLANOCONTAS_ALTER_POSITION      ) ;
 ExecuteDirect    ( _ALTER_PROCEDURE_SYS_COPY_PLANOCONTAS ) ;
end;

procedure TDBFinanceiroUpdate._5_001_31 ;
const
   _ALTER_TABLE_CMP_PEDIDOS_ALTER_IMPORTADANFE =
        'ALTER TABLE CMP_PEDIDOS'
 +#13#10'ALTER IMPORTADONFE TO IMPORTADO_NFE' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS_ALTER_IMPORTADANFE ) ;
end;

procedure TDBFinanceiroUpdate._5_001_30 ;
const

  _CREATE_DOMAIN_SYS_BLOBXML2 =
   'CREATE DOMAIN SYS$BLOBXML2 AS BLOB SUB_TYPE 1' ;

  _ALTER_TABLE_CMP_PEDIDOS_ADD_XML_NFE2 =
          'ALTER TABLE CMP_PEDIDOS'
   +#13#10'ADD XML_NFE2 SYS$BLOBXML2' ;

  _UPDATE_CMP_PEDIDOS =
            'EXECUTE BLOCK'
     +#13#10'AS'
     +#13#10'BEGIN'
     {$IFDEF _EXPORT}
     +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  ''1'' ) ;'
     {$ENDIF _EXPORT}
     +#13#10'UPDATE CMP_PEDIDOS'
     +#13#10'SET XML_NFE2 = XML_NFE ;'
     {$IFDEF _EXPORT}
     +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  NULL ) ;'
     {$ENDIF _EXPORT}
     +#13#10'END' ;

  _ALTER_TABLE_CMP_PEDIDOS_DROP_XML_NFE =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'DROP XML_NFE' ;

  _ALTER_TABLE_CMP_PEDIDOS_XML_NFE2_TO_XML_NFE =
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'ALTER XML_NFE2 TO XML_NFE' ;

begin
  TryExecuteDirect ( _CREATE_DOMAIN_SYS_BLOBXML2 ) ;
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS_ADD_XML_NFE2 ) ;
  {$IFDEF _EXPORT}
  //ExecuteDirect ( 'ALTER TRIGGER JNL$CMP_PEDIDOS INACTIVE' ) ;
  {$ENDIF _EXPORT}
  ExecuteDirect    ( _UPDATE_CMP_PEDIDOS ) ;
  ExecuteDirect    ( _ALTER_TABLE_CMP_PEDIDOS_DROP_XML_NFE ) ;
  ExecuteDirect    ( _ALTER_TABLE_CMP_PEDIDOS_XML_NFE2_TO_XML_NFE ) ;
end;


procedure TDBFinanceiroUpdate._5_001_29 ;
const
 _ALTER_PROCEDURE_SYS_INIT_CENTROSCUSTO =
         'CREATE OR ALTER PROCEDURE SYS$INIT_CENTROSCUSTO ('
  +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN)'
  +#13#10'AS'
  +#13#10'  DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
  +#13#10'  DECLARE CODIGO               SYS$INT ;'
  +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'  DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
  +#13#10'  DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
  +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'  DECLARE SYS$DU               SYS$DATE;'
  +#13#10'  DECLARE PATH VARCHAR( 256 );'
  +#13#10'  DECLARE LF_ char;'
  +#13#10'BEGIN'
  +#13#10'  LF_ = ASCII_CHAR(10) ;'
  +#13#10''
  +#13#10'  IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO) ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10''
  +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  FOR EXECUTE STATEMENT ('
  +#13#10'            ''WITH RECURSIVE CCM'''
  +#13#10'     ||LF_||''AS ('''
  +#13#10'     ||LF_||'' SELECT'''
  +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
  +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'     ||LF_||'' FROM DEF_CENTROSCUSTO'''
  +#13#10'     ||LF_||'' WHERE KMDEF_CENTROCUSTO IS NULL'''
  +#13#10'     ||LF_||'' UNION ALL'''
  +#13#10'     ||LF_||'' SELECT'''
  +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
  +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'     ||LF_||'' FROM DEF_CENTROSCUSTO CC'''
  +#13#10'     ||LF_||'' JOIN CCM ON CCM.KDEF_CENTROCUSTO = CC.KMDEF_CENTROCUSTO'''
  +#13#10'     ||LF_||'')'''
  +#13#10'     ||LF_||''SELECT'''
  +#13#10'     ||LF_||''  KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO,'''
  +#13#10'     ||LF_||''  ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'     ||LF_||''FROM CCM'''
  +#13#10'   ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
  +#13#10'   WITH COMMON TRANSACTION'
  +#13#10'   INTO :KDEF_CENTROCUSTO, :CODIGO, :NOME, :KMDEF_CENTROCUSTO,'
  +#13#10'        :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( KMDEF_CENTROCUSTO IS NULL ) THEN'
  +#13#10'          KMFIN_CENTROCUSTO = NULL ;'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
  +#13#10'            WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KMDEF_CENTROCUSTO'
  +#13#10'            INTO KMFIN_CENTROCUSTO ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'       IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO ) ) THEN'
  +#13#10'          UPDATE FIN_CENTROSCUSTO'
  +#13#10'          SET'
  +#13#10'              CODIGO           = :CODIGO,'
  +#13#10'              NOME             = :NOME,'
  +#13#10'              KMFIN_CENTROCUSTO = :KMFIN_CENTROCUSTO,'
  +#13#10'              ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
  +#13#10'              CLASSIFICACAO       = :CLASSIFICACAO,'
  +#13#10'              ATIVO               = :ATIVO,'
  +#13#10'              SYS$DU              = :SYS$DU'
  +#13#10'           WHERE ( KCAD_FAZENDA = :pKCAD_FAZENDA  AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO )'
  +#13#10'            AND ( KDEF_CENTROCUSTO <> ''RA9e#LZO^m^Q?jN2OV5O'' )'
  +#13#10'            AND ( KDEF_CENTROCUSTO <> ''La;m;0+smOQ+4RnK^6as'' )'
  +#13#10'            AND (   (SYS$DU IS NULL)'
  +#13#10'                 OR (SYS$DU < :SYS$DU)'
  +#13#10'                 OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
  +#13#10'                 OR ( NOME                IS DISTINCT FROM  :NOME )'
  +#13#10'                 OR ( KMFIN_CENTROCUSTO   IS DISTINCT FROM  :KMFIN_CENTROCUSTO )'
  +#13#10'                 OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
  +#13#10'                 OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
  +#13#10'                 OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
  +#13#10'              ) ;'
  +#13#10'       ELSE'
  +#13#10'         BEGIN'
  +#13#10'           INSERT INTO FIN_CENTROSCUSTO ('
  +#13#10'              KFIN_CENTROCUSTO, KCAD_FAZENDA, CODIGO, NOME, KMFIN_CENTROCUSTO, KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
  +#13#10'              ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU )'
  +#13#10'           VALUES ( Guid20(), :pKCAD_FAZENDA, :CODIGO, :NOME, :KMFIN_CENTROCUSTO, :KDEF_CENTROCUSTO, :KMDEF_CENTROCUSTO,'
  +#13#10'                :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
  +#13#10''
  +#13#10'         END'
  +#13#10'    END'
  +#13#10''
  +#13#10'  CODIGO = NULL ;'
  +#13#10'  SELECT MAX(CODIGO) FROM FIN_CENTROSCUSTO'
  +#13#10'  INTO CODIGO ;'
  +#13#10''
  +#13#10'  EXECUTE STATEMENT ''ALTER SEQUENCE CODIGO_CENTROS_CUSTO RESTART WITH '' || COALESCE( :CODIGO, 0 ) ;'
  +#13#10''
  +#13#10'END' ;

  _EXECUTE_BLOCK_UPDATE_CC =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'DECLARE A SYS$INT ;'
  +#13#10'DECLARE KFIN_CENTROCUSTO     SYS$PKGUID20 ;'
  +#13#10'DECLARE KSYS$DOMAIN          SYS$FKGUID20 ;'
  +#13#10'DECLARE KCAD_FAZENDA         SYS$FKGUID20 ;'
  +#13#10'DECLARE CODIGO               SYS$INT ;'
  +#13#10'DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
  +#13#10'DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'DECLARE DATA_ENCERRAMENTO    SYS$DATE ;'
  +#13#10'DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
  +#13#10'DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
  +#13#10'DECLARE COUNT_ SYS$INT ;'
  +#13#10'DECLARE NEW_KFIN_CENTROCUSTO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  ''1'' ) ;'
  {$ENDIF _EXPORT}
  +#13#10'  CODIGO = NULL ;'
  +#13#10'  SELECT MAX(CODIGO) FROM FIN_CENTROSCUSTO'
  +#13#10'  INTO CODIGO ;'
  +#13#10''
  +#13#10'  EXECUTE STATEMENT ''ALTER SEQUENCE CODIGO_CENTROS_CUSTO RESTART WITH '' || COALESCE( :CODIGO, 0 ) ;'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'   SELECT KFIN_CENTROCUSTO,'
  +#13#10'          KSYS$DOMAIN, KCAD_FAZENDA,'
  +#13#10'          CODIGO, NOME, ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO,'
  +#13#10'          KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
  +#13#10'          (SELECT 1 FROM FIN_CENTROSCUSTO CCA WHERE CCA.KMFIN_CENTROCUSTO = CCM.KFIN_CENTROCUSTO ROWS 1 )'
  +#13#10'  FROM FIN_CENTROSCUSTO CCM'
  +#13#10'  WHERE KMFIN_CENTROCUSTO IS NULL'
  +#13#10'  INTO KFIN_CENTROCUSTO,'
  +#13#10'       KSYS$DOMAIN, KCAD_FAZENDA,'
  +#13#10'       CODIGO, NOME, ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO,'
  +#13#10'       KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
  +#13#10'       COUNT_'
  +#13#10'  DO'
  +#13#10'   BEGIN'
  +#13#10'      IF ( COUNT_ > 0 ) THEN'
  +#13#10'       BEGIN'
  +#13#10'         UPDATE FIN_CENTROSCUSTO'
  +#13#10'         SET'
  +#13#10'           ANALITICO_SINTETICO = ''S'''
  +#13#10'         WHERE KFIN_CENTROCUSTO = :KFIN_CENTROCUSTO'
  +#13#10'          AND ANALITICO_SINTETICO IS DISTINCT FROM ''S'' ;'
  +#13#10'       END'
  +#13#10'      ELSE'
  +#13#10'       BEGIN'
  +#13#10'         NEW_KFIN_CENTROCUSTO = GUID20() ;'
  +#13#10'         INSERT INTO FIN_CENTROSCUSTO'
  +#13#10'          ( KFIN_CENTROCUSTO,'
  +#13#10'            KSYS$DOMAIN, KCAD_FAZENDA,'
  +#13#10'            CODIGO, NOME, ANALITICO_SINTETICO, CLASSIFICACAO'
  +#13#10'          )'
  +#13#10'          VALUES'
  +#13#10'          ( :NEW_KFIN_CENTROCUSTO,'
  +#13#10'            :KSYS$DOMAIN, :KCAD_FAZENDA,'
  +#13#10'            0, UPPER( :NOME ), ''S'', :CLASSIFICACAO'
  +#13#10'          ) ;'
  +#13#10'         UPDATE FIN_CENTROSCUSTO'
  +#13#10'         SET'
  +#13#10'           CLASSIFICACAO = CLASSIFICACAO || ''.1'','
  +#13#10'           KMFIN_CENTROCUSTO = :NEW_KFIN_CENTROCUSTO,'
  +#13#10'           ANALITICO_SINTETICO = ''A'''
  +#13#10'         WHERE ( KFIN_CENTROCUSTO = :KFIN_CENTROCUSTO ) ;'
  +#13#10'       END'
  +#13#10'    END'
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  NULL ) ;'
  {$ENDIF _EXPORT}
  +#13#10'END' ;

  _ALTER_TABLE_FIN_APAGAR_PARCELAS =
         'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'ADD NUM_CHEQUE FIN$DOC' ;

  _UPDATE_FIN_APAGAR_PARCELAS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  ''1'' ) ;'
  {$ENDIF _EXPORT}
  +#13#10'  UPDATE FIN_APAGAR_PARCELAS'
  +#13#10'  SET'
  +#13#10'   NUM_CHEQUE = DOCUMENTO'
  +#13#10'  WHERE CHEQUE = ''T'''
  +#13#10'    AND NUM_CHEQUE IS NULL ;'
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  NULL ) ;'
  {$ENDIF _EXPORT}
  +#13#10'END' ;

  _ALTER_TABLE_FIN_ARECEBER_PARCELAS =
         'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'ADD NUM_CHEQUE FIN$DOC' ;

  _UPDATE_FIN_ARECEBER_PARCELAS =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  ''1'' ) ;'
  {$ENDIF _EXPORT}
  +#13#10'  UPDATE FIN_ARECEBER_PARCELAS'
  +#13#10'  SET'
  +#13#10'   NUM_CHEQUE = DOCUMENTO'
  +#13#10'  WHERE CHEQUE = ''T'''
  +#13#10'    AND NUM_CHEQUE IS NULL ;'
  {$IFDEF _EXPORT}
  +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  NULL ) ;'
  {$ENDIF _EXPORT}
  +#13#10'END' ;


begin
  {$IFDEF _EXPORT}
  //ExecuteDirect ( 'ALTER TRIGGER JNL$FIN_CENTROSCUSTO INACTIVE' ) ;
  //ExecuteDirect ( 'ALTER TRIGGER JNL$APAGAR_PARCELAS INACTIVE' ) ;
  //ExecuteDirect ( 'ALTER TRIGGER JNL$ARECEBER_PARCELAS INACTIVE' ) ;
  {$ENDIF _EXPORT}

  ExecuteDirect    ( 'ALTER TRIGGER ON_CONNECT INACTIVE' ) ;
  Reconnect ;
  ExecuteDirect(  _ALTER_PROCEDURE_SYS_INIT_CENTROSCUSTO ) ;
  ExecuteDirect(  _EXECUTE_BLOCK_UPDATE_CC ) ;
  ExecuteDirect( 'ALTER TRIGGER ON_CONNECT ACTIVE' ) ;

  TryExecuteDirect ( _ALTER_TABLE_FIN_APAGAR_PARCELAS ) ;
  ExecuteDirect ( _UPDATE_FIN_APAGAR_PARCELAS ) ;

  TryExecuteDirect ( _ALTER_TABLE_FIN_ARECEBER_PARCELAS ) ;
  ExecuteDirect ( _UPDATE_FIN_ARECEBER_PARCELAS ) ;
end;


procedure TDBFinanceiroUpdate._5_001_25;
const
 _CREATE_SEQUENCE_TIPO_PLANOCONTAS =
  'CREATE SEQUENCE TIPO_PLANOCONTAS' ;

 _RESTART_SEQUENCE_TIPO_PLANOCONTAS =
  'ALTER SEQUENCE TIPO_PLANOCONTAS RESTART WITH -1' ;

   _ALTER_TABLE_FIN_PLANOCONTAS =
         'ALTER TABLE FIN_PLANOCONTAS'
  +#13#10'ADD TIPO_PLANOCONTAS SYS$INT_NN,'
  +#13#10'ALTER TIPO_PLANOCONTAS POSITION 4' ;

  _UPDATE_FIN_PLANOCONTAS_SET_TIPO_PLANOCONTAS =
            'EXECUTE BLOCK'
     +#13#10'AS'
     +#13#10'BEGIN'
     {$IFDEF _EXPORT}
     +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  ''1'' ) ;'
     {$ENDIF _EXPORT}
     +#13#10'UPDATE FIN_PLANOCONTAS'
     +#13#10'SET TIPO_PLANOCONTAS = -1'
     +#13#10'WHERE TIPO_PLANOCONTAS IS NULL ;'
     {$IFDEF _EXPORT}
     +#13#10'  RDB$SET_CONTEXT( ''USER_SESSION'', ''JNL$OFF'',  NULL ) ;'
     {$ENDIF _EXPORT}
     +#13#10'END' ;


 _CREATE_PROCEDURE_SYS_INIT_PLANOCONTAS  =
         'CREATE OR ALTER PROCEDURE SYS$INIT_PLANOCONTAS ('
  +#13#10'    PKCAD_FAZENDA TYPE OF SYS$FKGUID20_NN)'
  +#13#10'AS'
  +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE TIPO_PLANOCONTAS     SYS$INT_NN ;'
  +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
  +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
  +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
  +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
  +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
  +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
  +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'  DECLARE SYS$DU               SYS$DATE;'
  +#13#10'  DECLARE PATH VARCHAR( 256 );'
  +#13#10'  DECLARE LF_ char;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  LF_ = ASCII_CHAR(10) ;'
  +#13#10''
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10''
  +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  FOR EXECUTE STATEMENT ('
  +#13#10'              ''WITH RECURSIVE PLM'''
  +#13#10'       ||LF_||''AS ('''
  +#13#10'       ||LF_||'' SELECT'''
  +#13#10'       ||LF_||''  KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS'''
  +#13#10'       ||LF_||'' WHERE KMDEF_PLANOCONTA IS NULL'''
  +#13#10'       ||LF_||'' UNION ALL'''
  +#13#10'       ||LF_||'' SELECT'''
  +#13#10'       ||LF_||''  KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS PL'''
  +#13#10'       ||LF_||'' JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'''
  +#13#10'       ||LF_||'')'''
  +#13#10'       ||LF_||''SELECT'''
  +#13#10'       ||LF_||'' KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||'' ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||'' TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||''FROM PLM'''
  +#13#10'  ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
  +#13#10'  WITH COMMON TRANSACTION'
  +#13#10'  INTO KDEF_PLANOCONTA, TIPO_PLANOCONTAS, CODIGO, NOME, KMDEF_PLANOCONTA,'
  +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
  +#13#10'          KMFIN_PLANOCONTA = NULL ;'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
  +#13#10'            WHERE KCAD_FAZENDA = :pKCAD_FAZENDA'
  +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA'
  +#13#10'              AND TIPO_PLANOCONTAS = :TIPO_PLANOCONTAS'
  +#13#10'            INTO KMFIN_PLANOCONTA ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'       IF ( EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
  +#13#10'                    WHERE KCAD_FAZENDA     = :pKCAD_FAZENDA'
  +#13#10'                      AND KDEF_PLANOCONTA  = :KDEF_PLANOCONTA'
  +#13#10'                      AND TIPO_PLANOCONTAS < 0 ) ) THEN'
  +#13#10'          UPDATE FIN_PLANOCONTAS'
  +#13#10'          SET'
  +#13#10'              TIPO_PLANOCONTAS    = :TIPO_PLANOCONTAS,'
  +#13#10'              CODIGO              = :CODIGO,'
  +#13#10'              NOME                = :NOME,'
  +#13#10'              KMFIN_PLANOCONTA    = :KMFIN_PLANOCONTA,'
  +#13#10'              ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
  +#13#10'              DEVEDORA_CREDORA    = :DEVEDORA_CREDORA,'
  +#13#10'              FLUXOCAIXA          = :FLUXOCAIXA,'
  +#13#10'              TIPO_APRD           = :TIPO_APRD  ,'
  +#13#10'              FIXA_VARIAVEL       = :FIXA_VARIAVEL,'
  +#13#10'              MOVIMENTA_ESTOQUE   = :MOVIMENTA_ESTOQUE,'
  +#13#10'              CLASSIFICACAO       = :CLASSIFICACAO,'
  +#13#10'              ATIVO               = :ATIVO,'
  +#13#10'              SYS$DU              = :SYS$DU'
  +#13#10'           WHERE'
  +#13#10'                ( KCAD_FAZENDA = :pKCAD_FAZENDA )'
  +#13#10'            AND ( KDEF_PLANOCONTA = :KDEF_PLANOCONTA )'
  +#13#10'            AND ( TIPO_PLANOCONTAS < 0 )'
  +#13#10'            AND (   (SYS$DU IS NULL)'
  +#13#10'                 OR (SYS$DU < :SYS$DU)'
  +#13#10'                 OR ( TIPO_PLANOCONTAS    IS DISTINCT FROM  :TIPO_PLANOCONTAS )'
  +#13#10'                 OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
  +#13#10'                 OR ( NOME                IS DISTINCT FROM  :NOME )'
  +#13#10'                 OR ( KMFIN_PLANOCONTA    IS DISTINCT FROM  :KMFIN_PLANOCONTA )'
  +#13#10'                 OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
  +#13#10'                 OR ( DEVEDORA_CREDORA    IS DISTINCT FROM  :DEVEDORA_CREDORA )'
  +#13#10'                 OR ( FLUXOCAIXA          IS DISTINCT FROM  :FLUXOCAIXA )'
  +#13#10'                 OR ( TIPO_APRD           IS DISTINCT FROM  :TIPO_APRD )'
  +#13#10'                 OR ( FIXA_VARIAVEL       IS DISTINCT FROM  :FIXA_VARIAVEL )'
  +#13#10'                 OR ( MOVIMENTA_ESTOQUE   IS DISTINCT FROM  :MOVIMENTA_ESTOQUE )'
  +#13#10'                 OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
  +#13#10'                 OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
  +#13#10'                ) ;'
  +#13#10'       ELSE'
  +#13#10'         BEGIN'
  +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KCAD_FAZENDA, TIPO_PLANOCONTAS, CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA,'
  +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
  +#13#10'           VALUES ( Guid20(), :pKCAD_FAZENDA, :TIPO_PLANOCONTAS, :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA,'
  +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
  +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
  +#13#10''
  +#13#10'         END'
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;


 _CREATE_PROCEDURE_SYS_COPY_PLANOCONTAS  =
         'CREATE OR ALTER PROCEDURE SYS$COPY_PLANOCONTAS ('
  +#13#10'    PKCAD_FAZENDA TYPE OF SYS$FKGUID20_NN,'
  +#13#10'    FROM_TIPO SYS$INT = -1,'
  +#13#10'    TO_TIPO SYS$INT = 1)'
  +#13#10'AS'
  +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
  +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
  +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
  +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
  +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
  +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
  +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
  +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
  +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
  +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
  +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
  +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
  +#13#10'  DECLARE SYS$DU               SYS$DATE;'
  +#13#10'  DECLARE PATH VARCHAR( 256 );'
  +#13#10'  DECLARE LF_ char;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  LF_ = ASCII_CHAR(10) ;'
  +#13#10''
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10'  PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
  +#13#10''
  +#13#10'  IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  FOR EXECUTE STATEMENT ('
  +#13#10'              ''WITH RECURSIVE PLM'''
  +#13#10'       ||LF_||''AS ('''
  +#13#10'       ||LF_||'' SELECT'''
  +#13#10'       ||LF_||''  KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS'''
  +#13#10'       ||LF_||'' WHERE KMDEF_PLANOCONTA IS NULL'''
  +#13#10'       ||LF_||''   AND TIPO_PLANOCONTAS = '' || :FROM_TIPO '
  +#13#10'       ||LF_||'' UNION ALL'''
  +#13#10'       ||LF_||'' SELECT'''
  +#13#10'       ||LF_||''  KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||''  ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||''  TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||'' FROM DEF_PLANOCONTAS PL'''
  +#13#10'       ||LF_||'' JOIN PLM ON PLM.KDEF_PLANOCONTA = PL.KMDEF_PLANOCONTA'''
  +#13#10'       ||LF_||'' WHERE PL.TIPO_PLANOCONTAS = '' || :FROM_TIPO '
  +#13#10'       ||LF_||'')'''
  +#13#10'       ||LF_||''SELECT'''
  +#13#10'       ||LF_||'' KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA,'''
  +#13#10'       ||LF_||'' ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'''
  +#13#10'       ||LF_||'' TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'''
  +#13#10'       ||LF_||''FROM PLM'''
  +#13#10'  ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
  +#13#10'  WITH COMMON TRANSACTION'
  +#13#10'  INTO KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA,'
  +#13#10'       ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'       TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
  +#13#10'          KMFIN_PLANOCONTA = NULL ;'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
  +#13#10'            WHERE KCAD_FAZENDA = :pKCAD_FAZENDA'
  +#13#10'              AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA AND TIPO_PLANOCONTAS = :TO_TIPO'
  +#13#10'            INTO KMFIN_PLANOCONTA ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'       IF ( NOT EXISTS (SELECT 1 FROM FIN_PLANOCONTAS'
  +#13#10'                    WHERE KCAD_FAZENDA      = :pKCAD_FAZENDA'
  +#13#10'                      AND KDEF_PLANOCONTA   = :KDEF_PLANOCONTA'
  +#13#10'                      AND TIPO_PLANOCONTAS  = :TO_TIPO ) ) THEN'
  +#13#10'           INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KCAD_FAZENDA, TIPO_PLANOCONTAS, CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA,'
  +#13#10'                ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
  +#13#10'                TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
  +#13#10'           VALUES ( Guid20(), :pKCAD_FAZENDA, :TO_TIPO, :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA,'
  +#13#10'                :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
  +#13#10'                :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ;


  _EXECUTE_PROCEDURE_SYS_INIT_PLANOCONTAS =
      'EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS( %s )' ;
//var
//  LTransaction : TDBXTransaction ;

begin
  {$IFDEF _EXPORT}
  //ExecuteDirect ( 'ALTER TRIGGER JNL$FIN_PLANOCONTAS INACTIVE' ) ;
  {$ENDIF _EXPORT}

  TryExecuteDirect ( _CREATE_SEQUENCE_TIPO_PLANOCONTAS  ) ;
  ExecuteDirect    ( _RESTART_SEQUENCE_TIPO_PLANOCONTAS ) ;
  TryExecuteDirect ( _ALTER_TABLE_FIN_PLANOCONTAS ) ;
  ExecuteDirect    ( _UPDATE_FIN_PLANOCONTAS_SET_TIPO_PLANOCONTAS ) ;
//  LTransaction := TSQLConnection( self.IDB.Connection ).BeginTransaction ;
  ExecuteDirect    ( 'ALTER TRIGGER ON_CONNECT INACTIVE' ) ;
  Reconnect ;
  ExecuteDirect    ( _CREATE_PROCEDURE_SYS_INIT_PLANOCONTAS ) ;
  ExecuteDirect    ( _CREATE_PROCEDURE_SYS_COPY_PLANOCONTAS ) ;
  ExecuteDirect    ( 'ALTER TRIGGER ON_CONNECT ACTIVE' ) ;
  ExecuteDirect    ( Format ( _EXECUTE_PROCEDURE_SYS_INIT_PLANOCONTAS, [ QuotedStr ( LoggedUser.DomainID  ) ] ) ) ;
//  TSQLConnection( self.IDB.Connection ).CommitFreeAndNil(LTransaction)
end ;

procedure TDBFinanceiroUpdate._5_001_22;
const

 _ALTER_TABLE_CMP_PEDIDOS_ADD_MODELO_NFE  =
        'ALTER TABLE CMP_PEDIDOS'
 +#13#10'ADD MODELO_NFE SYS$INT,'
 +#13#10'ALTER MODELO_NFE POSITION 23' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS_ADD_MODELO_NFE  ) ;
end;

procedure TDBFinanceiroUpdate._5_001_21;
const
  _CREATE_DOMAIN_SYS_BLOBXML =
         'CREATE DOMAIN SYS$BLOBXML AS'
  +#13#10'BLOB SUB_TYPE 1 SEGMENT SIZE 80 CHARACTER SET UTF8' ;

 _ALTER_TABLE_CMP_PEDIDOS_ADD_XML_NFE =
        'ALTER TABLE CMP_PEDIDOS'
 +#13#10'ADD XML_NFE SYS$BLOBXML,'
 +#13#10'ALTER XML_NFE POSITION 22' ;
begin
  TryExecuteDirect ( _CREATE_DOMAIN_SYS_BLOBXML ) ;
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS_ADD_XML_NFE ) ;
end;

procedure TDBFinanceiroUpdate._5_001_20;
const
  _ALTER_TRIGGER_CMP_PEDIDOS_AUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO      SYS$FKGUID20 ;'
  +#13#10'DECLARE QTDE              SYS$FLOAT ;'
  +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
  +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
  +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
  +#13#10'DECLARE ATUALIZAR_CUSTO   SYS$BOOL ;'
  +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$FKGUID20 ;'
  +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
  +#13#10'        EXIT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR ;'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_TRANSPORTE ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE, I.ATUALIZAR_CUSTO'
  +#13#10'  FROM CMP_PEDIDO_ITENS I'
  +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
  +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
  +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
  +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
  +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE, ATUALIZAR_CUSTO'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'     IF ( DELETING ) THEN'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
  +#13#10'     IF (     ( KEST_PRODUTO IS NOT NULL )'
  +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
  +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
  +#13#10'       ) THEN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (  IIF ( DELETING, ''D'', ''U'' ),'
  +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
  +#13#10'                                                 KEST_PRODUTO,'
  +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
  +#13#10'                                                 ''E'','
  +#13#10'                                                 QTDE,'
  +#13#10'                                                 CUSTO,'
  +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                 KCMP_PEDIDO_ITEM,'
  +#13#10'                                                 ATUALIZAR_CUSTO);'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     FOR SELECT'
  +#13#10'       S.KCMP_PEDIDO_SERVICO'
  +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
  +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
  +#13#10'     INTO KCMP_PEDIDO_SERVICO'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
  +#13#10''
  +#13#10'END' ;
begin
  ExecuteDirect ( _ALTER_TRIGGER_CMP_PEDIDOS_AUD0 ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_19;
const
 _ALTER_TABLE_CMP_PEDIDOS_ADD_IMPORTADONFE =
        'ALTER TABLE CMP_PEDIDOS'
 +#13#10'ADD IMPORTADONFE SYS$BOOL_F,'
 +#13#10'ALTER IMPORTADONFE POSITION 7' ;
begin
  TryExecuteDirect ( _ALTER_TABLE_CMP_PEDIDOS_ADD_IMPORTADONFE ) ;
end;


procedure TDBFinanceiroUpdate._5_001_18;
const
  _CREATE_TRIGGER_EST_PRODUTO_FORNECEDORES_BI0 =
         'CREATE OR ALTER TRIGGER EST_PRODUTO_FORNECEDORES_BI0 FOR EST_PRODUTO_FORNECEDORES'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10' IF ( NEW.KEST_PRODUTO_FORNECEDOR IS NULL ) THEN'
  +#13#10'    NEW.KEST_PRODUTO_FORNECEDOR = GUID20() ;'
  +#13#10''
  +#13#10'END' ;
begin
  TryExecuteDirect ( _CREATE_TRIGGER_EST_PRODUTO_FORNECEDORES_BI0 ) ;
end;


procedure TDBFinanceiroUpdate._5_001_17;
const
  _CREATE_DOMAIN_FAT_CFOP =
         'CREATE DOMAIN FAT$CFOP AS'
  +#13#10'CHAR(4) CHARACTER SET ISO8859_1'
  +#13#10'COLLATE ISO8859_1' ;

  _CREATE_DOMAIN_SYS_DESCR_LARGE =
         'CREATE DOMAIN SYS$DESCR_LARGE AS'
  +#13#10'VARCHAR(512) CHARACTER SET ISO8859_1'
  +#13#10'COLLATE ISO8859_1' ;

  _CREATE_TABLE_FAT_CFOP =
         'CREATE TABLE FAT_CFOP'
  +#13#10'('
  +#13#10'  CFOP FAT$CFOP,'
  +#13#10'  DESCRICAO SYS$DESCR_LARGE,'
  +#13#10'  APLICACAO SYS$BLOBTEXT,'
  +#13#10'  ATUALIZA_CUSTO SYS$BOOL_T'
  +#13#10')' ;
begin
  TryExecuteDirect( _CREATE_DOMAIN_FAT_CFOP ) ;
  TryExecuteDirect( _CREATE_DOMAIN_SYS_DESCR_LARGE ) ;
  TryExecuteDirect( _CREATE_TABLE_FAT_CFOP ) ;
end;


procedure TDBFinanceiroUpdate._5_001_16 ;
const
  _ALTER_TABLE_EST_MOVIMENTO_1 =
         'ALTER TABLE EST_MOVIMENTO'
  +#13#10'ADD    ATUALIZAR_CUSTO   SYS$BOOL_T,'
  +#13#10'ALTER  ATUALIZAR_CUSTO  POSITION 11' ;


  _ALTER_PROCEDURE_EST_UPDATE_MOVIMENTO_2 =
         'CREATE OR ALTER PROCEDURE EST_UPDATE_MOVIMENTO ('
  +#13#10'    TIPO_IUD char(1),'
  +#13#10'    KDOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE,'
  +#13#10'    TIPO_ES SYS$TIPOMOVEST,'
  +#13#10'    QTDE SYS$FLOAT,'
  +#13#10'    CUSTO SYS$FLOAT,'
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$FKGUID20,'
  +#13#10'    ATUALIZAR_CUSTO SYS$BOOL = ''T'' )'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( TIPO_ES = ''S'' AND QTDE > 0 )  THEN'
  +#13#10'     QTDE = -QTDE ;'
  +#13#10''
  +#13#10'  IF (    (TIPO_IUD = ''U'')'
  +#13#10'      AND NOT EXISTS( SELECT 1 FROM EST_MOVIMENTO'
  +#13#10'                  WHERE'
  +#13#10'                       KSYS$DOMAIN = :KDOMAIN'
  +#13#10'                   AND TABLENAME    = :TABLENAME'
  +#13#10'                   AND TABLEKEY     = :TABLEKEY)'
  +#13#10''
  +#13#10'     ) THEN'
  +#13#10'     TIPO_IUD = ''I'' ;'
  +#13#10''
  +#13#10'  IF ( TIPO_IUD = ''I'' ) THEN'
  +#13#10'    INSERT INTO EST_MOVIMENTO'
  +#13#10'      ( KEST_MOVIMENTO, KSYS$DOMAIN, DATA, KEST_PRODUTO, TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO,'
  +#13#10'        TABLENAME, TABLEKEY )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), :KDOMAIN, :DATA, :KEST_PRODUTO, :TIPO_ES, :QTDE, :CUSTO, :ATUALIZAR_CUSTO,'
  +#13#10'        :TABLENAME, :TABLEKEY );'
  +#13#10'  ELSE IF (TIPO_IUD = ''U'') THEN'
  +#13#10'    UPDATE EST_MOVIMENTO'
  +#13#10'      SET KEST_PRODUTO = :KEST_PRODUTO,'
  +#13#10'          DATA = :DATA,'
  +#13#10'          TIPO = :TIPO_ES,'
  +#13#10'          QTDE = :QTDE,'
  +#13#10'          CUSTO = :CUSTO,'
  +#13#10'          ATUALIZAR_CUSTO = :ATUALIZAR_CUSTO'
  +#13#10'     WHERE'
  +#13#10'          KSYS$DOMAIN = :KDOMAIN'
  +#13#10'      AND TABLENAME    = :TABLENAME'
  +#13#10'      AND TABLEKEY     = :TABLEKEY'
  +#13#10'      AND (   (KEST_PRODUTO    IS DISTINCT FROM :KEST_PRODUTO)'
  +#13#10'           OR (DATA            IS DISTINCT FROM :DATA)'
  +#13#10'           OR (TIPO            IS DISTINCT FROM :TIPO_ES)'
  +#13#10'           OR (QTDE            IS DISTINCT FROM :QTDE)'
  +#13#10'           OR (CUSTO           IS DISTINCT FROM :CUSTO)'
  +#13#10'           OR (ATUALIZAR_CUSTO IS DISTINCT FROM :ATUALIZAR_CUSTO)'
  +#13#10'          ) ;'
  +#13#10'  ELSE IF (TIPO_IUD = ''D'') THEN'
  +#13#10'    DELETE FROM EST_MOVIMENTO'
  +#13#10'    WHERE KSYS$DOMAIN = :KDOMAIN AND TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_PROCEDURE_EST_UPDATE_ESTOQUE_3 =
         'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE ('
  +#13#10'    KDOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE)'
  +#13#10'AS'
  +#13#10'DECLARE TIPO CHAR(1) = NULL;'
  +#13#10'DECLARE ESTOQUE SYS$FLOAT;'
  +#13#10'DECLARE ESTOQUE_ANTERIOR SYS$FLOAT;'
  +#13#10'DECLARE QTDE SYS$FLOAT;'
  +#13#10'DECLARE CUSTO SYS$FLOAT;'
  +#13#10'DECLARE CUSTO_ANTERIOR SYS$FLOAT;'
  +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
  +#13#10'DECLARE TOTAL_ENTRADA SYS$FLOAT;'
  +#13#10'DECLARE TOTAL_SAIDA SYS$FLOAT;'
  +#13#10'DECLARE DATAMOVTO SYS$DATE;'
  +#13#10'DECLARE EST$MOVTO_OFF VARCHAR(1);'
  +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
  +#13#10'DECLARE ANO SMALLINT = NULL ;'
  +#13#10'DECLARE MES SMALLINT = NULL ;'
  +#13#10'DECLARE ATUALIZAR_CUSTO SYS$BOOL ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  CUSTO_ANTERIOR   = null ;'
  +#13#10'  CUSTO_MEDIO      = null ;'
  +#13#10'  ESTOQUE_ANTERIOR = null ;'
  +#13#10''
  +#13#10'  Ano = Extract ( YEAR from DATA ) ;'
  +#13#10'  Mes = Extract ( MONTH from DATA ) ;'
  +#13#10''
  +#13#10'  IF (MES=1) THEN'
  +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || (Ano - 1), 4 ) || ''12'' ;'
  +#13#10'  ELSE'
  +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || Ano, 4 ) || RIGHT ( ''00'' || (MES - 1), 2) ;'
  +#13#10''
  +#13#10'  SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
  +#13#10'    FROM EST_MOVIMENTO'
  +#13#10'   WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'     AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'     AND DATA < :DATA'
  +#13#10'   ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
  +#13#10'    ROWS 1'
  +#13#10'    INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
  +#13#10''
  +#13#10'  IF ( TIPO IS NULL ) then'
  +#13#10'    BEGIN'
  +#13#10'      SELECT TIPO, CUSTO, ATUALIZAR_CUSTO, CUSTO_MEDIO, QTDE, DATA'
  +#13#10'        FROM EST_MOVIMENTO'
  +#13#10'       WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'         AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'         AND TIPO = ''C'''
  +#13#10'       ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
  +#13#10'        ROWS 1'
  +#13#10'        INTO TIPO, CUSTO_ANTERIOR, ATUALIZAR_CUSTO, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
  +#13#10'      DATA = DATAMOVTO ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF (     (TIPO <> ''C'')'
  +#13#10'       AND ('
  +#13#10'               (EXTRACT( MONTH FROM DATAMOVTO ) <> EXTRACT( MONTH FROM DATA ))'
  +#13#10'            OR (EXTRACT( YEAR  FROM DATAMOVTO ) <> EXTRACT( YEAR  FROM DATA ))'
  +#13#10'           )'
  +#13#10'     ) THEN'
  +#13#10'     BEGIN'
  +#13#10'       SELECT EMP.CUSTO_MEDIO FROM EST_ENCERRAMENTO_MES EM'
  +#13#10'       LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = :KEST_PRODUTO )'
  +#13#10'       WHERE ( EM.ANO_MES = :ANO_MES_ANT AND EM.ENCERRADO = ''T'' )'
  +#13#10'       INTO CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'       CUSTO_ANTERIOR = CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'     END'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'       TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
  +#13#10'  FROM EST_MOVIMENTO'
  +#13#10'  WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    AND DATA >= :DATA'
  +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
  +#13#10'  INTO TIPO, QTDE, CUSTO, ATUALIZAR_CUSTO'
  +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
  +#13#10'          CUSTO_MEDIO      = CUSTO_ANTERIOR ;'
  +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
  +#13#10'        END'
  +#13#10'      ELSE IF ('
  +#13#10'                ( TIPO = ''E'' )'
  +#13#10'            AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
  +#13#10'              ) THEN'
  +#13#10'         BEGIN'
  +#13#10'           IF ( ATUALIZAR_CUSTO = ''T'') THEN'
  +#13#10'             CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
  +#13#10'           ELSE'
  +#13#10'             CUSTO_MEDIO = CUSTO_ANTERIOR ;'
  +#13#10'         END'
  +#13#10'      ELSE IF ( TIPO = ''S'' ) THEN'
  +#13#10'         CUSTO = CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
  +#13#10''
  +#13#10'      UPDATE EST_MOVIMENTO'
  +#13#10'         SET'
  +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
  +#13#10'             CUSTO            = :CUSTO,'
  +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
  +#13#10'             ESTOQUE          = :ESTOQUE'
  +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
  +#13#10''
  +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
  +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  -- revisar....'
  +#13#10'  -- Atualiza status atual produto'
  +#13#10'    SELECT'
  +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
  +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA'
  +#13#10'     FROM EST_MOVIMENTO ME'
  +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'       AND ME.TIPO <> ''C'''
  +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA ;'
  +#13#10''
  +#13#10'   UPDATE EST_PRODUTOS'
  +#13#10'      SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
  +#13#10'          QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
  +#13#10'          CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
  +#13#10'          CUSTO_MEDIO_MES   = NULL'
  +#13#10'   WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
  +#13#10''
  +#13#10' RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
  +#13#10''
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_CMP_PEDIDOS_AUD0_4 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
  +#13#10'DECLARE QTDE              SYS$FLOAT ;'
  +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
  +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
  +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
  +#13#10'DECLARE ATUALIZAR_CUSTO   SYS$BOOL ;'
  +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
  +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
  +#13#10'        EXIT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR ;'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_TRANSPORTE ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE, I.ATUALIZAR_CUSTO'
  +#13#10'  FROM CMP_PEDIDO_ITENS I'
  +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
  +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
  +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
  +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
  +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE, ATUALIZAR_CUSTO'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'     IF ( DELETING ) THEN'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
  +#13#10'     IF (     ( KEST_PRODUTO IS NOT NULL )'
  +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
  +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
  +#13#10'       ) THEN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (  IIF ( DELETING, ''D'', ''U'' ),'
  +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
  +#13#10'                                                 KEST_PRODUTO,'
  +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
  +#13#10'                                                 ''E'','
  +#13#10'                                                 QTDE,'
  +#13#10'                                                 CUSTO,'
  +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                 KCMP_PEDIDO_ITEM,'
  +#13#10'                                                 ATUALIZAR_CUSTO);'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     FOR SELECT'
  +#13#10'       S.KCMP_PEDIDO_SERVICO'
  +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
  +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
  +#13#10'     INTO KCMP_PEDIDO_SERVICO'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
  +#13#10''
  +#13#10'END' ;

   _ALTER_TRIGGER_CMP_PEDIDO_ITENS_AIUD0_5 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10''
  +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
  +#13#10'DECLARE KCAD_ENTIDADE   SYS$FKGUID20;'
  +#13#10'DECLARE NOMEENTIDADE    SYS$DESCR;'
  +#13#10'DECLARE DATA            SYS$DATE;'
  +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
  +#13#10'DECLARE KCMP_PEDIDO     SYS$FKGUID20  = NULL ;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'     ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
  +#13#10''
  +#13#10'  SELECT KSYS$DOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
  +#13#10'    FROM CMP_PEDIDOS'
  +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
  +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
  +#13#10''
  +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  IF (    UPDATING'
  +#13#10'      AND ('
  +#13#10'                ( OLD.KCMP_PEDIDO_ITEM IS DISTINCT FROM NEW.KCMP_PEDIDO_ITEM )'
  +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
  +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
  +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
  +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
  +#13#10'                )'
  +#13#10'          )'
  +#13#10'     ) THEN'
  +#13#10'   BEGIN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
  +#13#10'                                                KDOMAIN,'
  +#13#10'                                                OLD.KEST_PRODUTO,'
  +#13#10'                                                DATA,'
  +#13#10'                                                ''E'','
  +#13#10'                                                OLD.QTDE,'
  +#13#10'                                                OLD.CUSTO,'
  +#13#10'                                                ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                OLD.KCMP_PEDIDO_ITEM,'
  +#13#10'                                                OLD.ATUALIZAR_CUSTO'
  +#13#10'                                                );'
  +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
  +#13#10'          EXIT ;'
  +#13#10''
  +#13#10'   END'
  +#13#10''
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
  +#13#10'        UPDATE EST_PRODUTOS'
  +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
  +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
  +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
  +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
  +#13#10'  ELSE'
  +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
  +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  BAIXA_ESTOQUE = NULL ;'
  +#13#10''
  +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
  +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
  +#13#10'                                             when Inserting then ''I'''
  +#13#10'                                             when Updating  then ''U'''
  +#13#10'                                             when Deleting  then ''D'''
  +#13#10'                                             end,'
  +#13#10'                                             KDOMAIN,'
  +#13#10'                                             KEST_PRODUTO,'
  +#13#10'                                             DATA,'
  +#13#10'                                             ''E'','
  +#13#10'                                             NEW.QTDE,'
  +#13#10'                                             NEW.CUSTO,'
  +#13#10'                                             ''CMP_PEDIDO_ITENS'','
  +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM ),'
  +#13#10'                                             IIF( DELETING, OLD.ATUALIZAR_CUSTO, NEW.ATUALIZAR_CUSTO )'
  +#13#10'                                             );'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_EST_MOVIMENTO_AIUD0_6 =
         'CREATE OR ALTER TRIGGER EST_MOVIMENTO_AIUD0 FOR EST_MOVIMENTO'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  if ( RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) = ''1'' ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  if ( inserting or updating ) then'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE NEW.KSYS$DOMAIN, NEW.KEST_PRODUTO, NEW.DATA ;'
  +#13#10'  else'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE OLD.KSYS$DOMAIN, OLD.KEST_PRODUTO, OLD.DATA ;'
  +#13#10''
  +#13#10'END' ;

  _DROP_TRIGGER_JNL_EST_MOVIMENTO_7 =
      'DROP TRIGGER JNL$EST_MOVIMENTO' ;

  _DROP_TRIGGER_EST_MOVIMENTO_DOMAIN_8 =
      'DROP TRIGGER EST_MOVIMENTO_DOMAIN' ;

  _ALTER_TRIGGER_EST_PRODUTOS_BIUD0_9 =
         'CREATE OR ALTER TRIGGER EST_PRODUTOS_BIUD0 FOR EST_PRODUTOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( INSERTING ) THEN'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'      IF ( NEW.CODIGO IS NULL ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_PRODUTOS_CODIGO'' )'
  +#13#10'        INTO NEW.CODIGO ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_CADASTRO IS NULL ) THEN'
  +#13#10'         NEW.DATA_CADASTRO = CURRENT_DATE;'
  +#13#10''
  +#13#10'      NEW.CUSTO_MEDIO_MOVTO = COALESCE( NEW.CUSTO_INICIAL, 0 );'
  +#13#10'    END'
  +#13#10'  ELSE IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF (    ( NEW.BAIXA_ESTOQUE IS DISTINCT FROM OLD.BAIXA_ESTOQUE )'
  +#13#10'          AND ( NEW.BAIXA_ESTOQUE IS DISTINCT FROM ''T'' )'
  +#13#10'          AND ( EXISTS'
  +#13#10'                (SELECT 1'
  +#13#10'                   FROM EST_MOVIMENTO'
  +#13#10'                  WHERE KSYS$DOMAIN = NEW.KSYS$DOMAIN'
  +#13#10'                    AND KEST_PRODUTO = NEW.KEST_PRODUTO'
  +#13#10'                    AND TIPO <> ''C'''
  +#13#10'                  ROWS 1'
  +#13#10'                )'
  +#13#10'              )'
  +#13#10'          ) THEN'
  +#13#10'         EXCEPTION SYS$EXCEPTION ''Existe movimentação de estoque do produto. Não é possivel alterar baixa de estoque.'' ;'
  +#13#10''
  +#13#10'      IF (   ( NEW.DATA_SALDOINICIAL IS DISTINCT FROM OLD.DATA_SALDOINICIAL )'
  +#13#10'          OR ( NEW.QTDE_INICIAL  IS DISTINCT FROM OLD.QTDE_INICIAL )'
  +#13#10'          OR ( NEW.CUSTO_INICIAL IS DISTINCT FROM OLD.CUSTO_INICIAL )'
  +#13#10'         ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          IF ( EXISTS'
  +#13#10'                (SELECT 1'
  +#13#10'                  FROM EST_MOVIMENTO'
  +#13#10'                  WHERE KSYS$DOMAIN = NEW.KSYS$DOMAIN'
  +#13#10'                    AND KEST_PRODUTO = NEW.KEST_PRODUTO'
  +#13#10'                    AND TIPO <> ''C'''
  +#13#10'                    AND CAST( DATA AS DATE ) < CAST( NEW.DATA_SALDOINICIAL AS DATE )'
  +#13#10'                    ROWS 1'
  +#13#10'                )'
  +#13#10'             ) THEN'
  +#13#10'         EXCEPTION SYS$EXCEPTION ''Existe movimentação do produto anterior a data de saldo inicial'' ;'
  +#13#10''
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'        END'
  +#13#10'    END'
  +#13#10'  ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''EST_PRODUTOS'', OLD.KEST_PRODUTO ;'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_EST_PRODUTOS_AIU0_10 =
         'CREATE OR ALTER TRIGGER EST_PRODUTOS_AIU0 FOR EST_PRODUTOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (     ( UPDATING )'
  +#13#10'       AND (NEW.BAIXA_ESTOQUE IS DISTINCT FROM OLD.BAIXA_ESTOQUE)'
  +#13#10'       AND (NEW.BAIXA_ESTOQUE IS DISTINCT FROM ''T'')'
  +#13#10'     ) THEN'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO( ''D'','
  +#13#10'                                            NEW.KSYS$DOMAIN,'
  +#13#10'                                            NEW.KEST_PRODUTO,'
  +#13#10'                                            NEW.DATA_SALDOINICIAL,'
  +#13#10'                                            ''C'','
  +#13#10'                                            NEW.QTDE_INICIAL,'
  +#13#10'                                            NEW.CUSTO_INICIAL,'
  +#13#10'                                            ''EST_PRODUTOS'','
  +#13#10'                                            NEW.KEST_PRODUTO );'
  +#13#10''
  +#13#10''
  +#13#10'  IF (    (   ( INSERTING )'
  +#13#10'           OR (     UPDATING'
  +#13#10'               AND (   ( NEW.KSYS$DOMAIN      IS DISTINCT FROM OLD.KSYS$DOMAIN      )'
  +#13#10'                    OR ( NEW.KEST_PRODUTO      IS DISTINCT FROM OLD.KEST_PRODUTO      )'
  +#13#10'                    OR ( NEW.DATA_SALDOINICIAL IS DISTINCT FROM OLD.DATA_SALDOINICIAL )'
  +#13#10'                    OR ( NEW.QTDE_INICIAL      IS DISTINCT FROM OLD.QTDE_INICIAL      )'
  +#13#10'                    OR ( NEW.CUSTO_INICIAL     IS DISTINCT FROM OLD.CUSTO_INICIAL     )'
  +#13#10'                   )'
  +#13#10'              )'
  +#13#10'          )'
  +#13#10'      AND (NEW.BAIXA_ESTOQUE  = ''T'')'
  +#13#10'     ) THEN'
  +#13#10'  EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO( CASE'
  +#13#10'                                          when Inserting then ''I'''
  +#13#10'                                          when Updating  then ''U'''
  +#13#10'                                          end,'
  +#13#10'                                          NEW.KSYS$DOMAIN,'
  +#13#10'                                          NEW.KEST_PRODUTO,'
  +#13#10'                                          NEW.DATA_SALDOINICIAL,'
  +#13#10'                                          ''C'','
  +#13#10'                                          NEW.QTDE_INICIAL,'
  +#13#10'                                          NEW.CUSTO_INICIAL,'
  +#13#10'                                          ''EST_PRODUTOS'','
  +#13#10'                                          NEW.KEST_PRODUTO );'
  +#13#10''
  +#13#10'END' ;

  _DROP_TRIGGER_EST_PRODUTOS_DOMAIN_11 =
        'DROP TRIGGER EST_PRODUTOS_DOMAIN' ;

  _DROP_TRIGGER_JNL_EST_PRODUTOS_12 =
        'DROP TRIGGER JNL$EST_PRODUTOS' ;

  _ALTER_TRIGGER_VND_PEDIDO_ITENS_AIUD0_13 =
         'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10''
  +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
  +#13#10'DECLARE DATA            SYS$DATE;'
  +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
  +#13#10'DECLARE KVND_PEDIDO     SYS$FKGUID20  = NULL ;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'     ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  KVND_PEDIDO = IIF( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO ) ;'
  +#13#10''
  +#13#10'  SELECT KSYS$DOMAIN, DATA_EMISSAO'
  +#13#10'    FROM VND_PEDIDOS'
  +#13#10'   WHERE KVND_PEDIDO = :KVND_PEDIDO'
  +#13#10'  INTO KDOMAIN, DATA;'
  +#13#10''
  +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  IF (    UPDATING'
  +#13#10'      AND ('
  +#13#10'                ( OLD.KVND_PEDIDO_ITEM IS DISTINCT FROM NEW.KVND_PEDIDO_ITEM )'
  +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
  +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
  +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
  +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
  +#13#10'                )'
  +#13#10'          )'
  +#13#10'     ) THEN'
  +#13#10'   BEGIN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
  +#13#10'                                                KDOMAIN,'
  +#13#10'                                                OLD.KEST_PRODUTO,'
  +#13#10'                                                DATA,'
  +#13#10'                                                ''S'','
  +#13#10'                                                OLD.QTDE,'
  +#13#10'                                                OLD.CUSTO,'
  +#13#10'                                                ''VND_PEDIDO_ITENS'','
  +#13#10'                                                OLD.KVND_PEDIDO_ITEM'
  +#13#10'                                                );'
  +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
  +#13#10'          EXIT ;'
  +#13#10''
  +#13#10'   END'
  +#13#10''
  +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'       KEST_PRODUTO    = NEW.KEST_PRODUTO ;'
  +#13#10'       KFIN_PLANOCONTA = NEW.KFIN_PLANOCONTA ;'
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'      KEST_PRODUTO    = OLD.KEST_PRODUTO ;'
  +#13#10'      KFIN_PLANOCONTA = OLD.KFIN_PLANOCONTA ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
  +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  BAIXA_ESTOQUE = NULL ;'
  +#13#10''
  +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
  +#13#10'     WHERE KSYS$DOMAIN = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
  +#13#10'                                             when Inserting then ''I'''
  +#13#10'                                             when Updating  then ''U'''
  +#13#10'                                             when Deleting  then ''D'''
  +#13#10'                                             end,'
  +#13#10'                                             KDOMAIN,'
  +#13#10'                                             KEST_PRODUTO,'
  +#13#10'                                             DATA,'
  +#13#10'                                             ''S'','
  +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
  +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
  +#13#10'                                             ''VND_PEDIDO_ITENS'','
  +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
  +#13#10'                                            );'
  +#13#10''
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_EST_MOVIMENTO_BIU0 =
         'CREATE OR ALTER TRIGGER EST_MOVIMENTO_BIU0 FOR EST_MOVIMENTO'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( NEW.TIPO = ''C'' AND NEW.MOVTO_ID IS DISTINCT FROM -1 ) THEN'
  +#13#10'     NEW.MOVTO_ID = -1 ;'
  +#13#10''
  +#13#10'  IF ( NEW.MOVTO_ID IS NULL OR NEW.MOVTO_ID = 0 ) THEN'
  +#13#10'    SELECT SEQUENCE_VALUE'
  +#13#10'    FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_MOVTO_ID'' )'
  +#13#10'    INTO NEW.MOVTO_ID ;'
  +#13#10''
  +#13#10'  IF (    ( inserting )'
  +#13#10'      OR ( updating AND NEW.DATA IS DISTINCT FROM OLD.DATA ) ) THEN'
  +#13#10'    NEW.ANO_MES = Right ( ''0000'' || EXTRACT ( YEAR  FROM NEW.DATA ), 4 ) || Right ( ''00'' || EXTRACT ( MONTH FROM NEW.DATA ), 2 ) ;'
  +#13#10''
  +#13#10'  /*'
  +#13#10'  --GERA CODIGO SEQUENCIAL APENAS EM LANCAMENTOS DE ESTOQUE'
  +#13#10'  IF ( ( NEW.CODIGO_LANCAMENTO IS NULL ) AND ( NEW.TABLENAME = ''EST_MOVIMENTO'' ) ) THEN'
  +#13#10'  BEGIN'
  +#13#10'    VCODIGO = ''00000'' || GEN_ID ( CODIGO_MOVIMENTO_PRODUTOS, 1 );'
  +#13#10'    NEW.CODIGO_LANCAMENTO = RIGHT(:VCODIGO, 5) ;'
  +#13#10'  END'
  +#13#10''
  +#13#10'  IF ( NEW.TABLENAME = ''EST_PRODUTOS'') THEN'
  +#13#10'  BEGIN'
  +#13#10'    NEW.ESTOQUE     = NEW.QTDE;'
  +#13#10'    NEW.CUSTO_MEDIO = NEW.CUSTO;'
  +#13#10'  END'
  +#13#10''
  +#13#10'  NEW.TOTAL = ( NEW.ESTOQUE * NEW.CUSTO_MEDIO );'
  +#13#10'  */'
  +#13#10''
  +#13#10'END' ;

  _ALTER_TRIGGER_EST_ENCERRAMENTO_MES_BIUD0 =
         'CREATE OR ALTER TRIGGER EST_ENCERRAMENTO_MES_BIUD0 FOR EST_ENCERRAMENTO_MES'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'      NEW.DATA_STATUS = ''NOW''  ;'
  +#13#10'   ELSE if ( UPDATING ) THEN'
  +#13#10'     BEGIN'
  +#13#10'       IF ( NEW.ENCERRADO IS DISTINCT FROM OLD.ENCERRADO ) THEN'
  +#13#10'         BEGIN'
  +#13#10'           IF (   ( NEW.ENCERRADO = ''F'' )'
  +#13#10'              AND ( EXISTS (SELECT 1 FROM EST_ENCERRAMENTO_MES'
  +#13#10'                       WHERE KSYS$DOMAIN = NEW.KSYS$DOMAIN'
  +#13#10'                         AND ANO_MES > NEW.ANO_MES'
  +#13#10'                         AND ENCERRADO = ''T'''
  +#13#10'                         ROWS 1) )'
  +#13#10'              ) THEN'
  +#13#10'              EXCEPTION SYS$EXCEPTION ''Mês posterior encerrado. Não é possível continuar.'' ;'
  +#13#10'           IF (   ( NEW.ENCERRADO = ''T'' )'
  +#13#10'              AND ( EXISTS (SELECT 1 FROM EST_ENCERRAMENTO_MES'
  +#13#10'                       WHERE KSYS$DOMAIN = NEW.KSYS$DOMAIN'
  +#13#10'                         AND ANO_MES < NEW.ANO_MES'
  +#13#10'                         AND ENCERRADO = ''F'''
  +#13#10'                         ROWS 1) )'
  +#13#10'              ) THEN'
  +#13#10'              EXCEPTION SYS$EXCEPTION ''Mês anterior não encerrado. Não é possível continuar.'' ;'
  +#13#10''
  +#13#10'           NEW.DATA_STATUS = ''NOW''  ;'
  +#13#10''
  +#13#10'         END'
  +#13#10'     END'
  +#13#10'   ELSE IF (DELETING) then'
  +#13#10'     BEGIN'
  +#13#10'        IF ( EXISTS (SELECT 1 FROM EST_MOVIMENTO'
  +#13#10'                     WHERE KSYS$DOMAIN = OLD.KSYS$DOMAIN'
  +#13#10'                       AND ANO_MES = OLD.ANO_MES'
  +#13#10'                       ROWS 1) ) then'
  +#13#10'        EXCEPTION SYS$EXCEPTION ''Existe movimentação de estoque neste mes.'' ;'
  +#13#10'     END'
  +#13#10'END' ;

  _ALTER_TRIGGER_EST_OUTRAS_ENTRADAS_SAIDA_AIUD0 =
         'CREATE OR ALTER TRIGGER EST_OUTRAS_ENTRADAS_SAIDA_AIUD0 FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
  +#13#10'DECLARE KSYS$DOMAIN  SYS$FKGUID20 = NULL ;'
  +#13#10'DECLARE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  -- EXECUTE PROCEDURE SYS$LOG ''EST_OUTRAS_ENTRADAS_SAIDA_AIUD0'' ;'
  +#13#10''
  +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      KEST_PRODUTO = NEW.KEST_PRODUTO ;'
  +#13#10'      KSYS$DOMAIN = NEW.KSYS$DOMAIN ;'
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'      KEST_PRODUTO = OLD.KEST_PRODUTO ;'
  +#13#10'      KSYS$DOMAIN = OLD.KSYS$DOMAIN ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
  +#13#10'    WHERE KSYS$DOMAIN = :KSYS$DOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
  +#13#10'                                             when Inserting then ''I'''
  +#13#10'                                             when Updating  then ''U'''
  +#13#10'                                             when Deleting  then ''D'''
  +#13#10'                                             end,'
  +#13#10'                                             COALESCE( NEW.KSYS$DOMAIN, OLD.KSYS$DOMAIN ) ,'
  +#13#10'                                             KEST_PRODUTO,'
  +#13#10'                                             NEW.DATA,'
  +#13#10'                                             COALESCE(NEW.TIPO,  OLD.TIPO  ),'
  +#13#10'                                             COALESCE(NEW.QTDE,  OLD.QTDE  ),'
  +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO ),'
  +#13#10'                                             ''EST_OUTRAS_ENTRADAS_SAIDAS'','
  +#13#10'                                             COALESCE(NEW.KEST_OUTRA_ENTRADA_SAIDA, OLD.KEST_OUTRA_ENTRADA_SAIDA)'
  +#13#10'                                           );'
  +#13#10''
  +#13#10'END' ;

  _DROP_KCAD_FAZENDA_EST_MOVIMENTO_14 =
         'ALTER TABLE EST_MOVIMENTO'
  +#13#10'DROP KCAD_FAZENDA' ;

  _DROP_KCAD_FAZENDA_EST_PRODUTOS_15 =
         'ALTER TABLE EST_PRODUTOS'
  +#13#10'DROP KCAD_FAZENDA' ;

begin
  TryExecuteDirect ( _ALTER_TABLE_EST_MOVIMENTO_1             ) ;
  ExecuteDirect    ( _ALTER_PROCEDURE_EST_UPDATE_MOVIMENTO_2  ) ;
  ExecuteDirect    ( _ALTER_PROCEDURE_EST_UPDATE_ESTOQUE_3    ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_CMP_PEDIDOS_AUD0_4        ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_CMP_PEDIDO_ITENS_AIUD0_5  ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_MOVIMENTO_AIUD0_6     ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_PRODUTOS_BIUD0_9      ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_PRODUTOS_AIU0_10      ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_VND_PEDIDO_ITENS_AIUD0_13 ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_MOVIMENTO_BIU0        ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_ENCERRAMENTO_MES_BIUD0 ) ;
  ExecuteDirect    ( _ALTER_TRIGGER_EST_OUTRAS_ENTRADAS_SAIDA_AIUD0 ) ;

  TryExecuteDirect ( _DROP_TRIGGER_JNL_EST_MOVIMENTO_7        ) ;
  TryExecuteDirect ( _DROP_TRIGGER_EST_MOVIMENTO_DOMAIN_8     ) ;
  TryExecuteDirect ( _DROP_KCAD_FAZENDA_EST_MOVIMENTO_14      ) ;

  TryExecuteDirect ( _DROP_TRIGGER_EST_PRODUTOS_DOMAIN_11     ) ;
  TryExecuteDirect ( _DROP_TRIGGER_JNL_EST_PRODUTOS_12        ) ;
  TryExecuteDirect ( _DROP_KCAD_FAZENDA_EST_PRODUTOS_15 ) ;
end;



procedure TDBFinanceiroUpdate._5_001_15 ;
const

 _CREATE_DOMAIN_CFOP =
        'CREATE DOMAIN FIN$CFOP AS'
 +#13#10'CHAR(4) CHARACTER SET ISO8859_1'
 +#13#10'COLLATE ISO8859_1' ;

 _ALTER_CMP_PEDIDO_ITENS =
         'ALTER TABLE CMP_PEDIDO_ITENS'
  +#13#10'ADD    QTDE_COMPRA        SYS$FLOAT_NN_0,'
  +#13#10'ADD    UNITARIO_COMPRA    SYS$FLOAT_NN_0,'
  +#13#10'ADD    UNIDADE_COMPRA     SYS$UNIDADE,'
  +#13#10'ADD    CFOP               FIN$CFOP,'
  +#13#10'ADD    ATUALIZAR_CUSTO    SYS$BOOL_T,'
  +#13#10'ALTER  QTDE_COMPRA        POSITION 12,'
  +#13#10'ALTER  UNITARIO_COMPRA    POSITION 13,'
  +#13#10'ALTER  UNIDADE_COMPRA     POSITION 14,'
  +#13#10'ALTER  CFOP               POSITION 15,'
  +#13#10'ALTER  ATUALIZAR_CUSTO    POSITION 16' ;

  _UPDATE_CMP_PEDIDO_ITENS =
         'UPDATE CMP_PEDIDO_ITENS'
  +#13#10'SET'
  +#13#10' QTDE_COMPRA      = QTDE,'
  +#13#10' UNITARIO_COMPRA  = VALOR_UNITARIO,'
  +#13#10' UNIDADE_COMPRA   = UNIDADE,'
  +#13#10' ATUALIZAR_CUSTO  = ''T''' ;


var
  EncerramentoMensal : TEncerramentoMensal ;
begin
  TryExecuteDirect ( _CREATE_DOMAIN_CFOP  ) ;


  EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );

  TryExecuteDirect ( _ALTER_CMP_PEDIDO_ITENS ) ;

  ExecuteDirect ( _UPDATE_CMP_PEDIDO_ITENS ) ;

  EncerramentoMensal.Free ;

end ;




procedure TDBFinanceiroUpdate._5_001_14 ;
begin
//
end;

procedure TDBFinanceiroUpdate._5_001_12 ;
const
 _CREATE_TABLE_EST_PRODUTO_FORNECEDORES =
        'CREATE TABLE EST_PRODUTO_FORNECEDORES ('
 +#13#10'   KEST_PRODUTO_FORNECEDOR SYS$PKGUID20,'
 +#13#10'   KEST_PRODUTO            SYS$FKGUID20_NN,'
 +#13#10'   KCAD_FORNECEDOR         SYS$FKGUID20_NN,'
 +#13#10'   CODIGO                  SYS$CODE,'
 +#13#10'   NOME                    SYS$DESCR_NN,'
 +#13#10'   ATIVO                   SYS$BOOL_T,'
 +#13#10'   SYS$UI                  SYS$USERLOGIN,'
 +#13#10'   SYS$DI                  SYS$DATE,'
 +#13#10'   SYS$UU                  SYS$USERLOGIN,'
 +#13#10'   SYS$DU                  SYS$DATE'
 +#13#10')' ;

 _ALTER_TABLE_EST_PRODUTO_FORNECEDORES =
        'ALTER TABLE EST_PRODUTO_FORNECEDORES'
 +#13#10'ADD CONSTRAINT PKEST_PRODUTO_FORNECEDORES'
 +#13#10'PRIMARY KEY (KEST_PRODUTO_FORNECEDOR)' ;

 _CREATE_DOMAIN_FINCHAVENFE =
        'CREATE DOMAIN FIN$CHAVENFE AS'
 +#13#10'VARCHAR(44) CHARACTER SET ISO8859_1'
 +#13#10'COLLATE ISO8859_1' ;

 _ALTER_TABLE_CMP_PEDIDOS_ADD_CHAVENFE =
        'ALTER TABLE CMP_PEDIDOS'
 +#13#10'ADD CHAVENFE FIN$CHAVENFE,'
 +#13#10'ALTER CHAVENFE POSITION 6' ;

begin
  TryExecuteDirect( _CREATE_TABLE_EST_PRODUTO_FORNECEDORES ) ;
  TryExecuteDirect( _ALTER_TABLE_EST_PRODUTO_FORNECEDORES  ) ;
  TryExecuteDirect( _CREATE_DOMAIN_FINCHAVENFE ) ;
  TryExecuteDirect( _ALTER_TABLE_CMP_PEDIDOS_ADD_CHAVENFE ) ;
end;

procedure TDBFinanceiroUpdate._5_001_10 ;
const
  _UPDATE_FIN_APAGAR =
       'UPDATE FIN_APAGAR A'
 +#13#10'   SET A.KCAD_ENTIDADE = (SELECT E.KCAD_ENTIDADE'
 +#13#10'FROM CAD_ENTIDADES E'
 +#13#10'WHERE E.NOME = A.NOMEENTIDADE'
 +#13#10'ROWS 1 )'
 +#13#10'WHERE A.KCAD_ENTIDADE IS NULL' ;

  _UPDATE_FIN_ARECEBER =
       'UPDATE FIN_ARECEBER A'
 +#13#10'   SET A.KCAD_ENTIDADE = (SELECT E.KCAD_ENTIDADE'
 +#13#10'FROM CAD_ENTIDADES E'
 +#13#10'WHERE E.NOME = A.NOMEENTIDADE'
 +#13#10'ROWS 1 )'
 +#13#10'WHERE A.KCAD_ENTIDADE IS NULL' ;

begin
   ExecuteDirect( _UPDATE_FIN_APAGAR ) ;
   ExecuteDirect( _UPDATE_FIN_ARECEBER ) ;
end;

procedure TDBFinanceiroUpdate._5_001_09 ;
const
  _CREATE_INDEX_IXFIN_APAGAR_02 =
    'CREATE INDEX IXFIN_APAGAR_02 ON FIN_APAGAR (KSYS$DOMAIN,DATALANCTO)' ;
  _CREATE_INDEX_IXFIN_ARECEBER_02 =
    'CREATE INDEX IXFIN_ARECEBER_02 ON FIN_ARECEBER (KSYS$DOMAIN,DATALANCTO)' ;
  _CREATE_INDEX_IXFIN_APAGAR_PARCELAS_01 =
    'CREATE INDEX IXFIN_APAGAR_PARCELAS_01 ON FIN_APAGAR_PARCELAS (VENCTO)' ;
  _CREATE_INDEX_IXFIN_ARECEBER_PARCELAS_01 =
    'CREATE INDEX IXFIN_ARECEBER_PARCELAS_01 ON FIN_ARECEBER_PARCELAS (VENCTO)' ;
begin
  TryExecuteDirect( _CREATE_INDEX_IXFIN_APAGAR_02 ) ;
  TryExecuteDirect( _CREATE_INDEX_IXFIN_ARECEBER_02 ) ;
  TryExecuteDirect( _CREATE_INDEX_IXFIN_APAGAR_PARCELAS_01 ) ;
  TryExecuteDirect( _CREATE_INDEX_IXFIN_ARECEBER_PARCELAS_01 ) ;
end;

procedure TDBFinanceiroUpdate._5_001_07 ;
const
  _CREATE_GLOBAL_TEMPORARY_TABLE_TMP_ENTIDADES =
         'CREATE GLOBAL TEMPORARY TABLE TMP$ENTIDADES ('
  +#13#10'    KCAD_ENTIDADE  SYS$PKGUID20 NOT NULL /* SYS$PKGUID20 = CHAR(20) NOT NULL */,'
  +#13#10'    CODIGO         SYS$CODE /* SYS$CODE = VARCHAR(32) */,'
  +#13#10'    APELIDO        SYS$DESCR_NN /* SYS$DESCR_NN = VARCHAR(128) NOT NULL */,'
  +#13#10'    NOME           SYS$DESCR_NN /* SYS$DESCR_NN = VARCHAR(128) NOT NULL */,'
  +#13#10'    SYS$UI         SYS$USERLOGIN /* SYS$USERLOGIN = VARCHAR(32) */,'
  +#13#10'    SYS$DI         SYS$DATE /* SYS$DATE = TIMESTAMP */,'
  +#13#10'    SYS$UU         SYS$USERLOGIN /* SYS$USERLOGIN = VARCHAR(32) */,'
  +#13#10'    SYS$DU         SYS$DATE /* SYS$DATE = TIMESTAMP */'
  +#13#10') ON COMMIT DELETE ROWS ;' ;

  _CREATE_PROCEDURE_SYS_INIT_ENTIDADES =
         'CREATE OR ALTER PROCEDURE SYS$INIT_ENTIDADES'
  +#13#10'AS'
  +#13#10'DECLARE SOURCE_KCAD_ENTIDADE  SYS$FKGUID20;'
  +#13#10'DECLARE SOURCE_CODIGO         SYS$CODE;'
  +#13#10'DECLARE SOURCE_NOME           SYS$DESCR;'
  +#13#10'DECLARE SOURCE_APELIDO        SYS$DESCR;'
  +#13#10'DECLARE SOURCE_SYS$UI         SYS$USERLOGIN;'
  +#13#10'DECLARE SOURCE_SYS$DI         SYS$DATE;'
  +#13#10'DECLARE SOURCE_SYS$UU         SYS$USERLOGIN;'
  +#13#10'DECLARE SOURCE_SYS$DU         SYS$DATE ;'
  +#13#10''
  +#13#10'DECLARE TARGET_KCAD_ENTIDADE  SYS$FKGUID20;'
  +#13#10'DECLARE TARGET_CODIGO         SYS$CODE;'
  +#13#10'DECLARE TARGET_NOME           SYS$DESCR;'
  +#13#10'DECLARE TARGET_APELIDO        SYS$DESCR;'
  +#13#10''
  +#13#10'DECLARE PATH VARCHAR( 256 );'
  +#13#10'DECLARE RLOG$OFF VARCHAR( 1 ) ;'
  +#13#10''
  +#13#10'DECLARE RC_SOURCE INTEGER ;'
  +#13#10'DECLARE RC_TARGET INTEGER ;'
  +#13#10''
  +#13#10'DECLARE SOURCE CURSOR'
  +#13#10'   FOR ( SELECT KCAD_ENTIDADE, CODIGO, NOME, APELIDO /*, SYS$UI, SYS$DI, SYS$UU, SYS$DU */'
  +#13#10'         FROM TMP$ENTIDADES'
  +#13#10'         ORDER BY KCAD_ENTIDADE );'
  +#13#10'DECLARE TARGET CURSOR'
  +#13#10'   FOR ( SELECT KCAD_ENTIDADE, CODIGO, NOME, APELIDO'
  +#13#10'         FROM CAD_ENTIDADES'
  +#13#10'         ORDER BY KCAD_ENTIDADE );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  PATH = SU$CHANGEFILEEXT ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ), ''.ENT'' ) ;'
  +#13#10''
  +#13#10'  if ( SU$FILEEXISTS( PATH ) IS DISTINCT FROM 1 ) then'
  +#13#10'    exit ;'
  +#13#10''
  +#13#10'  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
  +#13#10''
  +#13#10'  FOR EXECUTE STATEMENT ('
  +#13#10'       ''SELECT'''
  +#13#10'    || '' KCAD_ENTIDADE, CODIGO, NOME, APELIDO, SYS$UI, SYS$DI, SYS$UU, SYS$DU'''
  +#13#10'    || '' FROM CAD_ENTIDADES'''
  +#13#10'    ) ON EXTERNAL DATA SOURCE PATH'
  +#13#10'    WITH COMMON TRANSACTION'
  +#13#10'    INTO SOURCE_KCAD_ENTIDADE, SOURCE_CODIGO, SOURCE_NOME, SOURCE_APELIDO, SOURCE_SYS$UI, SOURCE_SYS$DI, SOURCE_SYS$UU, SOURCE_SYS$DU'
  +#13#10'  DO'
  +#13#10'     INSERT INTO TMP$ENTIDADES ( KCAD_ENTIDADE, CODIGO, NOME, APELIDO, SYS$UI, SYS$DI, SYS$UU, SYS$DU)'
  +#13#10'     VALUES ( :SOURCE_KCAD_ENTIDADE, :SOURCE_CODIGO, :SOURCE_NOME, :SOURCE_APELIDO, :SOURCE_SYS$UI, :SOURCE_SYS$DI, :SOURCE_SYS$UU, :SOURCE_SYS$DU ) ;'
  +#13#10''
  +#13#10'  OPEN SOURCE ;'
  +#13#10'  FETCH SOURCE'
  +#13#10'  INTO SOURCE_KCAD_ENTIDADE, SOURCE_CODIGO, SOURCE_NOME, SOURCE_APELIDO /*, SOURCE_SYS$UI, SOURCE_SYS$DI, SOURCE_SYS$UU, SOURCE_SYS$DU*/ ;'
  +#13#10'  RC_SOURCE = ROW_COUNT ;'
  +#13#10''
  +#13#10'  OPEN TARGET ;'
  +#13#10'  FETCH TARGET'
  +#13#10'  INTO TARGET_KCAD_ENTIDADE, TARGET_CODIGO, TARGET_NOME, TARGET_APELIDO ;'
  +#13#10'  RC_TARGET = ROW_COUNT ;'
  +#13#10''
  +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
  +#13#10'        LEAVE ;'
  +#13#10''
  +#13#10'       IF ( SOURCE_KCAD_ENTIDADE = TARGET_KCAD_ENTIDADE ) THEN'
  +#13#10'        BEGIN'
  +#13#10''
  +#13#10'          --update target'
  +#13#10'          if ( ( TARGET_CODIGO    IS DISTINCT FROM SOURCE_CODIGO   )'
  +#13#10'            OR ( TARGET_NOME      IS DISTINCT FROM SOURCE_NOME     )'
  +#13#10'            OR ( TARGET_APELIDO  IS DISTINCT FROM SOURCE_APELIDO   )  ) then'
  +#13#10'              UPDATE CAD_ENTIDADES'
  +#13#10'                SET'
  +#13#10'                  CODIGO    = :SOURCE_CODIGO'
  +#13#10'                 , NOME      = :SOURCE_NOME'
  +#13#10'                 , APELIDO   = :SOURCE_APELIDO'
  +#13#10'              -- , SYS$UI    = :SOURCE_SYS$UI'
  +#13#10'              -- , SYS$DI    = :SOURCE_SYS$DI'
  +#13#10'              -- , SYS$UU    = :SOURCE_SYS$UU'
  +#13#10'              -- , SYS$DU    = :SOURCE_SYS$DU'
  +#13#10'              WHERE CURRENT OF TARGET ;'
  +#13#10'          -- next source'
  +#13#10'          FETCH SOURCE INTO SOURCE_KCAD_ENTIDADE, SOURCE_CODIGO, SOURCE_NOME, SOURCE_APELIDO /*, SOURCE_SYS$UI, SOURCE_SYS$DI, SOURCE_SYS$UU, SOURCE_SYS$DU */ ;'
  +#13#10'          RC_SOURCE = ROW_COUNT ;'
  +#13#10'          -- next target'
  +#13#10'          FETCH TARGET INTO TARGET_KCAD_ENTIDADE, TARGET_CODIGO, TARGET_NOME, TARGET_APELIDO ;'
  +#13#10'          RC_TARGET = ROW_COUNT ;'
  +#13#10'        END'
  +#13#10'       ELSE IF ( SOURCE_KCAD_ENTIDADE > TARGET_KCAD_ENTIDADE ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          -- delete target'
  +#13#10'          DELETE FROM CAD_ENTIDADES WHERE CURRENT OF TARGET ;'
  +#13#10'          -- next target'
  +#13#10'          FETCH TARGET INTO TARGET_KCAD_ENTIDADE, TARGET_CODIGO, TARGET_NOME, TARGET_APELIDO ;'
  +#13#10'          RC_TARGET = ROW_COUNT ;'
  +#13#10'        END'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            -- insert into target'
  +#13#10'            INSERT INTO CAD_ENTIDADES'
  +#13#10'             ( KCAD_ENTIDADE, CODIGO, NOME, APELIDO /*, SYS$UI, SYS$DI, SYS$UU, SYS$DU */ )'
  +#13#10'            VALUES'
  +#13#10'            ( :SOURCE_KCAD_ENTIDADE, :SOURCE_CODIGO, :SOURCE_NOME, :SOURCE_APELIDO /*, :SOURCE_SYS$UI, :SOURCE_SYS$DI, :SOURCE_SYS$UU, :SOURCE_SYS$DU */ ) ;'
  +#13#10'            -- next source'
  +#13#10'            FETCH SOURCE INTO SOURCE_KCAD_ENTIDADE, SOURCE_CODIGO, SOURCE_NOME, SOURCE_APELIDO /* , SOURCE_SYS$UI, SOURCE_SYS$DI, SOURCE_SYS$UU, SOURCE_SYS$DU*/ ;'
  +#13#10'            RC_SOURCE = ROW_COUNT ;'
  +#13#10'          END'
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'      -- insert target'
  +#13#10'      INSERT INTO CAD_ENTIDADES'
  +#13#10'        ( KCAD_ENTIDADE, CODIGO, NOME, APELIDO /*, SYS$UI, SYS$DI, SYS$UU, SYS$DU */ )'
  +#13#10'      VALUES'
  +#13#10'        ( :SOURCE_KCAD_ENTIDADE, :SOURCE_CODIGO, :SOURCE_NOME, :SOURCE_APELIDO /*, :SOURCE_SYS$UI, :SOURCE_SYS$DI, :SOURCE_SYS$UU, :SOURCE_SYS$DU */ ) ;'
  +#13#10'      -- next source'
  +#13#10'      FETCH SOURCE INTO SOURCE_KCAD_ENTIDADE, SOURCE_CODIGO, SOURCE_NOME, SOURCE_APELIDO /*, SOURCE_SYS$UI, SOURCE_SYS$DI, SOURCE_SYS$UU, SOURCE_SYS$DU */ ;'
  +#13#10'      RC_SOURCE = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'       -- delete target'
  +#13#10'       DELETE FROM CAD_ENTIDADES WHERE CURRENT OF TARGET ;'
  +#13#10'       -- next target'
  +#13#10'       FETCH TARGET INTO TARGET_KCAD_ENTIDADE, TARGET_CODIGO, TARGET_NOME, TARGET_APELIDO ;'
  +#13#10'       RC_TARGET = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
  +#13#10''
  +#13#10'END' ;

  _EXECUTE_PROCEDURE_SYS_INIT_ENTIDADES =
     'EXECUTE PROCEDURE SYS$INIT_ENTIDADES' ;

begin
  TryExecuteDirect ( _CREATE_GLOBAL_TEMPORARY_TABLE_TMP_ENTIDADES ) ;
  ExecuteDirect    ( _CREATE_PROCEDURE_SYS_INIT_ENTIDADES ) ;
  ExecuteDirect    ( _EXECUTE_PROCEDURE_SYS_INIT_ENTIDADES  ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_05 ;
const
  _CREATE_PROCEDURE_EST_CLEAR_ENCERRAMENTO_MES =
         'CREATE OR ALTER PROCEDURE EST_CLEAR_ENCERRAMENTO_MES('
  +#13#10'    KSYS$DOMAIN SYS$FKGUID20 )'
  +#13#10'AS'
  +#13#10'DECLARE DATA SYS$DATE ;'
  +#13#10'DECLARE MIN_DATA SYS$DATE ;'
  +#13#10'DECLARE ANO_MES SYS$ANO_MES ;'
  +#13#10'BEGIN'
  +#13#10'  IF ( EXISTS ( SELECT 1'
  +#13#10'                FROM EST_ENCERRAMENTO_MES'
  +#13#10'                WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'                  AND ENCERRADO = ''T'''
  +#13#10'                ROWS 1'
  +#13#10'              ) ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  SELECT DATA_SALDOINICIAL FROM EST_PRODUTOS ORDER BY 1 ROWS 1 INTO DATA ;'
  +#13#10'  IF ( (MIN_DATA IS NULL) or (( DATA IS NOT NULL ) AND (DATA < MIN_DATA)) ) THEN'
  +#13#10'     MIN_DATA = DATA ;'
  +#13#10''
  +#13#10'  SELECT DATA_EMISSAO      FROM CMP_PEDIDOS  ORDER BY 1 ROWS 1 INTO DATA ;'
  +#13#10'  IF ( (MIN_DATA IS NULL) or (( DATA IS NOT NULL ) AND (DATA < MIN_DATA)) ) THEN'
  +#13#10'     MIN_DATA = DATA ;'
  +#13#10''
  +#13#10'  SELECT DATA_ENTRADA      FROM CMP_PEDIDOS  ORDER BY 1 ROWS 1 INTO DATA ;'
  +#13#10'  IF ( (MIN_DATA IS NULL) or (( DATA IS NOT NULL ) AND (DATA < MIN_DATA)) ) THEN'
  +#13#10'     MIN_DATA = DATA ;'
  +#13#10''
  +#13#10'  SELECT DATA_EMISSAO      FROM VND_PEDIDOS  ORDER BY 1 ROWS 1 INTO DATA ;'
  +#13#10'  IF ( (MIN_DATA IS NULL) or (( DATA IS NOT NULL ) AND (DATA < MIN_DATA)) ) THEN'
  +#13#10'     MIN_DATA = DATA ;'
  +#13#10''
  +#13#10'  IF ( MIN_DATA IS NULL ) THEN'
  +#13#10'    DELETE FROM EST_ENCERRAMENTO_MES'
  +#13#10'    WHERE KSYS$DOMAIN = :KSYS$DOMAIN ;'
  +#13#10'  ELSE'
  +#13#10'    BEGIN'
  +#13#10'       ANO_MES =  Right ( ''0000'' || EXTRACT ( YEAR  FROM MIN_DATA ), 4 )'
  +#13#10'               || Right ( ''00''   || EXTRACT ( MONTH FROM MIN_DATA ), 2 ) ;'
  +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES'
  +#13#10'       WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'        AND ANO_MES < :ANO_MES ;'
  +#13#10'    END'
  +#13#10'END' ;

begin
  ExecuteDirect ( _CREATE_PROCEDURE_EST_CLEAR_ENCERRAMENTO_MES ) ;
end  ;

procedure TDBFinanceiroUpdate._5_001_04 ;
const
  _CREATE_TRIGGER_FIN_TRANSFERENCIAS_AIUD0 =
         'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AIUD0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_INSERT_CREDITODEBITO'
  +#13#10'       NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
  +#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
  +#13#10'  ELSE IF (UPDATING) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_UPDATE_CREDITODEBITO'
  +#13#10'       OLD.KFIN_TRANSFERENCIA, NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
  +#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
  +#13#10'  ELSE'
  +#13#10'    EXECUTE PROCEDURE FIN_DELETE_CREDITODEBITO OLD.KFIN_TRANSFERENCIA ;'
  +#13#10'END' ;
begin
  TryExecuteDirect ( _CREATE_TRIGGER_FIN_TRANSFERENCIAS_AIUD0 ) ;
end ;

procedure TDBFinanceiroUpdate._5_001_03 ;
const
   _CREATE_CMP_PEDIDOS_AUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
  +#13#10'DECLARE QTDE              SYS$FLOAT ;'
  +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
  +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
  +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
  +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
  +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
  +#13#10'        EXIT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR ;'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR_TRANSPORTE ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE'
  +#13#10'  FROM CMP_PEDIDO_ITENS I'
  +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
  +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
  +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
  +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
  +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'     IF ( DELETING ) THEN'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
  +#13#10'     IF (     ( KEST_PRODUTO IS NOT NULL )'
  +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
  +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
  +#13#10'       ) THEN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (   IIF ( DELETING, ''D'', ''U'' ),'
  +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
  +#13#10'                                                 KEST_PRODUTO,'
  +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
  +#13#10'                                                 ''E'','
  +#13#10'                                                 QTDE,'
  +#13#10'                                                 CUSTO,'
  +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                 KCMP_PEDIDO_ITEM'
  +#13#10'                                                 );'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     FOR SELECT'
  +#13#10'       S.KCMP_PEDIDO_SERVICO'
  +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
  +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
  +#13#10'     INTO KCMP_PEDIDO_SERVICO'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
  +#13#10''
  +#13#10'END' ;

begin
  ExecuteDirect ( _CREATE_CMP_PEDIDOS_AUD0 ) ;
end ;


procedure TDBFinanceiroUpdate._5_001_02 ;
const
   _UPDATE_FIN_CENTROSCUSTO =
        'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20 ;'
  +#13#10'DECLARE CODIGO INTEGER ;'
  +#13#10'BEGIN'
  +#13#10'  CODIGO = 0 ;'
  +#13#10'  FOR'
  +#13#10'   SELECT'
  +#13#10'        KFIN_CENTROCUSTO'
  +#13#10'   FROM FIN_CENTROSCUSTO'
  +#13#10'   ORDER BY SYS$DI'
  +#13#10'  INTO KFIN_CENTROCUSTO DO'
  +#13#10'    BEGIN'
  +#13#10'       CODIGO = CODIGO + 1 ;'
  +#13#10'       UPDATE FIN_CENTROSCUSTO'
  +#13#10'       SET'
  +#13#10'          CODIGO = :CODIGO'
  +#13#10'       WHERE KFIN_CENTROCUSTO = :KFIN_CENTROCUSTO ;'
  +#13#10'    END'
  +#13#10'  EXECUTE STATEMENT ''ALTER SEQUENCE CODIGO_CENTROS_CUSTO RESTART WITH '' || CODIGO ;'
  +#13#10'END' ;

begin
   ExecuteDirect ( _UPDATE_FIN_CENTROSCUSTO  ) ;
end;

procedure TDBFinanceiroUpdate._5_001_01 ;
const
   _UPDATE_FIN_APAGAR =
         'UPDATE FIN_APAGAR A'
  +#13#10' SET'
  +#13#10'    A.KCAD_ENTIDADE = (SELECT C.KCAD_ENTIDADE FROM CMP_PEDIDOS C WHERE C.KCMP_PEDIDO = A.TABLEKEY ),'
  +#13#10'    A.NOMEENTIDADE  = (SELECT C.NOMEENTIDADE  FROM CMP_PEDIDOS C WHERE C.KCMP_PEDIDO = A.TABLEKEY )'
  +#13#10'WHERE ( TABLENAME = ''CMP_PEDIDOS'' )' ;

   _UPDATE_FIN_ARECEBER =
         'UPDATE FIN_ARECEBER A'
  +#13#10' SET'
  +#13#10'    A.KCAD_ENTIDADE = (SELECT C.KCAD_ENTIDADE FROM VND_PEDIDOS C WHERE C.KVND_PEDIDO = A.TABLEKEY ),'
  +#13#10'    A.NOMEENTIDADE  = (SELECT C.NOMEENTIDADE  FROM VND_PEDIDOS C WHERE C.KVND_PEDIDO = A.TABLEKEY )'
  +#13#10'WHERE ( TABLENAME = ''VND_PEDIDOS'' )' ;


    _CREATE_TRIGGER_CMP_PEDIDOS_AUD0 =
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
  +#13#10'DECLARE QTDE              SYS$FLOAT ;'
  +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
  +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
  +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
  +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
  +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_APAGAR'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_APAGAR = NEW.KFIN_APAGAR )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
  +#13#10'        EXIT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'     DELETE FROM FIN_APAGAR WHERE KFIN_APAGAR = OLD.KFIN_APAGAR ;'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE'
  +#13#10'  FROM CMP_PEDIDO_ITENS I'
  +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
  +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
  +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
  +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
  +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'     IF ( DELETING ) THEN'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
  +#13#10'     IF (     ( KEST_PRODUTO IS NOT NULL )'
  +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
  +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
  +#13#10'       ) THEN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (   IIF ( DELETING, ''D'', ''U'' ),'
  +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
  +#13#10'                                                 KEST_PRODUTO,'
  +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
  +#13#10'                                                 ''E'','
  +#13#10'                                                 QTDE,'
  +#13#10'                                                 CUSTO,'
  +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                 KCMP_PEDIDO_ITEM'
  +#13#10'                                                 );'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     FOR SELECT'
  +#13#10'       S.KCMP_PEDIDO_SERVICO'
  +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
  +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
  +#13#10'     INTO KCMP_PEDIDO_SERVICO'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
  +#13#10''
  +#13#10'END' ;

    _CREATE_TRIGGER_VND_PEDIDOS_AUD0 =
         'CREATE OR ALTER TRIGGER VND_PEDIDOS_AUD0 FOR VND_PEDIDOS'
  +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
  +#13#10'DECLARE QTDE              SYS$FLOAT ;'
  +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
  +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
  +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
  +#13#10'DECLARE KVND_PEDIDO_ITEM  SYS$PKGUID20 ;'
  +#13#10'DECLARE KVND_PEDIDO_SERVICO SYS$PKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE FIN_ARECEBER'
  +#13#10'       SET'
  +#13#10'          KCAD_ENTIDADE = NEW.KCAD_ENTIDADE,'
  +#13#10'          NOMEENTIDADE  = NEW.NOMEENTIDADE'
  +#13#10'      WHERE ( KFIN_ARECEBER = NEW.KFIN_ARECEBER )'
  +#13#10'        AND (    KCAD_ENTIDADE IS DISTINCT FROM NEW.KCAD_ENTIDADE'
  +#13#10'              OR NOMEENTIDADE  IS DISTINCT FROM NEW.NOMEENTIDADE'
  +#13#10'            ) ;'
  +#13#10''
  +#13#10'      if (    ( NEW.DATA_VENDA   IS NOT DISTINCT FROM OLD.DATA_VENDA   )'
  +#13#10'          AND ( NEW.DATA_EMISSAO IS NOT DISTINCT FROM OLD.DATA_EMISSAO ) ) THEN'
  +#13#10'         EXIT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'     DELETE FROM FIN_ARECEBER WHERE KFIN_ARECEBER = OLD.KFIN_ARECEBER ;'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'     I.KVND_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE'
  +#13#10'   FROM VND_PEDIDO_ITENS I'
  +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
  +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
  +#13#10'  WHERE I.KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
  +#13#10'    AND IS_PATRIMONIO   IS DISTINCT FROM ''T'''
  +#13#10'    AND P.BAIXA_ESTOQUE = ''T'''
  +#13#10'  INTO KVND_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10'     IF ( DELETING ) THEN'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_ITENS'', KVND_PEDIDO_ITEM ;'
  +#13#10''
  +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
  +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
  +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
  +#13#10'       ) THEN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( IIF ( DELETING, ''D'', ''U'' ),'
  +#13#10'                                                IIF ( DELETING, OLD.KCAD_FAZENDA, NEW.KCAD_FAZENDA ),'
  +#13#10'                                                KEST_PRODUTO,'
  +#13#10'                                                IIF ( DELETING, OLD.DATA_EMISSAO, NEW.DATA_EMISSAO ),'
  +#13#10'                                                ''S'','
  +#13#10'                                                QTDE,'
  +#13#10'                                                CUSTO,'
  +#13#10'                                                ''VND_PEDIDO_ITENS'','
  +#13#10'                                                KVND_PEDIDO_ITEM'
  +#13#10'                                               );'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     FOR SELECT'
  +#13#10'       S.KVND_PEDIDO_SERVICO'
  +#13#10'     FROM VND_PEDIDO_SERVICOS S'
  +#13#10'     WHERE S.KVND_PEDIDO = OLD.KVND_PEDIDO'
  +#13#10'     INTO KVND_PEDIDO_SERVICO'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_SERVICOS'', KVND_PEDIDO_SERVICO ;'
  +#13#10''
  +#13#10''
  +#13#10'END' ;

begin
  ExecuteDirect( _CREATE_TRIGGER_CMP_PEDIDOS_AUD0 ) ;
  ExecuteDirect( _CREATE_TRIGGER_VND_PEDIDOS_AUD0 ) ;
  ExecuteDirect( _UPDATE_FIN_APAGAR ) ;
  ExecuteDirect( _UPDATE_FIN_ARECEBER ) ;
end ;

procedure TDBFinanceiroUpdate._5_000_98 ;
const
    _CREATE_INDEX_IXECRM_IUD_02 =
     'CREATE INDEX IXECRM$IUD_02 ON ECRM$IUD (TABLENAME, SYS$DU)' ;
begin
  TryExecuteDirect( _CREATE_INDEX_IXECRM_IUD_02 )
end;

procedure TDBFinanceiroUpdate._5_000_97 ;
const
    ALTER_TABLE_FIN_APAGAR_PARCELAS =
         'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'ALTER KFIN_PLANO_CONTA_JURO_DESCONTO TO KFIN_PLANOCONTA_JURO_DESCONTO' ;

    ALTER_TABLE_FIN_ARECEBER_PARCELAS =
         'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'ALTER KFIN_PLANO_CONTA_JURO_DESCONTO TO KFIN_PLANOCONTA_JURO_DESCONTO' ;

  ADD_FK_FIN_APAGAR_PARCELAS_03 =
         'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'ADD CONSTRAINT FKFIN_APAGAR_PARCELAS_03'
  +#13#10'FOREIGN KEY (KFIN_PLANOCONTA_JURO_DESCONTO)'
  +#13#10'REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA)'
  +#13#10'ON UPDATE CASCADE' ;

  ADD_FK_FIN_ARECEBER_PARCELAS_03 =
         'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'ADD CONSTRAINT FKFIN_ARECEBER_PARCELAS_03'
  +#13#10'FOREIGN KEY (KFIN_PLANOCONTA_JURO_DESCONTO)'
  +#13#10'REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA)'
  +#13#10'ON UPDATE CASCADE' ;

begin
  TryExecuteDirect( ALTER_TABLE_FIN_APAGAR_PARCELAS ) ;
  TryExecuteDirect( ALTER_TABLE_FIN_ARECEBER_PARCELAS ) ;
  TryExecuteDirect( ADD_FK_FIN_APAGAR_PARCELAS_03 ) ;
  TryExecuteDirect( ADD_FK_FIN_ARECEBER_PARCELAS_03 ) ;
end;

procedure TDBFinanceiroUpdate._5_000_96 ;
const
    ALTER_TABLE_FIN_APAGAR_PARCELAS =
          'ALTER TABLE FIN_APAGAR_PARCELAS'
  +#13#10'ADD JURO_DESCONTO  SYS$FLOAT,'
  +#13#10'ADD KFIN_PLANO_CONTA_JURO_DESCONTO SYS$FKGUID20,'
  +#13#10'ALTER JURO_DESCONTO  POSITION 12,'
  +#13#10'ALTER KFIN_PLANO_CONTA_JURO_DESCONTO POSITION 13' ;

    ALTER_TABLE_FIN_ARECEBER_PARCELAS =
          'ALTER TABLE FIN_ARECEBER_PARCELAS'
  +#13#10'ADD JURO_DESCONTO  SYS$FLOAT,'
  +#13#10'ADD KFIN_PLANO_CONTA_JURO_DESCONTO SYS$FKGUID20,'
  +#13#10'ALTER JURO_DESCONTO  POSITION 12,'
  +#13#10'ALTER KFIN_PLANO_CONTA_JURO_DESCONTO POSITION 13' ;

begin
    TryExecuteDirect ( ALTER_TABLE_FIN_APAGAR_PARCELAS ) ;
    TryExecuteDirect ( ALTER_TABLE_FIN_ARECEBER_PARCELAS ) ;
end;

procedure TDBFinanceiroUpdate._5_000_95 ;
const

  ALTER_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_PARCELAS_AIUD0 FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (( INSERTING ) AND ( NEW.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' ) ;'
  +#13#10'  ELSE IF (    (UPDATING)'
  +#13#10'      AND (   ( NEW.DT_COMPENSACAO IS DISTINCT FROM OLD.DT_COMPENSACAO )'
  +#13#10'           OR ( NEW.KFIN_CONTA     IS DISTINCT FROM OLD.KFIN_CONTA )'
  +#13#10'           OR ( NEW.PAGO           IS DISTINCT FROM OLD.PAGO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( OLD.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10'      IF ( NEW.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' );'
  +#13#10'    END'
  +#13#10'  ELSE IF (( DELETING ) AND ( OLD.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10''
  +#13#10'END' ;

  DROP_PROCEDURE_FIN_APAGAR_INSERT_JUROS =
         'DROP PROCEDURE FIN_APAGAR_INSERT_JUROS ;' ;

  DROP_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS =
         'DROP PROCEDURE FIN_APAGAR_INSERT_DESCONTOS ;' ;

  DROP_PROCEDURE_FIN_APAGAR_DELETE_JUROS =
         'DROP PROCEDURE FIN_APAGAR_DELETE_JUROS ;' ;

  DROP_PROCEDURE_FIN_APAGAR_DELETE_DESCONTOS =
         'DROP PROCEDURE FIN_APAGAR_DELETE_DESCONTOS ;' ;


begin
  ExecuteDirect ( ALTER_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 ) ;

  TryExecuteDirect ( DROP_PROCEDURE_FIN_APAGAR_INSERT_JUROS ) ;
  TryExecuteDirect ( DROP_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS ) ;
  TryExecuteDirect ( DROP_PROCEDURE_FIN_APAGAR_DELETE_JUROS ) ;
  TryExecuteDirect ( DROP_PROCEDURE_FIN_APAGAR_DELETE_DESCONTOS ) ;
end ;

procedure TDBFinanceiroUpdate._5_000_94 ;
const


  CREATE_PROCEDURE_FIN_APAGAR_INSERT_JUROS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_INSERT_JUROS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20,'
  +#13#10'    KFIN_CONTA  SYS$FKGUID20_NN,'
  +#13#10'    DOCUMENTO   FIN$DOC,'
  +#13#10'    DATA        SYS$DATE,'
  +#13#10'    VALOR       SYS$FLOAT,'
  +#13#10'    OBS         SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20_NN ;'
  +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_APAGAR_NEW SYS$FKGUID20 ;'
  +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
  +#13#10'DECLARE KDEF_PLANOCONTA SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20 = NULL;'
  +#13#10'DECLARE HISTORICO SYS$DESCR ;'
  +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20;'
  +#13#10'DECLARE PORCENTAGEM SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'     KFIN_APAGAR'
  +#13#10'  FROM'
  +#13#10'     FIN_APAGAR_PARCELAS'
  +#13#10'  WHERE'
  +#13#10'     KFIN_APAGAR_PARCELA = :KFIN_APAGAR_PARCELA'
  +#13#10'  INTO'
  +#13#10'     :KFIN_APAGAR ;'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'    KSYS$DOMAIN,  HISTORICO,  KCAD_ENTIDADE,  DOCUMENTO'
  +#13#10'  FROM'
  +#13#10'    FIN_APAGAR'
  +#13#10'  WHERE'
  +#13#10'    KFIN_APAGAR = :KFIN_APAGAR'
  +#13#10'  INTO'
  +#13#10'    :KSYS$DOMAIN, :HISTORICO, :KCAD_ENTIDADE, :DOCUMENTO ;'
  +#13#10''
  +#13#10' EXECUTE PROCEDURE SYS$TYPES_GETVALUE ''DEF_PLANOCONTAS'', ''JUROS'' RETURNING_VALUES KDEF_PLANOCONTA ;'
  +#13#10''
  +#13#10' SELECT'
  +#13#10'   KFIN_PLANOCONTA'
  +#13#10' FROM'
  +#13#10'   FIN_PLANOCONTAS'
  +#13#10' WHERE'
  +#13#10'   KDEF_PLANOCONTA = :KDEF_PLANOCONTA'
  +#13#10' INTO'
  +#13#10'   KFIN_PLANOCONTA ;'
  +#13#10''
  +#13#10'  KFIN_APAGAR_NEW = GUID20();'
  +#13#10''
  +#13#10'  INSERT INTO FIN_APAGAR'
  +#13#10'    ( KFIN_APAGAR, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DATALANCTO, VALOR, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :KFIN_APAGAR_NEW, :KSYS$DOMAIN, :KSYS$DOMAIN, ''JUROS: '' || :HISTORICO, :KCAD_ENTIDADE, :DATA, :VALOR, ''J-'' || COALESCE(:DOCUMENTO,''''), :KFIN_PLANOCONTA, ''FIN_APAGAR_PARCELAS'', :KFIN_APAGAR_PARCELA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_APAGAR_PARCELAS'
  +#13#10'    ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :KFIN_APAGAR_NEW, ''J-'' || COALESCE(:DOCUMENTO,''''), :DATA, :VALOR, :DATA, NULL, :VALOR, :KFIN_CONTA );'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'   SELECT KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'   FROM FIN_APROPRIACAO'
  +#13#10'   WHERE TABLENAME = ''FIN_APAGAR'' AND TABLEKEY = :KFIN_APAGAR'
  +#13#10'   INTO KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'  DO'
  +#13#10'    INSERT INTO FIN_APROPRIACAO'
  +#13#10'      ( KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), ''FIN_APAGAR'', :KFIN_APAGAR_NEW, :KFIN_CENTROCUSTO, :PORCENTAGEM ) ;'
  +#13#10''
  +#13#10'END' ;

  CREATE_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_INSERT_DESCONTOS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20,'
  +#13#10'    KFIN_CONTA SYS$FKGUID20_NN,'
  +#13#10'    DOCUMENTO  FIN$DOC,'
  +#13#10'    DATA       SYS$DATE,'
  +#13#10'    VALOR      SYS$FLOAT,'
  +#13#10'    OBS        SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20_NN ;'
  +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_ARECEBER_NEW SYS$FKGUID20;'
  +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
  +#13#10'DECLARE KDEF_PLANOCONTA SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20 = NULL;'
  +#13#10'DECLARE HISTORICO SYS$DESCR ;'
  +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20;'
  +#13#10'DECLARE PORCENTAGEM SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'     KFIN_APAGAR'
  +#13#10'  FROM'
  +#13#10'     FIN_APAGAR_PARCELAS'
  +#13#10'  WHERE'
  +#13#10'     KFIN_APAGAR_PARCELA = :KFIN_APAGAR_PARCELA'
  +#13#10'  INTO'
  +#13#10'     :KFIN_APAGAR ;'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'    KSYS$DOMAIN,  HISTORICO,  KCAD_ENTIDADE,  DOCUMENTO'
  +#13#10'  FROM'
  +#13#10'    FIN_APAGAR'
  +#13#10'  WHERE'
  +#13#10'    KFIN_APAGAR = :KFIN_APAGAR'
  +#13#10'  INTO'
  +#13#10'    :KSYS$DOMAIN, :HISTORICO, :KCAD_ENTIDADE, :DOCUMENTO ;'
  +#13#10''
  +#13#10' EXECUTE PROCEDURE SYS$TYPES_GETVALUE ''DEF_PLANOCONTAS'', ''DESCONTOS'' RETURNING_VALUES KDEF_PLANOCONTA ;'
  +#13#10''
  +#13#10' SELECT'
  +#13#10'   KFIN_PLANOCONTA'
  +#13#10' FROM'
  +#13#10'   FIN_PLANOCONTAS'
  +#13#10' WHERE'
  +#13#10'   KDEF_PLANOCONTA = :KDEF_PLANOCONTA'
  +#13#10' INTO'
  +#13#10'   KFIN_PLANOCONTA ;'
  +#13#10''
  +#13#10'  KFIN_ARECEBER_NEW = GUID20();'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER'
  +#13#10'    ( KFIN_ARECEBER, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DATALANCTO, VALOR, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :KFIN_ARECEBER_NEW, :KSYS$DOMAIN, :KSYS$DOMAIN, ''DESCONTOS: '' || :HISTORICO, :KCAD_ENTIDADE, :DATA, :VALOR, ''D+'' || COALESCE(:DOCUMENTO,''''), :KFIN_PLANOCONTA, ''FIN_APAGAR_PARCELAS'', :KFIN_APAGAR_PARCELA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER_PARCELAS'
  +#13#10'    ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :KFIN_ARECEBER_NEW, ''D+'' || COALESCE(:DOCUMENTO,''''), :DATA, :VALOR, :DATA, NULL, :VALOR, :KFIN_CONTA );'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'   SELECT KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'   FROM FIN_APROPRIACAO'
  +#13#10'   WHERE TABLENAME = ''FIN_APAGAR'' AND TABLEKEY = :KFIN_APAGAR'
  +#13#10'   INTO KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'  DO'
  +#13#10'    INSERT INTO FIN_APROPRIACAO'
  +#13#10'      ( KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), ''FIN_ARECEBER'', :KFIN_ARECEBER_NEW, :KFIN_CENTROCUSTO, :PORCENTAGEM ) ;'
  +#13#10''
  +#13#10'END' ;


  CREATE_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_PARCELAS_AIUD0 FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE DIFFPAGO_INS SYS$FLOAT ;'
  +#13#10'DECLARE DIFFPAGO_DEL SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (( INSERTING ) AND ( NEW.PAGTO IS NOT NULL )) THEN'
  +#13#10'    DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'  ELSE IF (    (UPDATING)'
  +#13#10'      AND (   ( NEW.PAGTO IS DISTINCT FROM OLD.PAGTO )'
  +#13#10'           OR ( NEW.KFIN_CONTA     IS DISTINCT FROM OLD.KFIN_CONTA )'
  +#13#10'           OR ( NEW.PAGO           IS DISTINCT FROM OLD.PAGO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF (( OLD.PAGTO IS NOT NULL ) AND (NEW.PAGTO IS NULL) ) THEN'
  +#13#10'        DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10'      ELSE IF (( NEW.PAGTO IS NOT NULL ) AND (OLD.PAGTO IS NULL) ) THEN'
  +#13#10'        DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'      ELSE IF ( NEW.PAGTO IS NOT NULL ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10'          DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'        END'
  +#13#10'    END'
  +#13#10'  ELSE IF (( DELETING ) AND ( OLD.PAGTO IS NOT NULL )) THEN'
  +#13#10'    DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10''
  +#13#10'  IF ( DIFFPAGO_DEL > 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_DELETE_JUROS OLD.KFIN_APAGAR_PARCELA ;'
  +#13#10'  ELSE IF ( DIFFPAGO_DEL < 0 ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_APAGAR_DELETE_DESCONTOS OLD.KFIN_APAGAR_PARCELA ;'
  +#13#10''
  +#13#10'  IF ( DIFFPAGO_INS > 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_INSERT_JUROS'
  +#13#10'      NEW.KFIN_APAGAR_PARCELA, NEW.KFIN_CONTA, NEW.DOCUMENTO, NEW.PAGTO, DIFFPAGO_INS, NEW.OBS ;'
  +#13#10'  ELSE IF ( DIFFPAGO_INS < 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_INSERT_DESCONTOS'
  +#13#10'      NEW.KFIN_APAGAR_PARCELA, NEW.KFIN_CONTA, NEW.DOCUMENTO, NEW.PAGTO, -DIFFPAGO_INS, NEW.OBS ;'
  +#13#10''
  +#13#10'  IF (( INSERTING ) AND ( NEW.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' ) ;'
  +#13#10'  ELSE IF (    (UPDATING)'
  +#13#10'      AND (   ( NEW.DT_COMPENSACAO IS DISTINCT FROM OLD.DT_COMPENSACAO )'
  +#13#10'           OR ( NEW.KFIN_CONTA     IS DISTINCT FROM OLD.KFIN_CONTA )'
  +#13#10'           OR ( NEW.PAGO           IS DISTINCT FROM OLD.PAGO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( OLD.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10'      IF ( NEW.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' );'
  +#13#10'    END'
  +#13#10'  ELSE IF (( DELETING ) AND ( OLD.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10''
  +#13#10'END' ;


  _EXECUTE_BLOCK_UPDATE_TRANSPORTE =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'DECLARE KFIN_APAGAR_TRANSPORTE SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10'  FOR'
  +#13#10'   SELECT'
  +#13#10'      KFIN_APAGAR_TRANSPORTE'
  +#13#10'   FROM CMP_PEDIDOS'
  +#13#10'  INTO KFIN_APAGAR_TRANSPORTE DO'
  +#13#10'    UPDATE FIN_APAGAR'
  +#13#10'      SET'
  +#13#10'       HISTORICO = ''Transporte - '' || HISTORICO'
  +#13#10'    WHERE'
  +#13#10'         KFIN_APAGAR = :KFIN_APAGAR_TRANSPORTE'
  +#13#10'     AND HISTORICO NOT LIKE ''Transporte - %'' ;'
  +#13#10'END' ;

begin
  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_INSERT_JUROS ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS ) ;
  ExecuteDirect ( CREATE_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 ) ;
  ExecuteDirect ( _EXECUTE_BLOCK_UPDATE_TRANSPORTE ) ;
end ;

procedure TDBFinanceiroUpdate._5_000_93 ;
const

  DROP_TRIGGER_ECRM_FIN_RECEBER =
    'DROP TRIGGER ECRM$FIN_RECEBER' ;

  UPDATE_FIN_APROPRIACAO =
           'UPDATE FIN_APROPRIACAO'
    +#13#10'SET'
    +#13#10' TABLEKEY = KFIN_ITEM'
    +#13#10'WHERE'
    +#13#10'     ( TABLEKEY IS NULL )'
    +#13#10' AND ( KFIN_ITEM IS NOT NULL )' ;

  DELETE_FIN_APROPRIACAO =
           'DELETE FIN_APROPRIACAO'
    +#13#10'WHERE'
    +#13#10'     ( TABLEKEY IS NULL )'  ;

  DROP_TRIGGER_JNL_FIN_APROPRIACAO =
    'DROP TRIGGER JNL$FIN_APROPRIACAO' ;

  ALTER_TABLE_FIN_APROPRIACAO_1 =
           'ALTER TABLE FIN_APROPRIACAO'
    +#13#10'DROP KFIN_ITEM' ;

  ALTER_TABLE_FIN_APROPRIACAO_2 =
           'ALTER TABLE FIN_APROPRIACAO'
    +#13#10'ALTER TABLEKEY TYPE SYS$FKGUID20_NN' ;


  CREATE_PROCEDURE_FIN_APAGAR_INSERT_JUROS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_INSERT_JUROS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20,'
  +#13#10'    KFIN_CONTA  SYS$FKGUID20_NN,'
  +#13#10'    DOCUMENTO   FIN$DOC,'
  +#13#10'    DATA        SYS$DATE,'
  +#13#10'    COMPENSACAO SYS$DATE,'
  +#13#10'    VALOR       SYS$FLOAT,'
  +#13#10'    OBS         SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20_NN ;'
  +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_APAGAR_NEW SYS$FKGUID20 ;'
  +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
  +#13#10'DECLARE KDEF_PLANOCONTA SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20 = NULL;'
  +#13#10'DECLARE HISTORICO SYS$DESCR ;'
  +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20;'
  +#13#10'DECLARE PORCENTAGEM SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'     KFIN_APAGAR'
  +#13#10'  FROM'
  +#13#10'     FIN_APAGAR_PARCELAS'
  +#13#10'  WHERE'
  +#13#10'     KFIN_APAGAR_PARCELA = :KFIN_APAGAR_PARCELA'
  +#13#10'  INTO'
  +#13#10'     :KFIN_APAGAR ;'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'    KSYS$DOMAIN,  HISTORICO,  KCAD_ENTIDADE,  DOCUMENTO'
  +#13#10'  FROM'
  +#13#10'    FIN_APAGAR'
  +#13#10'  WHERE'
  +#13#10'    KFIN_APAGAR = :KFIN_APAGAR'
  +#13#10'  INTO'
  +#13#10'    :KSYS$DOMAIN, :HISTORICO, :KCAD_ENTIDADE, :DOCUMENTO ;'
  +#13#10''
  +#13#10' EXECUTE PROCEDURE SYS$TYPES_GETVALUE ''DEF_PLANOCONTAS'', ''JUROS'' RETURNING_VALUES KDEF_PLANOCONTA ;'
  +#13#10''
  +#13#10' SELECT'
  +#13#10'   KFIN_PLANOCONTA'
  +#13#10' FROM'
  +#13#10'   FIN_PLANOCONTAS'
  +#13#10' WHERE'
  +#13#10'   KDEF_PLANOCONTA = :KDEF_PLANOCONTA'
  +#13#10' INTO'
  +#13#10'   KFIN_PLANOCONTA ;'
  +#13#10''
  +#13#10'  KFIN_APAGAR_NEW = GUID20();'
  +#13#10''
  +#13#10'  INSERT INTO FIN_APAGAR'
  +#13#10'    ( KFIN_APAGAR, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DATALANCTO, VALOR, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :KFIN_APAGAR_NEW, :KSYS$DOMAIN, :KSYS$DOMAIN, ''JUROS: '' || :HISTORICO, :KCAD_ENTIDADE, :DATA, :VALOR, ''J-'' || COALESCE(:DOCUMENTO,''''), :KFIN_PLANOCONTA, ''FIN_APAGAR_PARCELAS'', :KFIN_APAGAR_PARCELA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_APAGAR_PARCELAS'
  +#13#10'    ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :KFIN_APAGAR_NEW, ''J-'' || COALESCE(:DOCUMENTO,''''), :DATA, :VALOR, :DATA, :COMPENSACAO, :VALOR, :KFIN_CONTA );'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'   SELECT KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'   FROM FIN_APROPRIACAO'
  +#13#10'   WHERE TABLENAME = ''FIN_APAGAR'' AND TABLEKEY = :KFIN_APAGAR'
  +#13#10'   INTO KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'  DO'
  +#13#10'    INSERT INTO FIN_APROPRIACAO'
  +#13#10'      ( KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), ''FIN_APAGAR'', :KFIN_APAGAR_NEW, :KFIN_CENTROCUSTO, :PORCENTAGEM ) ;'
  +#13#10''
  +#13#10'END' ;

  CREATE_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_INSERT_DESCONTOS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20,'
  +#13#10'    KFIN_CONTA SYS$FKGUID20_NN,'
  +#13#10'    DOCUMENTO  FIN$DOC,'
  +#13#10'    DATA       SYS$DATE,'
  +#13#10'    COMPENSACAO SYS$DATE,'
  +#13#10'    VALOR      SYS$FLOAT,'
  +#13#10'    OBS        SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE KSYS$DOMAIN SYS$FKGUID20_NN ;'
  +#13#10'DECLARE KFIN_APAGAR SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_ARECEBER_NEW SYS$FKGUID20;'
  +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20 ;'
  +#13#10'DECLARE KDEF_PLANOCONTA SYS$FKGUID20 ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20 = NULL;'
  +#13#10'DECLARE HISTORICO SYS$DESCR ;'
  +#13#10'DECLARE KFIN_CENTROCUSTO SYS$FKGUID20;'
  +#13#10'DECLARE PORCENTAGEM SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'     KFIN_APAGAR'
  +#13#10'  FROM'
  +#13#10'     FIN_APAGAR_PARCELAS'
  +#13#10'  WHERE'
  +#13#10'     KFIN_APAGAR_PARCELA = :KFIN_APAGAR_PARCELA'
  +#13#10'  INTO'
  +#13#10'     :KFIN_APAGAR ;'
  +#13#10''
  +#13#10'  SELECT'
  +#13#10'    KSYS$DOMAIN,  HISTORICO,  KCAD_ENTIDADE,  DOCUMENTO'
  +#13#10'  FROM'
  +#13#10'    FIN_APAGAR'
  +#13#10'  WHERE'
  +#13#10'    KFIN_APAGAR = :KFIN_APAGAR'
  +#13#10'  INTO'
  +#13#10'    :KSYS$DOMAIN, :HISTORICO, :KCAD_ENTIDADE, :DOCUMENTO ;'
  +#13#10''
  +#13#10' EXECUTE PROCEDURE SYS$TYPES_GETVALUE ''DEF_PLANOCONTAS'', ''DESCONTOS'' RETURNING_VALUES KDEF_PLANOCONTA ;'
  +#13#10''
  +#13#10' SELECT'
  +#13#10'   KFIN_PLANOCONTA'
  +#13#10' FROM'
  +#13#10'   FIN_PLANOCONTAS'
  +#13#10' WHERE'
  +#13#10'   KDEF_PLANOCONTA = :KDEF_PLANOCONTA'
  +#13#10' INTO'
  +#13#10'   KFIN_PLANOCONTA ;'
  +#13#10''
  +#13#10'  KFIN_ARECEBER_NEW = GUID20();'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER'
  +#13#10'    ( KFIN_ARECEBER, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DATALANCTO, VALOR, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :KFIN_ARECEBER_NEW, :KSYS$DOMAIN, :KSYS$DOMAIN, ''DESCONTOS: '' || :HISTORICO, :KCAD_ENTIDADE, :DATA, :VALOR, ''D+'' || COALESCE(:DOCUMENTO,''''), :KFIN_PLANOCONTA, ''FIN_APAGAR_PARCELAS'', :KFIN_APAGAR_PARCELA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER_PARCELAS'
  +#13#10'    ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :KFIN_ARECEBER_NEW, ''D+'' || COALESCE(:DOCUMENTO,''''), :DATA, :VALOR, :DATA, :COMPENSACAO, :VALOR, :KFIN_CONTA );'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'   SELECT KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'   FROM FIN_APROPRIACAO'
  +#13#10'   WHERE TABLENAME = ''FIN_APAGAR'' AND TABLEKEY = :KFIN_APAGAR'
  +#13#10'   INTO KFIN_CENTROCUSTO, PORCENTAGEM'
  +#13#10'  DO'
  +#13#10'    INSERT INTO FIN_APROPRIACAO'
  +#13#10'      ( KFIN_APROPRIACAO, TABLENAME, TABLEKEY, KFIN_CENTROCUSTO, PORCENTAGEM )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), ''FIN_ARECEBER'', :KFIN_ARECEBER_NEW, :KFIN_CENTROCUSTO, :PORCENTAGEM ) ;'
  +#13#10''
  +#13#10'END' ;

  CREATE_PROCEDURE_FIN_APAGAR_DELETE_JUROS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_DELETE_JUROS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20'
  +#13#10')'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  DELETE FROM FIN_APAGAR'
  +#13#10'  WHERE TABLENAME = ''FIN_APAGAR_PARCELAS'''
  +#13#10'    AND TABLEKEY = :KFIN_APAGAR_PARCELA ;'
  +#13#10'END' ;

  CREATE_PROCEDURE_FIN_APAGAR_DELETE_DESCONTOS =
         'CREATE OR ALTER PROCEDURE FIN_APAGAR_DELETE_DESCONTOS ('
  +#13#10'    KFIN_APAGAR_PARCELA SYS$FKGUID20'
  +#13#10')'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  DELETE FROM FIN_ARECEBER'
  +#13#10'  WHERE TABLENAME = ''FIN_APAGAR_PARCELAS'''
  +#13#10'       AND TABLEKEY = :KFIN_APAGAR_PARCELA ;'
  +#13#10'END' ;

  DROP_TRIGGER_FIN_APAGAR_PARCELAS_AIU0 =
         'DROP TRIGGER FIN_APAGAR_PARCELAS_AIU0' ;

  CREATE_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 =
         'CREATE OR ALTER TRIGGER FIN_APAGAR_PARCELAS_AIUD0 FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE DIFFPAGO_INS SYS$FLOAT ;'
  +#13#10'DECLARE DIFFPAGO_DEL SYS$FLOAT ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (( INSERTING ) AND ( NEW.PAGTO IS NOT NULL )) THEN'
  +#13#10'    DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'  ELSE IF (    (UPDATING)'
  +#13#10'      AND (   ( NEW.PAGTO IS DISTINCT FROM OLD.PAGTO )'
  +#13#10'           OR ( NEW.KFIN_CONTA     IS DISTINCT FROM OLD.KFIN_CONTA )'
  +#13#10'           OR ( NEW.PAGO           IS DISTINCT FROM OLD.PAGO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF (( OLD.PAGTO IS NOT NULL ) AND (NEW.PAGTO IS NULL) ) THEN'
  +#13#10'        DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10'      ELSE IF (( NEW.PAGTO IS NOT NULL ) AND (OLD.PAGTO IS NULL) ) THEN'
  +#13#10'        DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'      ELSE IF ( NEW.PAGTO IS NOT NULL ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10'          DIFFPAGO_INS = NEW.PAGO - NEW.VALOR ;'
  +#13#10'        END'
  +#13#10'    END'
  +#13#10'  ELSE IF (( DELETING ) AND ( OLD.PAGTO IS NOT NULL )) THEN'
  +#13#10'    DIFFPAGO_DEL = OLD.PAGO - OLD.VALOR ;'
  +#13#10''
  +#13#10'  IF ( DIFFPAGO_DEL > 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_DELETE_JUROS OLD.KFIN_APAGAR_PARCELA ;'
  +#13#10'  ELSE IF ( DIFFPAGO_DEL < 0 ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_APAGAR_DELETE_DESCONTOS OLD.KFIN_APAGAR_PARCELA ;'
  +#13#10''
  +#13#10'  IF ( DIFFPAGO_INS > 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_INSERT_JUROS'
  +#13#10'      NEW.KFIN_APAGAR_PARCELA, NEW.KFIN_CONTA, NEW.DOCUMENTO, NEW.PAGTO, NEW.DT_COMPENSACAO, DIFFPAGO_INS, NEW.OBS ;'
  +#13#10'  ELSE IF ( DIFFPAGO_INS < 0 ) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_APAGAR_INSERT_DESCONTOS'
  +#13#10'      NEW.KFIN_APAGAR_PARCELA, NEW.KFIN_CONTA, NEW.DOCUMENTO, NEW.PAGTO, NEW.DT_COMPENSACAO, -DIFFPAGO_INS, NEW.OBS ;'
  +#13#10''
  +#13#10'  IF (( INSERTING ) AND ( NEW.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' ) ;'
  +#13#10'  ELSE IF (    (UPDATING)'
  +#13#10'      AND (   ( NEW.DT_COMPENSACAO IS DISTINCT FROM OLD.DT_COMPENSACAO )'
  +#13#10'           OR ( NEW.KFIN_CONTA     IS DISTINCT FROM OLD.KFIN_CONTA )'
  +#13#10'           OR ( NEW.PAGO           IS DISTINCT FROM OLD.PAGO ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( OLD.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10'      IF ( NEW.DT_COMPENSACAO IS NOT NULL ) THEN'
  +#13#10'        EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( NEW.KFIN_CONTA, COALESCE ( NEW.PAGO, 0 ), 0, ''D'' );'
  +#13#10'    END'
  +#13#10'  ELSE IF (( DELETING ) AND ( OLD.DT_COMPENSACAO IS NOT NULL )) THEN'
  +#13#10'      EXECUTE PROCEDURE FIN_UPDATE_SALDO_CONTA( OLD.KFIN_CONTA, 0, COALESCE ( OLD.PAGO, 0 ), ''D'' );'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect ( DROP_TRIGGER_ECRM_FIN_RECEBER ) ;
  TryExecuteDirect ( UPDATE_FIN_APROPRIACAO ) ;
  TryExecuteDirect ( DELETE_FIN_APROPRIACAO ) ;
  TryExecuteDirect ( DROP_TRIGGER_JNL_FIN_APROPRIACAO ) ;
  TryExecuteDirect ( ALTER_TABLE_FIN_APROPRIACAO_1 ) ;
  TryExecuteDirect ( ALTER_TABLE_FIN_APROPRIACAO_2 ) ;

  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_INSERT_JUROS ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_INSERT_DESCONTOS ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_DELETE_JUROS ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_APAGAR_DELETE_DESCONTOS ) ;
  TryExecuteDirect ( DROP_TRIGGER_FIN_APAGAR_PARCELAS_AIU0 ) ;
  ExecuteDirect ( CREATE_TRIGGER_FIN_APAGAR_PARCELAS_AIUD0 ) ;
end ;

procedure TDBFinanceiroUpdate._5_000_92 ;
const
  DROP_INDEX_IXEST_MOVIMENTO_01 =
     'DROP INDEX IXEST_MOVIMENTO_01' ;

  CREATE_INDEX_UQEST_MOVIMENTO_01 =
     'CREATE UNIQUE INDEX UQEST_MOVIMENTO_01 ON EST_MOVIMENTO (KSYS$DOMAIN, TABLENAME, TABLEKEY)' ;

  CREATE_INDEX_IXFIN_ARECEBER_01 =
     'CREATE INDEX IXFIN_ARECEBER_01 ON FIN_ARECEBER (TABLENAME, TABLEKEY)' ;

  CREATE_INDEX_IXFIN_APAGAR_01 =
     'CREATE INDEX IXFIN_APAGAR_01 ON FIN_APAGAR (TABLENAME, TABLEKEY)' ;

  CREATE_PROCEDURE_FIN_INSERT_CREDITODEBITO =
         'CREATE OR ALTER PROCEDURE FIN_INSERT_CREDITODEBITO ('
  +#13#10'    KFIN_TRANSFERENCIA SYS$FKGUID20,'
  +#13#10'    KSYS$DOMAIN        SYS$FKGUID20_NN,'
  +#13#10'    KFIN_CONTA_ORIGEM  SYS$FKGUID20_NN,'
  +#13#10'    DOC_ORIGEM         FIN$DOC,'
  +#13#10'    KFIN_CONTA_DESTINO SYS$FKGUID20_NN,'
  +#13#10'    DOC_DESTINO        FIN$DOC,'
  +#13#10'    DATA               SYS$DATE,'
  +#13#10'    VALOR              SYS$FLOAT,'
  +#13#10'    OBS                SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE PK SYS$FKGUID20;'
  +#13#10'BEGIN'
  +#13#10'  /* CREDITO */'
  +#13#10'  PK = GUID20();'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER'
  +#13#10'    ( KFIN_ARECEBER, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :PK, :KSYS$DOMAIN, :KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || :DOC_DESTINO, NULL, ''FIN_TRANSFERENCIAS'', :KFIN_TRANSFERENCIA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_ARECEBER_PARCELAS'
  +#13#10'    ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :PK, ''TC'' || :DOC_DESTINO, :DATA, :VALOR, :DATA, :DATA, :VALOR, :KFIN_CONTA_DESTINO );'
  +#13#10''
  +#13#10'  /* DEBITO */'
  +#13#10'  PK = GUID20();'
  +#13#10'  INSERT INTO FIN_APAGAR'
  +#13#10'    ( KFIN_APAGAR, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'  VALUES'
  +#13#10'    ( :PK, :KSYS$DOMAIN, :KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || :DOC_ORIGEM, NULL, ''FIN_TRANSFERENCIAS'', :KFIN_TRANSFERENCIA, :OBS);'
  +#13#10''
  +#13#10'  INSERT INTO FIN_APAGAR_PARCELAS'
  +#13#10'    ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'  VALUES'
  +#13#10'    ( GUID20(), :PK, ''TC'' || :DOC_ORIGEM, :DATA, :VALOR, :DATA, :DATA, :VALOR, :KFIN_CONTA_ORIGEM );'
  +#13#10'END' ;


  CREATE_PROCEDURE_FIN_UPDATE_CREDITODEBITO =
         'CREATE OR ALTER PROCEDURE FIN_UPDATE_CREDITODEBITO ('
  +#13#10'    KFIN_TRANSFERENCIA SYS$FKGUID20,'
  +#13#10'    KFIN_TRANSFERENCIA_NEW SYS$FKGUID20,'
  +#13#10'    KSYS$DOMAIN        SYS$FKGUID20_NN,'
  +#13#10'    KFIN_CONTA_ORIGEM  SYS$FKGUID20_NN,'
  +#13#10'    DOC_ORIGEM         FIN$DOC,'
  +#13#10'    KFIN_CONTA_DESTINO SYS$FKGUID20_NN,'
  +#13#10'    DOC_DESTINO        FIN$DOC,'
  +#13#10'    DATA               SYS$DATE,'
  +#13#10'    VALOR              SYS$FLOAT,'
  +#13#10'    OBS                SYS$BLOBTEXT'
  +#13#10')'
  +#13#10'AS'
  +#13#10'DECLARE PK SYS$FKGUID20;'
  +#13#10'BEGIN'
  +#13#10'  --VHISTORICO = NEW.HISTORICO;'
  +#13#10''
  +#13#10'  --IF (:VHISTORICO IS NULL) THEN'
  +#13#10'  --  VHISTORICO = ''TRANSFERÊNCIA N° '' || NEW.KFIN_TRANSFERENCIA ;'
  +#13#10''
  +#13#10'  --CREDITO'
  +#13#10'  SELECT KFIN_ARECEBER'
  +#13#10'  FROM FIN_ARECEBER'
  +#13#10'  WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'    AND TABLEKEY = :KFIN_TRANSFERENCIA'
  +#13#10'  INTO :PK ;'
  +#13#10''
  +#13#10'  UPDATE FIN_ARECEBER SET'
  +#13#10'    KSYS$DOMAIN = :KSYS$DOMAIN,'
  +#13#10'    --HISTORICO = :VHISTORICO,'
  +#13#10'    DOCUMENTO = ''TC'' || :DOC_DESTINO,'
  +#13#10'    TABLEKEY = :KFIN_TRANSFERENCIA_NEW,'
  +#13#10'    OBS = :OBS'
  +#13#10'  WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'  UPDATE FIN_ARECEBER_PARCELAS SET'
  +#13#10'    PAGTO = :DATA,'
  +#13#10'    DOCUMENTO = ''TC'' || :DOC_DESTINO,'
  +#13#10'    DT_COMPENSACAO = :DATA,'
  +#13#10'    PAGO = :VALOR,'
  +#13#10'    KFIN_CONTA = :KFIN_CONTA_DESTINO'
  +#13#10'  WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'  --DEBITO'
  +#13#10'  SELECT KFIN_APAGAR'
  +#13#10'  FROM FIN_APAGAR'
  +#13#10'  WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'    AND TABLEKEY = :KFIN_TRANSFERENCIA'
  +#13#10'  INTO :PK ;'
  +#13#10''
  +#13#10'  UPDATE FIN_APAGAR SET'
  +#13#10'    KSYS$DOMAIN = :KSYS$DOMAIN,'
  +#13#10'    --HISTORICO = :VHISTORICO,'
  +#13#10'    DOCUMENTO = ''TC'' || :DOC_ORIGEM,'
  +#13#10'    TABLEKEY = :KFIN_TRANSFERENCIA_NEW,'
  +#13#10'    OBS = :OBS'
  +#13#10'  WHERE KFIN_APAGAR = :PK ;'
  +#13#10''
  +#13#10'  UPDATE FIN_APAGAR_PARCELAS SET'
  +#13#10'    DOCUMENTO = ''TC'' || :DOC_ORIGEM,'
  +#13#10'    PAGTO = :DATA,'
  +#13#10'    DT_COMPENSACAO = :DATA,'
  +#13#10'    PAGO = :VALOR,'
  +#13#10'    KFIN_CONTA = :KFIN_CONTA_ORIGEM'
  +#13#10'  WHERE KFIN_APAGAR = :PK ;'
  +#13#10'END' ;

  CREATE_PROCEDURE_FIN_DELETE_CREDITODEBITO =
         'CREATE OR ALTER PROCEDURE FIN_DELETE_CREDITODEBITO ('
  +#13#10'    KFIN_TRANSFERENCIA SYS$FKGUID20'
  +#13#10')'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  /* CREDITO */'
  +#13#10'  DELETE FROM FIN_ARECEBER'
  +#13#10'  WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'       AND TABLEKEY = :KFIN_TRANSFERENCIA ;'
  +#13#10'  /* DEBITO */'
  +#13#10'  DELETE FROM FIN_APAGAR'
  +#13#10'  WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'    AND TABLEKEY = :KFIN_TRANSFERENCIA ;'
  +#13#10'END' ;

  DROP_TRIGGER_FIN_TRANSFERENCIAS_AI0 =
         'DROP TRIGGER FIN_TRANSFERENCIAS_AI0' ;
  DROP_TRIGGER_FIN_TRANSFERENCIAS_AU0 =
         'DROP TRIGGER FIN_TRANSFERENCIAS_AU0' ;
  DROP_TRIGGER_FIN_TRANSFERENCIAS_AD0 =
         'DROP TRIGGER FIN_TRANSFERENCIAS_AD0' ;

  ALTER_TABLE_FIN_TRANSFERENCIAS =
         'ALTER TABLE FIN_TRANSFERENCIAS'
  +#13#10'ALTER DOC_ORGIGEM TO DOC_ORIGEM' ;

  CREATE_TRIGGER_FIN_TRANSFERENCIAS_AIUD0 =
         'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AIUD0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER UPDATE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_INSERT_CREDITODEBITO'
  +#13#10'       NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
  +#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
  +#13#10'  ELSE IF (UPDATING) THEN'
  +#13#10'    EXECUTE PROCEDURE FIN_UPDATE_CREDITODEBITO'
  +#13#10'       OLD.KFIN_TRANSFERENCIA, NEW.KFIN_TRANSFERENCIA, NEW.KSYS$DOMAIN, NEW.KFIN_CONTA_ORIGEM, NEW.DOC_ORIGEM,'
  +#13#10'       NEW.KFIN_CONTA_DESTINO, NEW.DOC_DESTINO, NEW.DATA, NEW.VALOR, NEW.OBS ;'
  +#13#10'  ELSE'
  +#13#10'    EXECUTE PROCEDURE FIN_DELETE_CREDITODEBITO OLD.KFIN_TRANSFERENCIA ;'
  +#13#10'END' ;



begin
  TryExecuteDirect ( DROP_INDEX_IXEST_MOVIMENTO_01 ) ;
  TryExecuteDirect ( CREATE_INDEX_UQEST_MOVIMENTO_01 ) ;
  TryExecuteDirect ( CREATE_INDEX_IXFIN_ARECEBER_01 ) ;
  TryExecuteDirect ( CREATE_INDEX_IXFIN_APAGAR_01 ) ;

  ExecuteDirect ( CREATE_PROCEDURE_FIN_INSERT_CREDITODEBITO  ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_UPDATE_CREDITODEBITO  ) ;
  ExecuteDirect ( CREATE_PROCEDURE_FIN_DELETE_CREDITODEBITO  ) ;

  TryExecuteDirect ( DROP_TRIGGER_FIN_TRANSFERENCIAS_AI0  ) ;
  TryExecuteDirect ( DROP_TRIGGER_FIN_TRANSFERENCIAS_AU0  ) ;
  TryExecuteDirect ( DROP_TRIGGER_FIN_TRANSFERENCIAS_AD0  ) ;

  TryExecuteDirect ( ALTER_TABLE_FIN_TRANSFERENCIAS  ) ;

  ExecuteDirect ( CREATE_TRIGGER_FIN_TRANSFERENCIAS_AIUD0  ) ;

end ;

procedure TDBFinanceiroUpdate._5_000_91;
const

  CREATE_TRIGGER_ECRM_CAD_PATRIMONIOS1 =
         'CREATE OR ALTER TRIGGER ECRM$CAD_PATRIMONIOS FOR CAD_PATRIMONIOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CAD_PATRIMONIOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCAD_PATRIMONIO, OLD.KCAD_PATRIMONIO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END'  ;

  // apenas para referencia, nao foi necessario utilizar esta versao
   CREATE_TRIGGER_ECRM_CAD_PATRIMONIOS2 =
         'CREATE OR ALTER TRIGGER ECRM$CAD_PATRIMONIOS FOR CAD_PATRIMONIOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'DECLARE KCAD_PATRIMONIO_DEPRECIACAO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''CAD_PATRIMONIOS'', NEW.KCAD_PATRIMONIO, ''I'' ;'
  +#13#10'   ELSE IF ( UPDATING ) THEN'
  +#13#10'     BEGIN'
  +#13#10'       EXECUTE PROCEDURE ECRM$UPDATE_IUD ''CAD_PATRIMONIOS'', OLD.KCAD_PATRIMONIO, ''U'' ;'
  +#13#10'       IF ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM NEW.KFIN_PLANOCONTA ) THEN'
  +#13#10'          FOR'
  +#13#10'            SELECT KCAD_PATRIMONIO_DEPRECIACAO'
  +#13#10'            FROM CAD_PATRIMONIO_DEPRECIACOES'
  +#13#10'            WHERE'
  +#13#10'              KCAD_PATRIMONIO = OLD.KCAD_PATRIMONIO'
  +#13#10'          INTO KCAD_PATRIMONIO_DEPRECIACAO'
  +#13#10'          DO'
  +#13#10'            EXECUTE PROCEDURE ECRM$UPDATE_IUD ''CAD_PATRIMONIO_DEPRECIACOES'', KCAD_PATRIMONIO_DEPRECIACAO, ''U'' ;'
  +#13#10'     END'
  +#13#10'   ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''CAD_PATRIMONIOS'', OLD.KCAD_PATRIMONIO, ''D'' ;'
  +#13#10'END' ;

  CREATE_PROCEDURE_CRM_PDATE_IUD =
         'CREATE OR ALTER PROCEDURE ECRM$UPDATE_IUD('
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$PKGUID20,'
  +#13#10'    IUD SYS$IUD,'
  +#13#10'    RELATED_TABLENAME SYS$TABLENAME = NULL,'
  +#13#10'    RELATED_TABLEKEY SYS$FKGUID20 = NULL,'
  +#13#10'    DATE_ SYS$DATE = NULL )'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( DATE_ IS NULL ) THEN'
  +#13#10'    DATE_ = ''NOW'' ;'
  +#13#10''
  +#13#10'  IF ( IUD IN ( ''U'', ''D'' ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE ECRM$IUD'
  +#13#10'      SET KECRM$IUD = NEXT VALUE FOR ECRM$IUD,'
  +#13#10'          IUD       = :IUD,'
  +#13#10'          SYS$DU    = :DATE_'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD IN ( ''I'', ''U'', ''D'' ) ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( ( IUD = ''I'' ) OR ( ROW_COUNT = 0 ) ) THEN'
  +#13#10'     INSERT INTO ECRM$IUD'
  +#13#10'       ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'     VALUES'
  +#13#10'       ( NEXT VALUE FOR ECRM$IUD, :TABLENAME, :TABLEKEY, :RELATED_TABLENAME, :RELATED_TABLEKEY, :IUD, :DATE_, :DATE_ ) ;'
  +#13#10''
  +#13#10'END' ;

  CREATE_TRIGGER_EST_ENCERRAMENTO_MES_AU0 =
         'CREATE OR ALTER TRIGGER EST_ENCERRAMENTO_MES_AU0 FOR EST_ENCERRAMENTO_MES'
  +#13#10'ACTIVE AFTER UPDATE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_OUTRA_ENTRADA_SAIDA SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10'  if ( RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) = ''1'' ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  if ( NEW.ENCERRADO IS DISTINCT FROM OLD.ENCERRADO  ) THEN'
  +#13#10'   BEGIN'
  +#13#10'     IF ( NEW.ENCERRADO = ''T'' )then'
  +#13#10'      EXECUTE PROCEDURE EST_ENCERRAR_MES NEW.KEST_ENCERRAMENTO_MES ;'
  +#13#10'     ELSE'
  +#13#10'      EXECUTE PROCEDURE EST_REABRIR_MES NEW.KEST_ENCERRAMENTO_MES ;'
  +#13#10''
  +#13#10'     FOR'
  +#13#10'       SELECT'
  +#13#10'         TABLEKEY'
  +#13#10'       FROM EST_MOVIMENTO'
  +#13#10'       WHERE KSYS$DOMAIN = NEW.KSYS$DOMAIN'
  +#13#10'         AND TABLENAME = ''EST_OUTRAS_ENTRADAS_SAIDAS'''
  +#13#10'         AND ANO_MES = NEW.ANO_MES'
  +#13#10'         AND TIPO = ''S'''
  +#13#10'     INTO KEST_OUTRA_ENTRADA_SAIDA'
  +#13#10'     DO'
  +#13#10'       EXECUTE PROCEDURE ECRM$UPDATE_IUD ''EST_OUTRAS_ENTRADAS_SAIDAS'', KEST_OUTRA_ENTRADA_SAIDA, ''U'' ;'
  +#13#10'   END'
  +#13#10''
  +#13#10'END' ;

  EXECUTE_BLOCK_UPDATE_ECRM  =
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10' DECLARE KEST_OUTRA_ENTRADA_SAIDA SYS$FKGUID20 ;'
  +#13#10' DECLARE DATE_ SYS$DATE ;'
  +#13#10'BEGIN'
  +#13#10'  SELECT MAX( SYS$DI ) FROM ECRM$IUD'
  +#13#10'  INTO DATE_ ;'
  +#13#10''
  +#13#10'  DATE_ = DATEADD( 1 SECOND TO DATE_ ) ;'
  +#13#10''
  +#13#10'  FOR'
  +#13#10'    SELECT'
  +#13#10'      TABLEKEY'
  +#13#10'    FROM EST_MOVIMENTO'
  +#13#10'    WHERE'
  +#13#10'          TABLENAME = ''EST_OUTRAS_ENTRADAS_SAIDAS'''
  +#13#10'      AND TIPO = ''S'''
  +#13#10'  INTO KEST_OUTRA_ENTRADA_SAIDA'
  +#13#10'  DO'
  +#13#10'    EXECUTE PROCEDURE ECRM$UPDATE_IUD ''EST_OUTRAS_ENTRADAS_SAIDAS'', KEST_OUTRA_ENTRADA_SAIDA, ''U'', NULL, NULL, DATE_ ;'
  +#13#10''
  +#13#10'END' ;


begin
   ExecuteDirect ( CREATE_TRIGGER_ECRM_CAD_PATRIMONIOS1 ) ;
   ExecuteDirect ( CREATE_PROCEDURE_CRM_PDATE_IUD ) ;
   ExecuteDirect ( CREATE_TRIGGER_EST_ENCERRAMENTO_MES_AU0 ) ;
   ExecuteDirect ( EXECUTE_BLOCK_UPDATE_ECRM ) ;
end;

procedure TDBFinanceiroUpdate._5_000_88;
const

  _UPDATE_ECRM_IUD =
         'UPDATE ECRM$IUD'
  +#13#10'SET'
  +#13#10' TABLENAME = ''EST_OUTRAS_ENTRADAS_SAIDAS'''
  +#13#10'WHERE TABLENAME = ''EST_MOVIMENTO'''   ;

  _ALTER_TRIGGER_ECRM_EST_OUTRAS_ENTRADAS_SAIDAS =
         'CREATE OR ALTER TRIGGER ECRM$EST_OUTRAS_ENTRADAS_SAIDAS FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''EST_OUTRAS_ENTRADAS_SAIDAS'','
  +#13#10'    IIF ( INSERTING, NEW.KEST_OUTRA_ENTRADA_SAIDA, OLD.KEST_OUTRA_ENTRADA_SAIDA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ;


begin

  ExecuteDirect ( _UPDATE_ECRM_IUD ) ;
  ExecuteDirect ( _ALTER_TRIGGER_ECRM_EST_OUTRAS_ENTRADAS_SAIDAS ) ;

end;

procedure TDBFinanceiroUpdate._5_000_84;
begin

  ExecuteDirect (
           'CREATE OR ALTER PROCEDURE FIN_DELETE_APROPRIACAO('
    +#13#10'KSYS$DOMAIN SYS$PKGUID20,'
    +#13#10'TABLENAME SYS$TABLENAME,'
    +#13#10'TABLEKEY SYS$PKGUID20)'
    +#13#10'AS'
    +#13#10'BEGIN'
    +#13#10'  DELETE FROM FIN_APROPRIACAO WHERE TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY ;'
    +#13#10'END' ) ;

end ;

procedure TDBFinanceiroUpdate._5_000_83;
begin

  ExecuteDirect ('DROP TRIGGER CMP_PEDIDOS_BIUD0' ) ;
  ExecuteDirect ('DROP TRIGGER ECRM$CMP_PEDIDO_ITENS' ) ;
  ExecuteDirect ('DROP TRIGGER CMP_PEDIDO_ITENS_BIUD0' ) ;
  ExecuteDirect ('DROP TRIGGER CMP_PEDIDO_ITENS_AIUD0' ) ;


  TryExecuteDirect (
         'ALTER TABLE CMP_PEDIDOS'
  +#13#10'ADD KFIN_APAGAR_TRANSPORTE SYS$FKGUID20,'
  +#13#10'ALTER KFIN_APAGAR_TRANSPORTE POSITION 15' ) ;


  ExecuteDirect (
         'ALTER TABLE CMP_PEDIDO_ITENS'
  +#13#10' ALTER   KCMP_PEDIDO_ITEM POSITION 1,'
  +#13#10' ALTER   KCMP_PEDIDO POSITION 2,'
  +#13#10' ALTER   KEST_PRODUTO POSITION 3,'
  +#13#10' ALTER   KCAD_PATRIMONIO POSITION 4,'
  +#13#10' ALTER   CODIGO POSITION 5,'
  +#13#10' ALTER   NOME POSITION 6,'
  +#13#10' ALTER   UNIDADE POSITION 7,'
  +#13#10' ALTER   DETALHES POSITION 8,'
  +#13#10' ALTER   QTDE POSITION 9' ) ;

  TryExecuteDirect (
         'ALTER TABLE CMP_PEDIDO_ITENS'
  +#13#10' ADD   VALOR_UNITARIO  SYS$FLOAT_NN_0,'
  +#13#10' ADD   VALOR_PARCIAL  COMPUTED BY (QTDE*VALOR_UNITARIO),'
  +#13#10' ADD   DESCONTO  SYS$FLOAT_NN_0,'
  +#13#10' ADD   FRETE  SYS$FLOAT_NN_0,'
  +#13#10' ADD   IMPOSTO  SYS$FLOAT_NN_0' ) ;

  ExecuteDirect (
         'ALTER TABLE CMP_PEDIDO_ITENS'
  +#13#10' ALTER VALOR_UNITARIO  POSITION 10,'
  +#13#10' ALTER VALOR_PARCIAL  POSITION 11,'
  +#13#10' ALTER DESCONTO  POSITION 12,'
  +#13#10' ALTER FRETE  POSITION 13,'
  +#13#10' ALTER IMPOSTO  POSITION 14,'
  +#13#10' ALTER TOTAL  POSITION 15,'
  +#13#10' ALTER CUSTO  POSITION 16,'
  +#13#10' ALTER OBS  POSITION 17' ) ;

  ExecuteDirect (
         'UPDATE CMP_PEDIDO_ITENS'
  +#13#10' SET VALOR_UNITARIO = CUSTO' ) ;

  ExecuteDirect (
         'UPDATE CMP_PEDIDOS'
  +#13#10' SET KFIN_APAGAR_TRANSPORTE = GUID20()' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_BIUD0 FOR CMP_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'   BEGIN'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_EMISSAO ;'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_ENTRADA ;'
  +#13#10'   END'
  +#13#10'  ELSE IF (    ( updating )'
  +#13#10'           AND (   ( NEW.KCAD_FAZENDA IS DISTINCT FROM OLD.KCAD_FAZENDA )'
  +#13#10'                OR ( NEW.DATA_EMISSAO IS DISTINCT FROM OLD.DATA_EMISSAO )'
  +#13#10'                OR ( NEW.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_ENTRADA ) ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KCAD_FAZENDA, OLD.DATA_EMISSAO ;'
  +#13#10'      IF ( OLD.DATA_ENTRADA IS DISTINCT FROM OLD.DATA_EMISSAO ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KCAD_FAZENDA, OLD.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_EMISSAO ;'
  +#13#10'      IF ( NEW.DATA_ENTRADA IS DISTINCT FROM NEW.DATA_EMISSAO ) THEN'
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_ENTRADA ;'
  +#13#10''
  +#13#10'      FOR SELECT KEST_PRODUTO'
  +#13#10'        FROM CMP_PEDIDO_ITENS'
  +#13#10'        WHERE KCMP_PEDIDO = NEW.KCMP_PEDIDO AND NOT KEST_PRODUTO IS NULL'
  +#13#10'        INTO KEST_PRODUTO'
  +#13#10'      DO'
  +#13#10'          EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KCAD_FAZENDA, KEST_PRODUTO, NEW.DATA_EMISSAO ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( deleting ) then'
  +#13#10'    BEGIN'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KCAD_FAZENDA, OLD.DATA_EMISSAO ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KCAD_FAZENDA, OLD.DATA_ENTRADA ;'
  +#13#10'    END'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDO_ITENS FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDO_ITENS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO_ITEM, OLD.KCMP_PEDIDO_ITEM ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''CMP_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_BIUD0 FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'DECLARE KDOMAIN      SYS$FKGUID20 = null ;'
  +#13#10'DECLARE DATA_EMISSAO SYS$DATE;'
  +#13#10'DECLARE DATA_ENTRADA SYS$DATE;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT KCAD_FAZENDA, DATA_EMISSAO, DATA_ENTRADA'
  +#13#10'  FROM CMP_PEDIDOS'
  +#13#10'  WHERE KCMP_PEDIDO = IIF ( inserting or updating, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO )'
  +#13#10'  INTO KDOMAIN, DATA_EMISSAO, DATA_ENTRADA ;'
  +#13#10''
  +#13#10'  IF ( DELETING AND KDOMAIN IS NULL  ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_EMISSAO ;'
  +#13#10''
  +#13#10'  IF ( DATA_ENTRADA IS DISTINCT FROM DATA_EMISSAO ) THEN'
  +#13#10'     EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES KDOMAIN, DATA_ENTRADA ;'
  +#13#10''
  +#13#10'  IF ( ( INSERTING OR UPDATING ) AND ( NEW.KEST_PRODUTO IS NOT NULL ) ) THEN'
  +#13#10'     EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  KDOMAIN, NEW.KEST_PRODUTO, DATA_ENTRADA ;'
  +#13#10''
  +#13#10'  IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE FIN_DELETE_APROPRIACAO KDOMAIN, ''CMP_PEDIDO_ITENS'', OLD.KCMP_PEDIDO_ITEM ;'
  +#13#10''
  +#13#10'END' ) ;

  ExecuteDirect (
  'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10''
  +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
  +#13#10'DECLARE KCAD_ENTIDADE   SYS$FKGUID20;'
  +#13#10'DECLARE NOMEENTIDADE    SYS$DESCR;'
  +#13#10'DECLARE DATA            SYS$DATE;'
  +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
  +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
  +#13#10'DECLARE KCMP_PEDIDO     SYS$FKGUID20  = NULL ;'
  +#13#10''
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
  +#13#10'     ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
  +#13#10''
  +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
  +#13#10'    FROM CMP_PEDIDOS'
  +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
  +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
  +#13#10''
  +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  IF (    UPDATING'
  +#13#10'      AND ('
  +#13#10'                ( OLD.KCMP_PEDIDO_ITEM IS DISTINCT FROM NEW.KCMP_PEDIDO_ITEM )'
  +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
  +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
  +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
  +#13#10'                )'
  +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
  +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
  +#13#10'                )'
  +#13#10'          )'
  +#13#10'     ) THEN'
  +#13#10'   BEGIN'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
  +#13#10'                                                KDOMAIN,'
  +#13#10'                                                OLD.KEST_PRODUTO,'
  +#13#10'                                                DATA,'
  +#13#10'                                                ''E'','
  +#13#10'                                                OLD.QTDE,'
  +#13#10'                                                OLD.CUSTO,'
  +#13#10'                                                ''CMP_PEDIDO_ITENS'','
  +#13#10'                                                OLD.KCMP_PEDIDO_ITEM'
  +#13#10'                                                );'
  +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
  +#13#10'          EXIT ;'
  +#13#10''
  +#13#10'   END'
  +#13#10''
  +#13#10''
  +#13#10'  IF (INSERTING) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
  +#13#10'        UPDATE EST_PRODUTOS'
  +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
  +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
  +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
  +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
  +#13#10'  ELSE'
  +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
  +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  BAIXA_ESTOQUE = NULL ;'
  +#13#10''
  +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
  +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
  +#13#10'    INTO BAIXA_ESTOQUE ;'
  +#13#10''
  +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
  +#13#10'    KEST_PRODUTO = NULL ;'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
  +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
  +#13#10'                                             when Inserting then ''I'''
  +#13#10'                                             when Updating  then ''U'''
  +#13#10'                                             when Deleting  then ''D'''
  +#13#10'                                             end,'
  +#13#10'                                             KDOMAIN,'
  +#13#10'                                             KEST_PRODUTO,'
  +#13#10'                                             DATA,'
  +#13#10'                                             ''E'','
  +#13#10'                                             NEW.QTDE,'
  +#13#10'                                             NEW.CUSTO,'
  +#13#10'                                             ''CMP_PEDIDO_ITENS'','
  +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM )'
  +#13#10'                                             );'
  +#13#10''
  +#13#10'END' ) ;

end;

procedure TDBFinanceiroUpdate._5_000_82;
begin


   ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_OUTRAS_ENTRADAS_SAIDA_BIUD0 FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'    BEGIN'
  +#13#10'       EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM NEW.KSYS$DOMAIN, NEW.KEST_PRODUTO, NEW.DATA ;'
  +#13#10'       EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( updating ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'          OR ( NEW.DATA         IS DISTINCT FROM  OLD.DATA ) ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, NEW.KEST_PRODUTO, NEW.DATA ;'
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA ;'
  +#13#10''
  +#13#10'  IF (     ( INSERTING OR UPDATING )'
  +#13#10'       AND ( NEW.CODIGO_LANCAMENTO IS NULL )'
  +#13#10'     ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( NEW.TIPO = ''E'' ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_ENTRADAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'      ELSE IF ( NEW.TIPO = ''S'' ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_SAIDAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'      ELSE'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_ENTRADAS_SAIDAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'   IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''EST_OUTRAS_ENTRADAS_SAIDAS'', OLD.KEST_OUTRA_ENTRADA_SAIDA ;'
  +#13#10''
  +#13#10'END' ) ;


  TryExecuteDirect ( 'DROP TRIGGER FIN_APAGAR_PARCELAS_BI0'  ) ;
  TryExecuteDirect ( 'DROP TRIGGER EST_PRODUTOS_BIU0' ) ;

   ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_PRODUTOS_BIUD0 FOR EST_PRODUTOS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( INSERTING ) THEN'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'      IF ( NEW.CODIGO IS NULL ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KCAD_FAZENDA, ''EST_PRODUTOS_CODIGO'' )'
  +#13#10'        INTO NEW.CODIGO ;'
  +#13#10''
  +#13#10'      IF ( NEW.DATA_CADASTRO IS NULL ) THEN'
  +#13#10'         NEW.DATA_CADASTRO = CURRENT_DATE;'
  +#13#10''
  +#13#10'      NEW.CUSTO_MEDIO_MOVTO = COALESCE( NEW.CUSTO_INICIAL, 0 );'
  +#13#10'    END'
  +#13#10'  ELSE IF ( UPDATING ) THEN'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF (    ( NEW.BAIXA_ESTOQUE IS DISTINCT FROM OLD.BAIXA_ESTOQUE )'
  +#13#10'          AND ( NEW.BAIXA_ESTOQUE IS DISTINCT FROM ''T'' )'
  +#13#10'          AND ( EXISTS'
  +#13#10'                (SELECT 1'
  +#13#10'                   FROM EST_MOVIMENTO'
  +#13#10'                  WHERE KCAD_FAZENDA = NEW.KCAD_FAZENDA'
  +#13#10'                    AND KEST_PRODUTO = NEW.KEST_PRODUTO'
  +#13#10'                    AND TIPO <> ''C'''
  +#13#10'                  ROWS 1'
  +#13#10'                )'
  +#13#10'              )'
  +#13#10'          ) THEN'
  +#13#10'         EXCEPTION SYS$EXCEPTION ''Existe movimentação de estoque do produto. Não é possivel alterar baixa de estoque.'' ;'
  +#13#10''
  +#13#10'      IF (   ( NEW.DATA_SALDOINICIAL IS DISTINCT FROM OLD.DATA_SALDOINICIAL )'
  +#13#10'          OR ( NEW.QTDE_INICIAL  IS DISTINCT FROM OLD.QTDE_INICIAL )'
  +#13#10'          OR ( NEW.CUSTO_INICIAL IS DISTINCT FROM OLD.CUSTO_INICIAL )'
  +#13#10'         ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          IF ( EXISTS'
  +#13#10'                (SELECT 1'
  +#13#10'                  FROM EST_MOVIMENTO'
  +#13#10'                  WHERE KCAD_FAZENDA = NEW.KCAD_FAZENDA'
  +#13#10'                    AND KEST_PRODUTO = NEW.KEST_PRODUTO'
  +#13#10'                    AND TIPO <> ''C'''
  +#13#10'                    AND CAST( DATA AS DATE ) < CAST( NEW.DATA_SALDOINICIAL AS DATE )'
  +#13#10'                    ROWS 1'
  +#13#10'                )'
  +#13#10'             ) THEN'
  +#13#10'         EXCEPTION SYS$EXCEPTION ''Existe movimentação do produto anterior a data de saldo inicial'' ;'
  +#13#10''
  +#13#10'         EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KCAD_FAZENDA, NEW.DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'        END'
  +#13#10'    END'
  +#13#10'  ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''EST_PRODUTOS'', OLD.KEST_PRODUTO ;'
  +#13#10''
  +#13#10'END' ) ;

end;

procedure TDBFinanceiroUpdate._5_000_80;
begin
  ExecuteDirect ( 'DELETE FROM SYS$TYPES WHERE SYS$TYPE = ''STATUS_PRODUCAO'' AND SYS$VALUE >= 1 AND SYS$VALUE NOT IN ( 1,2,4,10,43,50 )' ) ;
end;


procedure TDBFinanceiroUpdate._5_000_76;
const

  _ALTER_TRG_FIN_TRANSFERENCIAS_AI0 =
          'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AI0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER INSERT POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE PK SYS$FKGUID20;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   /* DEBITO */'
  +#13#10''
  +#13#10'   PK = GUID20();'
  +#13#10'   INSERT INTO FIN_APAGAR'
  +#13#10'     ( KFIN_APAGAR, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'   VALUES'
  +#13#10'     ( :PK, NEW.KSYS$DOMAIN, NEW.KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || NEW.DOC_ORGIGEM, NULL, ''FIN_TRANSFERENCIAS'', NEW.KFIN_TRANSFERENCIA, NEW.OBS);'
  +#13#10''
  +#13#10'   INSERT INTO FIN_APAGAR_PARCELAS'
  +#13#10'     ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'   VALUES'
  +#13#10'     ( GUID20(), :PK, ''TC'' || NEW.DOC_ORGIGEM, NEW.DATA, NEW.VALOR, NEW.DATA, NEW.DATA, NEW.VALOR, NEW.KFIN_CONTA_ORIGEM );'
  +#13#10''
  +#13#10''
  +#13#10''
  +#13#10'   /* CREDITO */'
  +#13#10''
  +#13#10'   PK = GUID20();'
  +#13#10''
  +#13#10'   INSERT INTO FIN_ARECEBER'
  +#13#10'     ( KFIN_ARECEBER, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'   VALUES'
  +#13#10'     ( :PK, NEW.KSYS$DOMAIN, NEW.KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || NEW.DOC_DESTINO, NULL, ''FIN_TRANSFERENCIAS'', NEW.KFIN_TRANSFERENCIA, NEW.OBS);'
  +#13#10''
  +#13#10'   INSERT INTO FIN_ARECEBER_PARCELAS'
  +#13#10'     ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, DT_COMPENSACAO, PAGO, KFIN_CONTA )'
  +#13#10'   VALUES'
  +#13#10'     ( GUID20(), :PK, ''TC'' || NEW.DOC_ORGIGEM, NEW.DATA, NEW.VALOR, NEW.DATA, NEW.DATA, NEW.VALOR, NEW.KFIN_CONTA_DESTINO );'
  +#13#10''
  +#13#10''
  +#13#10'END'  ;


  _ALTER_TRG_FIN_TRANSFERENCIAS_AU0 =
         'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AU0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER UPDATE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE VARIABLE PK SYS$FKGUID20;'
  +#13#10'--DECLARE VARIABLE VHISTORICO VARCHAR(60);'
  +#13#10'begin'
  +#13#10''
  +#13#10'--   VHISTORICO = NEW.HISTORICO;'
  +#13#10''
  +#13#10'--   IF (:VHISTORICO IS NULL) THEN'
  +#13#10'--     VHISTORICO = ''TRANSFERÊNCIA N° '' || NEW.KFIN_TRANSFERENCIA ;'
  +#13#10''
  +#13#10'   /* DEBITO */'
  +#13#10'   SELECT KFIN_APAGAR'
  +#13#10'   FROM FIN_APAGAR'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA'
  +#13#10'   INTO :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_APAGAR SET'
  +#13#10'--     HISTORICO = :VHISTORICO,'
  +#13#10'     OBS = NEW.OBS'
  +#13#10'   WHERE KFIN_APAGAR = :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_APAGAR_PARCELAS SET'
  +#13#10'     PAGTO = NEW.DATA,'
  +#13#10'     DT_COMPENSACAO = NEW.DATA,'
  +#13#10'     PAGO = NEW.VALOR,'
  +#13#10'     KFIN_CONTA = NEW.KFIN_CONTA_ORIGEM'
  +#13#10'   WHERE KFIN_APAGAR = :PK ;'
  +#13#10''
  +#13#10'   /* CREDITO */'
  +#13#10'   SELECT KFIN_ARECEBER'
  +#13#10'   FROM FIN_ARECEBER'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA'
  +#13#10'   INTO :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_ARECEBER SET'
  +#13#10'--     HISTORICO = :VHISTORICO,'
  +#13#10'     OBS = NEW.OBS'
  +#13#10'   WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_ARECEBER_PARCELAS SET'
  +#13#10'     PAGTO = NEW.DATA,'
  +#13#10'     DT_COMPENSACAO = NEW.DATA,'
  +#13#10'     PAGO = NEW.VALOR,'
  +#13#10'     KFIN_CONTA = NEW.KFIN_CONTA_DESTINO'
  +#13#10'   WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'END' ;

begin
  TryExecuteDirect ( _ALTER_TRG_FIN_TRANSFERENCIAS_AI0 ) ;
  ExecuteDirect (  _ALTER_TRG_FIN_TRANSFERENCIAS_AU0 ) ;
end;


procedure TDBFinanceiroUpdate._5_000_74;
begin
  ExecuteDirect (
         'CREATE OR ALTER TRIGGER RLOG$FIN_TRANSFERENCIAS FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE POSITION 15000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  if ( (RDB$GET_CONTEXT( ''USER_SESSION'',     ''RLOG$OFF'' ) = ''1'')'
  +#13#10'    OR (RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) = ''1'') ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  if ( inserting ) then'
  +#13#10'  begin'
  +#13#10'    if ( NEW.SYS$UI is NULL ) then'
  +#13#10'      NEW.SYS$UI = RDB$GET_CONTEXT ( ''USER_SESSION'', ''USERNAME'' ) ;'
  +#13#10'    if ( NEW.SYS$DI is NULL ) then'
  +#13#10'      NEW.SYS$DI = CURRENT_TIMESTAMP ;'
  +#13#10'  end'
  +#13#10''
  +#13#10'  if ( updating ) then'
  +#13#10'  begin'
  +#13#10'     NEW.SYS$UU = RDB$GET_CONTEXT ( ''USER_SESSION'', ''USERNAME'' ) ;'
  +#13#10'     NEW.SYS$DU = CURRENT_TIMESTAMP ;'
  +#13#10'  end'
  +#13#10''
  +#13#10'END' ) ;

end ;

{ TDBFinanceiroUpdate }
procedure TDBFinanceiroUpdate._5_000_66;
begin

  ExecuteDirect ( 'DELETE FROM ECRM$IUD' ) ;

  TryExecuteDirect (
         'ALTER TABLE ECRM$IUD'
  +#13#10'ADD   RELATED_TABLENAME SYS$TABLENAME,'
  +#13#10'ALTER RELATED_TABLENAME POSITION 4' ) ;

  TryExecuteDirect (
         'ALTER TABLE ECRM$IUD'
  +#13#10'ADD   RELATED_TABLEKEY SYS$FKGUID20,'
  +#13#10'ALTER RELATED_TABLENAME POSITION 4' ) ;

  TryExecuteDirect (
         'ALTER TABLE ECRM$IUD'
  +#13#10'ADD   SYS$DU SYS$DATE,'
  +#13#10'ALTER SYS$DU POSITION 8' ) ;

  ExecuteDirect (
         'CREATE OR ALTER PROCEDURE ECRM$UPDATE_IUD('
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$PKGUID20,'
  +#13#10'    IUD SYS$IUD,'
  +#13#10'    RELATED_TABLENAME SYS$TABLENAME = NULL,'
  +#13#10'    RELATED_TABLEKEY SYS$FKGUID20 = NULL)'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( IUD IN ( ''U'', ''D'' ) ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE ECRM$IUD'
  +#13#10'      SET KECRM$IUD = NEXT VALUE FOR ECRM$IUD,'
  +#13#10'          IUD       = :IUD,'
  +#13#10'          SYS$DU    = ''NOW'''
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD IN ( ''I'', ''U'', ''D'' ) ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF ( ( IUD = ''I'' ) OR ( ROW_COUNT = 0 ) ) THEN'
  +#13#10'     INSERT INTO ECRM$IUD'
  +#13#10'       ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'     VALUES'
  +#13#10'       ( NEXT VALUE FOR ECRM$IUD, :TABLENAME, :TABLEKEY, :RELATED_TABLENAME, :RELATED_TABLEKEY, :IUD, ''NOW'', ''NOW'' ) ;'
  +#13#10''
  +#13#10'END' ) ;

  (*

  ExecuteDirect (
         'CREATE OR ALTER PROCEDURE ECRM$UPDATE_IUD('
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$PKGUID20,'
  +#13#10'    IUD SYS$IUD,'
  +#13#10'    RELATED_TABLENAME SYS$TABLENAME = NULL,'
  +#13#10'    RELATED_TABLEKEY SYS$FKGUID20 = NULL)'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( IUD = ''U'' )  THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE ECRM$IUD'
  +#13#10'      SET KECRM$IUD = NEXT VALUE FOR ECRM$IUD,'
  +#13#10'          SYS$DI    = CURRENT_TIMESTAMP'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD = ''U'' ) ;'
  +#13#10'    END'
  +#13#10'  ELSE if ( IUD = ''D'' ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      DELETE FROM ECRM$IUD'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'       AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'       AND IUD = ''U'' ;'
  +#13#10''
  +#13#10'      DELETE FROM ECRM$IUD'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD = ''I'' ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF (  (( IUD = ''I'' ) OR ( ROW_COUNT = 0 ))'
  +#13#10'      AND (         ( IUD <> ''U'' )'
  +#13#10'           OR (     ( IUD = ''U'' )'
  +#13#10'                AND ( NOT EXISTS ( SELECT 1 FROM ECRM$IUD'
  +#13#10'                         WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'                           AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'                           AND ( IUD = ''I'' ) )'
  +#13#10'                     )'
  +#13#10'              )'
  +#13#10'         )'
  +#13#10'     ) THEN'
  +#13#10'        INSERT INTO ECRM$IUD'
  +#13#10'          ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI )'
  +#13#10'        VALUES'
  +#13#10'          ( NEXT VALUE FOR ECRM$IUD, :TABLENAME, :TABLEKEY, :RELATED_TABLENAME, :RELATED_TABLEKEY, :IUD, CURRENT_TIMESTAMP ) ;'
  +#13#10''
  +#13#10'END' ) ;
    *)


  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CAD_PATRIMONIO_DEPRECIACOE FOR CAD_PATRIMONIO_DEPRECIACOES'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CAD_PATRIMONIO_DEPRECIACOES'','
  +#13#10'    IIF ( INSERTING, NEW.KCAD_PATRIMONIO_DEPRECIACAO, OLD.KCAD_PATRIMONIO_DEPRECIACAO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''CAD_PATRIMONIOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCAD_PATRIMONIO, OLD.KCAD_PATRIMONIO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APROPRIACAO FOR FIN_APROPRIACAO'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_APROPRIACAO'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_APROPRIACAO, OLD.KFIN_APROPRIACAO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    IIF ( INSERTING, NEW.TABLENAME, OLD.TABLENAME ),'
  +#13#10'    IIF ( INSERTING, NEW.TABLEKEY,  OLD.TABLEKEY ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APAGAR FOR FIN_APAGAR'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'DECLARE TABLENAME SYS$TABLENAME ;'
  +#13#10'DECLARE TABLEKEY  SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', NEW.KFIN_APAGAR, ''I'' ;'
  +#13#10'   ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', OLD.KFIN_APAGAR, ''D'' ;'
  +#13#10'   ELSE IF (OLD.RECORRENCIA IS DISTINCT FROM NEW.RECORRENCIA) then'
  +#13#10'      BEGIN'
  +#13#10'        IF ( NEW.RECORRENCIA = ''T'' ) THEN'
  +#13#10'           BEGIN'
  +#13#10'             EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', NEW.KFIN_APAGAR, ''D'' ;'
  +#13#10''
  +#13#10'             FOR SELECT'
  +#13#10'                IIF ( A.KFIN_APROPRIACAO IS NULL, P.KFIN_APAGAR_PARCELA, A.KFIN_APROPRIACAO ),  COALESCE ( A.KFIN_APROPRIACAO, P.KFIN_APAGAR_PARCELA )'
  +#13#10'             FROM FIN_APAGAR_PARCELAS P'
  +#13#10'             LEFT JOIN FIN_APROPRIACAO A ON A.TABLENAME = ''FIN_APAGAR'' AND A.TABLEKEY = NEW.KFIN_APAGAR'
  +#13#10'             WHERE P.KFIN_APAGAR = NEW.KFIN_APAGAR'
  +#13#10'             INTO TABLENAME, TABLEKEY'
  +#13#10'             DO'
  +#13#10'               EXECUTE PROCEDURE ECRM$UPDATE_IUD TABLENAME, TABLEKEY, ''U'', ''FIN_APAGAR'', NEW.KFIN_APAGAR ;'
  +#13#10'           END'
  +#13#10'        ELSE'
  +#13#10'           BEGIN'
  +#13#10'             FOR SELECT'
  +#13#10'                IIF ( A.KFIN_APROPRIACAO IS NULL, P.KFIN_APAGAR_PARCELA, A.KFIN_APROPRIACAO ),  COALESCE ( A.KFIN_APROPRIACAO, P.KFIN_APAGAR_PARCELA )'
  +#13#10'             FROM FIN_APAGAR_PARCELAS P'
  +#13#10'             LEFT JOIN FIN_APROPRIACAO A ON A.TABLENAME = ''FIN_APAGAR'' AND A.TABLEKEY = NEW.KFIN_APAGAR'
  +#13#10'             WHERE P.KFIN_APAGAR = NEW.KFIN_APAGAR'
  +#13#10'             INTO TABLENAME, TABLEKEY'
  +#13#10'             DO'
  +#13#10'               EXECUTE PROCEDURE ECRM$UPDATE_IUD TABLENAME, TABLEKEY, ''D'', ''FIN_APAGAR'', NEW.KFIN_APAGAR ;'
  +#13#10''
  +#13#10'             EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', NEW.KFIN_APAGAR, ''I'' ;'
  +#13#10'           END'
  +#13#10'      END'
  +#13#10'   ELSE'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', NEW.KFIN_APAGAR, ''U'' ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APAGAR_PARCELAS FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_APAGAR_PARCELAS'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_APAGAR_PARCELA, OLD.KFIN_APAGAR_PARCELA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''FIN_APAGAR'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_APAGAR, OLD.KFIN_APAGAR ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDO_ITENS FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDO_ITENS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO_ITEM, OLD.KCMP_PEDIDO_ITEM ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''CMP_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDO_SERVICOS FOR CMP_PEDIDO_SERVICOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDO_SERVICOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO_SERVICO, OLD.KCMP_PEDIDO_SERVICO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''CMP_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$VND_PEDIDO_ITENS FOR VND_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''VND_PEDIDO_ITENS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO_ITEM, OLD.KVND_PEDIDO_ITEM ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''VND_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO, OLD.KVND_PEDIDO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$VND_PEDIDO_SERVICOS FOR VND_PEDIDO_SERVICOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''VND_PEDIDO_SERVICOS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO_SERVICO, OLD.KVND_PEDIDO_SERVICO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''VND_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO, OLD.KVND_PEDIDO ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_ARECEBER FOR FIN_ARECEBER'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'DECLARE TABLENAME SYS$TABLENAME ;'
  +#13#10'DECLARE TABLEKEY  SYS$FKGUID20 ;'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', NEW.KFIN_ARECEBER, ''I'' ;'
  +#13#10'   ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', OLD.KFIN_ARECEBER, ''D'' ;'
  +#13#10'   ELSE IF (OLD.RECORRENCIA IS DISTINCT FROM NEW.RECORRENCIA) then'
  +#13#10'      BEGIN'
  +#13#10'        IF ( NEW.RECORRENCIA = ''T'' ) THEN'
  +#13#10'           BEGIN'
  +#13#10'             EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', NEW.KFIN_ARECEBER, ''D'' ;'
  +#13#10''
  +#13#10'             FOR SELECT'
  +#13#10'                IIF ( A.KFIN_APROPRIACAO IS NULL, P.KFIN_ARECEBER_PARCELA, A.KFIN_APROPRIACAO ),  COALESCE ( A.KFIN_APROPRIACAO, P.KFIN_ARECEBER_PARCELA )'
  +#13#10'             FROM FIN_ARECEBER_PARCELAS P'
  +#13#10'             LEFT JOIN FIN_APROPRIACAO A ON A.TABLENAME = ''FIN_ARECEBER'' AND A.TABLEKEY = NEW.KFIN_ARECEBER'
  +#13#10'             WHERE P.KFIN_ARECEBER = NEW.KFIN_ARECEBER'
  +#13#10'             INTO TABLENAME, TABLEKEY'
  +#13#10'             DO'
  +#13#10'               EXECUTE PROCEDURE ECRM$UPDATE_IUD TABLENAME, TABLEKEY, ''U'', ''FIN_ARECEBER'', NEW.KFIN_ARECEBER ;'
  +#13#10'           END'
  +#13#10'        ELSE'
  +#13#10'           BEGIN'
  +#13#10'             FOR SELECT'
  +#13#10'                IIF ( A.KFIN_APROPRIACAO IS NULL, P.KFIN_ARECEBER_PARCELA, A.KFIN_APROPRIACAO ),  COALESCE ( A.KFIN_APROPRIACAO, P.KFIN_ARECEBER_PARCELA )'
  +#13#10'             FROM FIN_ARECEBER_PARCELAS P'
  +#13#10'             LEFT JOIN FIN_APROPRIACAO A ON A.TABLENAME = ''FIN_ARECEBER'' AND A.TABLEKEY = NEW.KFIN_ARECEBER'
  +#13#10'             WHERE P.KFIN_ARECEBER = NEW.KFIN_ARECEBER'
  +#13#10'             INTO TABLENAME, TABLEKEY'
  +#13#10'             DO'
  +#13#10'               EXECUTE PROCEDURE ECRM$UPDATE_IUD TABLENAME, TABLEKEY, ''D'', ''FIN_ARECEBER'', NEW.KFIN_ARECEBER ;'
  +#13#10''
  +#13#10'             EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', NEW.KFIN_ARECEBER, ''I'' ;'
  +#13#10'           END'
  +#13#10'      END'
  +#13#10'   ELSE'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', NEW.KFIN_ARECEBER, ''U'' ;'
  +#13#10'END' ) ;

   ExecuteDirect (
          'CREATE OR ALTER TRIGGER ECRM$FIN_ARECEBER_PARCELAS FOR FIN_ARECEBER_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_ARECEBER_PARCELAS'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_ARECEBER_PARCELA, OLD.KFIN_ARECEBER_PARCELA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END,'
  +#13#10'    ''FIN_ARECEBER'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_ARECEBER, OLD.KFIN_ARECEBER ) ;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$EST_OUTRAS_ENTRADAS_SAIDAS FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''EST_MOVIMENTO'','
  +#13#10'    IIF ( INSERTING, NEW.KEST_OUTRA_ENTRADA_SAIDA, OLD.KEST_OUTRA_ENTRADA_SAIDA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;


  ExecuteDirect (
         'EXECUTE BLOCK'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( (SELECT COUNT(*) FROM ECRM$IUD) > 0 ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_PLANOCONTAS'', KFIN_PLANOCONTA, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_PLANOCONTAS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_CENTROSCUSTO'', KFIN_CENTROCUSTO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_CENTROSCUSTO ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''CAD_PATRIMONIOS'', KCAD_PATRIMONIO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM CAD_PATRIMONIOS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''CAD_PATRIMONIO_DEPRECIACOES'', KCAD_PATRIMONIO_DEPRECIACAO, ''CAD_PATRIMONIOS'', KCAD_PATRIMONIO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM CAD_PATRIMONIO_DEPRECIACOES ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_APROPRIACAO'', KFIN_APROPRIACAO, TABLENAME, TABLEKEY, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_APROPRIACAO ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_APAGAR'', KFIN_APAGAR, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_APAGAR ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_APAGAR_PARCELAS'', KFIN_APAGAR_PARCELA, ''FIN_APAGAR'', KFIN_APAGAR, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_APAGAR_PARCELAS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''CMP_PEDIDOS'', KCMP_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM CMP_PEDIDOS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM, ''CMP_PEDIDOS'', KCMP_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM CMP_PEDIDO_ITENS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO, ''CMP_PEDIDOS'', KCMP_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM CMP_PEDIDO_SERVICOS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''VND_PEDIDOS'', KVND_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM VND_PEDIDOS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''VND_PEDIDO_ITENS'', KVND_PEDIDO_ITEM, ''VND_PEDIDOS'', KVND_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM VND_PEDIDO_ITENS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''VND_PEDIDO_SERVICOS'', KVND_PEDIDO_SERVICO, ''VND_PEDIDOS'', KVND_PEDIDO, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM VND_PEDIDO_SERVICOS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_ARECEBER'', KFIN_ARECEBER, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_ARECEBER ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, RELATED_TABLENAME, RELATED_TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''FIN_ARECEBER_PARCELAS'', KFIN_ARECEBER_PARCELA, ''FIN_ARECEBER'', KFIN_ARECEBER, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM FIN_ARECEBER_PARCELAS ;'
  +#13#10''
  +#13#10'  INSERT INTO ECRM$IUD ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI, SYS$DU )'
  +#13#10'  SELECT GEN_ID( ECRM$IUD, 1 ), ''EST_OUTRAS_ENTRADAS_SAIDAS'', KEST_OUTRA_ENTRADA_SAIDA, ''I'', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM EST_OUTRAS_ENTRADAS_SAIDAS ;'
  +#13#10'END' ) ;

  TryExecuteDirect (
       'CREATE INDEX IXECRM$IUD_01 ON ECRM$IUD (TABLENAME, TABLEKEY)') ;


  TryExecuteDirect (
         'CREATE TABLE FIN_TRANSFERENCIAS ('
  +#13#10'    KFIN_TRANSFERENCIA SYS$PKGUID20,'
  +#13#10'    KSYS$DOMAIN        SYS$FKGUID20,'
  +#13#10'    DATA               SYS$DATE_NN,'
  +#13#10'    DOC_ORGIGEM        SYS$SHDESCR,'
  +#13#10'    DOC_DESTINO        SYS$SHDESCR,'
  +#13#10'    KFIN_CONTA_ORIGEM  SYS$FKGUID20_NN,'
  +#13#10'    KFIN_CONTA_DESTINO SYS$FKGUID20_NN,'
  +#13#10'    VALOR              SYS$FLOAT,'
  +#13#10'    OBS                SYS$BLOBTEXT,'
  +#13#10'    SYS$UI             SYS$USERLOGIN,'
  +#13#10'    SYS$DI             SYS$DATE,'
  +#13#10'    SYS$UU             SYS$USERLOGIN,'
  +#13#10'    SYS$DU             SYS$DATE'
  +#13#10')' ) ;

  TryExecuteDirect (
              'ALTER TABLE FIN_TRANSFERENCIAS'
       +#13#10'ADD CONSTRAINT PKFIN_TRANSFERENCIAS PRIMARY KEY (KFIN_TRANSFERENCIA)' ) ;

  TryExecuteDirect (
              'ALTER TABLE FIN_TRANSFERENCIAS'
       +#13#10'ADD CONSTRAINT FKFIN_TRANSFERENCIAS_01 FOREIGN KEY (KSYS$DOMAIN)'
       +#13#10'REFERENCES SYS$DOMAINS (KSYS$DOMAIN) ON DELETE CASCADE ON UPDATE CASCADE' ) ;

  TryExecuteDirect (
              'ALTER TABLE FIN_TRANSFERENCIAS'
       +#13#10'ADD CONSTRAINT FKFIN_TRANSFERENCIAS_02 FOREIGN KEY (KFIN_CONTA_ORIGEM)'
       +#13#10'REFERENCES FIN_CONTAS (KFIN_CONTA) ON UPDATE CASCADE') ;

  TryExecuteDirect (
              'ALTER TABLE FIN_TRANSFERENCIAS'
       +#13#10'ADD CONSTRAINT FKFIN_TRANSFERENCIAS_03 FOREIGN KEY (KFIN_CONTA_DESTINO)'
       +#13#10'REFERENCES FIN_CONTAS (KFIN_CONTA) ON UPDATE CASCADE') ;


  ExecuteDirect (
       'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AD0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER DELETE POSITION 20001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   /* DEBITO */'
  +#13#10'   DELETE FROM FIN_APAGAR'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA ;'
  +#13#10''
  +#13#10'   /* CREDITO */'
  +#13#10'   DELETE FROM FIN_ARECEBER'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA ;'
  +#13#10''
  +#13#10'END' ) ;


  TryExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AI0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER INSERT POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE PK SYS$FKGUID20;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   /* DEBITO */'
  +#13#10''
  +#13#10'   PK = GUID20();'
  +#13#10'   INSERT INTO FIN_APAGAR'
  +#13#10'     ( KFIN_APAGAR, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'   VALUES'
  +#13#10'     ( :PK, NEW.KSYS$DOMAIN, NEW.KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || NEW.DOC_ORGIGEM, NULL, ''FIN_TRANSFERENCIAS'', NEW.KFIN_TRANSFERENCIA, NEW.OBS);'
  +#13#10''
  +#13#10'   INSERT INTO FIN_APAGAR_PARCELAS'
  +#13#10'     ( KFIN_APAGAR_PARCELA, KFIN_APAGAR, DOCUMENTO, VENCTO, VALOR, PAGTO, PAGO, KFIN_CONTA )'
  +#13#10'   VALUES'
  +#13#10'     ( GUID20(), :PK, ''TC'' || NEW.DOC_ORGIGEM, NEW.DATA, NEW.VALOR, NEW.DATA, NEW.VALOR, NEW.KFIN_CONTA_ORIGEM );'
  +#13#10''
  +#13#10''
  +#13#10''
  +#13#10'   /* CREDITO */'
  +#13#10''
  +#13#10'   PK = GUID20();'
  +#13#10''
  +#13#10'   INSERT INTO FIN_ARECEBER'
  +#13#10'     ( KFIN_ARECEBER, KSYS$DOMAIN, KCAD_FAZENDA, HISTORICO, KCAD_ENTIDADE, DOCUMENTO, KFIN_PLANOCONTA, TABLENAME, TABLEKEY, OBS)'
  +#13#10'   VALUES'
  +#13#10'     ( :PK, NEW.KSYS$DOMAIN, NEW.KSYS$DOMAIN, ''Transferência: '', NULL, ''TC'' || NEW.DOC_DESTINO, NULL, ''FIN_TRANSFERENCIAS'', NEW.KFIN_TRANSFERENCIA, NEW.OBS);'
  +#13#10''
  +#13#10'   INSERT INTO FIN_ARECEBER_PARCELAS'
  +#13#10'     ( KFIN_ARECEBER_PARCELA, KFIN_ARECEBER, DOCUMENTO, VENCTO, VALOR, PAGTO, PAGO, KFIN_CONTA )'
  +#13#10'   VALUES'
  +#13#10'     ( GUID20(), :PK, ''TC'' || NEW.DOC_ORGIGEM, NEW.DATA, NEW.VALOR, NEW.DATA, NEW.VALOR, NEW.KFIN_CONTA_DESTINO );'
  +#13#10''
  +#13#10''
  +#13#10'END' ) ;

  ExecuteDirect (
       'CREATE OR ALTER TRIGGER FIN_TRANSFERENCIAS_AU0 FOR FIN_TRANSFERENCIAS'
  +#13#10'ACTIVE AFTER UPDATE POSITION 20001'
  +#13#10'AS'
  +#13#10'DECLARE VARIABLE PK INTEGER;'
  +#13#10'--DECLARE VARIABLE VHISTORICO VARCHAR(60);'
  +#13#10'begin'
  +#13#10''
  +#13#10'--   VHISTORICO = NEW.HISTORICO;'
  +#13#10''
  +#13#10'--   IF (:VHISTORICO IS NULL) THEN'
  +#13#10'--     VHISTORICO = ''TRANSFERÊNCIA N° '' || NEW.KFIN_TRANSFERENCIA ;'
  +#13#10''
  +#13#10'   /* DEBITO */'
  +#13#10'   SELECT KFIN_APAGAR'
  +#13#10'   FROM FIN_APAGAR'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA'
  +#13#10'   INTO :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_APAGAR SET'
  +#13#10'--     HISTORICO = :VHISTORICO,'
  +#13#10'     OBS = NEW.OBS'
  +#13#10'   WHERE KFIN_APAGAR = :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_APAGAR_PARCELAS SET'
  +#13#10'     PAGTO = NEW.DATA,'
  +#13#10'     PAGO = NEW.VALOR,'
  +#13#10'     KFIN_CONTA = NEW.KFIN_CONTA_ORIGEM'
  +#13#10'   WHERE KFIN_APAGAR = :PK ;'
  +#13#10''
  +#13#10'   /* CREDITO */'
  +#13#10'   SELECT KFIN_ARECEBER'
  +#13#10'   FROM FIN_ARECEBER'
  +#13#10'   WHERE TABLENAME = ''FIN_TRANSFERENCIAS'''
  +#13#10'     AND TABLEKEY = OLD.KFIN_TRANSFERENCIA'
  +#13#10'   INTO :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_ARECEBER SET'
  +#13#10'--     HISTORICO = :VHISTORICO,'
  +#13#10'     OBS = NEW.OBS'
  +#13#10'   WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'   UPDATE FIN_ARECEBER_PARCELAS SET'
  +#13#10'     PAGTO = NEW.DATA,'
  +#13#10'     PAGO = NEW.VALOR,'
  +#13#10'     KFIN_CONTA = NEW.KFIN_CONTA_DESTINO'
  +#13#10'   WHERE KFIN_ARECEBER = :PK ;'
  +#13#10''
  +#13#10'END' ) ;

end;

procedure TDBFinanceiroUpdate._5_000_61;
begin
   TryExecuteDirect (
       'CREATE INDEX IXFIN_APROPRIACAO_01 ON FIN_APROPRIACAO (TABLENAME, TABLEKEY)') ;

   TryExecuteDirect (
   'CREATE SEQUENCE ECRM$IUD' ) ;

   TryExecuteDirect (
       'CREATE DOMAIN SYS$IUD AS'
+#13#10'CHAR(1) CHARACTER SET OCTETS'
+#13#10'NOT NULL'
+#13#10'CHECK (VALUE IN ( ''I'', ''U'', ''D'' ))'
+#13#10'COLLATE OCTETS' ) ;

   TryExecuteDirect (
         'CREATE TABLE ECRM$IUD ('
  +#13#10'    KECRM$IUD  SYS$INT_NN,'
  +#13#10'    TABLENAME  SYS$TABLENAME_NN,'
  +#13#10'    TABLEKEY   SYS$PKGUID20,'
  +#13#10'    IUD        SYS$IUD,'
  +#13#10'    SYS$DI     SYS$DATE_DEF'
  +#13#10')' ) ;


               TryExecuteDirect (
  'ALTER TABLE ECRM$IUD ADD CONSTRAINT PKECRM$IUD PRIMARY KEY (KECRM$IUD)' ) ;


                 TryExecuteDirect (
'CREATE INDEX IXECRM$IUD_01 ON ECRM$IUD (TABLENAME, TABLEKEY, IUD)' ) ;


  ExecuteDirect (
         'CREATE OR ALTER PROCEDURE ECRM$UPDATE_IUD('
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$PKGUID20,'
  +#13#10'    IUD SYS$IUD)'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( IUD = ''U'' )  THEN'
  +#13#10'    BEGIN'
  +#13#10'      UPDATE ECRM$IUD'
  +#13#10'      SET KECRM$IUD = NEXT VALUE FOR ECRM$IUD,'
  +#13#10'          SYS$DI    = CURRENT_TIMESTAMP'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD = ''U'' ) ;'
  +#13#10'    END'
  +#13#10'  ELSE if ( IUD = ''D'' ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      DELETE FROM ECRM$IUD'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'       AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'       AND IUD = ''U'' ;'
  +#13#10''
  +#13#10'      DELETE FROM ECRM$IUD'
  +#13#10'      WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'        AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'        AND ( IUD = ''I'' ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF (  (( IUD = ''I'' ) OR ( ROW_COUNT = 0 ))'
  +#13#10'      AND (         ( IUD <> ''U'' )'
  +#13#10'           OR (     ( IUD = ''U'' )'
  +#13#10'                AND ( NOT EXISTS ( SELECT 1 FROM ECRM$IUD'
  +#13#10'                         WHERE ( TABLENAME = :TABLENAME )'
  +#13#10'                           AND ( TABLEKEY = :TABLEKEY )'
  +#13#10'                           AND ( IUD = ''I'' ) )'
  +#13#10'                     )'
  +#13#10'              )'
  +#13#10'         )'
  +#13#10'     ) THEN'
  +#13#10'        INSERT INTO ECRM$IUD'
  +#13#10'          ( KECRM$IUD, TABLENAME, TABLEKEY, IUD, SYS$DI )'
  +#13#10'        VALUES'
  +#13#10'          ( NEXT VALUE FOR ECRM$IUD, :TABLENAME, :TABLEKEY, :IUD, CURRENT_TIMESTAMP ) ;'
  +#13#10''
  +#13#10'END' ) ;


  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CAD_PATRIMONIOS FOR CAD_PATRIMONIOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CAD_PATRIMONIOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCAD_PATRIMONIO, OLD.KCAD_PATRIMONIO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;


  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CAD_PATRIMONIO_DEPRECIACOE FOR CAD_PATRIMONIO_DEPRECIACOES'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CAD_PATRIMONIO_DEPRECIACOES'','
  +#13#10'    IIF ( INSERTING, NEW.KCAD_PATRIMONIO_DEPRECIACAO, OLD.KCAD_PATRIMONIO_DEPRECIACAO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;


  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APROPRIACAO FOR FIN_APROPRIACAO'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_APROPRIACAO'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_APROPRIACAO, OLD.KFIN_APROPRIACAO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_PLANOCONTAS FOR FIN_PLANOCONTAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_PLANOCONTAS'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_PLANOCONTA, OLD.KFIN_PLANOCONTA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_CENTROSCUSTO FOR FIN_CENTROSCUSTO'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_CENTROSCUSTO'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_CENTROCUSTO, OLD.KFIN_CENTROCUSTO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APAGAR FOR FIN_APAGAR'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', MD5STR20(NEW.KFIN_APAGAR || NEW.RECORRENCIA), ''I'' ;'
  +#13#10'   ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', MD5STR20(OLD.KFIN_APAGAR || OLD.RECORRENCIA), ''D'' ;'
  +#13#10'   ELSE IF (OLD.RECORRENCIA IS DISTINCT FROM NEW.RECORRENCIA) then'
  +#13#10'      BEGIN'
  +#13#10'        EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', MD5STR20(OLD.KFIN_APAGAR || OLD.RECORRENCIA), ''D'' ;'
  +#13#10'        EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', MD5STR20(OLD.KFIN_APAGAR || NEW.RECORRENCIA), ''I'' ;'
  +#13#10'      END'
  +#13#10'   ELSE'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_APAGAR'', MD5STR20(OLD.KFIN_APAGAR || OLD.RECORRENCIA), ''U'' ;'
  +#13#10'END' ) ;


  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_APAGAR_PARCELAS FOR FIN_APAGAR_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_APAGAR_PARCELAS'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_APAGAR_PARCELA, OLD.KFIN_APAGAR_PARCELA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDOS FOR CMP_PEDIDOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO, OLD.KCMP_PEDIDO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDO_ITENS FOR CMP_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDO_ITENS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO_ITEM, OLD.KCMP_PEDIDO_ITEM ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$CMP_PEDIDO_SERVICOS FOR CMP_PEDIDO_SERVICOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''CMP_PEDIDO_SERVICOS'','
  +#13#10'    IIF ( INSERTING, NEW.KCMP_PEDIDO_SERVICO, OLD.KCMP_PEDIDO_SERVICO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$VND_PEDIDOS FOR VND_PEDIDOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''VND_PEDIDOS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO, OLD.KVND_PEDIDO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$VND_PEDIDO_ITENS FOR VND_PEDIDO_ITENS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''VND_PEDIDO_ITENS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO_ITEM, OLD.KVND_PEDIDO_ITEM ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$VND_PEDIDO_SERVICOS FOR VND_PEDIDO_SERVICOS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''VND_PEDIDO_SERVICOS'','
  +#13#10'    IIF ( INSERTING, NEW.KVND_PEDIDO_SERVICO, OLD.KVND_PEDIDO_SERVICO ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

  ExecuteDirect (
         'CREATE OR ALTER TRIGGER ECRM$FIN_ARECEBER FOR FIN_ARECEBER'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   IF ( INSERTING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', MD5STR20(NEW.KFIN_ARECEBER || NEW.RECORRENCIA), ''I'' ;'
  +#13#10'   ELSE IF ( DELETING ) THEN'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', MD5STR20(OLD.KFIN_ARECEBER || OLD.RECORRENCIA), ''D'' ;'
  +#13#10'   ELSE IF (OLD.RECORRENCIA IS DISTINCT FROM NEW.RECORRENCIA) then'
  +#13#10'      BEGIN'
  +#13#10'        EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', MD5STR20(OLD.KFIN_ARECEBER || OLD.RECORRENCIA), ''D'' ;'
  +#13#10'        EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', MD5STR20(OLD.KFIN_ARECEBER || NEW.RECORRENCIA), ''I'' ;'
  +#13#10'      END'
  +#13#10'   ELSE'
  +#13#10'     EXECUTE PROCEDURE ECRM$UPDATE_IUD ''FIN_ARECEBER'', MD5STR20(OLD.KFIN_ARECEBER || OLD.RECORRENCIA), ''U'' ;'
  +#13#10'END' ) ;


   ExecuteDirect (
          'CREATE OR ALTER TRIGGER ECRM$FIN_ARECEBER_PARCELAS FOR FIN_ARECEBER_PARCELAS'
  +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 19000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'   EXECUTE PROCEDURE ECRM$UPDATE_IUD'
  +#13#10'    ''FIN_ARECEBER_PARCELAS'','
  +#13#10'    IIF ( INSERTING, NEW.KFIN_ARECEBER_PARCELA, OLD.KFIN_ARECEBER_PARCELA ),'
  +#13#10'    CASE'
  +#13#10'       WHEN INSERTING THEN ''I'''
  +#13#10'       WHEN UPDATING  THEN ''U'''
  +#13#10'       WHEN DELETING  THEN ''D'''
  +#13#10'    END;'
  +#13#10'END' ) ;

end;

procedure TDBFinanceiroUpdate._5_000_37;
begin
               TryExecuteDirect (
       'CREATE UNIQUE INDEX IXEST_MOVIMENTO_01 ON EST_MOVIMENTO (KSYS$DOMAIN, TABLENAME, TABLEKEY)') ;
               ExecuteDirect (
             'CREATE OR ALTER PROCEDURE EST_UPDATE_MOVIMENTO ('
      +#13#10'    TIPO_IUD CHAR(1),'
      +#13#10'    KDOMAIN SYS$FKGUID20,'
      +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
      +#13#10'    DATA SYS$DATE,'
      +#13#10'    TIPO_ES SYS$TIPOMOVEST,'
      +#13#10'    QTDE SYS$FLOAT,'
      +#13#10'    CUSTO SYS$FLOAT,'
      +#13#10'    TABLENAME SYS$TABLENAME,'
      +#13#10'    TABLEKEY SYS$FKGUID20)'
      +#13#10'AS'
      +#13#10'BEGIN'
      +#13#10'  IF ( TIPO_ES = ''S'' AND QTDE > 0 )  THEN'
      +#13#10'     QTDE = -QTDE ;'
      +#13#10''
      +#13#10'  IF (    (TIPO_IUD = ''U'')'
      +#13#10'      AND NOT EXISTS( SELECT 1 FROM EST_MOVIMENTO'
      +#13#10'                  WHERE'
      +#13#10'                       KSYS$DOMAIN = :KDOMAIN'
      +#13#10'                   AND TABLENAME    = :TABLENAME'
      +#13#10'                   AND TABLEKEY     = :TABLEKEY)'
      +#13#10''
      +#13#10'     ) THEN'
      +#13#10'     TIPO_IUD = ''I'' ;'
      +#13#10''
      +#13#10'  IF ( TIPO_IUD = ''I'' ) THEN'
      +#13#10'    INSERT INTO EST_MOVIMENTO'
      +#13#10'      ( KEST_MOVIMENTO, KSYS$DOMAIN, DATA, KEST_PRODUTO, TIPO, QTDE, CUSTO,'
      +#13#10'        TABLENAME, TABLEKEY )'
      +#13#10'    VALUES'
      +#13#10'      ( GUID20(), :KDOMAIN, :DATA, :KEST_PRODUTO, :TIPO_ES, :QTDE, :CUSTO,'
      +#13#10'        :TABLENAME, :TABLEKEY );'
      +#13#10'  ELSE IF (TIPO_IUD = ''U'') THEN'
      +#13#10'    UPDATE EST_MOVIMENTO'
      +#13#10'      SET KEST_PRODUTO = :KEST_PRODUTO,'
      +#13#10'          DATA = :DATA,'
      +#13#10'          TIPO = :TIPO_ES,'
      +#13#10'          QTDE = :QTDE,'
      +#13#10'          CUSTO = :CUSTO'
      +#13#10'     WHERE'
      +#13#10'          KSYS$DOMAIN = :KDOMAIN'
      +#13#10'      AND TABLENAME    = :TABLENAME'
      +#13#10'      AND TABLEKEY     = :TABLEKEY'
      +#13#10'      AND (   (KEST_PRODUTO  IS DISTINCT FROM :KEST_PRODUTO)'
      +#13#10'           OR (DATA          IS DISTINCT FROM :DATA)'
      +#13#10'           OR (TIPO          IS DISTINCT FROM :TIPO_ES)'
      +#13#10'           OR (QTDE          IS DISTINCT FROM :QTDE   )'
      +#13#10'           OR (CUSTO         IS DISTINCT FROM :CUSTO  )'
      +#13#10'          ) ;'
      +#13#10'  ELSE IF (TIPO_IUD = ''D'') THEN'
      +#13#10'    DELETE FROM EST_MOVIMENTO'
      +#13#10'    WHERE KSYS$DOMAIN = :KDOMAIN AND TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY;'
      +#13#10''
      +#13#10'END' ) ;


               ExecuteDirect (
             'CREATE OR ALTER PROCEDURE EST_UPDATE_PRODUTO_CMM ('
      +#13#10'    KDOMAIN SYS$FKGUID20,'
      +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
      +#13#10'    ANO_MES SYS$ANO_MES,'
      +#13#10'    CUSTO_MEDIO SYS$FLOAT)'
      +#13#10'AS'
      +#13#10'BEGIN'
      +#13#10'     IF ( EXISTS (SELECT 1 FROM EST_MOVIMENTO'
      +#13#10'                 WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'                   AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'                   AND ANO_MES > :ANO_MES ) ) THEN'
      +#13#10'      UPDATE EST_PRODUTOS'
      +#13#10'         SET CUSTO_MEDIO_MES = NULL'
      +#13#10'      WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'        AND CUSTO_MEDIO_MES IS NOT NULL ;'
      +#13#10'    ELSE'
      +#13#10'      UPDATE EST_PRODUTOS'
      +#13#10'         SET CUSTO_MEDIO_MES = :CUSTO_MEDIO'
      +#13#10'      WHERE KSYS$DOMAIN = :KDOMAIN'
      +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'        AND CUSTO_MEDIO_MES IS DISTINCT FROM :CUSTO_MEDIO ;'
      +#13#10'END' ) ;

      (*
      try
              ExecuteDirect (
       'CREATE UNIQUE INDEX IXFIN_APROPRIACAO_01 ON FIN_APROPRIACAO (KSYS$DOMAIN, TABLENAME, TABLEKEY)') ;

      except

      end;

              ExecuteDirect (
             'CREATE OR ALTER PROCEDURE FIN_DELETE_APROPRIACAO ('
      +#13#10'    KSYS$DOMAIN SYS$PKGUID20,'
      +#13#10'    TABLENAME SYS$PKGUID20,'
      +#13#10'    TABLEKEY SYS$PKGUID20)'
      +#13#10'AS'
      +#13#10'BEGIN'
      +#13#10'  DELETE FROM FIN_APROPRIACAO WHERE KSYS$DOMAIN = :KSYS$DOMAIN AND TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY ;'
      +#13#10'END' ) ;
      *)

end;


procedure TDBFinanceiroUpdate._5_000_36;
begin

       ExecuteDirect (
   'DROP TRIGGER EST_OUTRAS_ENTRADAS_SAID_DOMAIN' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_CHECK_SALDOINICIAL_EM('
  +#13#10'    KSYS$DOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE)'
  +#13#10'AS'
  +#13#10'declare DATA_SALDOINICIAL SYS$DATE = NULL ;'
  +#13#10'declare NOME SYS$DESCR = NULL ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF ( KEST_PRODUTO IS NULL ) THEN'
  +#13#10'     EXIT ;'
  +#13#10''
  +#13#10'  SELECT NOME, CAST ( DATA_SALDOINICIAL AS DATE )'
  +#13#10'  FROM EST_PRODUTOS'
  +#13#10'  WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'  INTO NOME, DATA_SALDOINICIAL ;'
  +#13#10''
  +#13#10'  IF ( DATA_SALDOINICIAL IS NULL ) THEN'
  +#13#10'     EXCEPTION SYS$EXCEPTION ''Produto não cadastrado.''  ;'
  +#13#10''
  +#13#10'  IF ( DATA_SALDOINICIAL > CAST ( DATA AS DATE ) ) THEN'
  +#13#10'       EXCEPTION SYS$EXCEPTION ''Produto "'' || NOME || ''" não tem saldo inicial na data ('' || DATA || '').''  ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_CHECK_ENCERRAMENTO_MES('
  +#13#10'    KSYS$DOMAIN SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE,'
  +#13#10'    ADDNEW SYS$BOOL_NULL = ''T'')'
  +#13#10'AS'
  +#13#10'DECLARE ANO SMALLINT ;'
  +#13#10'DECLARE MES SMALLINT ;'
  +#13#10'DECLARE ANO_MES SYS$ANO_MES ;'
  +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
  +#13#10'BEGIN'
  +#13#10'  IF ( DATA IS NULL ) THEN'
  +#13#10'    EXCEPTION SYS$EXCEPTION ''Não é permitido movimentaçao de estoque sem data.'' ;'
  +#13#10''
  +#13#10'  ANO = EXTRACT ( YEAR  FROM DATA ) ;'
  +#13#10'  MES = EXTRACT ( MONTH FROM DATA ) ;'
  +#13#10''
  +#13#10'  ANO_MES =  Right ( ''0000'' || ANO, 4 ) || Right ( ''00'' || MES, 2 ) ;'
  +#13#10''
  +#13#10'  SELECT ENCERRADO'
  +#13#10'  FROM EST_ENCERRAMENTO_MES'
  +#13#10'  WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'    AND ANO_MES = :ANO_MES'
  +#13#10'  INTO ENCERRADO ;'
  +#13#10''
  +#13#10'  IF ( ENCERRADO = ''T'' ) THEN'
  +#13#10'    EXCEPTION SYS$EXCEPTION ''A movimentação de estoque para este mes esta encerrada ('' || RIGHT( ANO_MES, 2 ) ||  ''.'' || LEFT ( ANO_MES, 4 ) || '').'' ;'
  +#13#10''
  +#13#10'  IF ( ENCERRADO IS NULL ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      SELECT ENCERRADO, ANO_MES'
  +#13#10'        FROM EST_ENCERRAMENTO_MES'
  +#13#10'      WHERE KSYS$DOMAIN = :KSYS$DOMAIN'
  +#13#10'        AND ANO_MES > :ANO_MES'
  +#13#10'        AND ENCERRADO = ''T'''
  +#13#10'      ROWS 1'
  +#13#10'      INTO ENCERRADO, ANO_MES ;'
  +#13#10''
  +#13#10'      IF ( ENCERRADO = ''T'' ) THEN'
  +#13#10'        EXCEPTION SYS$EXCEPTION ''Não é permitido esta movimentação. Um período posterior esta encerrado ('' || RIGHT( ANO_MES, 2 ) ||  ''.'' || LEFT ( ANO_MES, 4 ) || '').'' ;'
  +#13#10''
  +#13#10'      IF ( ADDNEW = ''T'' ) THEN'
  +#13#10'        INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KSYS$DOMAIN, ANO_MES )'
  +#13#10'        VALUES ( GUID20(), :KSYS$DOMAIN, :ANO_MES ) ;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'END' ) ;


       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MES('
  +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
  +#13#10'AS'
  +#13#10'DECLARE SOURCE_KEST_PRODUTO SYS$FKGUID20;'
  +#13#10'DECLARE SOURCE_NOME SYS$DESCR;'
  +#13#10'DECLARE SOURCE_QTDE_ESTOQUE SYS$FLOAT;'
  +#13#10'DECLARE SOURCE_QTDE_ENTRADAS SYS$FLOAT;'
  +#13#10'DECLARE SOURCE_SOMA_ENTRADA_X_CUSTO SYS$FLOAT;'
  +#13#10'DECLARE SOURCE_ESTOQUE_ANTERIOR SYS$FLOAT;'
  +#13#10'DECLARE SOURCE_CM_ANTERIOR SYS$FLOAT;'
  +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
  +#13#10'DECLARE SOMA_EA_QE SYS$FLOAT;'
  +#13#10'DECLARE TARGET_KEST_PRODUTO SYS$FKGUID20;'
  +#13#10'DECLARE TARGET_NOME SYS$DESCR;'
  +#13#10'DECLARE TARGET_QTDE_ESTOQUE SYS$FLOAT;'
  +#13#10'DECLARE TARGET_CUSTO_MEDIO SYS$FLOAT;'
  +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
  +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
  +#13#10'DECLARE ANO_MES_PROX SYS$ANO_MES = NULL ;'
  +#13#10'DECLARE PROX_MES SYS$DATE ;'
  +#13#10'DECLARE ANO_MES SYS$ANO_MES = NULL ;'
  +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
  +#13#10'DECLARE RLOG$OFF VARCHAR(1);'
  +#13#10'DECLARE RC_SOURCE INTEGER;'
  +#13#10'DECLARE RC_TARGET INTEGER;'
  +#13#10'DECLARE EST$ENCERRAMES_OFF VARCHAR(1);'
  +#13#10'DECLARE SOURCE CURSOR FOR (SELECT'
  +#13#10'         E.KEST_PRODUTO,'
  +#13#10'         P.NOME,'
  +#13#10'         (SELECT'
  +#13#10'           ESTOQUE'
  +#13#10'            FROM EST_MOVIMENTO QE'
  +#13#10'           WHERE'
  +#13#10'                 QE.KEST_PRODUTO = E.KEST_PRODUTO'
  +#13#10'             AND QE.ANO_MES <= :ANO_MES'
  +#13#10'           ORDER BY CAST ( QE.DATA AS DATE ) DESC, QE.MOVTO_ID DESC'
  +#13#10'           ROWS 1'
  +#13#10'         ) QTDE_ESTOQUE,'
  +#13#10'         (SELECT'
  +#13#10'           COALESCE( SUM( C.QTDE ), 0 )'
  +#13#10'            FROM EST_MOVIMENTO C'
  +#13#10'           WHERE'
  +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
  +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
  +#13#10'             AND C.ANO_MES = :ANO_MES'
  +#13#10'         ) QTDE_ENTRADAS ,'
  +#13#10'         (SELECT'
  +#13#10'           COALESCE( SUM( C.QTDE * C.CUSTO ), 0 )'
  +#13#10'            FROM EST_MOVIMENTO C'
  +#13#10'           WHERE'
  +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
  +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
  +#13#10'             AND C.ANO_MES = :ANO_MES'
  +#13#10'         ) SOMA_ENTRADA_X_CUSTO,'
  +#13#10'         COALESCE ( EMP.QTDE_ESTOQUE, 0 ) ESTOQUE_ANTERIOR,'
  +#13#10'         COALESCE ( EMP.CUSTO_MEDIO, 0 )  CM_ANTERIOR'
  +#13#10'         FROM EST_MOVIMENTO E'
  +#13#10'         LEFT JOIN EST_PRODUTOS P ON ( P.KEST_PRODUTO = E.KEST_PRODUTO )'
  +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES EM ON ( EM.ANO_MES = :ANO_MES_ANT )'
  +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = E.KEST_PRODUTO )'
  +#13#10'         WHERE E.TIPO = ''C'''
  +#13#10'         AND E.ANO_MES <= :ANO_MES'
  +#13#10'         ORDER BY E.KEST_PRODUTO'
  +#13#10' );'
  +#13#10'DECLARE TARGET CURSOR FOR (SELECT KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO'
  +#13#10'         FROM  EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
  +#13#10'         ORDER BY KEST_PRODUTO );'
  +#13#10'DECLARE CURSOR_ENCERRAMENTO CURSOR FOR (SELECT KSYS$DOMAIN, ANO_MES, ENCERRADO'
  +#13#10'         FROM EST_ENCERRAMENTO_MES'
  +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES );'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10''
  +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
  +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
  +#13#10''
  +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''01'' ) THEN'
  +#13#10'     ANO_MES_ANT = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) - 1), 4 ) || ''12'' ;'
  +#13#10'   ELSE'
  +#13#10'     ANO_MES_ANT = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) - 1), 2) ;'
  +#13#10''
  +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
  +#13#10'     ANO_MES_PROX = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
  +#13#10'   ELSE'
  +#13#10'     ANO_MES_PROX = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1), 2) ;'
  +#13#10''
  +#13#10'   PROX_MES = CAST ( SUBSTRING( ANO_MES_PROX FROM 1 FOR 4 ) || ''-'' || SUBSTRING( ANO_MES_PROX FROM 5 FOR 2 ) || ''-01'' AS DATE  ) ;'
  +#13#10''
  +#13#10''
  +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
  +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
  +#13#10''
  +#13#10''
  +#13#10'  OPEN SOURCE ;'
  +#13#10'  FETCH SOURCE'
  +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR  ;'
  +#13#10'  RC_SOURCE = ROW_COUNT ;'
  +#13#10''
  +#13#10'  OPEN TARGET ;'
  +#13#10'  FETCH TARGET'
  +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'  RC_TARGET = ROW_COUNT ;'
  +#13#10''
  +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'       IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
  +#13#10'        LEAVE ;'
  +#13#10''
  +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
  +#13#10'               SOURCE_ESTOQUE_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'          IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
  +#13#10'               SOURCE_QTDE_ENTRADAS = 0 ;'
  +#13#10''
  +#13#10'          IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
  +#13#10'               SOURCE_CM_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'          SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
  +#13#10'          IF ( SOMA_EA_QE = 0 ) THEN'
  +#13#10'             SOMA_EA_QE = 1 ;'
  +#13#10''
  +#13#10'          CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
  +#13#10''
  +#13#10''
  +#13#10'          --update target'
  +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
  +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
  +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM CUSTO_MEDIO  ) ) then'
  +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'                  SET'
  +#13#10'                   NOME            = :SOURCE_NOME,'
  +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
  +#13#10'                   CUSTO_MEDIO     = :CUSTO_MEDIO'
  +#13#10'                WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
  +#13#10'          EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
  +#13#10''
  +#13#10'          -- next source'
  +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
  +#13#10'          RC_SOURCE = ROW_COUNT ;'
  +#13#10'          -- next target'
  +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'          RC_TARGET = ROW_COUNT ;'
  +#13#10'        END'
  +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
  +#13#10'          BEGIN'
  +#13#10'            -- delete target'
  +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
  +#13#10''
  +#13#10'            -- next target'
  +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'            RC_TARGET = ROW_COUNT ;'
  +#13#10'          END'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
  +#13#10'                 SOURCE_ESTOQUE_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'            IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
  +#13#10'                 SOURCE_QTDE_ENTRADAS = 0 ;'
  +#13#10''
  +#13#10'            IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
  +#13#10'                 SOURCE_CM_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'            SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
  +#13#10'            IF ( SOMA_EA_QE = 0 ) THEN'
  +#13#10'               SOMA_EA_QE = 1 ;'
  +#13#10''
  +#13#10'            CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
  +#13#10''
  +#13#10'            -- insert into target'
  +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
  +#13#10'            VALUES'
  +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
  +#13#10''
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
  +#13#10''
  +#13#10'            -- next source'
  +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
  +#13#10'            RC_SOURCE = ROW_COUNT ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'       IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
  +#13#10'          SOURCE_ESTOQUE_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'       IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
  +#13#10'          SOURCE_QTDE_ENTRADAS = 0 ;'
  +#13#10''
  +#13#10'       IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
  +#13#10'          SOURCE_CM_ANTERIOR = 0 ;'
  +#13#10''
  +#13#10'       SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
  +#13#10'       IF ( SOMA_EA_QE = 0 ) THEN'
  +#13#10'          SOMA_EA_QE = 1 ;'
  +#13#10''
  +#13#10'       CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
  +#13#10''
  +#13#10'      -- insert target'
  +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
  +#13#10'      VALUES'
  +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
  +#13#10'      EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
  +#13#10''
  +#13#10'      -- next source'
  +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
  +#13#10'      RC_SOURCE = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'       -- delete target'
  +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
  +#13#10''
  +#13#10'       -- next target'
  +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'       RC_TARGET = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
  +#13#10''
  +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
  +#13#10'    BEGIN'
  +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
  +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
  +#13#10'       SET ENCERRADO = ''T'''
  +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
  +#13#10''
  +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  CLOSE TARGET ;'
  +#13#10'  CLOSE SOURCE ;'
  +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
  +#13#10''
  +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
  +#13#10'                    WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'                      AND ANO_MES = :ANO_MES_PROX ) ) THEN'
  +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KSYS$DOMAIN, ANO_MES )'
  +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES_PROX ) ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_REABRIR_MES('
  +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
  +#13#10'AS'
  +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 ;'
  +#13#10'DECLARE KDOMAIN       SYS$FKGUID20 ;'
  +#13#10'DECLARE ANO_MES       SYS$ANO_MES ;'
  +#13#10'DECLARE ENCERRADO     SYS$BOOL_NULL = NULL ;'
  +#13#10'DECLARE EST$ENCERRAMES_OFF varchar( 1 ) ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  SELECT KSYS$DOMAIN, ANO_MES, ENCERRADO'
  +#13#10'  FROM EST_ENCERRAMENTO_MES'
  +#13#10'  WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
  +#13#10'  INTO KDOMAIN, ANO_MES, ENCERRADO ;'
  +#13#10''
  +#13#10'  IF ( ENCERRADO IS NULL ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  FOR SELECT KEST_PRODUTO'
  +#13#10'  FROM EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'  WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
  +#13#10'  INTO KEST_PRODUTO DO'
  +#13#10'    IF ( EXISTS (SELECT 1 FROM EST_MOVIMENTO'
  +#13#10'                 WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'                   AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'                   AND ANO_MES >= :ANO_MES'
  +#13#10'                   ROWS 1 ) ) THEN'
  +#13#10'      UPDATE EST_PRODUTOS'
  +#13#10'         SET CUSTO_MEDIO_MES = NULL'
  +#13#10'      WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO ;'
  +#13#10''
  +#13#10'  IF ( ENCERRADO IS NOT DISTINCT FROM ''F'' ) THEN'
  +#13#10'    EXIT ;'
  +#13#10''
  +#13#10'  EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  UPDATE EST_ENCERRAMENTO_MES'
  +#13#10'       SET ENCERRADO = ''F'''
  +#13#10'  WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES ;'
  +#13#10''
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE('
  +#13#10'    KDOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE)'
  +#13#10'AS'
  +#13#10'declare variable tipo char(1) = null;'
  +#13#10'declare variable estoque sys$float;'
  +#13#10'declare variable estoque_anterior sys$float;'
  +#13#10'declare variable qtde sys$float;'
  +#13#10'declare variable custo sys$float;'
  +#13#10'declare variable custo_anterior sys$float;'
  +#13#10'declare variable custo_medio sys$float;'
  +#13#10'declare variable total_entrada sys$float;'
  +#13#10'declare variable total_saida sys$float;'
  +#13#10'declare variable datamovto sys$date;'
  +#13#10'declare variable est$movto_off varchar(1);'
  +#13#10'declare variable ano_mes_ant sys$ano_mes = null ;'
  +#13#10'declare variable ano smallint = null ;'
  +#13#10'declare variable mes smallint = null ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
  +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'  CUSTO_ANTERIOR   = null ;'
  +#13#10'  CUSTO_MEDIO      = null ;'
  +#13#10'  ESTOQUE_ANTERIOR = null ;'
  +#13#10''
  +#13#10'  Ano = Extract ( YEAR from DATA ) ;'
  +#13#10'  Mes = Extract ( MONTH from DATA ) ;'
  +#13#10''
  +#13#10'  IF (MES=1) THEN'
  +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || (Ano - 1), 4 ) || ''12'' ;'
  +#13#10'  ELSE'
  +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || Ano, 4 ) || RIGHT ( ''00'' || (MES - 1), 2) ;'
  +#13#10''
  +#13#10'  SELECT TIPO, CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
  +#13#10'    FROM EST_MOVIMENTO'
  +#13#10'   WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'     AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'     AND DATA < :DATA'
  +#13#10'   ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
  +#13#10'    ROWS 1'
  +#13#10'    INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
  +#13#10''
  +#13#10'  IF ( TIPO IS NULL ) then'
  +#13#10'    BEGIN'
  +#13#10'      SELECT TIPO, CUSTO, CUSTO_MEDIO, QTDE, DATA'
  +#13#10'        FROM EST_MOVIMENTO'
  +#13#10'       WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'         AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'         AND TIPO = ''C'''
  +#13#10'       ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
  +#13#10'        ROWS 1'
  +#13#10'        INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
  +#13#10'      DATA = DATAMOVTO ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  IF (     (TIPO <> ''C'')'
  +#13#10'       AND ('
  +#13#10'               (EXTRACT( MONTH FROM DATAMOVTO ) <> EXTRACT( MONTH FROM DATA ))'
  +#13#10'            OR (EXTRACT( YEAR  FROM DATAMOVTO ) <> EXTRACT( YEAR  FROM DATA ))'
  +#13#10'           )'
  +#13#10'     ) THEN'
  +#13#10'     BEGIN'
  +#13#10'       SELECT EMP.CUSTO_MEDIO FROM EST_ENCERRAMENTO_MES EM'
  +#13#10'       LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = :KEST_PRODUTO )'
  +#13#10'       WHERE ( EM.ANO_MES = :ANO_MES_ANT AND EM.ENCERRADO = ''T'' )'
  +#13#10'       INTO CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'       CUSTO_ANTERIOR = CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'     END'
  +#13#10''
  +#13#10'  FOR SELECT'
  +#13#10'       TIPO, QTDE, CUSTO'
  +#13#10'  FROM EST_MOVIMENTO'
  +#13#10'  WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'    AND DATA >= :DATA'
  +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
  +#13#10'  INTO TIPO, QTDE, CUSTO'
  +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
  +#13#10'  DO'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
  +#13#10'          CUSTO_MEDIO      = CUSTO_ANTERIOR ;'
  +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
  +#13#10'        END'
  +#13#10'      ELSE IF (    ( TIPO = ''E'' )'
  +#13#10'          AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
  +#13#10'          ) THEN'
  +#13#10'         CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
  +#13#10''
  +#13#10'      ELSE IF ( TIPO = ''S'' ) THEN'
  +#13#10'         CUSTO = CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
  +#13#10''
  +#13#10'      UPDATE EST_MOVIMENTO'
  +#13#10'         SET'
  +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
  +#13#10'             CUSTO            = :CUSTO,'
  +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
  +#13#10'             ESTOQUE          = :ESTOQUE'
  +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
  +#13#10''
  +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
  +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  -- revisar....'
  +#13#10'  -- Atualiza status atual produto'
  +#13#10'    SELECT'
  +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
  +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA'
  +#13#10'     FROM EST_MOVIMENTO ME'
  +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'       AND ME.TIPO <> ''C'''
  +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA ;'
  +#13#10''
  +#13#10'   UPDATE EST_PRODUTOS'
  +#13#10'      SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
  +#13#10'          QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
  +#13#10'          CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
  +#13#10'          CUSTO_MEDIO_MES   = NULL'
  +#13#10'   WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
  +#13#10''
  +#13#10' RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
  +#13#10''
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_OUTRAS_ENTRADAS_SAIDA_BIUD0 FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 1001'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'  IF (inserting) THEN'
  +#13#10'    BEGIN'
  +#13#10'       EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM NEW.KSYS$DOMAIN, NEW.KEST_PRODUTO, NEW.DATA ;'
  +#13#10'       EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA ;'
  +#13#10'    END'
  +#13#10'  ELSE IF ( updating ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF (   ( NEW.KSYS$DOMAIN IS DISTINCT FROM OLD.KSYS$DOMAIN )'
  +#13#10'          OR ( NEW.DATA         IS DISTINCT FROM  OLD.DATA ) ) THEN'
  +#13#10'        EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES NEW.KSYS$DOMAIN, NEW.DATA ;'
  +#13#10'      EXECUTE PROCEDURE EST_CHECK_SALDOINICIAL_EM  NEW.KSYS$DOMAIN, NEW.KEST_PRODUTO, NEW.DATA ;'
  +#13#10'    END'
  +#13#10'  ELSE'
  +#13#10'    EXECUTE PROCEDURE EST_CHECK_ENCERRAMENTO_MES OLD.KSYS$DOMAIN, OLD.DATA ;'
  +#13#10''
  +#13#10'  IF (     ( INSERTING OR UPDATING )'
  +#13#10'       AND ( NEW.CODIGO_LANCAMENTO IS NULL )'
  +#13#10'     ) THEN'
  +#13#10'    BEGIN'
  +#13#10'      IF ( NEW.TIPO = ''E'' ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_ENTRADAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'      ELSE IF ( NEW.TIPO = ''S'' ) THEN'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_SAIDAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'      ELSE'
  +#13#10'        SELECT Right ( ''000000'' || SEQUENCE_VALUE, 6 )'
  +#13#10'        FROM  SYS$GET_SEQUENCE( NEW.KSYS$DOMAIN, ''EST_OUTRAS_ENTRADAS_SAIDAS'' )'
  +#13#10'        INTO NEW.CODIGO_LANCAMENTO ;'
  +#13#10'    END'
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_UPDATE_MOVIMENTO('
  +#13#10'    TIPO_IUD CHAR(1),'
  +#13#10'    KDOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    DATA SYS$DATE,'
  +#13#10'    TIPO_ES SYS$TIPOMOVEST,'
  +#13#10'    QTDE SYS$FLOAT,'
  +#13#10'    CUSTO SYS$FLOAT,'
  +#13#10'    TABLENAME SYS$TABLENAME,'
  +#13#10'    TABLEKEY SYS$FKGUID20)'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'  IF ( TIPO_ES = ''S'' AND QTDE > 0 )  THEN'
  +#13#10'     QTDE = -QTDE ;'
  +#13#10''
  +#13#10'  IF (    (TIPO_IUD = ''U'')'
  +#13#10'      AND NOT EXISTS( SELECT 1 FROM EST_MOVIMENTO'
  +#13#10'                  WHERE'
  +#13#10'                       KSYS$DOMAIN = :KDOMAIN'
  +#13#10'                   AND TABLENAME    = :TABLENAME'
  +#13#10'                   AND TABLEKEY     = :TABLEKEY)'
  +#13#10''
  +#13#10'     ) THEN'
  +#13#10'     TIPO_IUD = ''I'' ;'
  +#13#10''
  +#13#10'  IF ( TIPO_IUD = ''I'' ) THEN'
  +#13#10'    INSERT INTO EST_MOVIMENTO'
  +#13#10'      ( KEST_MOVIMENTO, KSYS$DOMAIN, DATA, KEST_PRODUTO, TIPO, QTDE, CUSTO,'
  +#13#10'        TABLENAME, TABLEKEY )'
  +#13#10'    VALUES'
  +#13#10'      ( GUID20(), :KDOMAIN, :DATA, :KEST_PRODUTO, :TIPO_ES, :QTDE, :CUSTO,'
  +#13#10'        :TABLENAME, :TABLEKEY );'
  +#13#10'  ELSE IF (TIPO_IUD = ''U'') THEN'
  +#13#10'    UPDATE EST_MOVIMENTO'
  +#13#10'      SET KEST_PRODUTO = :KEST_PRODUTO,'
  +#13#10'          DATA = :DATA,'
  +#13#10'          TIPO = :TIPO_ES,'
  +#13#10'          QTDE = :QTDE,'
  +#13#10'          CUSTO = :CUSTO'
  +#13#10'     WHERE'
  +#13#10'          KSYS$DOMAIN = :KDOMAIN'
  +#13#10'      AND TABLENAME    = :TABLENAME'
  +#13#10'      AND TABLEKEY     = :TABLEKEY'
  +#13#10'      AND (   (KEST_PRODUTO  IS DISTINCT FROM :KEST_PRODUTO)'
  +#13#10'           OR (DATA          IS DISTINCT FROM :DATA)'
  +#13#10'           OR (TIPO          IS DISTINCT FROM :TIPO_ES)'
  +#13#10'           OR (QTDE          IS DISTINCT FROM :QTDE   )'
  +#13#10'           OR (CUSTO         IS DISTINCT FROM :CUSTO  )'
  +#13#10'          ) ;'
  +#13#10'  ELSE IF (TIPO_IUD = ''D'') THEN'
  +#13#10'    DELETE FROM EST_MOVIMENTO'
  +#13#10'    WHERE KSYS$DOMAIN = :KDOMAIN AND TABLENAME = :TABLENAME AND TABLEKEY = :TABLEKEY;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER PROCEDURE EST_UPDATE_PRODUTO_CMM('
  +#13#10'    KDOMAIN SYS$FKGUID20,'
  +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
  +#13#10'    ANO_MES SYS$ANO_MES,'
  +#13#10'    CUSTO_MEDIO SYS$FLOAT)'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10'     IF ( EXISTS (SELECT 1 FROM EST_MOVIMENTO'
  +#13#10'                 WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'                   AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'                   AND ANO_MES > :ANO_MES ) ) THEN'
  +#13#10'      UPDATE EST_PRODUTOS'
  +#13#10'         SET CUSTO_MEDIO_MES = NULL'
  +#13#10'      WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'        AND CUSTO_MEDIO_MES IS NOT NULL ;'
  +#13#10'    ELSE'
  +#13#10'      UPDATE EST_PRODUTOS'
  +#13#10'         SET CUSTO_MEDIO_MES = :CUSTO_MEDIO'
  +#13#10'      WHERE KSYS$DOMAIN = :KDOMAIN'
  +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
  +#13#10'        AND CUSTO_MEDIO_MES IS DISTINCT FROM :CUSTO_MEDIO ;'
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER CAD_PATRIMONIOS_DOMAIN FOR CAD_PATRIMONIOS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER CMP_PEDIDOS_DOMAIN FOR CMP_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_ENCERRAMENTO_MES_DOMAIN FOR EST_ENCERRAMENTO_MES'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_MOVIMENTO_DOMAIN FOR EST_MOVIMENTO'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_OUTRAS_ENTRADAS_SAID_DOMAIN FOR EST_OUTRAS_ENTRADAS_SAIDAS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER EST_PRODUTOS_DOMAIN FOR EST_PRODUTOS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_APAGAR_DOMAIN FOR FIN_APAGAR'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_ARECEBER_DOMAIN FOR FIN_ARECEBER'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_CENTROSCUSTO_DOMAIN FOR FIN_CENTROSCUSTO'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_CONTAS_DOMAIN FOR FIN_CONTAS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER FIN_PLANOCONTAS_DOMAIN FOR FIN_PLANOCONTAS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

       ExecuteDirect (
         'CREATE OR ALTER TRIGGER VND_PEDIDOS_DOMAIN FOR VND_PEDIDOS'
  +#13#10'ACTIVE BEFORE INSERT POSITION 1000'
  +#13#10'AS'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   IF ( NEW.KSYS$DOMAIN IS NULL ) THEN NEW.KSYS$DOMAIN = NEW.KCAD_FAZENDA ; ELSE IF ( NEW.KCAD_FAZENDA IS NULL ) THEN NEW.KCAD_FAZENDA = NEW.KSYS$DOMAIN ;'
  +#13#10''
  +#13#10'END' ) ;

end;


procedure TDBFinanceiroUpdate._5_000_35;
begin

        try
          ExecuteDirect ( 'CREATE DOMAIN FIN$AGENCIA AS  CHAR(8)' ) ;
          ExecuteDirect ( 'CREATE DOMAIN FIN$AGENCIA_NN AS  CHAR(8) NOT NULL' ) ;

          ExecuteDirect ( 'CREATE DOMAIN FIN$CONTA AS  CHAR(16)' ) ;
          ExecuteDirect ( 'CREATE DOMAIN FIN$CONTA_NN AS  CHAR(16) NOT NULL' ) ;

          ExecuteDirect (
                              'ALTER TABLE CAD_ENTIDADES'
                       +#13#10'ADD BANCO FIN$CODFEBRABAN,'
                       +#13#10'ADD AGENCIA FIN$AGENCIA,'
                       +#13#10'ADD CONTA FIN$CONTA'  ) ;
        except on E : Exception do  ;

        end;

        try
          ExecuteDirect (
            'ALTER TABLE EST_PRODUTOS ADD KFIN_PLANOCONTA SYS$FKGUID20' ) ;
        except
        end;
end;



procedure TDBFinanceiroUpdate._5_000_31;
begin
end;

procedure TDBFinanceiroUpdate._5_000_30;
var
  EncerramentoMensal : TEncerramentoMensal ;
begin
         ExecuteDirect (

             'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE ('
      +#13#10'   kdomain sys$fkguid20,'
      +#13#10'    kest_produto sys$fkguid20,'
      +#13#10'    data sys$date)'
      +#13#10'as'
      +#13#10'declare variable tipo char(1) = null;'
      +#13#10'declare variable estoque sys$float;'
      +#13#10'declare variable estoque_anterior sys$float;'
      +#13#10'declare variable qtde sys$float;'
      +#13#10'declare variable custo sys$float;'
      +#13#10'declare variable custo_anterior sys$float;'
      +#13#10'declare variable custo_medio sys$float;'
      +#13#10'declare variable total_entrada sys$float;'
      +#13#10'declare variable total_saida sys$float;'
      +#13#10'declare variable datamovto sys$date;'
      +#13#10'declare variable est$movto_off varchar(1);'
      +#13#10'declare variable ano_mes_ant sys$ano_mes = null ;'
      +#13#10'declare variable ano smallint = null ;'
      +#13#10'declare variable mes smallint = null ;'
      +#13#10'BEGIN'
      +#13#10''
      +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
      +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
      +#13#10''
      +#13#10'  CUSTO_ANTERIOR   = null ;'
      +#13#10'  CUSTO_MEDIO      = null ;'
      +#13#10'  ESTOQUE_ANTERIOR = null ;'
      +#13#10''
      +#13#10'  Ano = Extract ( YEAR from DATA ) ;'
      +#13#10'  Mes = Extract ( MONTH from DATA ) ;'
      +#13#10''
      +#13#10'  IF (MES=1) THEN'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || (Ano - 1), 4 ) || ''12'' ;'
      +#13#10'  ELSE'
      +#13#10'    ANO_MES_ANT = RIGHT ( ''0000'' || Ano, 4 ) || RIGHT ( ''00'' || (MES - 1), 2) ;'
      +#13#10''
      +#13#10'  SELECT TIPO, CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
      +#13#10'    FROM EST_MOVIMENTO'
      +#13#10'   WHERE KCAD_FAZENDA = :KDOMAIN'
      +#13#10'     AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'     AND DATA < :DATA'
      +#13#10'   ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'    ROWS 1'
      +#13#10'    INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10''
      +#13#10'  IF ( TIPO IS NULL ) then'
      +#13#10'    BEGIN'
      +#13#10'      SELECT TIPO, CUSTO, CUSTO_MEDIO, QTDE, DATA'
      +#13#10'        FROM EST_MOVIMENTO'
      +#13#10'       WHERE KCAD_FAZENDA = :KDOMAIN'
      +#13#10'         AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'         AND TIPO = ''C'''
      +#13#10'       ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
      +#13#10'        ROWS 1'
      +#13#10'        INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
      +#13#10'      DATA = DATAMOVTO ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'  IF (     (TIPO <> ''C'')'
      +#13#10'       AND ('
      +#13#10'               (EXTRACT( MONTH FROM DATAMOVTO ) <> EXTRACT( MONTH FROM DATA ))'
      +#13#10'            OR (EXTRACT( YEAR  FROM DATAMOVTO ) <> EXTRACT( YEAR  FROM DATA ))'
      +#13#10'           )'
      +#13#10'     ) THEN'
      +#13#10'     BEGIN'
      +#13#10'       SELECT EMP.CUSTO_MEDIO FROM EST_ENCERRAMENTO_MES EM'
      +#13#10'       LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = :KEST_PRODUTO )'
      +#13#10'       WHERE ( EM.ANO_MES = :ANO_MES_ANT AND EM.ENCERRADO = ''T'' )'
      +#13#10'       INTO CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'       CUSTO_ANTERIOR = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'     END'
      +#13#10''
      +#13#10'  FOR SELECT'
      +#13#10'       TIPO, QTDE, CUSTO'
      +#13#10'  FROM EST_MOVIMENTO'
      +#13#10'  WHERE KCAD_FAZENDA = :KDOMAIN'
      +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'    AND DATA >= :DATA'
      +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
      +#13#10'  INTO TIPO, QTDE, CUSTO'
      +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
      +#13#10'  DO'
      +#13#10'    BEGIN'
      +#13#10''
      +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
      +#13#10'        BEGIN'
      +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
      +#13#10'          CUSTO_MEDIO      = CUSTO_ANTERIOR ;'
      +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
      +#13#10'        END'
      +#13#10'      ELSE IF (    ( TIPO = ''E'' )'
      +#13#10'          AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
      +#13#10'          ) THEN'
      +#13#10'         CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
      +#13#10''
      +#13#10'      ELSE IF ( TIPO = ''S'' ) THEN'
      +#13#10'         CUSTO = CUSTO_MEDIO ;'
      +#13#10''
      +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
      +#13#10''
      +#13#10'      UPDATE EST_MOVIMENTO'
      +#13#10'         SET'
      +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
      +#13#10'             CUSTO            = :CUSTO,'
      +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
      +#13#10'             ESTOQUE          = :ESTOQUE'
      +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
      +#13#10''
      +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
      +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
      +#13#10''
      +#13#10'    END'
      +#13#10''
      +#13#10'  -- revisar....'
      +#13#10'  -- Atualiza status atual produto'
      +#13#10'    SELECT'
      +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
      +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA'
      +#13#10'     FROM EST_MOVIMENTO ME'
      +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
      +#13#10'       AND ME.TIPO <> ''C'''
      +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA ;'
      +#13#10''
      +#13#10'   UPDATE EST_PRODUTOS'
      +#13#10'      SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
      +#13#10'          QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
      +#13#10'          CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
      +#13#10'          CUSTO_MEDIO_MES   = NULL'
      +#13#10'   WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
      +#13#10''
      +#13#10' RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
      +#13#10''
      +#13#10''
      +#13#10'END' ) ;


      ExecuteDirect (
             'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MES ('
      +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
      +#13#10'AS'
      +#13#10'DECLARE SOURCE_KEST_PRODUTO SYS$FKGUID20;'
      +#13#10'DECLARE SOURCE_NOME SYS$DESCR;'
      +#13#10'DECLARE SOURCE_QTDE_ESTOQUE SYS$FLOAT;'
      +#13#10'DECLARE SOURCE_QTDE_ENTRADAS SYS$FLOAT;'
      +#13#10'DECLARE SOURCE_SOMA_ENTRADA_X_CUSTO SYS$FLOAT;'
      +#13#10'DECLARE SOURCE_ESTOQUE_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE SOURCE_CM_ANTERIOR SYS$FLOAT;'
      +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
      +#13#10'DECLARE SOMA_EA_QE SYS$FLOAT;'
      +#13#10'DECLARE TARGET_KEST_PRODUTO SYS$FKGUID20;'
      +#13#10'DECLARE TARGET_NOME SYS$DESCR;'
      +#13#10'DECLARE TARGET_QTDE_ESTOQUE SYS$FLOAT;'
      +#13#10'DECLARE TARGET_CUSTO_MEDIO SYS$FLOAT;'
      +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
      +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
      +#13#10'DECLARE ANO_MES_PROX SYS$ANO_MES = NULL ;'
      +#13#10'DECLARE PROX_MES SYS$DATE ;'
      +#13#10'DECLARE ANO_MES SYS$ANO_MES = NULL ;'
      +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
      +#13#10'DECLARE RLOG$OFF VARCHAR(1);'
      +#13#10'DECLARE RC_SOURCE INTEGER;'
      +#13#10'DECLARE RC_TARGET INTEGER;'
      +#13#10'DECLARE EST$ENCERRAMES_OFF VARCHAR(1);'
      +#13#10'DECLARE SOURCE CURSOR FOR (SELECT'
      +#13#10'         E.KEST_PRODUTO,'
      +#13#10'         P.NOME,'
      +#13#10'         (SELECT'
      +#13#10'           ESTOQUE'
      +#13#10'            FROM EST_MOVIMENTO QE'
      +#13#10'           WHERE'
      +#13#10'                 QE.KEST_PRODUTO = E.KEST_PRODUTO'
      +#13#10'             AND QE.ANO_MES <= :ANO_MES'
      +#13#10'           ORDER BY CAST ( QE.DATA AS DATE ) DESC, QE.MOVTO_ID DESC'
      +#13#10'           ROWS 1'
      +#13#10'         ) QTDE_ESTOQUE,'
      +#13#10'         (SELECT'
      +#13#10'           COALESCE( SUM( C.QTDE ), 0 )'
      +#13#10'            FROM EST_MOVIMENTO C'
      +#13#10'           WHERE'
      +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
      +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
      +#13#10'             AND C.ANO_MES = :ANO_MES'
      +#13#10'         ) QTDE_ENTRADAS ,'
      +#13#10'         (SELECT'
      +#13#10'           COALESCE( SUM( C.QTDE * C.CUSTO ), 0 )'
      +#13#10'            FROM EST_MOVIMENTO C'
      +#13#10'           WHERE'
      +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
      +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
      +#13#10'             AND C.ANO_MES = :ANO_MES'
      +#13#10'         ) SOMA_ENTRADA_X_CUSTO,'
      +#13#10'         COALESCE ( EMP.QTDE_ESTOQUE, 0 ) ESTOQUE_ANTERIOR,'
      +#13#10'         COALESCE ( EMP.CUSTO_MEDIO, 0 )  CM_ANTERIOR'
      +#13#10'         FROM EST_MOVIMENTO E'
      +#13#10'         LEFT JOIN EST_PRODUTOS P ON ( P.KEST_PRODUTO = E.KEST_PRODUTO )'
      +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES EM ON ( EM.ANO_MES = :ANO_MES_ANT )'
      +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = E.KEST_PRODUTO )'
      +#13#10'         WHERE E.TIPO = ''C'''
      +#13#10'         AND E.ANO_MES <= :ANO_MES'
      +#13#10'         ORDER BY E.KEST_PRODUTO'
      +#13#10' );'
      +#13#10'DECLARE TARGET CURSOR FOR (SELECT KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO'
      +#13#10'         FROM  EST_ENCERRAMENTO_MES_PRODUTOS'
      +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
      +#13#10'         ORDER BY KEST_PRODUTO );'
      +#13#10'DECLARE CURSOR_ENCERRAMENTO CURSOR FOR (SELECT KCAD_FAZENDA, ANO_MES, ENCERRADO'
      +#13#10'         FROM EST_ENCERRAMENTO_MES'
      +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES );'
      +#13#10'BEGIN'
      +#13#10''
      +#13#10''
      +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
      +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
      +#13#10''
      +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''01'' ) THEN'
      +#13#10'     ANO_MES_ANT = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) - 1), 4 ) || ''12'' ;'
      +#13#10'   ELSE'
      +#13#10'     ANO_MES_ANT = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) - 1), 2) ;'
      +#13#10''
      +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
      +#13#10'     ANO_MES_PROX = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
      +#13#10'   ELSE'
      +#13#10'     ANO_MES_PROX = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1), 2) ;'
      +#13#10''
      +#13#10'   PROX_MES = CAST ( SUBSTRING( ANO_MES_PROX FROM 1 FOR 4 ) || ''-'' || SUBSTRING( ANO_MES_PROX FROM 5 FOR 2 ) || ''-01'' AS DATE  ) ;'
      +#13#10''
      +#13#10''
      +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
      +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
      +#13#10''
      +#13#10''
      +#13#10'  OPEN SOURCE ;'
      +#13#10'  FETCH SOURCE'
      +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR  ;'
      +#13#10'  RC_SOURCE = ROW_COUNT ;'
      +#13#10''
      +#13#10'  OPEN TARGET ;'
      +#13#10'  FETCH TARGET'
      +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
      +#13#10'  RC_TARGET = ROW_COUNT ;'
      +#13#10''
      +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
      +#13#10'    BEGIN'
      +#13#10''
      +#13#10'       IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
      +#13#10'        LEAVE ;'
      +#13#10''
      +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
      +#13#10'        BEGIN'
      +#13#10'          IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
      +#13#10'               SOURCE_ESTOQUE_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'          IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
      +#13#10'               SOURCE_QTDE_ENTRADAS = 0 ;'
      +#13#10''
      +#13#10'          IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
      +#13#10'               SOURCE_CM_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'          SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
      +#13#10'          IF ( SOMA_EA_QE = 0 ) THEN'
      +#13#10'             SOMA_EA_QE = 1 ;'
      +#13#10''
      +#13#10'          CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
      +#13#10''
      +#13#10''
      +#13#10'          --update target'
      +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
      +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
      +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM CUSTO_MEDIO  ) ) then'
      +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
      +#13#10'                  SET'
      +#13#10'                   NOME            = :SOURCE_NOME,'
      +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
      +#13#10'                   CUSTO_MEDIO     = :CUSTO_MEDIO'
      +#13#10'                WHERE CURRENT OF TARGET ;'
      +#13#10''
      +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
      +#13#10'          EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
      +#13#10''
      +#13#10'          -- next source'
      +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
      +#13#10'          RC_SOURCE = ROW_COUNT ;'
      +#13#10'          -- next target'
      +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
      +#13#10'          RC_TARGET = ROW_COUNT ;'
      +#13#10'        END'
      +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
      +#13#10'          BEGIN'
      +#13#10'            -- delete target'
      +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
      +#13#10''
      +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
      +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
      +#13#10''
      +#13#10'            -- next target'
      +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
      +#13#10'            RC_TARGET = ROW_COUNT ;'
      +#13#10'          END'
      +#13#10'       ELSE'
      +#13#10'          BEGIN'
      +#13#10'            IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
      +#13#10'                 SOURCE_ESTOQUE_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'            IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
      +#13#10'                 SOURCE_QTDE_ENTRADAS = 0 ;'
      +#13#10''
      +#13#10'            IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
      +#13#10'                 SOURCE_CM_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'            SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
      +#13#10'            IF ( SOMA_EA_QE = 0 ) THEN'
      +#13#10'               SOMA_EA_QE = 1 ;'
      +#13#10''
      +#13#10'            CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
      +#13#10''
      +#13#10'            -- insert into target'
      +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
      +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
      +#13#10'            VALUES'
      +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
      +#13#10''
      +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
      +#13#10'            EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
      +#13#10''
      +#13#10'            -- next source'
      +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
      +#13#10'            RC_SOURCE = ROW_COUNT ;'
      +#13#10'          END'
      +#13#10''
      +#13#10'    END'
      +#13#10''
      +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
      +#13#10'    BEGIN'
      +#13#10'       IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
      +#13#10'          SOURCE_ESTOQUE_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'       IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
      +#13#10'          SOURCE_QTDE_ENTRADAS = 0 ;'
      +#13#10''
      +#13#10'       IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
      +#13#10'          SOURCE_CM_ANTERIOR = 0 ;'
      +#13#10''
      +#13#10'       SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
      +#13#10'       IF ( SOMA_EA_QE = 0 ) THEN'
      +#13#10'          SOMA_EA_QE = 1 ;'
      +#13#10''
      +#13#10'       CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
      +#13#10''
      +#13#10'      -- insert target'
      +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
      +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
      +#13#10'      VALUES'
      +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
      +#13#10''
      +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
      +#13#10'      EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, SOURCE_KEST_PRODUTO, PROX_MES ) ;'
      +#13#10''
      +#13#10'      -- next source'
      +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
      +#13#10'      RC_SOURCE = ROW_COUNT ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
      +#13#10'    BEGIN'
      +#13#10'       -- delete target'
      +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
      +#13#10''
      +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
      +#13#10'       EXECUTE PROCEDURE EST_UPDATE_ESTOQUE ( KDOMAIN, TARGET_KEST_PRODUTO, PROX_MES ) ;'
      +#13#10''
      +#13#10'       -- next target'
      +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
      +#13#10'       RC_TARGET = ROW_COUNT ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
      +#13#10''
      +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
      +#13#10'    BEGIN'
      +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
      +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
      +#13#10''
      +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
      +#13#10'       SET ENCERRADO = ''T'''
      +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
      +#13#10''
      +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
      +#13#10'    END'
      +#13#10''
      +#13#10'  CLOSE TARGET ;'
      +#13#10'  CLOSE SOURCE ;'
      +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
      +#13#10''
      +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
      +#13#10'                    WHERE KCAD_FAZENDA = :KDOMAIN'
      +#13#10'                      AND ANO_MES = :ANO_MES_PROX ) ) THEN'
      +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KCAD_FAZENDA, ANO_MES )'
      +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES_PROX ) ;'
      +#13#10''
      +#13#10'END' ) ;

       EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );

       ExecuteDirect (
                     'EXECUTE BLOCK'
              +#13#10'AS'
              +#13#10'declare KSYS$DOMAIN  SYS$FKGUID20 ;'
              +#13#10'declare KEST_PRODUTO SYS$FKGUID20 ;'
              +#13#10'BEGIN'
              +#13#10'  FOR SELECT KSYS$DOMAIN, KEST_PRODUTO FROM EST_PRODUTOS INTO KSYS$DOMAIN, KEST_PRODUTO DO'
              +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE( KSYS$DOMAIN, KEST_PRODUTO,  CAST ( ''01.01.1900'' AS DATE) ) ;'
              +#13#10'END' ) ;

       EncerramentoMensal.Free ;

end;

procedure TDBFinanceiroUpdate._5_000_27;
var
  EncerramentoMensal : TEncerramentoMensal ;
begin

         ExecuteDirect (
                 'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MES ('
          +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
          +#13#10'AS'
          +#13#10'DECLARE SOURCE_KEST_PRODUTO SYS$FKGUID20;'
          +#13#10'DECLARE SOURCE_NOME SYS$DESCR;'
          +#13#10'DECLARE SOURCE_QTDE_ESTOQUE SYS$FLOAT;'
          +#13#10''
          +#13#10'DECLARE SOURCE_QTDE_ENTRADAS SYS$FLOAT;'
          +#13#10'DECLARE SOURCE_SOMA_ENTRADA_X_CUSTO SYS$FLOAT;'
          +#13#10'DECLARE SOURCE_ESTOQUE_ANTERIOR SYS$FLOAT;'
          +#13#10'DECLARE SOURCE_CM_ANTERIOR SYS$FLOAT;'
          +#13#10''
          +#13#10'DECLARE CUSTO_MEDIO SYS$FLOAT;'
          +#13#10'DECLARE SOMA_EA_QE  SYS$FLOAT;'
          +#13#10''
          +#13#10'DECLARE TARGET_KEST_PRODUTO SYS$FKGUID20;'
          +#13#10'DECLARE TARGET_NOME SYS$DESCR;'
          +#13#10'DECLARE TARGET_QTDE_ESTOQUE SYS$FLOAT;'
          +#13#10'DECLARE TARGET_CUSTO_MEDIO SYS$FLOAT;'
          +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
          +#13#10'DECLARE ANO_MES_ANT SYS$ANO_MES = NULL ;'
          +#13#10'DECLARE ANO_MES SYS$ANO_MES = NULL ;'
          +#13#10'DECLARE ENCERRADO SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE RLOG$OFF VARCHAR(1);'
          +#13#10'DECLARE RC_SOURCE INTEGER;'
          +#13#10'DECLARE RC_TARGET INTEGER;'
          +#13#10'DECLARE EST$ENCERRAMES_OFF VARCHAR(1);'
          +#13#10'DECLARE SOURCE CURSOR FOR (SELECT'
          +#13#10'         E.KEST_PRODUTO,'
          +#13#10'         P.NOME,'
          +#13#10'         (SELECT'
          +#13#10'           ESTOQUE'
          +#13#10'            FROM EST_MOVIMENTO QE'
          +#13#10'           WHERE'
          +#13#10'                 QE.KEST_PRODUTO = E.KEST_PRODUTO'
          +#13#10'             AND QE.ANO_MES <= :ANO_MES'
          +#13#10'           ORDER BY QE.DATA DESC, QE.MOVTO_ID DESC'
          +#13#10'           ROWS 1'
          +#13#10'         ) QTDE_ESTOQUE,'
          +#13#10'         (SELECT'
          +#13#10'           SUM( C.QTDE )'
          +#13#10'            FROM EST_MOVIMENTO C'
          +#13#10'           WHERE'
          +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
          +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
          +#13#10'             AND C.ANO_MES = :ANO_MES'
          +#13#10'         ) QTDE_ENTRADAS ,'
          +#13#10'         (SELECT'
          +#13#10'           SUM( C.QTDE * C.CUSTO )'
          +#13#10'            FROM EST_MOVIMENTO C'
          +#13#10'           WHERE'
          +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
          +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
          +#13#10'             AND C.ANO_MES = :ANO_MES'
          +#13#10'         ) SOMA_ENTRADA_X_CUSTO,'
          +#13#10'         EMP.QTDE_ESTOQUE ESTOQUE_ANTERIOR,'
          +#13#10'         EMP.CUSTO_MEDIO  CM_ANTERIOR'
          +#13#10'         FROM EST_MOVIMENTO E'
          +#13#10'         LEFT JOIN EST_PRODUTOS P ON ( P.KEST_PRODUTO = E.KEST_PRODUTO )'
          +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES EM ON ( EM.ANO_MES = :ANO_MES_ANT )'
          +#13#10'         LEFT JOIN EST_ENCERRAMENTO_MES_PRODUTOS EMP ON ( EMP.KEST_ENCERRAMENTO_MES = EM.KEST_ENCERRAMENTO_MES AND EMP.KEST_PRODUTO = E.KEST_PRODUTO )'
          +#13#10'         WHERE E.TIPO = ''C'''
          +#13#10'         AND E.ANO_MES <= :ANO_MES'
          +#13#10'         ORDER BY E.KEST_PRODUTO'
          +#13#10' );'
          +#13#10'DECLARE TARGET CURSOR FOR (SELECT KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO'
          +#13#10'         FROM  EST_ENCERRAMENTO_MES_PRODUTOS'
          +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
          +#13#10'         ORDER BY KEST_PRODUTO );'
          +#13#10'DECLARE CURSOR_ENCERRAMENTO CURSOR FOR (SELECT KCAD_FAZENDA, ANO_MES, ENCERRADO'
          +#13#10'         FROM EST_ENCERRAMENTO_MES'
          +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES );'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10''
          +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
          +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
          +#13#10''
          +#13#10'   IF ( RIGHT ( ANO_MES, 2 ) = ''01'' ) THEN'
          +#13#10'     ANO_MES_ANT = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) - 1), 4 ) || ''12'' ;'
          +#13#10'   ELSE'
          +#13#10'     ANO_MES_ANT = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) - 1), 2) ;'
          +#13#10''
          +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
          +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
          +#13#10''
          +#13#10''
          +#13#10'  OPEN SOURCE ;'
          +#13#10'  FETCH SOURCE'
          +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR  ;'
          +#13#10'  RC_SOURCE = ROW_COUNT ;'
          +#13#10''
          +#13#10'  OPEN TARGET ;'
          +#13#10'  FETCH TARGET'
          +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
          +#13#10'  RC_TARGET = ROW_COUNT ;'
          +#13#10''
          +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
          +#13#10'    BEGIN'
          +#13#10''
          +#13#10'       IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
          +#13#10'        LEAVE ;'
          +#13#10''
          +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
          +#13#10'        BEGIN'
          +#13#10'          IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
          +#13#10'               SOURCE_ESTOQUE_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'          IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
          +#13#10'               SOURCE_QTDE_ENTRADAS = 0 ;'
          +#13#10''
          +#13#10'          IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
          +#13#10'               SOURCE_CM_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'          SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
          +#13#10'          IF ( SOMA_EA_QE = 0 ) THEN'
          +#13#10'             SOMA_EA_QE = 1 ;'
          +#13#10''
          +#13#10'          CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
          +#13#10''
          +#13#10''
          +#13#10'          --update target'
          +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
          +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
          +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM CUSTO_MEDIO  ) ) then'
          +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
          +#13#10'                  SET'
          +#13#10'                   NOME            = :SOURCE_NOME,'
          +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
          +#13#10'                   CUSTO_MEDIO     = :CUSTO_MEDIO'
          +#13#10'                WHERE CURRENT OF TARGET ;'
          +#13#10''
          +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
          +#13#10''
          +#13#10'          -- next source'
          +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
          +#13#10'          RC_SOURCE = ROW_COUNT ;'
          +#13#10'          -- next target'
          +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
          +#13#10'          RC_TARGET = ROW_COUNT ;'
          +#13#10'        END'
          +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
          +#13#10'          BEGIN'
          +#13#10'            -- delete target'
          +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
          +#13#10''
          +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
          +#13#10''
          +#13#10'            -- next target'
          +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
          +#13#10'            RC_TARGET = ROW_COUNT ;'
          +#13#10'          END'
          +#13#10'       ELSE'
          +#13#10'          BEGIN'
          +#13#10'            IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
          +#13#10'                 SOURCE_ESTOQUE_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'            IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
          +#13#10'                 SOURCE_QTDE_ENTRADAS = 0 ;'
          +#13#10''
          +#13#10'            IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
          +#13#10'                 SOURCE_CM_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'            SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
          +#13#10'            IF ( SOMA_EA_QE = 0 ) THEN'
          +#13#10'               SOMA_EA_QE = 1 ;'
          +#13#10''
          +#13#10'            CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
          +#13#10''
          +#13#10'            -- insert into target'
          +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
          +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
          +#13#10'            VALUES'
          +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
          +#13#10''
          +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
          +#13#10''
          +#13#10'            -- next source'
          +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
          +#13#10'            RC_SOURCE = ROW_COUNT ;'
          +#13#10'          END'
          +#13#10''
          +#13#10'    END'
          +#13#10''
          +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
          +#13#10'    BEGIN'
          +#13#10'       IF ( (SOURCE_ESTOQUE_ANTERIOR IS NULL) OR (SOURCE_ESTOQUE_ANTERIOR < 0) ) THEN'
          +#13#10'          SOURCE_ESTOQUE_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'       IF ( (SOURCE_QTDE_ENTRADAS IS NULL) OR (SOURCE_QTDE_ENTRADAS < 0) ) THEN'
          +#13#10'          SOURCE_QTDE_ENTRADAS = 0 ;'
          +#13#10''
          +#13#10'       IF ( SOURCE_CM_ANTERIOR IS NULL ) THEN'
          +#13#10'          SOURCE_CM_ANTERIOR = 0 ;'
          +#13#10''
          +#13#10'       SOMA_EA_QE = SOURCE_ESTOQUE_ANTERIOR + SOURCE_QTDE_ENTRADAS ;'
          +#13#10'       IF ( SOMA_EA_QE = 0 ) THEN'
          +#13#10'          SOMA_EA_QE = 1 ;'
          +#13#10''
          +#13#10'       CUSTO_MEDIO = (( SOURCE_ESTOQUE_ANTERIOR * SOURCE_CM_ANTERIOR ) + SOURCE_SOMA_ENTRADA_X_CUSTO) / SOMA_EA_QE ;'
          +#13#10''
          +#13#10'      -- insert target'
          +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
          +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
          +#13#10'      VALUES'
          +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :CUSTO_MEDIO ) ;'
          +#13#10''
          +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, CUSTO_MEDIO ;'
          +#13#10''
          +#13#10'      -- next source'
          +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_QTDE_ENTRADAS, SOURCE_SOMA_ENTRADA_X_CUSTO, SOURCE_ESTOQUE_ANTERIOR, SOURCE_CM_ANTERIOR ;'
          +#13#10'      RC_SOURCE = ROW_COUNT ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
          +#13#10'    BEGIN'
          +#13#10'       -- delete target'
          +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
          +#13#10''
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
          +#13#10''
          +#13#10'       -- next target'
          +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
          +#13#10'       RC_TARGET = ROW_COUNT ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
          +#13#10''
          +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
          +#13#10'    BEGIN'
          +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
          +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
          +#13#10''
          +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
          +#13#10'       SET ENCERRADO = ''T'''
          +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
          +#13#10''
          +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'  CLOSE TARGET ;'
          +#13#10'  CLOSE SOURCE ;'
          +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
          +#13#10''
          +#13#10'  IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
          +#13#10'    ANO_MES = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
          +#13#10'  ELSE'
          +#13#10'    ANO_MES = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1), 2) ;'
          +#13#10''
          +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
          +#13#10'                    WHERE KCAD_FAZENDA = :KDOMAIN'
          +#13#10'                      AND ANO_MES = :ANO_MES ) ) THEN'
          +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KCAD_FAZENDA, ANO_MES )'
          +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES ) ;'
          +#13#10''
          +#13#10'END'
          ) ;

       EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );

       ExecuteDirect (
                     'EXECUTE BLOCK'
              +#13#10'AS'
              +#13#10'declare KSYS$DOMAIN  SYS$FKGUID20 ;'
              +#13#10'declare KEST_PRODUTO SYS$FKGUID20 ;'
              +#13#10'BEGIN'
              +#13#10'  FOR SELECT KSYS$DOMAIN, KEST_PRODUTO FROM EST_PRODUTOS INTO KSYS$DOMAIN, KEST_PRODUTO DO'
              +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE( KSYS$DOMAIN, KEST_PRODUTO,  CAST ( ''01.01.1900'' AS DATE) ) ;'
              +#13#10'END' ) ;

       EncerramentoMensal.Free ;

end;


procedure TDBFinanceiroUpdate._5_000_26;
var
  EncerramentoMensal : TEncerramentoMensal ;
begin
          ExecuteDirect (

               'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE('
        +#13#10'    KDOMAIN SYS$FKGUID20,'
        +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
        +#13#10'    DATA SYS$DATE)'
        +#13#10'AS'
        +#13#10'DECLARE TIPO             CHAR ;'
        +#13#10'DECLARE ESTOQUE          SYS$FLOAT ;'
        +#13#10'DECLARE ESTOQUE_ANTERIOR SYS$FLOAT ;'
        +#13#10'DECLARE QTDE             SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO            SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO_ANTERIOR   SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO_MEDIO      SYS$FLOAT ;'
        +#13#10'DECLARE TOTAL_ENTRADA    SYS$FLOAT ;'
        +#13#10'DECLARE TOTAL_SAIDA      SYS$FLOAT ;'
        +#13#10''
        +#13#10'DECLARE DATAMOVTO        SYS$DATE ;'
        +#13#10''
        +#13#10'DECLARE EST$MOVTO_OFF varchar( 1 ) ;'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
        +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
        +#13#10''
        +#13#10'  CUSTO_ANTERIOR   = null ;'
        +#13#10'  CUSTO_MEDIO      = null ;'
        +#13#10'  ESTOQUE_ANTERIOR = null ;'
        +#13#10''
        +#13#10'  /* seleciona o estoque anterior */'
        +#13#10'  SELECT TIPO, CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
        +#13#10'  FROM EST_MOVIMENTO'
        +#13#10'  WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    AND DATA < :DATA'
        +#13#10'    AND TIPO <> ''C'''
        +#13#10'  ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
        +#13#10'  ROWS 1'
        +#13#10'  INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
        +#13#10''
        +#13#10'  /* seleciona o estoque anterior */'
        +#13#10'  IF ( TIPO = ''S'' ) THEN'
        +#13#10'     SELECT CUSTO_MEDIO'
        +#13#10'       FROM EST_MOVIMENTO'
        +#13#10'      WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'        AND DATA < :DATA'
        +#13#10'        AND TIPO = ''E'''
        +#13#10'     ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
        +#13#10'     ROWS 1'
        +#13#10'     INTO CUSTO_ANTERIOR ;'
        +#13#10''
        +#13#10'  if ( ( CUSTO_ANTERIOR IS null ) AND ( CUSTO_MEDIO IS NULL ) AND ( ESTOQUE_ANTERIOR IS NULL ) ) THEN'
        +#13#10'    SELECT CUSTO_INICIAL, CUSTO_INICIAL, QTDE_INICIAL, DATA_SALDOINICIAL'
        +#13#10'    FROM EST_PRODUTOS'
        +#13#10'    WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'      AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    ROWS 1'
        +#13#10'    INTO CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
        +#13#10''
        +#13#10''
        +#13#10'  FOR SELECT'
        +#13#10'       TIPO, QTDE, CUSTO, DATA'
        +#13#10'  FROM EST_MOVIMENTO'
        +#13#10'  WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    AND DATA >= :DATA'
        +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
        +#13#10'  INTO TIPO, QTDE, CUSTO, DATAMOVTO'
        +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
        +#13#10'  DO'
        +#13#10'    BEGIN'
        +#13#10''
        +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
        +#13#10'        BEGIN'
        +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
        +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
        +#13#10'        END'
        +#13#10'      ELSE IF (    ( TIPO = ''E'' )'
        +#13#10'          AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
        +#13#10'          ) THEN'
        +#13#10'         CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
        +#13#10''
        +#13#10'      IF ( TIPO <> ''E'' ) THEN'
        +#13#10'         CUSTO = CUSTO_ANTERIOR ;'
        +#13#10''
        +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
        +#13#10''
        +#13#10'      UPDATE EST_MOVIMENTO'
        +#13#10'         SET'
        +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
        +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
        +#13#10'             ESTOQUE          = :ESTOQUE'
        +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
        +#13#10''
        +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
        +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
        +#13#10''
        +#13#10'    END'
        +#13#10''
        +#13#10'  -- revisar....'
        +#13#10'  -- Atualiza status atual produto'
        +#13#10'    SELECT'
        +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
        +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA'
        +#13#10'     FROM EST_MOVIMENTO ME'
        +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'       AND ME.TIPO <> ''C'''
        +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA ;'
        +#13#10''
        +#13#10'    UPDATE EST_PRODUTOS'
        +#13#10'       SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
        +#13#10'           QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
        +#13#10'           CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
        +#13#10'           CUSTO_MEDIO_MES   = NULL'
        +#13#10'    WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
        +#13#10''
        +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
        +#13#10''
        +#13#10''
        +#13#10'END' ) ;

         ExecuteDirect (
               'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MES ('
        +#13#10'    kest_encerramento_mes sys$pkguid20)'
        +#13#10'as'
        +#13#10'declare variable source_kest_produto sys$fkguid20;'
        +#13#10'declare variable source_nome sys$descr;'
        +#13#10'declare variable source_qtde_estoque sys$float;'
        +#13#10'declare variable source_custo_medio sys$float;'
        +#13#10'declare variable target_kest_produto sys$fkguid20;'
        +#13#10'declare variable target_nome sys$descr;'
        +#13#10'declare variable target_qtde_estoque sys$float;'
        +#13#10'declare variable target_custo_medio sys$float;'
        +#13#10'declare variable kdomain sys$fkguid20;'
        +#13#10'declare variable ano_mes sys$ano_mes = null ;'
        +#13#10'declare variable encerrado sys$bool_null = null ;'
        +#13#10'declare variable rlog$off varchar(1);'
        +#13#10'declare variable rc_source integer;'
        +#13#10'declare variable rc_target integer;'
        +#13#10'declare variable est$encerrames_off varchar(1);'
        +#13#10'declare source cursor for (select'
        +#13#10'         e.kest_produto,'
        +#13#10'         p.nome,'
        +#13#10'         (select'
        +#13#10'           estoque'
        +#13#10'            from est_movimento qe'
        +#13#10'           where'
        +#13#10'                 qe.kest_produto = e.kest_produto'
        +#13#10'             and qe.ano_mes <= :ano_mes'
        +#13#10'           order by qe.data desc, qe.movto_id desc'
        +#13#10'           rows 1'
        +#13#10'         ) qtde_estoque,'
        +#13#10'         (select'
        +#13#10'           custo_medio'
        +#13#10'            from est_movimento qe'
        +#13#10'           where'
        +#13#10'                 qe.kest_produto = e.kest_produto'
        +#13#10'             and qe.ano_mes <= :ano_mes'
        +#13#10'           order by qe.data desc, qe.movto_id desc'
        +#13#10'           rows 1'
        +#13#10'         ) custo_medio'
        +#13#10'         from est_movimento e'
        +#13#10'         left join est_produtos p on ( p.kest_produto = e.kest_produto )'
        +#13#10'         where e.tipo = ''C'''
        +#13#10'         and e.ano_mes <= :ano_mes'
        +#13#10'         order by e.kest_produto'
        +#13#10' );'
        +#13#10'declare target cursor for (select kest_produto, nome, qtde_estoque, custo_medio'
        +#13#10'         from  est_encerramento_mes_produtos'
        +#13#10'         where kest_encerramento_mes = :kest_encerramento_mes'
        +#13#10'         order by kest_produto );'
        +#13#10'declare cursor_encerramento cursor for (select kcad_fazenda, ano_mes, encerrado'
        +#13#10'         from est_encerramento_mes'
        +#13#10'         where kest_encerramento_mes = :kest_encerramento_mes );'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
        +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
        +#13#10''
        +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
        +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
        +#13#10''
        +#13#10''
        +#13#10'  OPEN SOURCE ;'
        +#13#10'  FETCH SOURCE'
        +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
        +#13#10'  RC_SOURCE = ROW_COUNT ;'
        +#13#10''
        +#13#10'  OPEN TARGET ;'
        +#13#10'  FETCH TARGET'
        +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'  RC_TARGET = ROW_COUNT ;'
        +#13#10''
        +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
        +#13#10'    BEGIN'
        +#13#10''
        +#13#10'      IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
        +#13#10'        LEAVE ;'
        +#13#10''
        +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
        +#13#10'        BEGIN'
        +#13#10'          --update target'
        +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
        +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
        +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM SOURCE_CUSTO_MEDIO  ) ) then'
        +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'                  SET'
        +#13#10'                   NOME            = :SOURCE_NOME,'
        +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
        +#13#10'                   CUSTO_MEDIO     = :SOURCE_CUSTO_MEDIO'
        +#13#10'                WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
        +#13#10''
        +#13#10'          -- next source'
        +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
        +#13#10'          RC_SOURCE = ROW_COUNT ;'
        +#13#10'          -- next target'
        +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'          RC_TARGET = ROW_COUNT ;'
        +#13#10'        END'
        +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
        +#13#10'          BEGIN'
        +#13#10'            -- delete target'
        +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
        +#13#10''
        +#13#10'            -- next target'
        +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'            RC_TARGET = ROW_COUNT ;'
        +#13#10'          END'
        +#13#10'       ELSE'
        +#13#10'          BEGIN'
        +#13#10'            -- insert into target'
        +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
        +#13#10'            VALUES'
        +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :SOURCE_CUSTO_MEDIO ) ;'
        +#13#10''
        +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
        +#13#10''
        +#13#10'            -- next source'
        +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
        +#13#10'            RC_SOURCE = ROW_COUNT ;'
        +#13#10'          END'
        +#13#10''
        +#13#10'    END'
        +#13#10''
        +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
        +#13#10'    BEGIN'
        +#13#10'      -- insert target'
        +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
        +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
        +#13#10'      VALUES'
        +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :SOURCE_CUSTO_MEDIO ) ;'
        +#13#10''
        +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
        +#13#10''
        +#13#10'      -- next source'
        +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
        +#13#10'      RC_SOURCE = ROW_COUNT ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
        +#13#10'    BEGIN'
        +#13#10'       -- delete target'
        +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
        +#13#10''
        +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
        +#13#10''
        +#13#10'       -- next target'
        +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
        +#13#10'       RC_TARGET = ROW_COUNT ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
        +#13#10''
        +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
        +#13#10'    BEGIN'
        +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
        +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
        +#13#10''
        +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
        +#13#10'       SET ENCERRADO = ''T'''
        +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
        +#13#10''
        +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
        +#13#10'    END'
        +#13#10''
        +#13#10'  CLOSE TARGET ;'
        +#13#10'  CLOSE SOURCE ;'
        +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
        +#13#10''
        +#13#10'  IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
        +#13#10'    ANO_MES = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
        +#13#10'  ELSE'
        +#13#10'    ANO_MES = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1 ), 2) ;'
        +#13#10''
        +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
        +#13#10'                    WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'                      AND ANO_MES = :ANO_MES ) ) THEN'
        +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KCAD_FAZENDA, ANO_MES )'
        +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES ) ;'
        +#13#10''
        +#13#10'END' ) ;

       EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );

      try
          ExecuteDirect (
                'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10'ADD KFIN_SETOR   SYS$FKGUID20,'
       +#13#10'ALTER KFIN_SETOR POSITION 18' ) ;

      except

      end;

          ExecuteDirect (
              'ALTER TABLE CAD_PATRIMONIO_DEPRECIACOES'
       +#13#10'ALTER VALOR_PATRIMONIO COMPUTED BY'
       +#13#10'('
       +#13#10'  ('
       +#13#10'    SELECT P.VALOR_UNITARIO * P.QUANTIDADE'
       +#13#10'    FROM CAD_PATRIMONIOS P'
       +#13#10'    WHERE P.KCAD_PATRIMONIO = CAD_PATRIMONIO_DEPRECIACOES.KCAD_PATRIMONIO'
       +#13#10'    ROWS 1'
       +#13#10'  )'
       +#13#10'  -'
       +#13#10'  ('
       +#13#10'    SELECT SUM(D.VALOR) FROM CAD_PATRIMONIO_DEPRECIACOES D'
       +#13#10'    WHERE D.KCAD_PATRIMONIO = CAD_PATRIMONIO_DEPRECIACOES.KCAD_PATRIMONIO'
       +#13#10'    AND D.DATA <= CAD_PATRIMONIO_DEPRECIACOES.DATA'
       +#13#10'  )'
       +#13#10')' ) ;
                                      (*26 nao
          ExecuteDirect (
              'EXECUTE BLOCK'
       +#13#10'AS'
       +#13#10'DECLARE KCAD_PATRIMONIO_DEPRECIACAO SYS$FKGUID20 ;'
       +#13#10'DECLARE DATA SYS$DATE ;'
       +#13#10'BEGIN'
       +#13#10'  FOR SELECT'
       +#13#10'    D.KCAD_PATRIMONIO_DEPRECIACAO,'
       +#13#10'    DATEADD( MONTH, IIF ( EXTRACT( DAY FROM P.DATA_IMOBILIZADO ) <= 15, 1, 2 ), D.DATA - EXTRACT( DAY FROM D.DATA ) + 1 ) - 1 DATA'
       +#13#10'  FROM CAD_PATRIMONIO_DEPRECIACOES D'
       +#13#10'  LEFT JOIN CAD_PATRIMONIOS P ON P.KCAD_PATRIMONIO = D.KCAD_PATRIMONIO'
       +#13#10'  INTO KCAD_PATRIMONIO_DEPRECIACAO, DATA'
       +#13#10'  DO'
       +#13#10'    UPDATE CAD_PATRIMONIO_DEPRECIACOES'
       +#13#10'    SET'
       +#13#10'           DATA = :DATA'
       +#13#10'    WHERE KCAD_PATRIMONIO_DEPRECIACAO = :KCAD_PATRIMONIO_DEPRECIACAO ;'
       +#13#10'END' ) ;

                                              *)
       tryExecuteDirect (
                'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10'ADD CONSTRAINT FKCAD_PATRIMONIOS_04'
       +#13#10'FOREIGN KEY (KFIN_SETOR)'
       +#13#10'REFERENCES FIN_CENTROSCUSTO (KFIN_CENTROCUSTO) ON UPDATE CASCADE' ) ;


          ExecuteDirect (
             'UPDATE FIN_APAGAR A'
      +#13#10'SET A.VALOR ='
      +#13#10' (SELECT SUM ( P.VALOR )'
      +#13#10'  FROM FIN_APAGAR_PARCELAS P'
      +#13#10'  WHERE A.KFIN_APAGAR = P.KFIN_APAGAR'
      +#13#10' )'
      +#13#10'WHERE A.VALOR = 0' ) ;

      //1
          ExecuteDirect (
                'UPDATE FIN_APAGAR SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KFIN_APAGAR IN'
      +#13#10'(SELECT I.KFIN_APAGAR FROM FIN_APAGAR I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //2
      ExecuteDirect (
             'UPDATE FIN_ARECEBER SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KFIN_ARECEBER IN'
      +#13#10'(SELECT I.KFIN_ARECEBER I FROM FIN_ARECEBER I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //3
      ExecuteDirect (
             'UPDATE CMP_PEDIDO_ITENS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KCMP_PEDIDO_ITEM IN'
      +#13#10'(SELECT I.KCMP_PEDIDO_ITEM FROM CMP_PEDIDO_ITENS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //4
      ExecuteDirect (
             'UPDATE CMP_PEDIDO_SERVICOS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KCMP_PEDIDO_SERVICO IN'
      +#13#10'(SELECT I.KCMP_PEDIDO_SERVICO FROM CMP_PEDIDO_SERVICOS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //5
      ExecuteDirect (
             'UPDATE VND_PEDIDO_ITENS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KVND_PEDIDO_ITEM IN'
      +#13#10'(SELECT I.KVND_PEDIDO_ITEM FROM VND_PEDIDO_ITENS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //6
      ExecuteDirect (
            'UPDATE VND_PEDIDO_SERVICOS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KVND_PEDIDO_SERVICO IN'
      +#13#10'(SELECT I.KVND_PEDIDO_SERVICO FROM VND_PEDIDO_SERVICOS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //7
      ExecuteDirect (
               'UPDATE EST_OUTRAS_ENTRADAS_SAIDAS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KEST_OUTRA_ENTRADA_SAIDA IN'
      +#13#10'(SELECT I.KEST_OUTRA_ENTRADA_SAIDA FROM EST_OUTRAS_ENTRADAS_SAIDAS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

         //1
         tryExecuteDirect (
             'ALTER TABLE FIN_APAGAR   DROP CONSTRAINT FKFIN_APAGAR_03' ) ;

         //2
         tryExecuteDirect (
             'ALTER TABLE FIN_ARECEBER DROP CONSTRAINT FKFIN_ARECEBER_03' ) ;

         //1
         tryExecuteDirect (
             'ALTER TABLE FIN_APAGAR   ADD CONSTRAINT FKFIN_APAGAR_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //2
         tryExecuteDirect (
             'ALTER TABLE FIN_ARECEBER ADD CONSTRAINT FKFIN_ARECEBER_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //3
         tryExecuteDirect (
             'ALTER TABLE CMP_PEDIDO_ITENS ADD CONSTRAINT FKCMP_PEDIDO_ITENS_04 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //4
         tryExecuteDirect (
             'ALTER TABLE CMP_PEDIDO_SERVICOS ADD CONSTRAINT FKCMP_PEDIDO_SERVICOS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //5
         tryExecuteDirect (
             'ALTER TABLE VND_PEDIDO_ITENS ADD CONSTRAINT FKVND_PEDIDO_ITENS_04 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //6
         tryExecuteDirect (
             'ALTER TABLE VND_PEDIDO_SERVICOS ADD CONSTRAINT FKVND_PEDIDO_SERVICOS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //7
         tryExecuteDirect (
             'ALTER TABLE EST_OUTRAS_ENTRADAS_SAIDAS ADD CONSTRAINT FKEST_OUTRAS_ENTRADAS_SAIDAS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

          ExecuteDirect (
                     'EXECUTE BLOCK'
              +#13#10'AS'
              +#13#10'declare KSYS$DOMAIN  SYS$FKGUID20 ;'
              +#13#10'declare KEST_PRODUTO SYS$FKGUID20 ;'
              +#13#10'BEGIN'
              +#13#10'  FOR SELECT KSYS$DOMAIN, KEST_PRODUTO FROM EST_PRODUTOS INTO KSYS$DOMAIN, KEST_PRODUTO DO'
              +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE( KSYS$DOMAIN, KEST_PRODUTO,  CAST ( ''01.01.1900'' AS DATE) ) ;'
              +#13#10'END' ) ;

       EncerramentoMensal.Free ;

end;

procedure TDBFinanceiroUpdate._5_000_25;
var
  EncerramentoMensal : TEncerramentoMensal ;

begin
          ExecuteDirect (

               'CREATE OR ALTER PROCEDURE EST_UPDATE_ESTOQUE('
        +#13#10'    KDOMAIN SYS$FKGUID20,'
        +#13#10'    KEST_PRODUTO SYS$FKGUID20,'
        +#13#10'    DATA SYS$DATE)'
        +#13#10'AS'
        +#13#10'DECLARE TIPO             CHAR ;'
        +#13#10'DECLARE ESTOQUE          SYS$FLOAT ;'
        +#13#10'DECLARE ESTOQUE_ANTERIOR SYS$FLOAT ;'
        +#13#10'DECLARE QTDE             SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO            SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO_ANTERIOR   SYS$FLOAT ;'
        +#13#10'DECLARE CUSTO_MEDIO      SYS$FLOAT ;'
        +#13#10'DECLARE TOTAL_ENTRADA    SYS$FLOAT ;'
        +#13#10'DECLARE TOTAL_SAIDA      SYS$FLOAT ;'
        +#13#10''
        +#13#10'DECLARE DATAMOVTO        SYS$DATE ;'
        +#13#10''
        +#13#10'DECLARE EST$MOVTO_OFF varchar( 1 ) ;'
        +#13#10'BEGIN'
        +#13#10''
        +#13#10'  EST$MOVTO_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'' ) ;'
        +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'', ''1'' ) ;'
        +#13#10''
        +#13#10'  CUSTO_ANTERIOR   = null ;'
        +#13#10'  CUSTO_MEDIO      = null ;'
        +#13#10'  ESTOQUE_ANTERIOR = null ;'
        +#13#10''
        +#13#10'  /* seleciona o estoque anterior */'
        +#13#10'  SELECT TIPO, CUSTO, CUSTO_MEDIO, ESTOQUE, DATA'
        +#13#10'  FROM EST_MOVIMENTO'
        +#13#10'  WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    AND DATA < :DATA'
        +#13#10'    AND TIPO <> ''C'''
        +#13#10'  ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
        +#13#10'  ROWS 1'
        +#13#10'  INTO TIPO, CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
        +#13#10''
        +#13#10'  /* seleciona o estoque anterior */'
        +#13#10'  IF ( TIPO = ''S'' ) THEN'
        +#13#10'     SELECT CUSTO_MEDIO'
        +#13#10'       FROM EST_MOVIMENTO'
        +#13#10'      WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'        AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'        AND DATA < :DATA'
        +#13#10'        AND TIPO = ''E'''
        +#13#10'     ORDER BY CAST ( DATA AS DATE ) DESC, MOVTO_ID DESC'
        +#13#10'     ROWS 1'
        +#13#10'     INTO CUSTO_ANTERIOR ;'
        +#13#10''
        +#13#10'  if ( ( CUSTO_ANTERIOR IS null ) AND ( CUSTO_MEDIO IS NULL ) AND ( ESTOQUE_ANTERIOR IS NULL ) ) THEN'
        +#13#10'    SELECT CUSTO_INICIAL, CUSTO_INICIAL, QTDE_INICIAL, DATA_SALDOINICIAL'
        +#13#10'    FROM EST_PRODUTOS'
        +#13#10'    WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'      AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    ROWS 1'
        +#13#10'    INTO CUSTO_ANTERIOR, CUSTO_MEDIO, ESTOQUE_ANTERIOR, DATAMOVTO ;'
        +#13#10''
        +#13#10''
        +#13#10'  FOR SELECT'
        +#13#10'       TIPO, QTDE, CUSTO, DATA'
        +#13#10'  FROM EST_MOVIMENTO'
        +#13#10'  WHERE KCAD_FAZENDA = :KDOMAIN'
        +#13#10'    AND KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'    AND DATA >= :DATA'
        +#13#10'  ORDER BY CAST ( DATA AS DATE ), MOVTO_ID'
        +#13#10'  INTO TIPO, QTDE, CUSTO, DATAMOVTO'
        +#13#10'  AS CURSOR CURSOR_MOVIMENTO'
        +#13#10'  DO'
        +#13#10'    BEGIN'
        +#13#10''
        +#13#10'      IF ( TIPO IN ( ''C'' ) ) THEN'
        +#13#10'        BEGIN'
        +#13#10'          QTDE             = ESTOQUE_ANTERIOR ;'
        +#13#10'          ESTOQUE_ANTERIOR = 0 ;'
        +#13#10'        END'
        +#13#10'      ELSE IF (    ( TIPO = ''E'' )'
        +#13#10'          AND ( ESTOQUE_ANTERIOR + ABS ( QTDE ) <> 0 )'
        +#13#10'          ) THEN'
        +#13#10'         CUSTO_MEDIO = (( ABS ( QTDE ) * CUSTO) + ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR )* CUSTO_MEDIO )) / ( IIF ( ESTOQUE_ANTERIOR < 0, 0, ESTOQUE_ANTERIOR ) + ABS ( QTDE ) ) ;'
        +#13#10''
        +#13#10'      IF ( TIPO <> ''E'' ) THEN'
        +#13#10'         CUSTO = CUSTO_ANTERIOR ;'
        +#13#10''
        +#13#10'      ESTOQUE  = ESTOQUE_ANTERIOR + QTDE ;'
        +#13#10''
        +#13#10'      UPDATE EST_MOVIMENTO'
        +#13#10'         SET'
        +#13#10'             CUSTO_MEDIO      = :CUSTO_MEDIO,'
        +#13#10'             --ESTOQUE_ANTERIOR = :ESTOQUE_ESTOQUE,'
        +#13#10'             ESTOQUE          = :ESTOQUE'
        +#13#10'      WHERE CURRENT OF CURSOR_MOVIMENTO ;'
        +#13#10''
        +#13#10'      ESTOQUE_ANTERIOR = ESTOQUE ;'
        +#13#10'      CUSTO_ANTERIOR   = CUSTO ;'
        +#13#10''
        +#13#10'    END'
        +#13#10''
        +#13#10'  -- revisar....'
        +#13#10'  -- Atualiza status atual produto'
        +#13#10'    SELECT'
        +#13#10'        SUM( IIF ( TIPO = ''E'',  ME.QTDE, 0 ) ) ENTRADA,'
        +#13#10'        SUM( IIF ( TIPO = ''S'', -ME.QTDE, 0 ) ) SAIDA'
        +#13#10'     FROM EST_MOVIMENTO ME'
        +#13#10'     WHERE ME.KEST_PRODUTO = :KEST_PRODUTO'
        +#13#10'       AND ME.TIPO <> ''C'''
        +#13#10'    INTO TOTAL_ENTRADA, TOTAL_SAIDA ;'
        +#13#10''
        +#13#10'    UPDATE EST_PRODUTOS'
        +#13#10'       SET QTDE_COMPRADA     = COALESCE( :TOTAL_ENTRADA, 0 ),'
        +#13#10'           QTDE_UTILIZADA    = COALESCE( :TOTAL_SAIDA, 0 ),'
        +#13#10'           CUSTO_MEDIO_MOVTO = COALESCE( :CUSTO_MEDIO, 0 ),'
        +#13#10'           CUSTO_MEDIO_MES   = NULL'
        +#13#10'    WHERE KEST_PRODUTO     = :KEST_PRODUTO ;'
        +#13#10''
        +#13#10'  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$MOVTO_OFF'',  EST$MOVTO_OFF ) ;'
        +#13#10''
        +#13#10''
        +#13#10'END' ) ;

       EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );

      try
          ExecuteDirect (
                'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10'ADD KFIN_SETOR   SYS$FKGUID20,'
       +#13#10'ALTER KFIN_SETOR POSITION 18' ) ;

      except

      end;

          ExecuteDirect (
              'ALTER TABLE CAD_PATRIMONIO_DEPRECIACOES'
       +#13#10'ALTER VALOR_PATRIMONIO COMPUTED BY'
       +#13#10'('
       +#13#10'  ('
       +#13#10'    SELECT P.VALOR_UNITARIO * P.QUANTIDADE'
       +#13#10'    FROM CAD_PATRIMONIOS P'
       +#13#10'    WHERE P.KCAD_PATRIMONIO = CAD_PATRIMONIO_DEPRECIACOES.KCAD_PATRIMONIO'
       +#13#10'    ROWS 1'
       +#13#10'  )'
       +#13#10'  -'
       +#13#10'  ('
       +#13#10'    SELECT SUM(D.VALOR) FROM CAD_PATRIMONIO_DEPRECIACOES D'
       +#13#10'    WHERE D.KCAD_PATRIMONIO = CAD_PATRIMONIO_DEPRECIACOES.KCAD_PATRIMONIO'
       +#13#10'    AND D.DATA <= CAD_PATRIMONIO_DEPRECIACOES.DATA'
       +#13#10'  )'
       +#13#10')' ) ;

          ExecuteDirect (
              'EXECUTE BLOCK'
       +#13#10'AS'
       +#13#10'DECLARE KCAD_PATRIMONIO_DEPRECIACAO SYS$FKGUID20 ;'
       +#13#10'DECLARE DATA SYS$DATE ;'
       +#13#10'BEGIN'
       +#13#10'  FOR SELECT'
       +#13#10'    D.KCAD_PATRIMONIO_DEPRECIACAO,'
       +#13#10'    DATEADD( MONTH, IIF ( EXTRACT( DAY FROM P.DATA_IMOBILIZADO ) <= 15, 1, 2 ), D.DATA - EXTRACT( DAY FROM D.DATA ) + 1 ) - 1 DATA'
       +#13#10'  FROM CAD_PATRIMONIO_DEPRECIACOES D'
       +#13#10'  LEFT JOIN CAD_PATRIMONIOS P ON P.KCAD_PATRIMONIO = D.KCAD_PATRIMONIO'
       +#13#10'  INTO KCAD_PATRIMONIO_DEPRECIACAO, DATA'
       +#13#10'  DO'
       +#13#10'    UPDATE CAD_PATRIMONIO_DEPRECIACOES'
       +#13#10'    SET'
       +#13#10'           DATA = :DATA'
       +#13#10'    WHERE KCAD_PATRIMONIO_DEPRECIACAO = :KCAD_PATRIMONIO_DEPRECIACAO ;'
       +#13#10'END' ) ;


       try
          ExecuteDirect (
                'ALTER TABLE CAD_PATRIMONIOS'
       +#13#10'ADD CONSTRAINT FKCAD_PATRIMONIOS_04'
       +#13#10'FOREIGN KEY (KFIN_SETOR)'
       +#13#10'REFERENCES FIN_CENTROSCUSTO (KFIN_CENTROCUSTO) ON UPDATE CASCADE' ) ;

       except

       end;


          ExecuteDirect (
             'UPDATE FIN_APAGAR A'
      +#13#10'SET A.VALOR ='
      +#13#10' (SELECT SUM ( P.VALOR )'
      +#13#10'  FROM FIN_APAGAR_PARCELAS P'
      +#13#10'  WHERE A.KFIN_APAGAR = P.KFIN_APAGAR'
      +#13#10' )'
      +#13#10'WHERE A.VALOR = 0' ) ;

      //1
          ExecuteDirect (
                'UPDATE FIN_APAGAR SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KFIN_APAGAR IN'
      +#13#10'(SELECT I.KFIN_APAGAR FROM FIN_APAGAR I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //2
      ExecuteDirect (
             'UPDATE FIN_ARECEBER SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KFIN_ARECEBER IN'
      +#13#10'(SELECT I.KFIN_ARECEBER I FROM FIN_ARECEBER I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //3
      ExecuteDirect (
             'UPDATE CMP_PEDIDO_ITENS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KCMP_PEDIDO_ITEM IN'
      +#13#10'(SELECT I.KCMP_PEDIDO_ITEM FROM CMP_PEDIDO_ITENS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //4
      ExecuteDirect (
             'UPDATE CMP_PEDIDO_SERVICOS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KCMP_PEDIDO_SERVICO IN'
      +#13#10'(SELECT I.KCMP_PEDIDO_SERVICO FROM CMP_PEDIDO_SERVICOS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //5
      ExecuteDirect (
             'UPDATE VND_PEDIDO_ITENS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KVND_PEDIDO_ITEM IN'
      +#13#10'(SELECT I.KVND_PEDIDO_ITEM FROM VND_PEDIDO_ITENS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //6
      ExecuteDirect (
            'UPDATE VND_PEDIDO_SERVICOS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KVND_PEDIDO_SERVICO IN'
      +#13#10'(SELECT I.KVND_PEDIDO_SERVICO FROM VND_PEDIDO_SERVICOS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

      //7
      ExecuteDirect (
               'UPDATE EST_OUTRAS_ENTRADAS_SAIDAS SET KFIN_PLANOCONTA = NULL'
      +#13#10'WHERE KEST_OUTRA_ENTRADA_SAIDA IN'
      +#13#10'(SELECT I.KEST_OUTRA_ENTRADA_SAIDA FROM EST_OUTRAS_ENTRADAS_SAIDAS I'
      +#13#10'LEFT JOIN FIN_PLANOCONTAS P ON P.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
      +#13#10'WHERE I.KFIN_PLANOCONTA IS NOT NULL AND P.KFIN_PLANOCONTA IS NULL) ' ) ;

         //1
         tryExecuteDirect (
             'ALTER TABLE FIN_APAGAR   DROP CONSTRAINT FKFIN_APAGAR_03' ) ;

         //2
         tryExecuteDirect (
             'ALTER TABLE FIN_ARECEBER DROP CONSTRAINT FKFIN_ARECEBER_03' ) ;

         //1
         tryExecuteDirect (
             'ALTER TABLE FIN_APAGAR   ADD CONSTRAINT FKFIN_APAGAR_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //2
         tryExecuteDirect (
             'ALTER TABLE FIN_ARECEBER ADD CONSTRAINT FKFIN_ARECEBER_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;


         //3
         tryExecuteDirect (
             'ALTER TABLE CMP_PEDIDO_ITENS ADD CONSTRAINT FKCMP_PEDIDO_ITENS_04 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //4
         tryExecuteDirect (
             'ALTER TABLE CMP_PEDIDO_SERVICOS ADD CONSTRAINT FKCMP_PEDIDO_SERVICOS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //5
         tryExecuteDirect (
             'ALTER TABLE VND_PEDIDO_ITENS ADD CONSTRAINT FKVND_PEDIDO_ITENS_04 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

         //6
         tryExecuteDirect (
             'ALTER TABLE VND_PEDIDO_SERVICOS ADD CONSTRAINT FKVND_PEDIDO_SERVICOS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;


         //7
         tryExecuteDirect (
             'ALTER TABLE EST_OUTRAS_ENTRADAS_SAIDAS ADD CONSTRAINT FKEST_OUTRAS_ENTRADAS_SAIDAS_03 FOREIGN KEY (KFIN_PLANOCONTA) REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA) ON UPDATE CASCADE' ) ;

          ExecuteDirect (
                     'EXECUTE BLOCK'
              +#13#10'AS'
              +#13#10'declare KSYS$DOMAIN  SYS$FKGUID20 ;'
              +#13#10'declare KEST_PRODUTO SYS$FKGUID20 ;'
              +#13#10'BEGIN'
              +#13#10'  FOR SELECT KSYS$DOMAIN, KEST_PRODUTO FROM EST_PRODUTOS INTO KSYS$DOMAIN, KEST_PRODUTO DO'
              +#13#10'    EXECUTE PROCEDURE EST_UPDATE_ESTOQUE( KSYS$DOMAIN, KEST_PRODUTO,  CAST ( ''01.01.1900'' AS DATE) ) ;'
              +#13#10'END' ) ;

   EncerramentoMensal.Free ;


end;

procedure TDBFinanceiroUpdate._5_000_19;
begin
         try
             ExecuteDirect ( 'UPDATE FIN_APROPRIACAO SET TABLEKEY = KFIN_ITEM WHERE TABLEKEY <> KFIN_ITEM' ) ;
         except
         end;

              ExecuteDirect (
              'CREATE OR ALTER PROCEDURE SYS$INIT_CENTROSCUSTO ('
       +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN)'
       +#13#10'AS'
       +#13#10'  DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
       +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
       +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
       +#13#10'  DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
       +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
       +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
       +#13#10'  DECLARE SYS$DU               SYS$DATE;'
       +#13#10'  DECLARE PATH VARCHAR( 256 );'
       +#13#10'BEGIN'
       +#13#10''
       +#13#10'   IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO) ) THEN'
       +#13#10'      EXIT ;'
       +#13#10''
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10''
       +#13#10'   IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
       +#13#10'     EXIT ;'
       +#13#10''
       +#13#10'   FOR EXECUTE STATEMENT ('
       +#13#10'          ''SELECT '''
       +#13#10'        ||'' KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO, '''
       +#13#10'        ||'' ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU '''
       +#13#10'        ||''FROM DEF_CENTROSCUSTO'''
       +#13#10'        ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
       +#13#10'        WITH COMMON TRANSACTION'
       +#13#10'        INTO :KDEF_CENTROCUSTO, :CODIGO, :NOME, :KMDEF_CENTROCUSTO,'
       +#13#10'             :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU'
       +#13#10'   DO'
       +#13#10'     BEGIN'
       +#13#10'        IF ( KMDEF_CENTROCUSTO IS NULL ) THEN'
       +#13#10'           KMFIN_CENTROCUSTO = NULL ;'
       +#13#10'        ELSE'
       +#13#10'           BEGIN'
       +#13#10'             SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
       +#13#10'             WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KMDEF_CENTROCUSTO'
       +#13#10'             INTO KMFIN_CENTROCUSTO ;'
       +#13#10'           END'
       +#13#10''
       +#13#10'        IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO ) ) THEN'
       +#13#10'           UPDATE FIN_CENTROSCUSTO'
       +#13#10'           SET'
       +#13#10'               CODIGO           = :CODIGO,'
       +#13#10'               NOME             = :NOME,'
       +#13#10'               KMFIN_CENTROCUSTO = :KMFIN_CENTROCUSTO,'
       +#13#10'               ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
       +#13#10'               CLASSIFICACAO       = :CLASSIFICACAO,'
       +#13#10'               ATIVO               = :ATIVO,'
       +#13#10'               SYS$DU              = :SYS$DU'
       +#13#10'            WHERE ( KCAD_FAZENDA = :pKCAD_FAZENDA  AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO )'
       +#13#10'             AND ( KDEF_CENTROCUSTO <> ''La;m;0+smOQ+4RnK^6as'' )'
       +#13#10'             AND (   (SYS$DU IS NULL)'
       +#13#10'                  OR (SYS$DU < :SYS$DU)'
       +#13#10'                  OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
       +#13#10'                  OR ( NOME                IS DISTINCT FROM  :NOME )'
       +#13#10'                  OR ( KMFIN_CENTROCUSTO   IS DISTINCT FROM  :KMFIN_CENTROCUSTO )'
       +#13#10'                  OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
       +#13#10'                  OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
       +#13#10'                  OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
       +#13#10'               ) ;'
       +#13#10'        ELSE'
       +#13#10'          BEGIN'
       +#13#10'            INSERT INTO FIN_CENTROSCUSTO ( KFIN_CENTROCUSTO, KCAD_FAZENDA, CODIGO, NOME, KMFIN_CENTROCUSTO, KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
       +#13#10'                 ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU )'
       +#13#10'            VALUES ( Guid20(), :pKCAD_FAZENDA, :CODIGO, :NOME, :KMFIN_CENTROCUSTO, :KDEF_CENTROCUSTO, :KMDEF_CENTROCUSTO,'
       +#13#10'                 :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
       +#13#10''
       +#13#10'          END'
       +#13#10'     END'
       +#13#10''
       +#13#10'END' ) ;

        ExecuteDirect( Format ( 'EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS( %s )', [ QuotedStr ( LoggedUser.DomainID  ) ] ) ) ;

end;


procedure TDBFinanceiroUpdate._5_000_17;
begin
      try
        ExecuteDirect (
                   'ALTER TABLE CAD_PATRIMONIOS'
            +#13#10'ADD KFIN_CATEGORIA SYS$FKGUID20_NN,'
            +#13#10'ALTER KFIN_CATEGORIA POSITION 17' )  ;

        ExecuteDirect (
                   'UPDATE CAD_PATRIMONIOS'
            +#13#10'SET KFIN_CATEGORIA ='
            +#13#10' (SELECT KFIN_PLANOCONTA'
            +#13#10'  FROM FIN_PLANOCONTAS'
            +#13#10'  WHERE CODIGO = ''10'' AND CLASSIFICACAO = ''1.3.1'')' ) ;

        ExecuteDirect (
                   'ALTER TABLE CAD_PATRIMONIOS'
            +#13#10'DROP CONSTRAINT FKCAD_PATRIMONIOS_01' ) ;

        ExecuteDirect (
                   'ALTER TABLE CAD_PATRIMONIOS'
            +#13#10'ADD CONSTRAINT FKCAD_PATRIMONIOS_01'
            +#13#10'FOREIGN KEY (KSYS$DOMAIN)'
            +#13#10'REFERENCES SYS$DOMAINS (KSYS$DOMAIN)'
            +#13#10'ON UPDATE CASCADE ON DELETE CASCADE' ) ;

        ExecuteDirect (
                  'ALTER TABLE CAD_PATRIMONIOS'
           +#13#10'ADD CONSTRAINT FKCAD_PATRIMONIOS_02'
           +#13#10'FOREIGN KEY (KFIN_PLANOCONTA)'
           +#13#10'REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA)'
           +#13#10'ON UPDATE CASCADE' )  ;

        ExecuteDirect (
                   'ALTER TABLE CAD_PATRIMONIOS'
            +#13#10'ADD CONSTRAINT FKCAD_PATRIMONIOS_03'
            +#13#10'FOREIGN KEY (KFIN_CATEGORIA)'
            +#13#10'REFERENCES FIN_PLANOCONTAS (KFIN_PLANOCONTA)'
            +#13#10'ON UPDATE CASCADE' ) ;

              ExecuteDirect (
              'CREATE OR ALTER PROCEDURE SYS$INIT_CENTROSCUSTO ('
       +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN)'
       +#13#10'AS'
       +#13#10'  DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
       +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
       +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
       +#13#10'  DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
       +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
       +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
       +#13#10'  DECLARE SYS$DU               SYS$DATE;'
       +#13#10'  DECLARE PATH VARCHAR( 256 );'
       +#13#10''
       +#13#10'BEGIN'
       +#13#10''
       +#13#10'   IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO) ) THEN'
       +#13#10'      EXIT ;'
       +#13#10''
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10''
       +#13#10'   IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
       +#13#10'     EXIT ;'
       +#13#10''
       +#13#10'   FOR EXECUTE STATEMENT ('
       +#13#10'          ''SELECT '''
       +#13#10'        ||'' KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO, '''
       +#13#10'        ||'' ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU '''
       +#13#10'        ||''FROM DEF_CENTROSCUSTO'''
       +#13#10'        ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
       +#13#10'        WITH COMMON TRANSACTION'
       +#13#10'        INTO :KDEF_CENTROCUSTO, :CODIGO, :NOME, :KMDEF_CENTROCUSTO,'
       +#13#10'             :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU'
       +#13#10'   DO'
       +#13#10'     BEGIN'
       +#13#10'        IF ( KMDEF_CENTROCUSTO IS NULL ) THEN'
       +#13#10'           KMFIN_CENTROCUSTO = NULL ;'
       +#13#10'        ELSE'
       +#13#10'           BEGIN'
       +#13#10'             SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
       +#13#10'             WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KMDEF_CENTROCUSTO'
       +#13#10'             INTO KMFIN_CENTROCUSTO ;'
       +#13#10'           END'
       +#13#10''
       +#13#10'        IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO ) ) THEN'
       +#13#10'           UPDATE FIN_CENTROSCUSTO'
       +#13#10'           SET'
       +#13#10'               CODIGO           = :CODIGO,'
       +#13#10'               NOME             = :NOME,'
       +#13#10'               KMFIN_CENTROCUSTO = :KMFIN_CENTROCUSTO,'
       +#13#10'               ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
       +#13#10'               CLASSIFICACAO       = :CLASSIFICACAO,'
       +#13#10'               ATIVO               = :ATIVO,'
       +#13#10'               SYS$DU              = :SYS$DU'
       +#13#10'            WHERE ( KCAD_FAZENDA = :pKCAD_FAZENDA  AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO )'
       +#13#10'             AND ( KDEF_CENTROCUSTO <> ''La;m;0+smOQ+4RnK^6as'' )'
       +#13#10'             AND (   (SYS$DU IS NULL)'
       +#13#10'                  OR (SYS$DU < :SYS$DU)'
       +#13#10'                  OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
       +#13#10'                  OR ( NOME                IS DISTINCT FROM  :NOME )'
       +#13#10'                  OR ( KMFIN_CENTROCUSTO   IS DISTINCT FROM  :KMFIN_CENTROCUSTO )'
       +#13#10'                  OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
       +#13#10'                  OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
       +#13#10'                  OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
       +#13#10'               ) ;'
       +#13#10'        ELSE'
       +#13#10'          BEGIN'
       +#13#10'            INSERT INTO FIN_CENTROSCUSTO ( KFIN_CENTROCUSTO, KCAD_FAZENDA, CODIGO, NOME, KMFIN_CENTROCUSTO, KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
       +#13#10'                 ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU )'
       +#13#10'            VALUES ( Guid20(), :pKCAD_FAZENDA, :CODIGO, :NOME, :KMFIN_CENTROCUSTO, :KDEF_CENTROCUSTO, :KMDEF_CENTROCUSTO,'
       +#13#10'                 :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
       +#13#10''
       +#13#10'          END'
       +#13#10'     END'
       +#13#10''
       +#13#10'END' ) ;


      except On E : Exception do
//         ShowMessage ( E.Message ) ;
      end;
end;

procedure TDBFinanceiroUpdate._5_000_14;
begin
              ExecuteDirect (
              'CREATE OR ALTER PROCEDURE SYS$INIT_CENTROSCUSTO ('
       +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN)'
       +#13#10'AS'
       +#13#10'  DECLARE KDEF_CENTROCUSTO     SYS$FKGUID20 ;'
       +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
       +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
       +#13#10'  DECLARE KMDEF_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE KMFIN_CENTROCUSTO    SYS$FKGUID20 ;'
       +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
       +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
       +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
       +#13#10'  DECLARE SYS$DU               SYS$DATE;'
       +#13#10'  DECLARE PATH VARCHAR( 256 );'
       +#13#10''
       +#13#10'BEGIN'
       +#13#10''
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
       +#13#10''
       +#13#10'   IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
       +#13#10'     EXIT ;'
       +#13#10''
       +#13#10'   FOR EXECUTE STATEMENT ('
       +#13#10'          ''SELECT '''
       +#13#10'        ||'' KDEF_CENTROCUSTO, CODIGO, NOME, KMDEF_CENTROCUSTO, '''
       +#13#10'        ||'' ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU '''
       +#13#10'        ||''FROM DEF_CENTROSCUSTO'''
       +#13#10'        ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
       +#13#10'        WITH COMMON TRANSACTION'
       +#13#10'        INTO :KDEF_CENTROCUSTO, :CODIGO, :NOME, :KMDEF_CENTROCUSTO,'
       +#13#10'             :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU'
       +#13#10'   DO'
       +#13#10'     BEGIN'
       +#13#10'        IF ( KMDEF_CENTROCUSTO IS NULL ) THEN'
       +#13#10'           KMFIN_CENTROCUSTO = NULL ;'
       +#13#10'        ELSE'
       +#13#10'           BEGIN'
       +#13#10'             SELECT KFIN_CENTROCUSTO FROM FIN_CENTROSCUSTO'
       +#13#10'             WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KMDEF_CENTROCUSTO'
       +#13#10'             INTO KMFIN_CENTROCUSTO ;'
       +#13#10'           END'
       +#13#10''
       +#13#10'        IF ( EXISTS (SELECT 1 FROM FIN_CENTROSCUSTO WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO ) ) THEN'
       +#13#10'           UPDATE FIN_CENTROSCUSTO'
       +#13#10'           SET'
       +#13#10'               CODIGO           = :CODIGO,'
       +#13#10'               NOME             = :NOME,'
       +#13#10'               KMFIN_CENTROCUSTO = :KMFIN_CENTROCUSTO,'
       +#13#10'               ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
       +#13#10'               CLASSIFICACAO       = :CLASSIFICACAO,'
       +#13#10'               ATIVO               = :ATIVO,'
       +#13#10'               SYS$DU              = :SYS$DU'
       +#13#10'            WHERE ( KCAD_FAZENDA = :pKCAD_FAZENDA  AND KDEF_CENTROCUSTO = :KDEF_CENTROCUSTO )'
       +#13#10'             AND (   (SYS$DU IS NULL)'
       +#13#10'                  OR (SYS$DU < :SYS$DU)'
       +#13#10'                  OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
       +#13#10'                  OR ( NOME                IS DISTINCT FROM  :NOME )'
       +#13#10'                  OR ( KMFIN_CENTROCUSTO    IS DISTINCT FROM  :KMFIN_CENTROCUSTO )'
       +#13#10'                  OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
       +#13#10'                  OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
       +#13#10'                  OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
       +#13#10'               ) ;'
       +#13#10'        ELSE'
       +#13#10'          BEGIN'
       +#13#10'            INSERT INTO FIN_CENTROSCUSTO ( KFIN_CENTROCUSTO, KCAD_FAZENDA, CODIGO, NOME, KMFIN_CENTROCUSTO, KDEF_CENTROCUSTO, KMDEF_CENTROCUSTO,'
       +#13#10'                 ANALITICO_SINTETICO, CLASSIFICACAO, ATIVO, SYS$DU )'
       +#13#10'            VALUES ( Guid20(), :pKCAD_FAZENDA, :CODIGO, :NOME, :KMFIN_CENTROCUSTO, :KDEF_CENTROCUSTO, :KMDEF_CENTROCUSTO,'
       +#13#10'                 :ANALITICO_SINTETICO, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
       +#13#10''
       +#13#10'          END'
       +#13#10'     END'
       +#13#10''
       +#13#10'END' ) ;


              ExecuteDirect (
              'CREATE OR ALTER PROCEDURE SYS$INIT'
       +#13#10'AS'
       +#13#10'DECLARE VARIABLE vKCAD_FAZENDA TYPE OF SYS$FKGUID20_NN ;'
       +#13#10'BEGIN'
       +#13#10'   EXECUTE PROCEDURE SYS$INIT_TYPES ;'
       +#13#10'   EXECUTE PROCEDURE SYS$INIT_BANCOS ;'
       +#13#10''
       +#13#10'   FOR SELECT KCAD_FAZENDA FROM CAD_FAZENDAS INTO :vKCAD_FAZENDA'
       +#13#10'   DO'
       +#13#10'     BEGIN'
       +#13#10'      EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS vKCAD_FAZENDA ;'
       +#13#10'      EXECUTE PROCEDURE SYS$INIT_CENTROSCUSTO vKCAD_FAZENDA ;'
       +#13#10'     END'
       +#13#10'END' ) ;


end ;

procedure TDBFinanceiroUpdate._5_000_13;
begin

        ExecuteDirect (
    'CREATE OR ALTER PROCEDURE EST_ENCERRAR_MES ('
  +#13#10'    KEST_ENCERRAMENTO_MES SYS$PKGUID20)'
  +#13#10'AS'
  +#13#10'declare SOURCE_KEST_PRODUTO  SYS$FKGUID20 ;'
  +#13#10'declare SOURCE_NOME          SYS$DESCR ;'
  +#13#10'declare SOURCE_QTDE_ESTOQUE  SYS$FLOAT ;'
  +#13#10'declare SOURCE_CUSTO_MEDIO   SYS$FLOAT ;'
  +#13#10''
  +#13#10'declare TARGET_KEST_PRODUTO  SYS$FKGUID20 ;'
  +#13#10'declare TARGET_NOME          SYS$DESCR ;'
  +#13#10'declare TARGET_QTDE_ESTOQUE  SYS$FLOAT ;'
  +#13#10'declare TARGET_CUSTO_MEDIO   SYS$FLOAT ;'
  +#13#10''
  +#13#10'declare KDOMAIN   SYS$FKGUID20 ;'
  +#13#10'declare ANO_MES   SYS$ANO_MES   = NULL ;'
  +#13#10'declare ENCERRADO SYS$BOOL_NULL = NULL ;'
  +#13#10''
  +#13#10'DECLARE RLOG$OFF VARCHAR( 1 ) ;'
  +#13#10''
  +#13#10'DECLARE RC_SOURCE INTEGER ;'
  +#13#10'DECLARE RC_TARGET INTEGER ;'
  +#13#10''
  +#13#10'DECLARE SOURCE CURSOR'
  +#13#10'   FOR ( SELECT'
  +#13#10'         E.KEST_PRODUTO,'
  +#13#10'         P.NOME,'
  +#13#10'         (SELECT'
  +#13#10'           ESTOQUE'
  +#13#10'            FROM EST_MOVIMENTO QE'
  +#13#10'           WHERE'
  +#13#10'                 QE.KEST_PRODUTO = E.KEST_PRODUTO'
  +#13#10'             AND QE.ANO_MES <= :ANO_MES'
  +#13#10'           ORDER BY QE.DATA DESC, QE.MOVTO_ID DESC'
  +#13#10'           ROWS 1'
  +#13#10'         ) QTDE_ESTOQUE,'
  +#13#10'         (SELECT'
  +#13#10'           SUM( C.QTDE * C.CUSTO ) / COALESCE ( NULLIF ( SUM ( C.QTDE ), 0 ), 1 )'
  +#13#10'            FROM EST_MOVIMENTO C'
  +#13#10'           WHERE'
  +#13#10'                 C.KEST_PRODUTO = E.KEST_PRODUTO'
  +#13#10'             AND C.TIPO IN ( ''C'', ''E'' )'
  +#13#10'             AND C.ANO_MES <= :ANO_MES'
  +#13#10'--           GROUP BY C.KEST_PRODUTO, C.ANO_MES, C.MOVTO_ID'
  +#13#10'--           ORDER BY C.KEST_PRODUTO, C.ANO_MES DESC, C.MOVTO_ID DESC'
  +#13#10'--           ROWS 1'
  +#13#10'         ) CUSTO_MEDIO'
  +#13#10'         FROM EST_MOVIMENTO E'
  +#13#10'         LEFT JOIN EST_PRODUTOS P ON ( P.KEST_PRODUTO = E.KEST_PRODUTO )'
  +#13#10'         WHERE E.TIPO = ''C'''
  +#13#10'         AND E.ANO_MES <= :ANO_MES'
  +#13#10'         ORDER BY E.KEST_PRODUTO'
  +#13#10' );'
  +#13#10''
  +#13#10'DECLARE TARGET CURSOR'
  +#13#10'  FOR ( SELECT KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO'
  +#13#10'         FROM  EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES'
  +#13#10'         ORDER BY KEST_PRODUTO );'
  +#13#10''
  +#13#10'DECLARE CURSOR_ENCERRAMENTO CURSOR'
  +#13#10'  FOR ( SELECT KCAD_FAZENDA, ANO_MES, ENCERRADO'
  +#13#10'         FROM EST_ENCERRAMENTO_MES'
  +#13#10'         WHERE KEST_ENCERRAMENTO_MES = :KEST_ENCERRAMENTO_MES );'
  +#13#10''
  +#13#10'DECLARE EST$ENCERRAMES_OFF varchar( 1 ) ;'
  +#13#10'BEGIN'
  +#13#10''
  +#13#10'   OPEN CURSOR_ENCERRAMENTO ;'
  +#13#10'   FETCH CURSOR_ENCERRAMENTO INTO KDOMAIN, ANO_MES, ENCERRADO ;'
  +#13#10''
  +#13#10'--  RLOG$OFF = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'' ) ;'
  +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', ''1''  ) ;'
  +#13#10''
  +#13#10''
  +#13#10'  OPEN SOURCE ;'
  +#13#10'  FETCH SOURCE'
  +#13#10'  INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
  +#13#10'  RC_SOURCE = ROW_COUNT ;'
  +#13#10''
  +#13#10'  OPEN TARGET ;'
  +#13#10'  FETCH TARGET'
  +#13#10'  INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'  RC_TARGET = ROW_COUNT ;'
  +#13#10''
  +#13#10'  WHILE (( RC_SOURCE <> 0 ) AND ( RC_TARGET <> 0 )) DO'
  +#13#10'    BEGIN'
  +#13#10''
  +#13#10'      IF ( ( RC_SOURCE = 0 ) OR ( RC_TARGET = 0 )) THEN'
  +#13#10'        LEAVE ;'
  +#13#10''
  +#13#10'       IF ( SOURCE_KEST_PRODUTO = TARGET_KEST_PRODUTO ) THEN'
  +#13#10'        BEGIN'
  +#13#10'          --update target'
  +#13#10'          if (   ( TARGET_NOME             IS DISTINCT FROM SOURCE_NOME  )'
  +#13#10'             OR  ( TARGET_QTDE_ESTOQUE     IS DISTINCT FROM SOURCE_QTDE_ESTOQUE  )'
  +#13#10'             OR  ( TARGET_CUSTO_MEDIO      IS DISTINCT FROM SOURCE_CUSTO_MEDIO  ) ) then'
  +#13#10'                UPDATE EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'                  SET'
  +#13#10'                   NOME            = :SOURCE_NOME,'
  +#13#10'                   QTDE_ESTOQUE    = :SOURCE_QTDE_ESTOQUE,'
  +#13#10'                   CUSTO_MEDIO     = :SOURCE_CUSTO_MEDIO'
  +#13#10'                WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'          EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'          -- next source'
  +#13#10'          FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
  +#13#10'          RC_SOURCE = ROW_COUNT ;'
  +#13#10'          -- next target'
  +#13#10'          FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'          RC_TARGET = ROW_COUNT ;'
  +#13#10'        END'
  +#13#10'       ELSE IF ( SOURCE_KEST_PRODUTO > TARGET_KEST_PRODUTO ) THEN'
  +#13#10'          BEGIN'
  +#13#10'            -- delete target'
  +#13#10'            DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
  +#13#10''
  +#13#10'            -- next target'
  +#13#10'            FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'            RC_TARGET = ROW_COUNT ;'
  +#13#10'          END'
  +#13#10'       ELSE'
  +#13#10'          BEGIN'
  +#13#10'            -- insert into target'
  +#13#10'            INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'             ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
  +#13#10'            VALUES'
  +#13#10'             ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :SOURCE_CUSTO_MEDIO ) ;'
  +#13#10''
  +#13#10'            EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'            -- next source'
  +#13#10'            FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
  +#13#10'            RC_SOURCE = ROW_COUNT ;'
  +#13#10'          END'
  +#13#10''
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_SOURCE <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'      -- insert target'
  +#13#10'      INSERT INTO EST_ENCERRAMENTO_MES_PRODUTOS'
  +#13#10'        ( KEST_ENCERRAMENTO_MES, KEST_PRODUTO, NOME, QTDE_ESTOQUE, CUSTO_MEDIO )'
  +#13#10'      VALUES'
  +#13#10'        ( :KEST_ENCERRAMENTO_MES, :SOURCE_KEST_PRODUTO, :SOURCE_NOME, :SOURCE_QTDE_ESTOQUE, :SOURCE_CUSTO_MEDIO ) ;'
  +#13#10''
  +#13#10'      EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, SOURCE_KEST_PRODUTO, ANO_MES, SOURCE_CUSTO_MEDIO ;'
  +#13#10''
  +#13#10'      -- next source'
  +#13#10'      FETCH SOURCE INTO SOURCE_KEST_PRODUTO, SOURCE_NOME, SOURCE_QTDE_ESTOQUE, SOURCE_CUSTO_MEDIO ;'
  +#13#10'      RC_SOURCE = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  WHILE ( RC_TARGET <> 0 ) DO'
  +#13#10'    BEGIN'
  +#13#10'       -- delete target'
  +#13#10'       DELETE FROM EST_ENCERRAMENTO_MES_PRODUTOS WHERE CURRENT OF TARGET ;'
  +#13#10''
  +#13#10'       EXECUTE PROCEDURE EST_UPDATE_PRODUTO_CMM KDOMAIN, TARGET_KEST_PRODUTO, ANO_MES, NULL ;'
  +#13#10''
  +#13#10'       -- next target'
  +#13#10'       FETCH TARGET INTO TARGET_KEST_PRODUTO, TARGET_NOME, TARGET_QTDE_ESTOQUE, TARGET_CUSTO_MEDIO ;'
  +#13#10'       RC_TARGET = ROW_COUNT ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'--  RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''RLOG$OFF'', RLOG$OFF ) ;'
  +#13#10''
  +#13#10'  if (ENCERRADO IS DISTINCT FROM ''T'') then'
  +#13#10'    BEGIN'
  +#13#10'     EST$ENCERRAMES_OFF   = RDB$GET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'' ) ;'
  +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', ''1'' ) ;'
  +#13#10''
  +#13#10'     UPDATE EST_ENCERRAMENTO_MES'
  +#13#10'       SET ENCERRADO = ''T'''
  +#13#10'     WHERE CURRENT OF CURSOR_ENCERRAMENTO ;'
  +#13#10''
  +#13#10'     RDB$SET_CONTEXT( ''USER_TRANSACTION'', ''EST$ENCERRAMES_OFF'', EST$ENCERRAMES_OFF ) ;'
  +#13#10'    END'
  +#13#10''
  +#13#10'  CLOSE TARGET ;'
  +#13#10'  CLOSE SOURCE ;'
  +#13#10'  CLOSE CURSOR_ENCERRAMENTO ;'
  +#13#10''
  +#13#10'  IF ( RIGHT ( ANO_MES, 2 ) = ''12'' ) THEN'
  +#13#10'    ANO_MES = RIGHT ( ''0000'' || (CAST ( LEFT ( ANO_MES, 4 ) AS SMALLINT ) + 1), 4 ) || ''01'' ;'
  +#13#10'  ELSE'
  +#13#10'    ANO_MES = LEFT ( ANO_MES, 4 ) || RIGHT ( ''00'' || (CAST ( RIGHT ( ANO_MES, 2 ) AS SMALLINT ) + 1 ), 2) ;'
  +#13#10''
  +#13#10'  IF ( NOT EXISTS ( SELECT 1 FROM EST_ENCERRAMENTO_MES'
  +#13#10'                    WHERE KCAD_FAZENDA = :KDOMAIN'
  +#13#10'                      AND ANO_MES = :ANO_MES ) ) THEN'
  +#13#10'    INSERT INTO EST_ENCERRAMENTO_MES ( KEST_ENCERRAMENTO_MES, KCAD_FAZENDA, ANO_MES )'
  +#13#10'    VALUES ( GUID20(), :KDOMAIN, :ANO_MES ) ;'
  +#13#10''
  +#13#10'END' ) ;

end;

procedure TDBFinanceiroUpdate._5_000_07;
begin

          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
          +#13#10'DECLARE KCAD_ENTIDADE   SYS$FKGUID20;'
          +#13#10'DECLARE NOMEENTIDADE    SYS$DESCR;'
          +#13#10'DECLARE DATA            SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KCMP_PEDIDO     SYS$FKGUID20  = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'     ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
          +#13#10'    FROM CMP_PEDIDOS'
          +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ('
          +#13#10'                ( OLD.KCMP_PEDIDO_ITEM IS DISTINCT FROM NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
          +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
          +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
          +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
          +#13#10'                )'
          +#13#10'          )'
          +#13#10'     ) THEN'
          +#13#10'   BEGIN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
          +#13#10'                                                KDOMAIN,'
          +#13#10'                                                OLD.KEST_PRODUTO,'
          +#13#10'                                                DATA,'
          +#13#10'                                                ''E'','
          +#13#10'                                                OLD.QTDE,'
          +#13#10'                                                OLD.CUSTO,'
          +#13#10'                                                ''CMP_PEDIDO_ITENS'','
          +#13#10'                                                OLD.KCMP_PEDIDO_ITEM'
          +#13#10'                                                );'
          +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
          +#13#10'          EXIT ;'
          +#13#10''
          +#13#10'   END'
          +#13#10''
          +#13#10''
          +#13#10'  IF (INSERTING) THEN'
          +#13#10'    BEGIN'
          +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
          +#13#10'        UPDATE EST_PRODUTOS'
          +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
          +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
          +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
          +#13#10''
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  BAIXA_ESTOQUE = NULL ;'
          +#13#10''
          +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''E'','
          +#13#10'                                             NEW.QTDE,'
          +#13#10'                                             NEW.CUSTO,'
          +#13#10'                                             ''CMP_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'                                             );'
          +#13#10''
          +#13#10'END' ) ;

          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
          +#13#10'DECLARE DATA            SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KVND_PEDIDO     SYS$FKGUID20  = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'     ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KVND_PEDIDO = IIF( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, DATA_EMISSAO'
          +#13#10'    FROM VND_PEDIDOS'
          +#13#10'   WHERE KVND_PEDIDO = :KVND_PEDIDO'
          +#13#10'  INTO KDOMAIN, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ('
          +#13#10'                ( OLD.KVND_PEDIDO_ITEM IS DISTINCT FROM NEW.KVND_PEDIDO_ITEM )'
          +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
          +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
          +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
          +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
          +#13#10'                )'
          +#13#10'          )'
          +#13#10'     ) THEN'
          +#13#10'   BEGIN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
          +#13#10'                                                KDOMAIN,'
          +#13#10'                                                OLD.KEST_PRODUTO,'
          +#13#10'                                                DATA,'
          +#13#10'                                                ''S'','
          +#13#10'                                                OLD.QTDE,'
          +#13#10'                                                OLD.CUSTO,'
          +#13#10'                                                ''VND_PEDIDO_ITENS'','
          +#13#10'                                                OLD.KVND_PEDIDO_ITEM'
          +#13#10'                                                );'
          +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
          +#13#10'          EXIT ;'
          +#13#10''
          +#13#10'   END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    BEGIN'
          +#13#10'       KEST_PRODUTO    = NEW.KEST_PRODUTO ;'
          +#13#10'       KFIN_PLANOCONTA = NEW.KFIN_PLANOCONTA ;'
          +#13#10'    END'
          +#13#10'  ELSE'
          +#13#10'    BEGIN'
          +#13#10'      KEST_PRODUTO    = OLD.KEST_PRODUTO ;'
          +#13#10'      KFIN_PLANOCONTA = OLD.KFIN_PLANOCONTA ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  BAIXA_ESTOQUE = NULL ;'
          +#13#10''
          +#13#10'  KFIN_PLANOCONTA = IIF( DELETING, OLD.KFIN_PLANOCONTA, NEW.KFIN_PLANOCONTA ) ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''S'','
          +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
          +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
          +#13#10'                                             ''VND_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
          +#13#10'                                            );'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

end ;

procedure TDBFinanceiroUpdate._5_000_06;
begin
          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( UPDATING AND NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE'
          +#13#10'  FROM CMP_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
          +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
          +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
          +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'      EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (   IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
          +#13#10'                                                 KEST_PRODUTO,'
          +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
          +#13#10'                                                 ''E'','
          +#13#10'                                                 QTDE,'
          +#13#10'                                                 CUSTO,'
          +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
          +#13#10'                                                 KCMP_PEDIDO_ITEM'
          +#13#10'                                                 );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KCMP_PEDIDO_SERVICO'
          +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
          +#13#10'     INTO KCMP_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10'END' ) ;

          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
          +#13#10'DECLARE KCAD_ENTIDADE   SYS$FKGUID20;'
          +#13#10'DECLARE NOMEENTIDADE    SYS$DESCR;'
          +#13#10'DECLARE DATA            SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KCMP_PEDIDO     SYS$FKGUID20  = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'     ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
          +#13#10'    FROM CMP_PEDIDOS'
          +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ('
          +#13#10'                ( OLD.KCMP_PEDIDO_ITEM IS DISTINCT FROM NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
          +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
          +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
          +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
          +#13#10'                )'
          +#13#10'          )'
          +#13#10'     ) THEN'
          +#13#10'   BEGIN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
          +#13#10'                                                KDOMAIN,'
          +#13#10'                                                OLD.KEST_PRODUTO,'
          +#13#10'                                                DATA,'
          +#13#10'                                                ''E'','
          +#13#10'                                                OLD.QTDE,'
          +#13#10'                                                OLD.CUSTO,'
          +#13#10'                                                ''CMP_PEDIDO_ITENS'','
          +#13#10'                                                OLD.KCMP_PEDIDO_ITEM'
          +#13#10'                                                );'
          +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
          +#13#10'          EXIT ;'
          +#13#10''
          +#13#10'   END'
          +#13#10''
          +#13#10''
          +#13#10'  IF (INSERTING) THEN'
          +#13#10'    BEGIN'
          +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
          +#13#10'        UPDATE EST_PRODUTOS'
          +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
          +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
          +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
          +#13#10''
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  BAIXA_ESTOQUE = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''E'','
          +#13#10'                                             NEW.QTDE,'
          +#13#10'                                             NEW.CUSTO,'
          +#13#10'                                             ''CMP_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'                                             );'
          +#13#10''
          +#13#10'END' ) ;

          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDOS_AUD0 FOR VND_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE MOVIMENTA_ESTOQUE SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KVND_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KVND_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ( NEW.DATA_VENDA   IS NOT DISTINCT FROM OLD.DATA_VENDA   )'
          +#13#10'      AND ( NEW.DATA_EMISSAO IS NOT DISTINCT FROM OLD.DATA_EMISSAO ) ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KVND_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO, PC.MOVIMENTA_ESTOQUE'
          +#13#10'   FROM VND_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  LEFT JOIN FIN_PLANOCONTAS PC ON PC.KFIN_PLANOCONTA = I.KFIN_PLANOCONTA'
          +#13#10'  WHERE I.KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
          +#13#10'    AND IS_PATRIMONIO   IS DISTINCT FROM ''T'''
          +#13#10'    AND P.BAIXA_ESTOQUE = ''T'''
          +#13#10'  INTO KVND_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO, MOVIMENTA_ESTOQUE'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_ITENS'', KVND_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'         AND ( MOVIMENTA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                IIF ( DELETING, OLD.KCAD_FAZENDA, NEW.KCAD_FAZENDA ),'
          +#13#10'                                                KEST_PRODUTO,'
          +#13#10'                                                IIF ( DELETING, OLD.DATA_EMISSAO, NEW.DATA_EMISSAO ),'
          +#13#10'                                                ''S'','
          +#13#10'                                                QTDE,'
          +#13#10'                                                CUSTO,'
          +#13#10'                                                ''VND_PEDIDO_ITENS'','
          +#13#10'                                                KVND_PEDIDO_ITEM'
          +#13#10'                                               );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KVND_PEDIDO_SERVICO'
          +#13#10'     FROM VND_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KVND_PEDIDO = OLD.KVND_PEDIDO'
          +#13#10'     INTO KVND_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_SERVICOS'', KVND_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;


          ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN         SYS$FKGUID20;'
          +#13#10'DECLARE DATA            SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO    SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE KFIN_PLANOCONTA SYS$FKGUID20  = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE   SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KVND_PEDIDO     SYS$FKGUID20  = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    ( INSERTING AND ( NEW.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( UPDATING  AND ( NEW.IS_PATRIMONIO = ''T'' AND OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'       OR ( DELETING  AND ( OLD.IS_PATRIMONIO = ''T'' ) )'
          +#13#10'     ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KVND_PEDIDO = IIF( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, DATA_EMISSAO'
          +#13#10'    FROM VND_PEDIDOS'
          +#13#10'   WHERE KVND_PEDIDO = :KVND_PEDIDO'
          +#13#10'  INTO KDOMAIN, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ('
          +#13#10'                ( OLD.KVND_PEDIDO_ITEM IS DISTINCT FROM NEW.KVND_PEDIDO_ITEM )'
          +#13#10'            OR  (     ( NEW.KEST_PRODUTO IS DISTINCT FROM OLD.KEST_PRODUTO )'
          +#13#10'                  AND ( OLD.KEST_PRODUTO IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.KFIN_PLANOCONTA IS DISTINCT FROM OLD.KFIN_PLANOCONTA )'
          +#13#10'                  AND ( OLD.KFIN_PLANOCONTA IS NOT NULL )'
          +#13#10'                )'
          +#13#10'            OR  (     ( NEW.IS_PATRIMONIO IS DISTINCT FROM OLD.IS_PATRIMONIO )'
          +#13#10'                  AND ( NEW.IS_PATRIMONIO = ''T'' )'
          +#13#10'                )'
          +#13#10'          )'
          +#13#10'     ) THEN'
          +#13#10'   BEGIN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( ''D'','
          +#13#10'                                                KDOMAIN,'
          +#13#10'                                                OLD.KEST_PRODUTO,'
          +#13#10'                                                DATA,'
          +#13#10'                                                ''S'','
          +#13#10'                                                OLD.QTDE,'
          +#13#10'                                                OLD.CUSTO,'
          +#13#10'                                                ''VND_PEDIDO_ITENS'','
          +#13#10'                                                OLD.KVND_PEDIDO_ITEM'
          +#13#10'                                                );'
          +#13#10'       IF ( NEW.IS_PATRIMONIO = ''T''  ) THEN'
          +#13#10'          EXIT ;'
          +#13#10''
          +#13#10'   END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    BEGIN'
          +#13#10'       KEST_PRODUTO    = NEW.KEST_PRODUTO ;'
          +#13#10'       KFIN_PLANOCONTA = NEW.KFIN_PLANOCONTA ;'
          +#13#10'    END'
          +#13#10'  ELSE'
          +#13#10'    BEGIN'
          +#13#10'      KEST_PRODUTO    = OLD.KEST_PRODUTO ;'
          +#13#10'      KFIN_PLANOCONTA = OLD.KFIN_PLANOCONTA ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  BAIXA_ESTOQUE = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT MOVIMENTA_ESTOQUE FROM FIN_PLANOCONTAS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KFIN_PLANOCONTA = :KFIN_PLANOCONTA'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''S'','
          +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
          +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
          +#13#10'                                             ''VND_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
          +#13#10'                                            );'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

end ;

procedure TDBFinanceiroUpdate._5_000_05;
begin

        try
          ExecuteDirect ('ALTER TABLE FIN_PLANOCONTAS'
            +#13#10'ADD    MOVIMENTA_ESTOQUE    SYS$BOOL_F,'
            +#13#10'ALTER  MOVIMENTA_ESTOQUE POSITION 12' ) ;
        except
        end;

        ExecuteDirect (
                   'CREATE OR ALTER PROCEDURE SYS$INIT_PLANOCONTAS ('
            +#13#10'    PKCAD_FAZENDA type of SYS$FKGUID20_NN)'
            +#13#10'AS'
            +#13#10'  DECLARE KDEF_PLANOCONTA      SYS$FKGUID20 ;'
            +#13#10'  DECLARE CODIGO               SYS$INT_NN ;'
            +#13#10'  DECLARE NOME                 FIN$DESCPLANCONTAS_NN ;'
            +#13#10'  DECLARE KMDEF_PLANOCONTA     SYS$FKGUID20 ;'
            +#13#10'  DECLARE KMFIN_PLANOCONTA     SYS$FKGUID20 ;'
            +#13#10'  DECLARE ANALITICO_SINTETICO  FIN$ANALITICO_SINTETICO ;'
            +#13#10'  DECLARE DEVEDORA_CREDORA     FIN$DEVEDORA_CREDORA ;'
            +#13#10'  DECLARE FLUXOCAIXA           FIN$FLUXOCAIXA ;'
            +#13#10'  DECLARE TIPO_APRD            FIN$TIPO_APRD ;'
            +#13#10'  DECLARE FIXA_VARIAVEL        FIN$FIXA_VARIAVEL ;'
            +#13#10'  DECLARE MOVIMENTA_ESTOQUE    SYS$BOOL ;'
            +#13#10'  DECLARE CLASSIFICACAO        SYS$CODE_NN ;'
            +#13#10'  DECLARE ATIVO                SYS$BOOL_T ;'
            +#13#10'  DECLARE SYS$DU               SYS$DATE;'
            +#13#10'  DECLARE PATH VARCHAR( 256 );'
            +#13#10'BEGIN'
            +#13#10''
            +#13#10'   PATH = SU$EXTRACTFILEPATH ( RDB$GET_CONTEXT( ''SYSTEM'', ''DB_NAME'' ) ) ;'
            +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
            +#13#10'   PATH = SU$EXTRACTFILEPATH ( SUBSTRING ( PATH FROM 1 FOR CHAR_LENGTH( PATH )- 1 ) ) ;'
            +#13#10''
            +#13#10'   IF ( SU$FILEEXISTS( PATH || ''CLAG5.DB'' ) <> 1) THEN'
            +#13#10'     EXIT ;'
            +#13#10''
            +#13#10'   FOR EXECUTE STATEMENT ('
            +#13#10'          ''SELECT '''
            +#13#10'        ||'' KDEF_PLANOCONTA, CODIGO, NOME, KMDEF_PLANOCONTA, '''
            +#13#10'        ||'' ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA, '''
            +#13#10'        ||'' TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU '''
            +#13#10'        ||''FROM DEF_PLANOCONTAS'''
            +#13#10'        ) ON EXTERNAL DATA SOURCE PATH || ''CLAG5.DB'''
            +#13#10'        WITH COMMON TRANSACTION'
            +#13#10'        INTO :KDEF_PLANOCONTA, :CODIGO, :NOME, :KMDEF_PLANOCONTA,'
            +#13#10'             :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
            +#13#10'             :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU'
            +#13#10'   DO'
            +#13#10'     BEGIN'
            +#13#10'        IF ( KMDEF_PLANOCONTA IS NULL ) THEN'
            +#13#10'           KMFIN_PLANOCONTA = NULL ;'
            +#13#10'        ELSE'
            +#13#10'           BEGIN'
            +#13#10'             SELECT KFIN_PLANOCONTA FROM FIN_PLANOCONTAS'
            +#13#10'             WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_PLANOCONTA = :KMDEF_PLANOCONTA'
            +#13#10'             INTO KMFIN_PLANOCONTA ;'
            +#13#10'           END'
            +#13#10''
            +#13#10'        IF ( EXISTS (SELECT 1 FROM FIN_PLANOCONTAS WHERE KCAD_FAZENDA = :pKCAD_FAZENDA AND KDEF_PLANOCONTA = :KDEF_PLANOCONTA ) ) THEN'
            +#13#10'           UPDATE FIN_PLANOCONTAS'
            +#13#10'           SET'
            +#13#10'               CODIGO           = :CODIGO,'
            +#13#10'               NOME             = :NOME,'
            +#13#10'               KMFIN_PLANOCONTA = :KMFIN_PLANOCONTA,'
            +#13#10'               ANALITICO_SINTETICO = :ANALITICO_SINTETICO,'
            +#13#10'               DEVEDORA_CREDORA    = :DEVEDORA_CREDORA,'
            +#13#10'               FLUXOCAIXA          = :FLUXOCAIXA,'
            +#13#10'               TIPO_APRD           = :TIPO_APRD  ,'
            +#13#10'               FIXA_VARIAVEL       = :FIXA_VARIAVEL,'
            +#13#10'               MOVIMENTA_ESTOQUE   = :MOVIMENTA_ESTOQUE,'
            +#13#10'               CLASSIFICACAO       = :CLASSIFICACAO,'
            +#13#10'               ATIVO               = :ATIVO,'
            +#13#10'               SYS$DU              = :SYS$DU'
            +#13#10'            WHERE ( KCAD_FAZENDA = :pKCAD_FAZENDA  AND KDEF_PLANOCONTA = :KDEF_PLANOCONTA )'
            +#13#10'             AND (   (SYS$DU IS NULL)'
            +#13#10'                  OR (SYS$DU < :SYS$DU)'
            +#13#10'                  OR ( CODIGO              IS DISTINCT FROM  :CODIGO )'
            +#13#10'                  OR ( NOME                IS DISTINCT FROM  :NOME )'
            +#13#10'                  OR ( KMFIN_PLANOCONTA    IS DISTINCT FROM  :KMFIN_PLANOCONTA )'
            +#13#10'                  OR ( ANALITICO_SINTETICO IS DISTINCT FROM  :ANALITICO_SINTETICO )'
            +#13#10'                  OR ( DEVEDORA_CREDORA    IS DISTINCT FROM  :DEVEDORA_CREDORA )'
            +#13#10'                  OR ( FLUXOCAIXA          IS DISTINCT FROM  :FLUXOCAIXA )'
            +#13#10'                  OR ( TIPO_APRD           IS DISTINCT FROM  :TIPO_APRD )'
            +#13#10'                  OR ( FIXA_VARIAVEL       IS DISTINCT FROM  :FIXA_VARIAVEL )'
            +#13#10'                  OR ( MOVIMENTA_ESTOQUE   IS DISTINCT FROM  :MOVIMENTA_ESTOQUE )'
            +#13#10'                  OR ( CLASSIFICACAO       IS DISTINCT FROM  :CLASSIFICACAO )'
            +#13#10'                  OR ( ATIVO               IS DISTINCT FROM  :ATIVO )'
            +#13#10'               ) ;'
            +#13#10'        ELSE'
            +#13#10'          BEGIN'
            +#13#10'            INSERT INTO FIN_PLANOCONTAS ( KFIN_PLANOCONTA, KCAD_FAZENDA, CODIGO, NOME, KMFIN_PLANOCONTA, KDEF_PLANOCONTA, KMDEF_PLANOCONTA,'
            +#13#10'                 ANALITICO_SINTETICO, DEVEDORA_CREDORA, FLUXOCAIXA,'
            +#13#10'                 TIPO_APRD, FIXA_VARIAVEL, MOVIMENTA_ESTOQUE, CLASSIFICACAO, ATIVO, SYS$DU )'
            +#13#10'            VALUES ( Guid20(), :pKCAD_FAZENDA, :CODIGO, :NOME, :KMFIN_PLANOCONTA, :KDEF_PLANOCONTA, :KMDEF_PLANOCONTA,'
            +#13#10'                 :ANALITICO_SINTETICO, :DEVEDORA_CREDORA, :FLUXOCAIXA,'
            +#13#10'                 :TIPO_APRD, :FIXA_VARIAVEL, :MOVIMENTA_ESTOQUE, :CLASSIFICACAO, :ATIVO, :SYS$DU );'
            +#13#10''
            +#13#10'          END'
            +#13#10'     END'
            +#13#10''
            +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
          +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20;'
          +#13#10'DECLARE NOMEENTIDADE  SYS$DESCR;'
          +#13#10'DECLARE DATA          SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KCMP_PEDIDO   SYS$FKGUID20 = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( COALESCE( NEW.IS_PATRIMONIO, OLD.IS_PATRIMONIO ) IS NOT DISTINCT FROM ''T'' ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
          +#13#10'    FROM CMP_PEDIDOS'
          +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (INSERTING) THEN'
          +#13#10'    BEGIN'
          +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
          +#13#10'        UPDATE EST_PRODUTOS'
          +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
          +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
          +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
          +#13#10''
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''E'','
          +#13#10'                                             NEW.QTDE,'
          +#13#10'                                             NEW.CUSTO,'
          +#13#10'                                             ''CMP_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'                                             );'
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( UPDATING AND NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO'
          +#13#10'   FROM CMP_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
          +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
          +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'      EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (   IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
          +#13#10'                                                 KEST_PRODUTO,'
          +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
          +#13#10'                                                 ''E'','
          +#13#10'                                                 QTDE,'
          +#13#10'                                                 CUSTO,'
          +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
          +#13#10'                                                 KCMP_PEDIDO_ITEM'
          +#13#10'                                                 );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KCMP_PEDIDO_SERVICO'
          +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
          +#13#10'     INTO KCMP_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10'END' ) ;


        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE VARIABLE KDOMAIN SYS$FKGUID20;'
          +#13#10'DECLARE VARIABLE KCAD_ENTIDADE SYS$FKGUID20;'
          +#13#10'DECLARE VARIABLE NOMEENTIDADE  SYS$DESCR;'
          +#13#10'DECLARE VARIABLE DATA          SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE VARIABLE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( COALESCE( NEW.IS_PATRIMONIO, OLD.IS_PATRIMONIO ) IS NOT DISTINCT FROM ''T'' ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_EMISSAO'
          +#13#10'    FROM VND_PEDIDOS'
          +#13#10'   WHERE KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''S'','
          +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
          +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
          +#13#10'                                             ''VND_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
          +#13#10'                                            );'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDOS_AUD0 FOR VND_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KVND_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KVND_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ( NEW.DATA_VENDA   IS NOT DISTINCT FROM OLD.DATA_VENDA   )'
          +#13#10'      AND ( NEW.DATA_EMISSAO IS NOT DISTINCT FROM OLD.DATA_EMISSAO ) ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KVND_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO'
          +#13#10'   FROM VND_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  WHERE I.KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
          +#13#10'    AND IS_PATRIMONIO   IS DISTINCT FROM ''T'''
          +#13#10'    AND P.BAIXA_ESTOQUE = ''T'''
          +#13#10'  INTO KVND_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_ITENS'', KVND_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                IIF ( DELETING, OLD.KCAD_FAZENDA, NEW.KCAD_FAZENDA ),'
          +#13#10'                                                KEST_PRODUTO,'
          +#13#10'                                                IIF ( DELETING, OLD.DATA_EMISSAO, NEW.DATA_EMISSAO ),'
          +#13#10'                                                ''S'','
          +#13#10'                                                QTDE,'
          +#13#10'                                                CUSTO,'
          +#13#10'                                                ''VND_PEDIDO_ITENS'','
          +#13#10'                                                KVND_PEDIDO_ITEM'
          +#13#10'                                               );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KVND_PEDIDO_SERVICO'
          +#13#10'     FROM VND_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KVND_PEDIDO = OLD.KVND_PEDIDO'
          +#13#10'     INTO KVND_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_SERVICOS'', KVND_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect( Format ( 'EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS( %s )', [ QuotedStr ( LoggedUser.DomainID  ) ] ) ) ;

end;

procedure TDBFinanceiroUpdate._5_000_04;
begin

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDO_ITENS_AIUD0 FOR CMP_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10''
          +#13#10'DECLARE KDOMAIN SYS$FKGUID20;'
          +#13#10'DECLARE KCAD_ENTIDADE SYS$FKGUID20;'
          +#13#10'DECLARE NOMEENTIDADE  SYS$DESCR;'
          +#13#10'DECLARE DATA          SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
          +#13#10'DECLARE KCMP_PEDIDO   SYS$FKGUID20 = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( COALESCE( NEW.IS_PATRIMONIO, OLD.IS_PATRIMONIO ) IS NOT DISTINCT FROM ''T'' ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  KCMP_PEDIDO = IIF( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO ) ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_ENTRADA'
          +#13#10'    FROM CMP_PEDIDOS'
          +#13#10'   WHERE KCMP_PEDIDO = :KCMP_PEDIDO'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN IS NULL ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF (INSERTING) THEN'
          +#13#10'    BEGIN'
          +#13#10'      IF ( (NEW.KEST_PRODUTO IS NOT NULL) AND ((KCAD_ENTIDADE <> '''') OR (KCAD_ENTIDADE IS NOT NULL)) ) THEN'
          +#13#10'        UPDATE EST_PRODUTOS'
          +#13#10'        SET KULTIMO_FORNECEDOR = :KCAD_ENTIDADE,'
          +#13#10'        ULTIMO_FORNECEDOR  = :NOMEENTIDADE'
          +#13#10'        WHERE KEST_PRODUTO = NEW.KEST_PRODUTO;'
          +#13#10''
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''E'','
          +#13#10'                                             NEW.QTDE,'
          +#13#10'                                             NEW.CUSTO,'
          +#13#10'                                             ''CMP_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KCMP_PEDIDO_ITEM, NEW.KCMP_PEDIDO_ITEM )'
          +#13#10'                                             );'
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER CMP_PEDIDOS_AUD0 FOR CMP_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KCMP_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KCMP_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( UPDATING AND NEW.DATA_ENTRADA IS NOT DISTINCT FROM OLD.DATA_ENTRADA ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KCMP_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO'
          +#13#10'   FROM CMP_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  WHERE I.KCMP_PEDIDO = IIF ( DELETING, OLD.KCMP_PEDIDO, NEW.KCMP_PEDIDO )'
          +#13#10'    AND I.IS_PATRIMONIO IS DISTINCT FROM ''T'''
          +#13#10'  INTO KCMP_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_ITENS'', KCMP_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'      EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO (   IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                 IIF ( DELETING, OLD.KSYS$DOMAIN, NEW.KSYS$DOMAIN ),'
          +#13#10'                                                 KEST_PRODUTO,'
          +#13#10'                                                 IIF ( DELETING, OLD.DATA_ENTRADA, NEW.DATA_ENTRADA ),'
          +#13#10'                                                 ''E'','
          +#13#10'                                                 QTDE,'
          +#13#10'                                                 CUSTO,'
          +#13#10'                                                 ''CMP_PEDIDO_ITENS'','
          +#13#10'                                                 KCMP_PEDIDO_ITEM'
          +#13#10'                                                 );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KCMP_PEDIDO_SERVICO'
          +#13#10'     FROM CMP_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KCMP_PEDIDO = OLD.KCMP_PEDIDO'
          +#13#10'     INTO KCMP_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''CMP_PEDIDO_SERVICOS'', KCMP_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER EST_OUTRAS_ENTRADAS_SAIDA_AIUD0 FOR EST_OUTRAS_ENTRADAS_SAIDAS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE KCAD_FAZENDA  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    BEGIN'
          +#13#10'      KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'      KCAD_FAZENDA = NEW.KCAD_FAZENDA ;'
          +#13#10'    END'
          +#13#10'  ELSE'
          +#13#10'    BEGIN'
          +#13#10'      KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10'      KCAD_FAZENDA = OLD.KCAD_FAZENDA ;'
          +#13#10'    END'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'    WHERE KCAD_FAZENDA = :KCAD_FAZENDA AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             COALESCE( NEW.KCAD_FAZENDA, OLD.KCAD_FAZENDA ) ,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             NEW.DATA,'
          +#13#10'                                             COALESCE(NEW.TIPO,  OLD.TIPO  ),'
          +#13#10'                                             COALESCE(NEW.QTDE,  OLD.QTDE  ),'
          +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO ),'
          +#13#10'                                             ''EST_OUTRAS_ENTRADAS_SAIDAS'','
          +#13#10'                                             COALESCE(NEW.KEST_OUTRA_ENTRADA_SAIDA, OLD.KEST_OUTRA_ENTRADA_SAIDA)'
          +#13#10'                                           );'
          +#13#10''
          +#13#10'END' ) ;


        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDO_ITENS_AIUD0 FOR VND_PEDIDO_ITENS'
          +#13#10'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE VARIABLE KDOMAIN SYS$FKGUID20;'
          +#13#10'DECLARE VARIABLE KCAD_ENTIDADE SYS$FKGUID20;'
          +#13#10'DECLARE VARIABLE NOMEENTIDADE  SYS$DESCR;'
          +#13#10'DECLARE VARIABLE DATA          SYS$DATE;'
          +#13#10'DECLARE KEST_PRODUTO  SYS$FKGUID20 = NULL ;'
          +#13#10'DECLARE VARIABLE BAIXA_ESTOQUE SYS$BOOL_NULL = NULL ;'
          +#13#10''
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF ( COALESCE( NEW.IS_PATRIMONIO, OLD.IS_PATRIMONIO ) IS NOT DISTINCT FROM ''T'' ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  SELECT KCAD_FAZENDA, KCAD_ENTIDADE, NOMEENTIDADE, DATA_EMISSAO'
          +#13#10'    FROM VND_PEDIDOS'
          +#13#10'   WHERE KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
          +#13#10'  INTO KDOMAIN, KCAD_ENTIDADE, NOMEENTIDADE, DATA;'
          +#13#10''
          +#13#10'  IF ( DELETING AND KDOMAIN is null ) then'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  IF ( INSERTING OR UPDATING ) THEN'
          +#13#10'    KEST_PRODUTO = NEW.KEST_PRODUTO ;'
          +#13#10'  ELSE'
          +#13#10'    KEST_PRODUTO = OLD.KEST_PRODUTO ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    SELECT BAIXA_ESTOQUE FROM EST_PRODUTOS'
          +#13#10'     WHERE KCAD_FAZENDA = :KDOMAIN AND KEST_PRODUTO = :KEST_PRODUTO'
          +#13#10'    INTO BAIXA_ESTOQUE ;'
          +#13#10''
          +#13#10'  IF ( BAIXA_ESTOQUE IS DISTINCT FROM ''T'' ) THEN'
          +#13#10'    KEST_PRODUTO = NULL ;'
          +#13#10''
          +#13#10'  IF ( KEST_PRODUTO IS NOT NULL ) THEN'
          +#13#10'    EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( CASE'
          +#13#10'                                             when Inserting then ''I'''
          +#13#10'                                             when Updating  then ''U'''
          +#13#10'                                             when Deleting  then ''D'''
          +#13#10'                                             end,'
          +#13#10'                                             KDOMAIN,'
          +#13#10'                                             KEST_PRODUTO,'
          +#13#10'                                             DATA,'
          +#13#10'                                             ''S'','
          +#13#10'                                             COALESCE(NEW.QTDE, OLD.QTDE),'
          +#13#10'                                             COALESCE(NEW.CUSTO, OLD.CUSTO),'
          +#13#10'                                             ''VND_PEDIDO_ITENS'','
          +#13#10'                                             IIF( DELETING, OLD.KVND_PEDIDO_ITEM, NEW.KVND_PEDIDO_ITEM)'
          +#13#10'                                            );'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

        ExecuteDirect (
                 'CREATE OR ALTER TRIGGER VND_PEDIDOS_AUD0 FOR VND_PEDIDOS'
          +#13#10'ACTIVE AFTER UPDATE OR DELETE POSITION 20001'
          +#13#10'AS'
          +#13#10'DECLARE KEST_PRODUTO      SYS$PKGUID20 ;'
          +#13#10'DECLARE QTDE              SYS$FLOAT ;'
          +#13#10'DECLARE BAIXA_ESTOQUE     SYS$BOOL_NULL ;'
          +#13#10'DECLARE CUSTO             SYS$FLOAT ;'
          +#13#10'DECLARE KVND_PEDIDO_ITEM  SYS$PKGUID20 ;'
          +#13#10'DECLARE KVND_PEDIDO_SERVICO SYS$PKGUID20 ;'
          +#13#10'BEGIN'
          +#13#10''
          +#13#10'  IF (    UPDATING'
          +#13#10'      AND ( NEW.DATA_VENDA   IS NOT DISTINCT FROM OLD.DATA_VENDA   )'
          +#13#10'      AND ( NEW.DATA_EMISSAO IS NOT DISTINCT FROM OLD.DATA_EMISSAO ) ) THEN'
          +#13#10'    EXIT ;'
          +#13#10''
          +#13#10'  FOR SELECT'
          +#13#10'     I.KVND_PEDIDO_ITEM, I.KEST_PRODUTO, P.BAIXA_ESTOQUE, I.QTDE, I.CUSTO'
          +#13#10'   FROM VND_PEDIDO_ITENS I'
          +#13#10'  LEFT JOIN EST_PRODUTOS P ON P.KEST_PRODUTO = I.KEST_PRODUTO'
          +#13#10'  WHERE I.KVND_PEDIDO = IIF ( DELETING, OLD.KVND_PEDIDO, NEW.KVND_PEDIDO )'
          +#13#10'    AND IS_PATRIMONIO   IS DISTINCT FROM ''T'''
          +#13#10'    AND P.BAIXA_ESTOQUE = ''T'''
          +#13#10'  INTO KVND_PEDIDO_ITEM, KEST_PRODUTO, BAIXA_ESTOQUE, QTDE, CUSTO'
          +#13#10'  DO'
          +#13#10'    BEGIN'
          +#13#10'     IF ( DELETING ) THEN'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_ITENS'', KVND_PEDIDO_ITEM ;'
          +#13#10''
          +#13#10'    IF (     ( KEST_PRODUTO IS NOT NULL )'
          +#13#10'         AND ( BAIXA_ESTOQUE = ''T'' )'
          +#13#10'       ) THEN'
          +#13#10'       EXECUTE PROCEDURE EST_UPDATE_MOVIMENTO ( IIF ( DELETING, ''D'', ''U'' ),'
          +#13#10'                                                IIF ( DELETING, OLD.KCAD_FAZENDA, NEW.KCAD_FAZENDA ),'
          +#13#10'                                                KEST_PRODUTO,'
          +#13#10'                                                IIF ( DELETING, OLD.DATA_EMISSAO, NEW.DATA_EMISSAO ),'
          +#13#10'                                                ''S'','
          +#13#10'                                                QTDE,'
          +#13#10'                                                CUSTO,'
          +#13#10'                                                ''VND_PEDIDO_ITENS'','
          +#13#10'                                                KVND_PEDIDO_ITEM'
          +#13#10'                                               );'
          +#13#10'    END'
          +#13#10''
          +#13#10'   IF ( DELETING ) THEN'
          +#13#10'     FOR SELECT'
          +#13#10'       S.KVND_PEDIDO_SERVICO'
          +#13#10'     FROM VND_PEDIDO_SERVICOS S'
          +#13#10'     WHERE S.KVND_PEDIDO = OLD.KVND_PEDIDO'
          +#13#10'     INTO KVND_PEDIDO_SERVICO'
          +#13#10'     DO'
          +#13#10'       EXECUTE PROCEDURE  FIN_DELETE_APROPRIACAO OLD.KSYS$DOMAIN, ''VND_PEDIDO_SERVICOS'', KVND_PEDIDO_SERVICO ;'
          +#13#10''
          +#13#10''
          +#13#10'END' ) ;

end;


procedure TDBFinanceiroUpdate._5_000_01;
begin
    //RecreateInitPlano ;
    ExecuteDirect(Format('EXECUTE PROCEDURE SYS$INIT_PLANOCONTAS( %s )', [QuotedStr(LoggedUser.DomainID)]));

    ExecuteDirect('UPDATE FIN_PLANOCONTAS'
                      + ' SET NOME = ''Manutenção de máquinas e equipamentos: eq. ordenha, implementos'' '
                      + ' WHERE CODIGO = 32'
                      + '   AND NOME = ''Manutenção de máquinias e equipamentos: eq. ordenha, implementos''');

    ExecuteDirect('UPDATE FIN_PLANOCONTAS'
                      + ' SET NOME = ''Receitas'' '
                      + ' WHERE CODIGO = 3'
                      + '   AND NOME = ''Receita''');

    ExecuteDirect('UPDATE FIN_PLANOCONTAS'
                      + ' SET NOME = ''Despesas'' '
                      + ' WHERE CODIGO = 4'
                      + '   AND NOME = ''Despesa''');

end;


procedure TDBFinanceiroUpdate._5_001_42 ;
const
   _UPDATE_EST_PRODUTOS =
         'UPDATE EST_PRODUTOS'
  +#13#10'SET'
  +#13#10'  DATA_SALDOINICIAL = DATA_SALDOINICIAL -1'
  +#13#10'WHERE KEST_PRODUTO IN ('
  +#13#10' SELECT'
  +#13#10'  P.KEST_PRODUTO'
  +#13#10' FROM EST_PRODUTOS P'
  +#13#10' LEFT JOIN EST_MOVIMENTO M on M.KEST_PRODUTO = P.KEST_PRODUTO AND M.TIPO = ''C'''
  +#13#10' WHERE P.BAIXA_ESTOQUE = ''T'''
  +#13#10'  AND M.KEST_PRODUTO IS NULL'
  +#13#10')' ;

   _UPDATE_BAK_EST_PRODUTOS =
         'UPDATE EST_PRODUTOS'
  +#13#10'SET'
  +#13#10'  DATA_SALDOINICIAL = DATA_SALDOINICIAL +1'
  +#13#10'WHERE KEST_PRODUTO IN ('
  +#13#10' SELECT'
  +#13#10'  M.KEST_PRODUTO'
  +#13#10' FROM EST_MOVIMENTO M'
  +#13#10' WHERE M.TIPO = ''C'''
  +#13#10'   AND M.SYS$DI > %s'
  +#13#10'GROUP BY 1'
  +#13#10')' ;

var
  LUpdateDate : string ;
  EncerramentoMensal : TEncerramentoMensal ;
begin

  EncerramentoMensal := TEncerramentoMensal.Create( self.IDB );
  LUpdateDate := QuotedStr( FormatDateTime ( 'dd.mm.yyyy hh:nn', IncMinute( Now, -1 ) ) ) ;

  TryExecuteDirect ( _UPDATE_EST_PRODUTOS ) ;
  TryExecuteDirect ( Format( _UPDATE_BAK_EST_PRODUTOS, [ LUpdateDate ] ) ) ;

  EncerramentoMensal.Free ;

end ;


end.



